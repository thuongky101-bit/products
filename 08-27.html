<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="·ª®ng d·ª•ng Pomodoro h·ªó tr·ª£ h·ªçc t·∫≠p v·ªõi t√≠ch h·ª£p Gemini AI v√† giao di·ªán hi·ªán ƒë·∫°i." />
    <title>Pomodoro Study App ‚Äî T√≠ch h·ª£p Gemini AI (Giao di·ªán m·ªõi)</title>
    <style>
    /*
    =============================================
    POMODORO STUDY APP ‚Äî PHI√äN B·∫¢N GIAO DI·ªÜN T·∫¨P TRUNG (v11.1)
    =============================================
    */

    :root {
      --bg: #0f1222;
      --panel: #171a2e;
      --muted: #212646;
      --text: #f4f6ff;
      --sub: #cdd5ff;
      --acc: #6c8cff;
      --acc-2: #27d3a2;
      --warn: #ffb020;
      --danger: #ff5c7a;
      --shadow: 0px 1.8px 2.2px rgba(0, 0, 0, 0.034),
                0px 4.3px 5.3px rgba(0, 0, 0, 0.048),
                0px 8.1px 10px rgba(0, 0, 0, 0.06),
                0px 14.5px 17.9px rgba(0, 0, 0, 0.072),
                0px 27.2px 33.4px rgba(0, 0, 0, 0.086),
                0px 65px 80px rgba(0, 0, 0, 0.12);
      --radius: 16px;
      --panel-opacity: 0.85;
      --gradient-border: linear-gradient(135deg, var(--acc), var(--acc-2));
    }

    *:focus-visible {
      outline: 2px solid var(--acc); outline-offset: 2px; border-radius: 4px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background: var(--bg-image, radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%)); background-size: cover; background-position: center; color:var(--text); transition: background-image 0.5s ease; text-shadow: 0px 0px 5px rgba(0, 0, 0, 0.5);}
    a{color:var(--acc)}

    .app{display:flex; min-height:100vh}
    
    .app-nav {
        width: 60px;
        /* D√πng m√†u g·ªëc l√† rgba(15, 18, 34, ...) v√† √°p d·ª•ng bi·∫øn --panel-opacity */
        background: rgba(15, 18, 34, var(--panel-opacity));
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(255,255,255,.08);
        padding: 16px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        z-index: 100;
    }
    .nav-btn {
        background: transparent;
        border: none;
        color: var(--sub);
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all .2s ease;
        position: relative;
    }
    .nav-btn:hover { background: var(--muted); color: var(--text); }
    .nav-btn.active { background: var(--acc); color: white; }
    .nav-btn svg { width: 24px; height: 24px; }
    .nav-btn .tooltip {
        position: absolute;
        left: 110%;
        top: 50%;
        transform: translateY(-50%);
        background: #1d243f;
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity .2s ease, visibility .2s ease;
        pointer-events: none;
    }
    .nav-btn:hover .tooltip { opacity: 1; visibility: visible; }

    .app-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        max-height: 100vh;
    }

    .view { display: none; }
    .view.active { display: grid; gap: 24px; animation: fadeIn .3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .main.reloading { opacity: 0; transition: opacity 0.2s ease-out; }

    .panel-bg{background: rgba(23, 26, 46, var(--panel-opacity)); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.08);}

    header.app-header{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom: 24px;}
    header .actions{display:flex; gap:8px; align-items:center}
    
    .btn {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border: 1px solid transparent;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.08);
      font-weight: 600;
      transition: all .15s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        border: 2px solid transparent; border-radius: 12px; background: var(--gradient-border) border-box;
        -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: destination-out; mask-composite: exclude; opacity: 0; transition: opacity 0.3s ease;
    }
    .btn:hover::before { opacity: 1; }
    .btn:hover {
        background: rgba(255, 255, 255, 0.12);
        filter: none;
    }
    .btn:active { transform: translateY(1px) scale(0.98); filter: brightness(1); }
    .btn:disabled { cursor: not-allowed; filter: brightness(0.8) saturate(0.5); }
    .btn.ghost {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn.ghost:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
    }
    .btn.acc { background: var(--acc); color: white; }
    .btn.warn { background: var(--warn); color: white; }
    .btn.danger { background: var(--danger); color: white; }
    .btn.small { padding: 6px 10px; font-size: 14px; border-radius: 9px; }
    .btn.small::before { border-radius: 9px; }
    .btn > svg { width: 16px; height: 16px; stroke-width: 2.5px; }

    #view-topics { grid-template-columns: 1fr; }
    .topic-item{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px; margin-bottom:8px}
    .topic-header{display:flex; align-items:center; gap:8px}
    .topic-actions, .sub-row > .btn.small { opacity: 0.4; transition: opacity .2s ease; }
    .topic-item:hover .topic-actions, .sub-row:hover > .btn.small { opacity: 1; }
    .topic-title{flex:1; font-weight:600}
    .topic-actions{display:flex; gap:6px}
    .chev{width:28px; height:28px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center}
    .chev .ico{display:inline-block; transition: transform .18s ease}
    .chev[aria-expanded="false"] .ico{transform: rotate(-90deg)}
    .subtopics{margin-top:8px; display:flex; flex-direction:column; gap:6px}
    .subtopics.hidden{display:none}
    .sub-row{display:flex; gap:6px; align-items:center}
    
    /* === START: Y√äU C·∫¶U C·∫¨P NH·∫¨T 1 === */
    .subtopic-btn{
        flex:1; 
        text-align:left;
        background-color: rgba(255, 255, 255, 0.05);
    }
    .subtopic-btn:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    .subtopic-btn.active {
        outline: 2px solid var(--acc);
        background: transparent; /* Thay ƒë·ªïi th√†nh n·ªÅn trong su·ªët */
    }
    .subtopic-btn.active:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    /* === END: Y√äU C·∫¶U C·∫¨P NH·∫¨T 1 === */

    .panel{border-radius:var(--radius); padding:24px; box-shadow:var(--shadow)}

    .timer-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .timer{display:grid; gap:16px; grid-template-columns: 1fr; align-items:center; text-align:center}
    .big-time{font-size: clamp(60px, 12vw, 96px); letter-spacing:1px; font-weight:700; color: var(--text)}
    .state{font-weight:700; letter-spacing:.6px}
    .state.work{color:#8be28b}
    .state.break{color:#ffd479}
    .state.long{color:#ff9bb1}
    .controls{display:flex; flex-wrap:wrap; gap:12px; justify-content:center}    
    #btnStart { padding: 14px 28px; font-size: 1.2em; }
    #btnPause, #btnResume { padding: 12px 24px; font-size: 1.1em; }

    .stats-grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:12px}
    .stat-card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; text-align:center}
    .stat-card h4{margin:4px 0 8px; color:var(--sub); font-weight:600; font-size: 14px;}
    .stat-value{font-size: 20px; font-weight: 600;}
    .tiny{font-size:12px; color:var(--sub)}
    .history{display:grid; gap:8px; max-height:300px; overflow:auto; padding-right:6px}
    .hist-item{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:start; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px}
    .hist-meta{font-size:12px; color:var(--sub)}

    .row{display:flex; gap:8px; align-items:center}
    .row > * {flex:1}
    input[type="text"], input[type="password"], input[type="number"], select, textarea{width:100%; background:var(--panel); color:var(--text); border:1px solid var(--muted); border-radius:10px; padding:10px; outline:none}
    textarea{min-height:80px; resize: vertical;}

    .toasts{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999}
    .toast{background:#1d243f; border:1px solid rgba(255,255,255,.12); color:var(--text); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); animation: toast-in .3s ease; transform-origin: bottom right;}
    @keyframes toast-in { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.65); z-index:1000; backdrop-filter: blur(5px);}
    .modal.show{display:flex}
    .modal-card{
        width:min(720px, 94vw);
        /* D√πng m√†u g·ªëc l√† rgba(18, 22, 50, ...) v√† √°p d·ª•ng bi·∫øn --panel-opacity */
        background: rgba(18, 22, 50, var(--panel-opacity));
        backdrop-filter: blur(10px); /* Th√™m hi·ªáu ·ª©ng m·ªù n·ªÅn cho ƒë·∫πp h∆°n */
        -webkit-backdrop-filter: blur(10px);
        border:1px solid rgba(255,255,255,.1);
        border-radius:16px;
        padding:16px;
        box-shadow:var(--shadow);
        animation: modal-in .25s ease-out;
        max-height: 90vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    @keyframes modal-in { from { opacity: 0; transform: scale(0.92) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal-card h3{margin-top:0}
    .dashboard-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .dashboard-table th, .dashboard-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--muted); }
    .dashboard-table th { color: var(--sub); }

    .footer-note{font-size:12px; color:var(--sub)}
    .hidden{display:none !important}

    .notes-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; padding-right: 6px; }
    .note-item { background: rgba(255,255,255,0.04); border-radius: 10px; padding: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; cursor: pointer; }
    .note-content-wrapper { flex: 1; min-width: 0; }
    .note-content { white-space: pre-wrap; word-break: break-word; max-height: 60px; overflow: hidden; position: relative; transition: max-height 0.35s ease-in-out; }
    .note-content:not(.expanded)::after {
        content: ''; position: absolute; bottom: 0; right: 0; width: 100%; height: 20px; background: linear-gradient(to top, var(--panel) 20%, transparent);
    }
    .note-content.expanded { max-height: 500px; }
    .note-meta { font-size: 11px; color: var(--sub); margin-top: 4px; }
    
    .spinner { border: 2px solid rgba(255,255,255,.2); border-top-color: var(--text); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .panel-header h3 { margin: 0; }
    .panel-header .actions { display: flex; gap: 8px; }
    
    .aux-panel { margin-top: 24px; }
    .tab-nav { display: flex; gap: 4px; border-bottom: 1px solid var(--muted); margin-bottom: 16px; }
    .tab-btn { background: transparent; border: none; color: var(--sub); padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all .2s ease; font-weight: 600; }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--acc); border-bottom-color: var(--acc); }
    .tab-content { display: none; padding-top: 8px; }
    .tab-content.active { display: block; animation: fadeIn .3s ease; }
    
    .chat-messages { max-height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; padding: 4px; }
    .chat-msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; word-break: break-word; }
    .chat-msg.user { background: var(--acc); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-msg.model { background: var(--muted); align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-input-area { display: flex; gap: 8px; }

    .methods-list { list-style: none; padding: 0; }
    .method-item { align-items: flex-start; padding: 12px; display: flex; gap: 10px; border-radius: 8px; }
    .method-item:hover { background: rgba(255,255,255,0.05); }
    .method-item input[type="checkbox"] { width: 18px; height: 18px; margin-top: 2px; flex-shrink: 0;}
    .method-item label { flex: 1; }
    .method-item label.completed { text-decoration: line-through; color: var(--sub); }
    .method-item .content-wrapper { flex: 1; cursor: pointer; }
    .method-item .concept { font-size: 14px; color: var(--sub); margin-top: 8px; border-left: 2px solid var(--muted); padding-left: 12px; white-space: pre-wrap; word-break: break-word; }
    .subtopic-todo-list { list-style: none; padding: 0; margin: 0; max-height: 100px; overflow-y: auto; text-align: left; }
    .subtopic-todo-list li { display: flex; align-items: center; gap: 8px; padding: 4px; transition: all 0.2s ease-out; }
    .subtopic-todo-list li.removing { transform: translateX(100%); opacity: 0; }
    .subtopic-todo-list label { flex: 1; }

    #youtube-player-container { position: absolute; top: -9999px; left: -9999px; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background: var(--sub); background-clip: content-box; }
    
    .timer-circle-container {
        position: relative; width: clamp(250px, 40vw, 320px); height: clamp(250px, 40vw, 320px); margin: 24px auto; display: flex; align-items: center; justify-content: center;
    }
    .timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
    .timer-circle-bg, .timer-circle-progress { fill: none; stroke-width: 8; }
    .timer-circle-bg { stroke: rgba(255, 255, 255, 0.1); }
    .timer-circle-progress { stroke: var(--acc); stroke-linecap: round; transition: stroke-dashoffset 0.3s linear, stroke 0.5s ease; }
    @keyframes flash { 0%, 100% { box-shadow: 0 0 10px 2px transparent; } 50% { box-shadow: 0 0 20px 8px currentColor; } }
    .timer-circle-container.finished { color: var(--acc-2); animation: flash 1s ease-out; }
    @keyframes breathing-effect { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    .timer-circle-container.breathing { animation: breathing-effect 3s ease-in-out infinite; }
    @media (max-width: 1024px) {
      .app-content { padding: 20px; }
      .panel { padding: 20px; }
      .timer-circle-container { width: clamp(220px, 50vw, 300px); height: clamp(220px, 50vw, 300px); }
    }

    @media (max-width: 768px) {
      .app { flex-direction: column; }
      .app-nav { width: 100%; height: 60px; flex-direction: row; justify-content: center; border-right: none; border-top: 1px solid rgba(255,255,255,.08); order: 2; padding: 0 16px; }
      .app-content { padding: 16px; order: 1; }
      .panel { padding: 16px; }
      .modal-card .tab-nav { overflow-x: auto; }
    }

    @media (max-width: 480px) {
      .app-nav { height: 50px; }
      .nav-btn { flex: 1; }
      header.app-header { flex-direction: column; align-items: stretch; gap: 8px; }
      .btn { padding: 8px 12px; }
      .timer-circle-container { width: clamp(180px, 80vw, 220px); height: clamp(180px, 80vw, 220px); margin: 16px auto; }
      .panel { padding: 12px; }
      .app-content { padding: 12px; }
    }

    /* === C·∫¨P NH·∫¨T 1: C·∫£i thi·ªán Tr·∫£i nghi·ªám Ng∆∞·ªùi d√πng M·ªõi === */
    #view-timer.no-subtopic-selected > .panel-bg:not(:first-child) {
        display: none;
    }
    #view-timer.no-subtopic-selected .timer-header > .presets {
        display: none;
    }
    #view-timer.no-subtopic-selected .timer {
        display: none;
    }

    /* === C·∫¨P NH·∫¨T 2: Tinh ch·ªânh Giao di·ªán Header === */
    header.app-header .actions #btnFullscreen {
        background: transparent;
        border: none;
        box-shadow: none;
    }
    header.app-header .actions #btnFullscreen:hover {
        background: var(--muted);
        filter: none;
    }
    header.app-header .actions #btnFullscreen:hover::before {
        opacity: 0;
    }

    /* √ÅP D·ª§NG N·ªÄN TRONG SU·ªêT CHO T·∫§T C·∫¢ C√ÅC √î NH·∫¨P LI·ªÜU */
    input[type="text"], input[type="password"], input[type="number"], select, textarea {
        background: rgba(255, 255, 255, 0.04) !important; /* D√πng !important ƒë·ªÉ ghi ƒë√® m·ªçi style c≈© */
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: background .2s ease, border-color .2s ease;
    }
    /* HI·ªÜU ·ª®NG KHI FOCUS */
    input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
        background: rgba(255, 255, 255, 0.06) !important;
        border-color: var(--acc);
    }
    
    /* === START: Y√äU C·∫¶U C·∫¨P NH·∫¨T 2 === */
    /* === C·∫£i thi·ªán ƒë·ªô t∆∞∆°ng ph·∫£n cho Placeholder === */
    ::placeholder {
      /* D√πng bi·∫øn m√†u --sub (m√†u ch·ªØ ph·ª•) thay v√¨ m√†u m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát */
      color: var(--sub);
      /* ƒê·∫£m b·∫£o ƒë·ªô m·ªù c·ªßa placeholder l√† 100% (ch·ªâ m√†u s·∫Øc quy·∫øt ƒë·ªãnh) */
      opacity: 1;
    }

    /* D√†nh cho c√°c tr√¨nh duy·ªát c≈© h∆°n */
    ::-ms-input-placeholder {
      color: var(--sub);
    }

    /* D√†nh cho Firefox phi√™n b·∫£n c≈© h∆°n */
    :-ms-input-placeholder {
      color: var(--sub);
    }
    /* === END: Y√äU C·∫¶U C·∫¨P NH·∫¨T 2 === */
    </style>
</head>
<body>
  <div class="app" id="app">
    <nav class="app-nav">
        <button class="nav-btn active" id="navBtnTimer" data-view="timer" aria-label="Timer">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            <span class="tooltip">Timer</span>
        </button>
        <button class="nav-btn" id="navBtnTopics" data-view="topics" aria-label="Ch·ªß ƒë·ªÅ">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
            <span class="tooltip">Ch·ªß ƒë·ªÅ</span>
        </button>
        <button class="nav-btn" id="navBtnStats" data-view="stats" aria-label="Th·ªëng k√™">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
            <span class="tooltip">Th·ªëng k√™</span>
        </button>
        <button class="nav-btn" id="navBtnTools" data-view="tools" aria-label="C√¥ng c·ª• h·ªçc">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
            <span class="tooltip">C√¥ng c·ª• h·ªçc</span>
        </button>
        <button class="nav-btn" id="btnSettings" style="margin-top: auto;" aria-label="C√†i ƒë·∫∑t">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            <span class="tooltip">C√†i ƒë·∫∑t</span>
        </button>
    </nav>

    <main class="app-content">
      <header class="app-header panel-bg">
        <div class="row" style="gap:12px; align-items:center; flex:0 1 auto">
          <strong>üìö Pomodoro Study App</strong>
          <span class="badge" id="selectedContext">Ch∆∞a ch·ªçn Subtopic</span>
        </div>
        <div class="actions">
          <button class="btn ghost small" id="btnDashboard" title="Dashboard T·ªïng quan">üìä Dashboard</button>
          <button class="btn ghost small" id="btnExport" title="Xu·∫•t JSON">‚¨áÔ∏è Export</button>
          <label class="btn ghost small" for="importFile" title="Nh·∫≠p JSON">‚¨ÜÔ∏è Import</label>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
          <button class="btn small" id="btnFullscreen" title="To√†n m√†n h√¨nh">‚ÜóÔ∏è</button>
        </div>
      </header>

      <!-- VIEW: TIMER (M·∫∑c ƒë·ªãnh) -->
      <div id="view-timer" class="view active">
        <section class="panel panel-bg">
          <div class="timer-header">
            <div id="welcomePanel" class="hidden panel-bg" style="text-align:center; padding: 20px; border-radius: var(--radius); width: 100%;">
                <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi Pomodoro Study App!</h3>
                <p>H√£y b·∫Øt ƒë·∫ßu b·∫±ng c√°ch ch·ªçn m·ªôt <strong>Subtopic</strong> ho·∫∑c t·∫°o Topic/Subtopic m·ªõi.</p>
                <button class="btn acc" id="btnHelpCreateTopic">Ôºã T·∫°o Topic M·ªõi</button>
            </div>
            <div class="presets" role="group" aria-label="Ch·ªçn ch·∫ø ƒë·ªô preset">
                <button class="btn small ghost" data-preset="2x50">2√ó50 (B)</button>
                <button class="btn small ghost" data-preset="4x25">4√ó25 (A)</button>
                <button class="btn small ghost" data-preset="4x50">4√ó50 (B)</button>
            </div>
          </div>
          <hr style="border-color:rgba(255,255,255,.08)" />
          <div class="timer" aria-live="polite">
            <div class="badge" id="stateBadge">STATE</div>
            
            <div class="timer-circle-container">
              <svg class="timer-svg" viewBox="0 0 100 100">
                  <circle class="timer-circle-bg" cx="50" cy="50" r="45"></circle>
                  <circle class="timer-circle-progress" cx="50" cy="50" r="45"></circle>
              </svg>
              <div id="timeDisplay" class="big-time">00:00</div>
            </div>

            <div class="tiny" id="cycleInfo">Chu k·ª≥: 0 / 0</div>
            
            <div class="controls">
              <button class="btn acc" id="btnStart" aria-label="B·∫Øt ƒë·∫ßu (Space)">‚ñ∂Ô∏è Start</button>
              <button class="btn" id="btnPause" aria-label="T·∫°m d·ª´ng (Space)">‚è∏Ô∏è Pause</button>
              <button class="btn" id="btnResume" aria-label="Ti·∫øp t·ª•c (Space)">‚èµ Resume</button>
              <button class="btn warn" id="btnSkip" aria-label="B·ªè qua (N)">‚è≠Ô∏è Skip</button>
              <button class="btn danger" id="btnReset">‚Ü∫ Reset</button>
            </div>
            <div class="tiny">Ph√≠m t·∫Øt: <strong>Space</strong> = Start/Pause/Resume, <strong>N</strong> = Next/Skip</div>
          </div>
        </section>

        <!-- KHU V·ª∞C TAB M·ªöI -->
        <section class="panel panel-bg aux-panel">
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="tasks">Tasks</button>
                <button class="tab-btn" data-tab="notes">Ghi ch√∫</button>
                <button class="tab-btn" data-tab="ai">Gemini AI</button>
            </nav>
            <div id="tasks" class="tab-content active">
                <h4 style="margin: 0 0 8px; color: var(--sub);">To-do cho subtopic n√†y:</h4>
                <ul id="subtopicTasksList" class="subtopic-todo-list"></ul>
                <div class="row" style="gap:8px; margin-top: 8px;">
                    <input type="text" id="newSubtopicTaskInput" placeholder="Th√™m m·ªôt task m·ªõi..." />
                    <button id="btnAddSubtopicTask" class="btn small" style="flex: 0 1 auto;">Th√™m</button>
                </div>
            </div>
            <div id="notes" class="tab-content">
                <div id="generalNotesList" class="notes-list"></div>
                <div class="add-note-area" style="margin-top: 12px;">
                    <textarea id="newGeneralNoteText" placeholder="Th√™m ghi ch√∫ m·ªõi..."></textarea>
                    <div style="text-align: right; margin-top: 8px;">
                        <button class="btn acc small" id="btnAddGeneralNote">Ôºã Th√™m ghi ch√∫</button>
                    </div>
                </div>
            </div>
            <div id="ai" class="tab-content">
                <div class="panel-header" style="margin-bottom: 8px; padding: 0;">
                    <h4 style="margin:0;">Gemini Assistant cho: <span id="currentSubtopicNameChat">(ch∆∞a ch·ªçn)</span></h4>
                    <div class="actions">
                        <button id="btnNewChat" class="btn small ghost" title="Chat m·ªõi">‚ûï</button>
                        <button id="btnClearChat" class="btn small danger" title="X√≥a l·ªãch s·ª≠">üóëÔ∏è</button>
                    </div>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="H·ªèi Gemini ƒëi·ªÅu g√¨ ƒë√≥..." />
                    <button id="btnSendMessage" class="btn acc">G·ª≠i</button>
                </div>
            </div>
        </section>
      </div>

      <!-- VIEW: TOPICS -->
      <div id="view-topics" class="view">
        <div class="panel panel-bg">
            <div class="row" style="gap:8px; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0;">Qu·∫£n l√Ω Ch·ªß ƒë·ªÅ</h3>
                <button class="btn small acc" id="btnAddTopic" style="margin-left: auto;">Ôºã Th√™m Topic</button>
            </div>
            <div id="topicsList"></div>
            <div class="footer-note">Nh·∫•p m≈©i t√™n ƒë·ªÉ m·ªü/ƒë√≥ng danh s√°ch subtopic.</div>
        </div>
      </div>
      
      <!-- VIEW: STATS -->
      <div id="view-stats" class="view">
        <section class="panel panel-bg">
            <h3 style="margin:0 0 12px 0;">Th·ªëng k√™ & L·ªãch s·ª≠ ‚Äî <span id="currentSubtopicName">(ch∆∞a ch·ªçn)</span></h3>
            <div class="stats-grid">
              <div class="stat-card"><h4>T·ªïng th·ªùi gian</h4><div class="stat-value" id="statTotal">0 ph√∫t</div></div>
              <div class="stat-card"><h4>Sessions</h4><div class="stat-value" id="statSessions">0</div></div>
              <div class="stat-card"><h4>Tasks Ho√†n th√†nh</h4><div class="stat-value" id="statTasks">0</div></div>
            </div>
            <div style="margin-top:12px">
              <h4 style="margin:4px 0 8px; color:var(--sub)">L·ªãch s·ª≠ (WORK)</h4>
              <div class="history" id="historyList"></div>
            </div>
        </section>
      </div>

      <!-- VIEW: TOOLS -->
      <div id="view-tools" class="view">
        <section class="panel panel-bg">
            <h3 style="margin:0 0 12px 0;">ü§î Ch·∫ø ƒë·ªô H·ªèi-ƒê√°p Socratic</h3>
            <p class="tiny" style="margin-top: -8px; margin-bottom: 12px;">S·ª≠ d·ª•ng c√°c c√¢u h·ªèi n√†y ƒë·ªÉ ƒë√†o s√¢u t∆∞ duy, th·ª≠ th√°ch c√°c gi·∫£ ƒë·ªãnh v√† hi·ªÉu r√µ v·∫•n ƒë·ªÅ h∆°n.</p>
            <div id="socraticMethodsList" style="display: flex; flex-direction: column; gap: 8px;"></div>
        </section>
        <section class="panel panel-bg">
            <h3 style="margin:0 0 12px 0;">C√°c ph∆∞∆°ng ph√°p h·ªçc</h3>
            <ul id="learningMethodsList" class="methods-list" style="max-height: none;"></ul>
            <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
                <input type="text" id="newMethodNameInput" placeholder="T√™n ph∆∞∆°ng ph√°p m·ªõi...">
                <textarea id="newMethodConceptInput" placeholder="Kh√°i ni·ªám (kh√¥ng b·∫Øt bu·ªôc)..." style="min-height: 60px;"></textarea>
                <div style="text-align: right;">
                    <button id="btnAddMethod" class="btn small" style="flex: 0 1 auto;">Th√™m</button>
                </div>
            </div>
        </section>
      </div>

    </main>
  </div>

  <!-- ========= MODALS ========= -->
  <div class="modal" id="modalSettings" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-card">
          <h3 id="settingsTitle">‚öôÔ∏è C√†i ƒë·∫∑t</h3>
          <nav class="tab-nav">
              <button class="tab-btn active" data-tab="settings-timer">Timer</button>
              <button class="tab-btn" data-tab="settings-ui">Giao di·ªán & √Çm thanh</button>
              <button class="tab-btn" data-tab="settings-integrations">T√≠ch h·ª£p</button>
          </nav>
          <div class="settings-content">
              <div id="settings-timer" class="tab-content active" style="display: flex; flex-direction: column; gap: 20px;">
                  <div>
                      <h4>Th·ªùi l∆∞·ª£ng</h4>
                      <div class="row"><strong>Ki·ªÉu A (25/5) ‚Äî Long break 15</strong></div>
                      <div class="row">
                          <label>WORK (ph√∫t)<input type="number" id="set_A_work" min="1" /></label>
                          <label>BREAK (ph√∫t)<input type="number" id="set_A_short" min="1" /></label>
                          <label>LONG BREAK (ph√∫t)<input type="number" id="set_A_long" min="1" /></label>
                      </div>
                      <div class="row" style="margin-top:8px"><strong>Ki·ªÉu B (50/10) ‚Äî Long break 30</strong></div>
                      <div class="row">
                          <label>WORK (ph√∫t)<input type="number" id="set_B_work" min="1" /></label>
                          <label>BREAK (ph√∫t)<input type="number" id="set_B_short" min="1" /></label>
                          <label>LONG BREAK (ph√∫t)<input type="number" id="set_B_long" min="1" /></label>
                      </div>
                  </div>
                  <div>
                      <h4>Chu k·ª≥</h4>
                      <div class="row">
                          <label>Long break m·ªói <input type="number" id="set_interval" min="2" /> phi√™n WORK</label>
                      </div>
                  </div>
              </div>
              <div id="settings-ui" class="tab-content" style="display: none; flex-direction: column; gap: 20px;">
                  <div>
                      <h4>Giao di·ªán</h4>
                      <div class="row">
                          <label>Theme Giao Di·ªán
                              <select id="set_theme_color">
                                  <option value="default">M·∫∑c ƒë·ªãnh (Dark Blue)</option>
                              </select>
                          </label>
                      </div>
                      <div class="row">
                          <label>H√¨nh n·ªÅn
                              <label class="btn small ghost" for="uploadBg">T·∫£i l√™n ·∫£nh...</label>
                              <input type="file" id="uploadBg" accept="image/*" class="hidden" />
                          </label>
                          <button class="btn small danger" id="btnClearBg">X√≥a n·ªÅn</button>
                      </div>
                      <div class="row">
                          <label style="flex: 1;">ƒê·ªô trong su·ªët c·ªßa n·ªÅn</label>
                          <input type="range" id="set_panelOpacity" min="0.1" max="1" step="0.05" style="flex: 2;">
                      </div>
                  </div>
                  <div>
                      <h4>√Çm thanh</h4>
                      <div class="row">
                          <label>√Çm l∆∞·ª£ng (0‚Äì1)<input type="number" id="set_volume" step="0.05" min="0" max="1"/></label>
                          <label>Ki·ªÉu √¢m b√°o
                              <select id="set_theme">
                                  <option value="beep">Beep</option>
                                  <option value="chime">Chime</option>
                              </select>
                          </label>
                          <button class="btn" id="btnTestSound">Test</button>
                      </div>
                      <div class="row" style="gap: 16px;">
                          <div>
                              <small>√Çm b√°o h·∫øt WORK</small>
                              <label class="btn small ghost" for="uploadSoundWork">T·∫£i l√™n...</label>
                              <input type="file" id="uploadSoundWork" accept="audio/*" class="hidden" />
                          </div>
                          <div>
                              <small>√Çm b√°o h·∫øt BREAK</small>
                              <label class="btn small ghost" for="uploadSoundBreak">T·∫£i l√™n...</label>
                              <input type="file" id="uploadSoundBreak" accept="audio/*" class="hidden" />
                          </div>
                          <div>
                              <small>√Çm b√°o h·∫øt LONG BREAK</small>
                              <label class="btn small ghost" for="uploadSoundLong">T·∫£i l√™n...</label>
                              <input type="file" id="uploadSoundLong" accept="audio/*" class="hidden" />
                          </div>
                      </div>
                  </div>
              </div>
              <div id="settings-integrations" class="tab-content" style="display: none; flex-direction: column; gap: 20px;">
                  <div>
                      <h4>T√≠ch h·ª£p AI</h4>
                      <label>Gemini API Key
                          <input type="password" id="set_apiKey" placeholder="D√°n API Key c·ªßa b·∫°n v√†o ƒë√¢y..." />
                      </label>
                      <div class="tiny">C·∫ßn c√≥ ƒë·ªÉ s·ª≠ d·ª•ng c√°c t√≠nh nƒÉng AI. L·∫•y key mi·ªÖn ph√≠ t·∫°i <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.</div>
                  </div>
                  <div>
                      <h4>üéµ Nh·∫°c n·ªÅn YouTube</h4>
                      <div class="row">
                          <input type="text" id="set_youtubeUrl" placeholder="D√°n link YouTube v√†o ƒë√¢y...">
                      </div>
                      <div class="row" style="margin-top: 4px;">
                          <label style="flex: 0 1 auto; display: flex; align-items: center; gap: 8px; font-size: 14px;">
                              <input type="checkbox" id="set_ytThumbAsBg">
                              <span>D√πng ·∫£nh b√¨a video l√†m n·ªÅn</span>
                          </label>
                      </div>
                      <div class="row" style="margin-top: 8px;">
                          <button id="btnToggleYtSound" class="btn small" style="flex: 0 1 auto;">‚ñ∂Ô∏è</button>
                          <input type="range" id="ytSoundVolume" min="0" max="100" step="1" value="80" style="flex: 1;">
                      </div>
                  </div>
              </div>
          </div>
          <div class="row" style="margin-top:16px; justify-content:flex-end">
              <button class="btn ghost" id="btnDefaults">M·∫∑c ƒë·ªãnh</button>
              <button class="btn acc" id="btnSaveSettings">L∆∞u</button>
              <button class="btn" id="btnCloseSettings">ƒê√≥ng</button>
          </div>
      </div>
  </div>

  <div class="modal" id="modalNote" role="dialog" aria-modal="true" aria-labelledby="noteTitle">
    <div class="modal-card">
      <h3 id="noteTitle">üìù Ghi ch√∫ cho phi√™n v·ª´a ho√†n th√†nh</h3>
      <div class="row"><textarea id="noteText" placeholder="B·∫°n h·ªçc ƒë∆∞·ª£c g√¨? Kh√≥ khƒÉn? Next steps?"></textarea></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px; gap: 12px;">
        <button class="btn" id="btnSummarizeNote">‚ú® T√≥m t·∫Øt & G·ª£i √Ω</button>
        <button class="btn" id="btnSkipNote">B·ªè qua</button>
        <button class="btn acc" id="btnSaveNote">L∆∞u ghi ch√∫</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalGeneric" role="dialog" aria-modal="true" aria-labelledby="genericTitle">
      <div class="modal-card" style="width: min(450px, 94vw);">
          <h3 id="genericTitle">Ti√™u ƒë·ªÅ</h3>
          <p id="genericMessage" class="hidden"></p>
          <input type="text" id="genericInput" class="hidden" />
          <div class="row" style="justify-content:flex-end; margin-top:12px">
              <button class="btn" id="btnGenericCancel">H·ªßy</button>
              <button class="btn acc" id="btnGenericOk">OK</button>
          </div>
      </div>
  </div>
  
  <div class="modal" id="modalDashboard" role="dialog" aria-modal="true" aria-labelledby="dashboardTitle">
    <div class="modal-card" style="width: min(800px, 95vw);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 id="dashboardTitle">üìä Dashboard T·ªïng quan</h3>
            <button class="btn ghost small" onclick="$('#modalDashboard').classList.remove('show')">ƒê√≥ng</button>
        </div>
        <p class="tiny">T·ªïng h·ª£p th·ªùi gian v√† s·ªë phi√™n ƒë√£ ho√†n th√†nh tr√™n t·∫•t c·∫£ c√°c ch·ªß ƒë·ªÅ.</p>
        <div id="dashboardContent" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>
  <audio id="audioWorkEnd"></audio>
  <audio id="audioBreakEnd"></audio>
  <audio id="audioLongEnd"></audio>
  <div id="youtube-player-container"></div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // =============================
    // Helpers
    // =============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const formatMMSS = (s) => { const m = Math.floor(s/60).toString().padStart(2,'0'); const ss = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; };
    const uid = (p='id') => `${p}_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;
    const todayISO = () => new Date().toISOString();
    function toast(msg, ms=2600){ const box=$('#toasts'); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; box.appendChild(t); setTimeout(()=>{t.style.opacity='0';}, ms-300); setTimeout(()=> box.removeChild(t), ms); }
    function escapeHTML(str){ return str.replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    function formatDaysHoursMinutes(totalMinutes) {
        if (!totalMinutes || totalMinutes < 1) return "0 ph√∫t";
        const MINS_IN_DAY = 24 * 60;
        const days = Math.floor(totalMinutes / MINS_IN_DAY);
        const remainingMinutes = totalMinutes % MINS_IN_DAY;
        const hours = Math.floor(remainingMinutes / 60);
        const minutes = remainingMinutes % 60;
        const parts = [];
        if (days > 0) parts.push(`${days} ng√†y`);
        if (hours > 0) parts.push(`${hours} gi·ªù`);
        if (minutes > 0 || parts.length === 0) parts.push(`${minutes} ph√∫t`);
        return parts.join(', ');
    }
    function formatGeminiResponse(text) {
        return text.replace(/(\*\*|__|\*|_|#+\s*)/g, '');
    }
    function extractYouTubeID(url) {
        let videoId = null;
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        if (match && match[2].length === 11) {
            videoId = match[2];
        }
        return videoId;
    }
    function applyTheme() {
        const theme = store.data.settings.theme || 'default';
        document.body.className = ''; // X√≥a t·∫•t c·∫£ c√°c class c≈©
        if (theme !== 'default') {
            document.body.classList.add(theme);
        }
    }

    // =============================
    // Gemini API Integration
    // =============================
    async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
        const apiKey = store.data.settings.apiKey || "";
        if (!apiKey) {
            toast("Vui l√≤ng nh·∫≠p Gemini API Key trong ph·∫ßn C√†i ƒë·∫∑t.");
            return null;
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                if (response.status === 429 && retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                return formatGeminiResponse(result.candidates[0].content.parts[0].text);
            } else {
                console.error("API response structure is unexpected:", result);
                if (result.promptFeedback?.blockReason) { return `N·ªôi dung b·ªã ch·∫∑n v√¨: ${result.promptFeedback.blockReason}. Vui l√≤ng th·ª≠ l·∫°i v·ªõi n·ªôi dung kh√°c.`; }
                return "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung h·ª£p l·ªá t·ª´ AI.";
            }
        } catch (error) {
            console.error("L·ªói khi g·ªçi Gemini API:", error);
            if (retries > 0) {
                await new Promise(resolve => setTimeout(resolve, delay));
                return callGeminiAPI(prompt, retries - 1, delay * 2);
            }
            return "ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.";
        }
    }

    // =============================
    // Audio
    // =============================
    let AUDIO_CTX = null;
    function ensureAudio(){ if(!AUDIO_CTX) AUDIO_CTX = new (window.AudioContext||window.webkitAudioContext)(); }
    function tone(freq=880, durMs=200, vol=0.2, type='sine', when=0){ ensureAudio(); const ctx=AUDIO_CTX; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); const t = ctx.currentTime + when; g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(vol, t+0.01); g.gain.exponentialRampToValueAtTime(0.0001, t + durMs/1000); o.start(t); o.stop(t + durMs/1000 + 0.05); }

    function playSound(kind){
      if(!store.data.settings.soundOn) return;
      const vol = Math.max(0, Math.min(1, store.data.settings.volume ?? 0.8));
      const customSoundUrl = store.data.settings.customSounds?.[kind];
      let audioEl;
      if (kind === 'work_end') audioEl = $('#audioWorkEnd'); else if (kind === 'break_end') audioEl = $('#audioBreakEnd'); else if (kind === 'long_end') audioEl = $('#audioLongEnd');
      if (customSoundUrl && audioEl) { audioEl.src = customSoundUrl; audioEl.volume = vol; audioEl.play().catch(e => console.error("L·ªói ph√°t √¢m thanh:", e)); return; }
      const theme = store.data.settings.soundTheme || 'beep';
      if(theme==='beep'){
        if(kind==='work_end') { tone(880,250,vol); tone(660,180,vol*0.8, 'sine', 0.22); } else if(kind==='break_end') { tone(660,220,vol*0.9); } else if(kind==='long_end') { tone(520,200,vol); tone(780,200,vol, 'sine', 0.22); tone(1040,220,vol, 'sine', 0.44); }
      } else {
        if(kind==='work_end') { tone(1200,160,vol*0.9,'triangle'); tone(900,220,vol*0.8,'triangle',0.18); } else if(kind==='break_end') { tone(880,240,vol*0.8,'triangle'); } else if(kind==='long_end') { tone(600,220,vol*0.9,'triangle'); tone(950,240,vol*0.9,'triangle',0.22); tone(1200,240,vol,'triangle',0.44); }
      }
    }

    // =============================
    // Storage
    // =============================
    const LS_KEY = 'pomodoro_data_v11'; // C·∫≠p nh·∫≠t phi√™n b·∫£n ƒë·ªÉ tr√°nh xung ƒë·ªôt
    const defaultData = () => ({
      version:11,
      settings:{
        apiKey: "",
        currentView: 'timer', // Th√™m tr·∫°ng th√°i view m·ªõi
        preset:'4x25',
        autoStartNext:true,
        soundOn:true,
        volume:0.8,
        soundTheme:'beep',
        theme: 'default',
        longBreakInterval:4,
        durations:{A_work:25,A_short:5,A_long:15,B_work:50,B_short:10,B_long:30},
        selectedTopicId:'',
        selectedSubtopicId:'',
        collapsedTopics:{},
        customBg: '',
        customSounds: { work_end: '', break_end: '', long_end: '' },
        youtubeUrl: '',
        youtubeVolume: 80,
        useYtThumbnailAsBg: true,
        panelOpacity: 0.85
      },
      topics:[ { id: uid('t'), name:'Ch·ªß ƒë·ªÅ m·∫´u', subtopics:[ { id: uid('s'), name:'Subtopic m·∫´u', tasks: [], generalNotes: [], chatHistory: [],
      learningMethods: [
            { id: uid('m'), text: 'G·ª£i Nh·ªõ Ch·ªß ƒê·ªông (Active Recall)', concept: 'Ch·ªß ƒë·ªông t√°i t·∫°o th√¥ng tin t·ª´ k√Ω ·ª©c thay v√¨ ƒë·ªçc l·∫°i th·ª• ƒë·ªông. N√£o b·ªô h·ªçc b·∫±ng c√°ch l·∫•y th√¥ng tin ra, kh√¥ng ph·∫£i nh√©t v√†o. S·ª≠ d·ª•ng c√¢u h·ªèi, flashcard, t√≥m t·∫Øt t·ª´ k√Ω ·ª©c ƒë·ªÉ r√®n luy·ªán kh·∫£ nƒÉng recall.', completed: false },
            { id: uid('m'), text: 'L·∫∑p L·∫°i C√≥ Kho·∫£ng C√°ch (Spaced Repetition)', concept: '√în l·∫°i ki·∫øn th·ª©c theo kho·∫£ng th·ªùi gian tƒÉng d·∫ßn (1 ng√†y ‚Üí 3 ng√†y ‚Üí 1 tu·∫ßn ‚Üí 1 th√°ng). N√£o b·ªô ghi nh·ªõ l√¢u d√†i khi th√¥ng tin xu·∫•t hi·ªán nhi·ªÅu l·∫ßn v·ªõi kho·∫£ng c√°ch th√≠ch h·ª£p, ch·ªëng qu√™n theo ƒë∆∞·ªùng cong Ebbinghaus.', completed: false },
            { id: uid('m'), text: 'K·ªπ Thu·∫≠t Feynman', concept: 'Gi·∫£i th√≠ch ki·∫øn th·ª©c b·∫±ng ng√¥n ng·ªØ ƒë∆°n gi·∫£n nh∆∞ d·∫°y cho tr·∫ª em. N·∫øu kh√¥ng gi·∫£i th√≠ch ƒë∆∞·ª£c ƒë∆°n gi·∫£n, b·∫°n ch∆∞a hi·ªÉu th·∫≠t s·ª±. Quy tr√¨nh: Vi·∫øt ch·ªß ƒë·ªÅ ‚Üí Gi·∫£i th√≠ch b·∫±ng t·ª´ ng·ªØ th∆∞·ªùng ng√†y ‚Üí T√¨m l·ªó h·ªïng ki·∫øn th·ª©c ‚Üí H·ªçc l·∫°i ‚Üí Gi·∫£i th√≠ch l·∫°i ƒë∆°n gi·∫£n h∆°n.', completed: false },
            { id: uid('m'), text: 'H·ªçc ƒê·∫Øm Ch√¨m (Immersion Learning)', concept: 'T·∫°o m√¥i tr∆∞·ªùng ng√¥n ng·ªØ bao quanh (ƒë·ªçc s√°ch, xem phim, nghe nh·∫°c b·∫±ng ng√¥n ng·ªØ m·ª•c ti√™u). N√£o b·ªô h·ªçc ng√¥n ng·ªØ qua exposure t·ª± nhi√™n v√† context phong ph√∫.', completed: false }
        ],
      stats:{totalMinutes:0,sessionsCompleted:0, tasksCompleted: 0},
      sessions:[],
      timerState: {
            state: 'idle',
            remaining: 0,
            segmentTotal: 0,
            cycleIndex: 0
        }
    } ] } ]
    });

    const store = {
      data:null,
      load(){
        try{ const raw=localStorage.getItem(LS_KEY); this.data = raw? JSON.parse(raw) : defaultData(); }
        catch(e){ this.data=defaultData(); console.error("L·ªói parse JSON, d√πng d·ªØ li·ªáu m·∫∑c ƒë·ªãnh:", e); }

        if (!this.data.version || this.data.version < 11) {
            // N·∫øu phi√™n b·∫£n c≈©, c√≥ th·ªÉ th√™m logic chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu ·ªü ƒë√¢y
            // Hi·ªán t·∫°i, ch·ªâ ƒë∆°n gi·∫£n l√† reset v·ªÅ m·∫∑c ƒë·ªãnh ƒë·ªÉ ƒë·∫£m b·∫£o t∆∞∆°ng th√≠ch
            this.data = defaultData();
        }
        
        const set = this.data.settings;
        if (set.currentView === undefined) set.currentView = 'timer';

        this.save();
        ensureValidSelection();
        return this.data;
      },
      save(){ localStorage.setItem(LS_KEY, JSON.stringify(this.data)); },
      export(){ const blob=new Blob([JSON.stringify(this.data,null,2)],{type:'application/json'}); const a=document.createElement('a'); const ts=new Date(); const pad=n=>`${n}`.padStart(2,'0'); a.href=URL.createObjectURL(blob); a.download=`pomodoro_backup_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}.json`; a.click(); URL.revokeObjectURL(a.href); },
      async import(file){ const text=await file.text(); try{ const obj=JSON.parse(text); if(!obj.version||!obj.settings||!Array.isArray(obj.topics)) throw new Error('T·ªáp kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng'); this.data=obj; this.save(); ensureValidSelection(); toast('ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!'); renderAll(); }catch(e){ toast('Nh·∫≠p th·∫•t b·∫°i: '+e.message); } }
    };

    function ensureValidSelection(){
      const set = store.data.settings;
      if (!store.data.topics || store.data.topics.length === 0) { set.selectedTopicId = ''; set.selectedSubtopicId = ''; store.save(); return; }
      const t = store.data.topics.find(x=>x.id===set.selectedTopicId);
      const s = t?.subtopics.find(x=>x.id===set.selectedSubtopicId);
      if(!t || !s){
        const t0 = store.data.topics[0];
        const s0 = t0?.subtopics?.[0];
        set.selectedTopicId = t0?.id || '';
        set.selectedSubtopicId = s0?.id || '';
        store.save();
      }
    }

    // =============================
    // Generic Modals & View Switching
    // =============================
    function showInputModal(title, okCallback, defaultValue = '') {
        $('#genericTitle').textContent = title;
        $('#genericMessage').classList.add('hidden');
        const input = $('#genericInput'); input.value = defaultValue; input.classList.remove('hidden');
        $('#modalGeneric').classList.add('show'); input.focus(); input.select();
        const okHandler = () => { okCallback(input.value); cleanup(); };
        const cancelHandler = () => cleanup();
        const keyHandler = (e) => { if (e.key === 'Enter') okHandler(); if (e.key === 'Escape') cancelHandler(); };
        $('#btnGenericOk').onclick = okHandler; $('#btnGenericCancel').onclick = cancelHandler; input.onkeydown = keyHandler;
        function cleanup() { $('#modalGeneric').classList.remove('show'); $('#btnGenericOk').onclick = null; $('#btnGenericCancel').onclick = null; input.onkeydown = null; }
    }

    function showConfirmModal(title, message, okCallback) {
        $('#genericTitle').textContent = title;
        const msgEl = $('#genericMessage'); msgEl.textContent = message; msgEl.classList.remove('hidden');
        $('#genericInput').classList.add('hidden'); $('#modalGeneric').classList.add('show');
        const okHandler = () => { okCallback(true); cleanup(); };
        const cancelHandler = () => { okCallback(false); cleanup(); };
        $('#btnGenericOk').onclick = okHandler; $('#btnGenericCancel').onclick = cancelHandler;
        function cleanup() { $('#modalGeneric').classList.remove('show'); $('#btnGenericOk').onclick = null; $('#btnGenericCancel').onclick = null; }
    }

    function switchView(viewId) {
        $$('.view').forEach(v => v.classList.remove('active'));
        $(`#view-${viewId}`).classList.add('active');
        $$('.nav-btn').forEach(b => b.classList.remove('active'));
        const navBtn = $(`.nav-btn[data-view="${viewId}"]`);
        if (navBtn) navBtn.classList.add('active');
        store.data.settings.currentView = viewId;
        store.save();
        if (viewId === 'stats') {
            renderDashboard();
        }
    }

    // =============================
    // Sidebar: Topics & Subtopics
    // =============================
    function renderTopics(){
      const wrap = $('#topicsList'); wrap.innerHTML='';
      const collapsedMap = store.data.settings.collapsedTopics || {};
      store.data.topics.forEach(topic => {
        const box = document.createElement('div'); box.className='topic-item';
        const header = document.createElement('div'); header.className='topic-header';
        const isCollapsed = !!collapsedMap[topic.id];
        const chev = document.createElement('button'); chev.className='btn small ghost chev'; chev.setAttribute('title','M·ªü/ƒë√≥ng subtopics'); chev.setAttribute('aria-expanded', String(!isCollapsed)); chev.innerHTML = '<span class="ico">‚ñº</span>';
        const title = document.createElement('div'); title.className='topic-title'; title.textContent = topic.name;
        const act = document.createElement('div'); act.className='topic-actions';
        const bAdd = document.createElement('button'); bAdd.className='btn small'; bAdd.textContent='Ôºã Sub';
        const bEdit = document.createElement('button'); bEdit.className='btn small ghost'; bEdit.textContent='S·ª≠a';
        const bDel = document.createElement('button'); bDel.className='btn small danger'; bDel.textContent='X√≥a';
        act.append(bAdd,bEdit,bDel);
        header.append(chev,title,act);
        const subs = document.createElement('div'); subs.className='subtopics' + (isCollapsed? ' hidden':'');
        topic.subtopics.forEach(st => {
          const row = document.createElement('div'); row.className='sub-row';
          const btn = document.createElement('button'); btn.className='btn subtopic-btn'; btn.textContent = '‚Ä¢ '+st.name; btn.dataset.sid = st.id; btn.dataset.tid = topic.id; if(store.data.settings.selectedSubtopicId===st.id) btn.classList.add('active');
          const edit = document.createElement('button'); edit.className='btn small ghost'; edit.textContent='S·ª≠a';
          const del = document.createElement('button'); del.className='btn small danger'; del.textContent='X√≥a';
          row.append(btn, edit, del);
          subs.appendChild(row);
          btn.addEventListener('click', ()=> selectSubtopic(topic.id, st.id));
          edit.addEventListener('click', ()=> showInputModal('ƒê·ªïi t√™n Subtopic', (newName) => { if(!newName) return; st.name=newName; store.save(); renderAll(); }, st.name));
          del.addEventListener('click', ()=> showConfirmModal('X√°c nh·∫≠n x√≥a', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Subtopic "${st.name}"? M·ªçi d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã m·∫•t.`, (ok) => { if(!ok) return; topic.subtopics = topic.subtopics.filter(x=>x.id!==st.id); const set=store.data.settings; if(set.selectedSubtopicId===st.id){ set.selectedSubtopicId=''; set.selectedTopicId=''; ensureValidSelection(); } store.save(); renderAll(); }));
        });
        chev.addEventListener('click', ()=>{ if(isCollapsed){ delete collapsedMap[topic.id]; } else { collapsedMap[topic.id] = true; } store.data.settings.collapsedTopics = collapsedMap; store.save(); renderTopics(); });
        bAdd.addEventListener('click', ()=> showInputModal('T√™n Subtopic m·ªõi?', (name) => { if(!name) return; topic.subtopics.push({ id: uid('s'), name, tasks: [], generalNotes: [], chatHistory: [], learningMethods: [], stats:{ totalMinutes:0, sessionsCompleted:0, tasksCompleted: 0 }, sessions: [], timerState: { state: 'idle', remaining: 0, segmentTotal: 0, cycleIndex: 0 } }); store.save(); renderTopics(); }));
        bEdit.addEventListener('click', ()=> showInputModal('ƒê·ªïi t√™n Topic', (newName) => { if(!newName) return; topic.name=newName; store.save(); renderTopics(); }, topic.name));
        bDel.addEventListener('click', ()=> showConfirmModal('X√°c nh·∫≠n x√≥a', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Topic "${topic.name}"? M·ªçi subtopic v√† d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã m·∫•t.`, (ok) => { if(!ok) return; store.data.topics = store.data.topics.filter(t=>t.id!==topic.id); delete collapsedMap[topic.id]; if(store.data.settings.selectedTopicId===topic.id){ store.data.settings.selectedTopicId=''; store.data.settings.selectedSubtopicId=''; ensureValidSelection(); } store.save(); renderAll(); }));
        box.append(header, subs);
        wrap.appendChild(box);
      });
    }

    function selectSubtopic(topicId, subId) {
        const mainEl = $('.app-content');
        const oldSubtopic = getCurrentSubtopic();

        if (oldSubtopic && timer.state !== 'idle') {
            oldSubtopic.timerState = {
                state: timer.state,
                remaining: timer.remaining,
                segmentTotal: timer.segmentTotal,
                cycleIndex: timer.cycleIndex
            };
        }

        mainEl.classList.add('reloading');

        setTimeout(() => {
            store.data.settings.selectedTopicId = topicId;
            store.data.settings.selectedSubtopicId = subId;

            const newSubtopic = getCurrentSubtopic();

            if (newSubtopic.timerState) {
                timer.state = newSubtopic.timerState.state;
                timer.remaining = newSubtopic.timerState.remaining;
                timer.segmentTotal = newSubtopic.timerState.segmentTotal;
                timer.cycleIndex = newSubtopic.timerState.cycleIndex;
            } else {
                timer.reset();
            }

            store.save();
            timer.updateUI();
            renderAll();
            switchView('timer'); // Quay v·ªÅ m√†n h√¨nh timer sau khi ch·ªçn
            mainEl.classList.remove('reloading');
        }, 200);
    }
    function getCurrentSubtopic(){ const tid=store.data.settings.selectedTopicId, sid=store.data.settings.selectedSubtopicId; if(!tid||!sid) return null; const t=store.data.topics.find(x=>x.id===tid); if(!t) return null; return t.subtopics.find(x=>x.id===sid) || null; }
    function renderContextBadge(){ const s=getCurrentSubtopic(); const name = s ? s.name : '(ch∆∞a ch·ªçn)'; $('#selectedContext').textContent = s? `Subtopic: ${s.name}`:'Ch∆∞a ch·ªçn Subtopic'; $('#currentSubtopicName').textContent = name; $('#currentSubtopicNameChat').textContent = name; }

    // =============================
    // Timer & Session To-Do List
    // =============================
    function renderSubtopicTasks() {
        const s = getCurrentSubtopic();
        const listEl = $('#subtopicTasksList');
        const addArea = $('#newSubtopicTaskInput').parentElement;
        if (!s) {
            listEl.innerHTML = '<li class="tiny" style="opacity: 0.7;">Ch·ªçn subtopic ƒë·ªÉ xem to-do list.</li>';
            addArea.classList.add('hidden'); return;
        }
        addArea.classList.remove('hidden');
        listEl.innerHTML = '';
        const uncompletedTasks = s.tasks ? s.tasks.filter(t => !t.isCompleted) : [];

        if (uncompletedTasks.length === 0) {
            listEl.innerHTML = '<li class="tiny" style="opacity: 0.7;">Tuy·ªát v·ªùi! Kh√¥ng c√≤n task n√†o.</li>';
        }
        uncompletedTasks.forEach(task => {
            const item = document.createElement('li');
            item.innerHTML = `<input type="checkbox" id="${task.id}" title="Ho√†n th√†nh task"> <label for="${task.id}">${escapeHTML(task.text)}</label>`;
            item.querySelector('input').addEventListener('change', (e) => toggleSubtopicTask(e.target.id, item));
            listEl.appendChild(item);
        });
    }

    function addSubtopicTask() {
        const s = getCurrentSubtopic();
        if (!s) { toast("Vui l√≤ng ch·ªçn subtopic tr∆∞·ªõc."); return; }
        const input = $('#newSubtopicTaskInput');
        const text = input.value.trim();
        if (text) {
            if (!s.tasks) s.tasks = [];
            s.tasks.push({ id: uid('task'), text, isCompleted: false, createdAt: todayISO() });
            store.save();
            renderSubtopicTasks();
            input.value = '';
        }
        input.focus();
    }

    function toggleSubtopicTask(taskId, listItemElement) {
        const s = getCurrentSubtopic();
        if (!s || !s.tasks) return;
        const task = s.tasks.find(t => t.id === taskId);
        if (task) {
            task.isCompleted = true;
            s.stats.tasksCompleted = (s.stats.tasksCompleted || 0) + 1;
            store.save();

            listItemElement.classList.add('removing');
            setTimeout(() => {
                renderSubtopicTasks();
                renderStatsHistory();
            }, 200);
        }
    }


    const timer = {
      state:'idle', prevState:null, interval:null, endAt:null,
      remaining:0, segmentTotal:0, cyclesTarget:4, cycleIndex:0, mode:'A',
      setPreset(p, {silent=false}={}){
        const st=store.data.settings;
        if(p==='2x50'){ this.mode='B'; this.cyclesTarget=2; }
        if(p==='4x25'){ this.mode='A'; this.cyclesTarget=4; }
        if(p==='4x50'){ this.mode='B'; this.cyclesTarget=4; }
        st.preset=p; store.save();
        if (this.state === 'idle') {
            this.reset();
        }
      },
      currentDurations(){ const d=store.data.settings.durations; return this.mode==='A'? {work:d.A_work, short:d.A_short, long:d.A_long} : {work:d.B_work, short:d.B_short, long:d.B_long}; },
      updateUI() {
          const badge = $('#stateBadge');
          const progressCircle = $('.timer-circle-progress');
          const container = $('.timer-circle-container');
          
          $('#btnStart').classList.toggle('hidden', this.state !== 'idle' && this.state !== 'paused');
          $('#btnPause').classList.toggle('hidden', !['work', 'break', 'long_break'].includes(this.state));
          $('#btnResume').classList.toggle('hidden', this.state !== 'paused');

          let currentColor = 'var(--muted)';
          if (this.state === 'work') {
              badge.textContent = 'WORK'; badge.className = 'badge state work';
              currentColor = 'var(--acc)';
          } else if (this.state === 'break') {
              badge.textContent = 'BREAK'; badge.className = 'badge state break';
              currentColor = 'var(--warn)';
          } else if (this.state === 'long_break') {
              badge.textContent = 'LONG BREAK'; badge.className = 'badge state long';
              currentColor = 'var(--danger)';
          } else if (this.state === 'paused') {
              badge.textContent = 'PAUSED';
              badge.className = 'badge';
          } else {
              badge.textContent = 'READY';
              badge.className = 'badge';
          }

          if (this.state === 'work' || this.state === 'break' || this.state === 'long_break') {
              container.classList.add('breathing');
          } else {
              container.classList.remove('breathing');
          }

          progressCircle.style.stroke = currentColor;
          container.classList.remove('finished');

          $('#timeDisplay').textContent = formatMMSS(this.remaining);

          const radius = progressCircle.r.baseVal.value;
          const circumference = 2 * Math.PI * radius;
          const offset = circumference - (this.remaining / this.segmentTotal) * circumference;

          progressCircle.style.strokeDasharray = circumference;

          if (this.segmentTotal === 0 || isNaN(offset)) {
              progressCircle.style.strokeDashoffset = circumference;
          } else {
              progressCircle.style.strokeDashoffset = offset;
          }

          $('#cycleInfo').textContent = `Chu k·ª≥: ${this.cycleIndex} / ${this.cyclesTarget}`;
      },
      start(){ if(!getCurrentSubtopic()){ toast('H√£y ch·ªçn m·ªôt Subtopic tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu'); return; } ensureAudio(); if(this.state==='idle'){ this.cycleIndex = this.cycleIndex || 0; this.beginWork(); } else if(this.state==='paused'){ this.resume(); } },
      beginWork(){ const {work}=this.currentDurations(); this.state='work'; if(this.cycleIndex===0) this.cycleIndex=1; this.remaining=work*60; this.segmentTotal=this.remaining; this.tickStart(); },
      beginBreak(){ const {short,long}=this.currentDurations(); const interval=store.data.settings.longBreakInterval; const isLong=(this.cycleIndex % interval===0) && (this.cyclesTarget>=interval); if(isLong){ this.state='long_break'; this.remaining=long*60; } else { this.state='break'; this.remaining=short*60; } this.segmentTotal=this.remaining; this.tickStart(); },
      tickStart(){ clearInterval(this.interval); this.endAt = Date.now() + this.remaining*1000; this.updateUI(); this.interval=setInterval(()=>{ const now=Date.now(); this.remaining = Math.max(0, Math.ceil((this.endAt - now)/1000)); this.updateUI(); if(this.remaining<=0){ clearInterval(this.interval); this.interval=null; this.segmentFinished(); } }, 250); },
      pause(){ if(this.interval){ clearInterval(this.interval); this.interval=null; this.prevState=this.state; this.state='paused'; this.updateUI(); } },
      resume(){ if(this.state==='paused'){ this.state = this.prevState || 'work'; this.endAt = Date.now() + this.remaining*1000; this.tickStart(); } },
      skip(){ if(this.state==='idle') return; if(this.state==='paused' && this.prevState){ this.state = this.prevState; } clearInterval(this.interval); this.interval=null; this.segmentFinished(true); },
      reset() {
          clearInterval(this.interval);
          this.interval = null;
          this.state = 'idle';
          this.prevState = null;
          this.remaining = 0;
          this.segmentTotal = 0;
          this.cycleIndex = 0;
          this.updateUI();

          const currentSubtopic = getCurrentSubtopic();
          if (currentSubtopic) {
              currentSubtopic.timerState = { state: 'idle', remaining: 0, segmentTotal: 0, cycleIndex: 0 };
              store.save();
          }
      },
      segmentFinished(skipped=false){
        const lastState = this.state;
        $('.timer-circle-container').classList.add('finished');
        if(lastState==='work' && !skipped) playSound('work_end');
        if(lastState==='break') playSound('break_end');
        if(lastState==='long_break') playSound('long_end');

        if(lastState==='work' && !skipped){
            const s=getCurrentSubtopic();
            if(s){
                const {work}=this.currentDurations();
                const entry={ id:uid('sess'), dateISO:todayISO(), mode:this.mode, workMinutes:work, note:'', durationMinutes:work };
                s.sessions.unshift(entry);
                s.stats.sessionsCompleted = (s.stats.sessionsCompleted || 0) + 1;
                s.stats.totalMinutes = (s.stats.totalMinutes || 0) + work;
                store.save();
                openNoteModal(entry.id);
                renderStatsHistory();
            }
        }

        if(lastState==='work'){
          const interval = store.data.settings.longBreakInterval;
          const shouldLong = (this.cycleIndex % interval === 0) && (this.cyclesTarget >= interval);
          if(this.cycleIndex >= this.cyclesTarget){
            if(shouldLong){ this.beginBreak(); if(!store.data.settings.autoStartNext) this.pause(); return; }
            this.state='idle'; this.remaining=0; this.segmentTotal=0; this.updateUI(); toast('üéâ Ho√†n th√†nh ch∆∞∆°ng tr√¨nh preset!'); return;
          }
          this.beginBreak(); if(!store.data.settings.autoStartNext){ this.pause(); } return;
        }
        if(lastState==='break' || lastState==='long_break'){
          if(this.cycleIndex >= this.cyclesTarget){ this.state='idle'; this.remaining=0; this.segmentTotal=0; this.updateUI(); toast('üéØ K·∫øt th√∫c ch∆∞∆°ng tr√¨nh'); return; }
          this.cycleIndex += 1;
          this.beginWork(); if(!store.data.settings.autoStartNext){ this.pause(); } return;
        }
        if(lastState==='paused'){ this.updateUI(); }
      }
    };

    // =============================
    // Stats/History/Notes
    // =============================
    function renderStatsHistory(){
        const s = getCurrentSubtopic();
        if(!s){
            $('#statTotal').textContent='0 ph√∫t'; $('#statSessions').textContent='0'; $('#statTasks').textContent='0';
            $('#historyList').innerHTML='<div class="tiny">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
            return;
        }
        const total=s.stats.totalMinutes||0;
        const count=s.stats.sessionsCompleted||0;
        const tasks = s.tasks ? s.tasks.filter(t => t.isCompleted).length : 0;
        s.stats.tasksCompleted = tasks;

        $('#statTotal').textContent= formatDaysHoursMinutes(total);
        $('#statSessions').textContent = count;
        $('#statTasks').textContent = tasks;
        const list=$('#historyList'); list.innerHTML='';
        if(s.sessions.length===0){ list.innerHTML='<div class="tiny">Ch∆∞a c√≥ phi√™n n√†o</div>'; }
        s.sessions.forEach(sess=>{
            const row=document.createElement('div'); row.className='hist-item';
            const content = document.createElement('div');
            const date=new Date(sess.dateISO);
            content.innerHTML=`<div class="hist-meta">${date.toLocaleString()} ‚Ä¢ ${sess.durationMinutes}‚Ä≤ ‚Ä¢ Mode ${sess.mode}</div><div>${sess.note? escapeHTML(sess.note):'<span class="tiny">(ch∆∞a c√≥ ghi ch√∫)</span>'}</div>`;

            const right=document.createElement('div');
            const b=document.createElement('button'); b.className='btn small ghost'; b.textContent='‚úé Ghi ch√∫';
            b.addEventListener('click', ()=> editNoteForSession(sess.id));
            right.appendChild(b);
            row.append(content, right);
            list.appendChild(row);
        });
    }

    let pendingNoteSessionId=null; function openNoteModal(sessionId){ pendingNoteSessionId=sessionId; $('#noteText').value=''; $('#modalNote').classList.add('show'); } function closeNoteModal(){ pendingNoteSessionId=null; $('#modalNote').classList.remove('show'); } function editNoteForSession(sessionId){ pendingNoteSessionId=sessionId; const s=getCurrentSubtopic(); if(!s) return; const sess=s.sessions.find(x=>x.id===sessionId); $('#noteText').value=(sess&&sess.note)||''; $('#modalNote').classList.add('show'); }

    function renderGeneralNotes() {
        const s = getCurrentSubtopic();
        const listEl = $('#generalNotesList');
        const addArea = $('.add-note-area');
        if (!s) { listEl.innerHTML = '<div class="tiny">Vui l√≤ng ch·ªçn m·ªôt subtopic ƒë·ªÉ xem ghi ch√∫.</div>'; addArea.classList.add('hidden'); return; }
        addArea.classList.remove('hidden'); listEl.innerHTML = '';
        if (!s.generalNotes || s.generalNotes.length === 0) { listEl.innerHTML = '<div class="tiny">Ch∆∞a c√≥ ghi ch√∫ chung n√†o.</div>'; return; }
        s.generalNotes.forEach(note => {
            const item = document.createElement('div'); item.className = 'note-item';
            const contentWrapper = document.createElement('div'); contentWrapper.className = 'note-content-wrapper';
            const noteContent = document.createElement('div'); noteContent.className = 'note-content'; noteContent.textContent = note.content;
            const noteMeta = document.createElement('div'); noteMeta.className = 'note-meta'; noteMeta.textContent = new Date(note.createdAt).toLocaleString();
            contentWrapper.append(noteContent, noteMeta);

            const deleteBtn = document.createElement('button'); deleteBtn.className = 'btn small danger'; deleteBtn.textContent = 'X√≥a';
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteGeneralNote(note.id); };

            item.append(contentWrapper, deleteBtn);
            item.addEventListener('click', () => noteContent.classList.toggle('expanded'));
            listEl.appendChild(item);
        });
    }

    function addGeneralNote() {
        const s = getCurrentSubtopic();
        if (!s) { toast("Vui l√≤ng ch·ªçn m·ªôt subtopic tr∆∞·ªõc."); return; }
        const textInput = $('#newGeneralNoteText');
        const content = textInput.value.trim();
        if (!content) { toast("N·ªôi dung ghi ch√∫ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng."); return; }
        if (!s.generalNotes) s.generalNotes = [];
        s.generalNotes.unshift({ id: uid('note'), content, createdAt: todayISO() });
        store.save(); renderGeneralNotes(); textInput.value = ''; toast("ƒê√£ th√™m ghi ch√∫.");
    }

    function deleteGeneralNote(noteId) {
        showConfirmModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ghi ch√∫ n√†y?', (ok) => {
            if (!ok) return;
            const s = getCurrentSubtopic();
            if (!s || !s.generalNotes) return;
            s.generalNotes = s.generalNotes.filter(note => note.id !== noteId);
            store.save(); renderGeneralNotes(); toast("ƒê√£ x√≥a ghi ch√∫.");
        });
    }

    // =============================
    // Settings & Customization
    // =============================
    function openSettings(){
        const s = store.data.settings;
        $('#set_apiKey').value = s.apiKey || '';
        const d=s.durations;
        $('#set_A_work').value=d.A_work; $('#set_A_short').value=d.A_short; $('#set_A_long').value=d.A_long;
        $('#set_B_work').value=d.B_work; $('#set_B_short').value=d.B_short; $('#set_B_long').value=d.B_long;
        $('#set_interval').value=s.longBreakInterval;
        $('#set_volume').value=s.volume ?? 0.8;
        $('#set_theme').value=s.soundTheme || 'beep';
        $('#set_theme_color').value = s.theme || 'default';
        $('#set_youtubeUrl').value = s.youtubeUrl || '';
        $('#ytSoundVolume').value = s.youtubeVolume || 80;
        $('#set_ytThumbAsBg').checked = !!s.useYtThumbnailAsBg;
        $('#set_panelOpacity').value = s.panelOpacity || 0.85;
        $('#modalSettings').classList.add('show');
    }

    function closeSettings(){ $('#modalSettings').classList.remove('show'); }
    function setDefaults(){ store.data.settings.durations={A_work:25,A_short:5,A_long:15,B_work:50,B_short:10,B_long:30}; store.data.settings.longBreakInterval=4; store.data.settings.volume=0.8; store.data.settings.soundTheme='beep'; store.save(); openSettings(); toast('ƒê√£ kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh'); }
    function saveSettings(){
        const s = store.data.settings;
        s.apiKey = $('#set_apiKey').value.trim();
        const d=s.durations;
        d.A_work=clampInt($('#set_A_work').value,1,999); d.A_short=clampInt($('#set_A_short').value,1,999); d.A_long=clampInt($('#set_A_long').value,1,999);
        d.B_work=clampInt($('#set_B_work').value,1,999); d.B_short=clampInt($('#set_B_short').value,1,999); d.B_long=clampInt($('#set_B_long').value,1,999);
        s.longBreakInterval=clampInt($('#set_interval').value,2,12);
        s.volume = clampFloat($('#set_volume').value,0,1,0.8);
        s.soundTheme = $('#set_theme').value==='chime' ? 'chime':'beep';
        s.theme = $('#set_theme_color').value;
        s.panelOpacity = parseFloat($('#set_panelOpacity').value) || 0.85;

        const newYtUrl = $('#set_youtubeUrl').value.trim();
        s.useYtThumbnailAsBg = $('#set_ytThumbAsBg').checked;
        if (newYtUrl !== s.youtubeUrl) {
            s.youtubeUrl = newYtUrl;
            updateYouTubePlayer();
        }
        s.youtubeVolume = parseInt($('#ytSoundVolume').value, 10);
        if (ytPlayer && ytPlayer.setVolume) {
            ytPlayer.setVolume(s.youtubeVolume);
        }

        store.save();
        applyTheme();
        applyPanelOpacity();

        closeSettings();
        toast('ƒê√£ l∆∞u c√†i ƒë·∫∑t');
    }
    function clampInt(v,min,max){ v=parseInt(v||0,10); if(isNaN(v)) v=min; return Math.max(min, Math.min(max, v)); }
    function clampFloat(v,min,max,def){ v=parseFloat(v); if(Number.isNaN(v)) v=def; return Math.max(min, Math.min(max, v)); }

    function handleFileUpload(file, callback) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => callback(e.target.result);
        reader.onerror = () => toast("L·ªói ƒë·ªçc file.");
        reader.readAsDataURL(file);
    }
    function applyCustomBg() { document.body.style.setProperty('--bg-image', store.data.settings.customBg ? `url(${store.data.settings.customBg})` : ''); }
    function applyPanelOpacity() { document.documentElement.style.setProperty('--panel-opacity', store.data.settings.panelOpacity); }

    // =============================
    // Dashboard
    // =============================
    function renderDashboard(){
        const data = store.data.topics.flatMap(t => t.subtopics.map(s => ({ topic: t.name, subtopic: s.name, m: s.stats.totalMinutes || 0, c: s.stats.sessionsCompleted || 0, t: s.stats.tasksCompleted || 0 })));
        const totalM = data.reduce((a, b) => a + b.m, 0);
        const totalC = data.reduce((a, b) => a + b.c, 0);
        const totalT = data.reduce((a, b) => a + b.t, 0);

        let tableHTML = `<p class="tiny"><strong>T·ªïng th·ªùi gian:</strong> ${formatDaysHoursMinutes(totalM)} | <strong>T·ªïng sessions:</strong> ${totalC} | <strong>T·ªïng tasks:</strong> ${totalT}</p>
        <table class="dashboard-table">
            <thead><tr><th>Topic</th><th>Subtopic</th><th>Th·ªùi gian</th><th>Sessions</th><th>Tasks</th></tr></thead>
            <tbody>`;

        data.forEach(item => {
            tableHTML += `<tr><td>${escapeHTML(item.topic)}</td><td>${escapeHTML(item.subtopic)}</td><td>${formatDaysHoursMinutes(item.m)}</td><td>${item.c}</td><td>${item.t}</td></tr>`;
        });

        tableHTML += '</tbody></table>';
        $('#dashboardContent').innerHTML = tableHTML;
    }

    // =============================
    // Gemini & Other Feature Handlers
    // =============================
    async function handleSendMessage() {
        const btn = $('#btnSendMessage');
        const input = $('#chatInput');
        const query = input.value.trim();
        const subtopic = getCurrentSubtopic();

        if (!query) return;
        if (!subtopic) { toast("Vui l√≤ng ch·ªçn m·ªôt subtopic."); return; }

        input.value = '';
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div>';

        subtopic.chatHistory.push({ role: 'user', text: query });
        renderChat();

        const response = await callGeminiAPI(query);
        if (response) {
            subtopic.chatHistory.push({ role: 'model', text: response });
            store.save();
            renderChat();
        }

        btn.disabled = false;
        btn.innerHTML = 'G·ª≠i';
    }

    function renderChat() {
        const s = getCurrentSubtopic();
        const messagesEl = $('#chatMessages');
        const chatInput = $('#chatInput');
        const sendBtn = $('#btnSendMessage');

        if (!s) {
            messagesEl.innerHTML = '<div class="tiny">Ch·ªçn subtopic ƒë·ªÉ b·∫Øt ƒë·∫ßu chat.</div>';
            chatInput.disabled = true; sendBtn.disabled = true;
            return;
        }

        chatInput.disabled = false; sendBtn.disabled = false;
        messagesEl.innerHTML = '';
        if (!s.chatHistory || s.chatHistory.length === 0) {
            messagesEl.innerHTML = '<div class="tiny">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</div>';
            return;
        }
        s.chatHistory.forEach(msg => {
            const msgEl = document.createElement('div');
            msgEl.className = `chat-msg ${msg.role}`;
            msgEl.textContent = msg.text;
            messagesEl.appendChild(msgEl);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function handleSummarizeNote() {
        const btn = $('#btnSummarizeNote');
        const noteTextEl = $('#noteText');
        const noteText = noteTextEl.value.trim();
        const subtopic = getCurrentSubtopic();

        if (!noteText) { toast("Vui l√≤ng nh·∫≠p ghi ch√∫ tr∆∞·ªõc khi t√≥m t·∫Øt."); return; }

        const originalContent = btn.innerHTML;
        btn.innerHTML = '<div class="spinner"></div>'; btn.disabled = true;
        const prompt = `D·ª±a v√†o th√¥ng tin sau:\n- Ch·ªß ƒë·ªÅ: "${subtopic?.name || 'kh√¥ng r√µ'}"\n- Ghi ch√∫ c·ªßa ng∆∞·ªùi d√πng sau m·ªôt phi√™n l√†m vi·ªác: "${noteText}"\n\nH√£y t·∫°o m·ªôt b·∫£n t√≥m t·∫Øt ng·∫Øn g·ªçn v·ªÅ nh·ªØng g√¨ ƒë√£ l√†m v√† ƒë·ªÅ xu·∫•t m·ªôt b∆∞·ªõc h·ª£p l√Ω ti·∫øp theo. ƒê·ªãnh d·∫°ng c√¢u tr·∫£ l·ªùi nh∆∞ sau:\n\n---\n**‚ú® T√≥m t·∫Øt AI:**\n[T√≥m t·∫Øt ·ªü ƒë√¢y]\n\n**üöÄ G·ª£i √Ω ti·∫øp theo:**\n[G·ª£i √Ω ·ªü ƒë√¢y]`;
        const result = await callGeminiAPI(prompt);
        if (result) {
            noteTextEl.value += `\n\n${result}`;
        }
        btn.innerHTML = originalContent; btn.disabled = false;
    }

    function renderLearningMethods() {
        const s = getCurrentSubtopic();
        const listEl = $('#learningMethodsList');
        const addArea = $('#newMethodNameInput').parentElement;
        if (!s) {
            listEl.innerHTML = '<li class="tiny">Ch·ªçn subtopic ƒë·ªÉ xem c√°c ph∆∞∆°ng ph√°p h·ªçc.</li>';
            addArea.classList.add('hidden'); return;
        }
        addArea.classList.remove('hidden');
        listEl.innerHTML = '';
        if (!s.learningMethods || s.learningMethods.length === 0) {
            listEl.innerHTML = '<li class="tiny">Ch∆∞a c√≥ ph∆∞∆°ng ph√°p n√†o. H√£y th√™m m·ªôt ph∆∞∆°ng ph√°p m·ªõi.</li>';
            return;
        }

        s.learningMethods.forEach(method => {
            const item = document.createElement('li');
            item.className = 'method-item';
            const conceptHTML = method.concept ? `<div class="concept hidden">${escapeHTML(method.concept)}</div>` : '';

            item.innerHTML = `
                <input type="checkbox" id="${method.id}" ${method.completed ? 'checked' : ''}>
                <div class="content-wrapper">
                    <label for="${method.id}" class="${method.completed ? 'completed' : ''}">${escapeHTML(method.text)}</label>
                    ${conceptHTML}
                </div>
                <button class="btn small danger" data-method-id="${method.id}">X√≥a</button>
            `;

            item.querySelector('.content-wrapper').addEventListener('click', (e) => {
                if (e.target.tagName !== 'INPUT') {
                    const conceptEl = item.querySelector('.concept');
                    if (conceptEl) conceptEl.classList.toggle('hidden');
                }
            });

            item.querySelector('input[type="checkbox"]').addEventListener('change', () => toggleMethod(method.id));
            item.querySelector('.btn.danger').addEventListener('click', () => deleteMethod(method.id));

            listEl.appendChild(item);
        });
    }

    function addMethod() {
        const s = getCurrentSubtopic();
        if (!s) { toast("Vui l√≤ng ch·ªçn subtopic."); return; }
        const nameInput = $('#newMethodNameInput');
        const conceptInput = $('#newMethodConceptInput');
        const name = nameInput.value.trim();
        const concept = conceptInput.value.trim();

        if (!name) { toast("T√™n ph∆∞∆°ng ph√°p kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng."); return; }
        if (!s.learningMethods) s.learningMethods = [];

        s.learningMethods.push({ id: uid('m'), text: name, concept: concept, completed: false });
        store.save();
        renderLearningMethods();
        nameInput.value = '';
        conceptInput.value = '';
    }

    function deleteMethod(methodId) {
        const s = getCurrentSubtopic();
        if (!s) return;

        showConfirmModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph∆∞∆°ng ph√°p n√†y?', (ok) => {
            if (ok) {
                s.learningMethods = s.learningMethods.filter(m => m.id !== methodId);
                store.save();
                renderLearningMethods();
                toast('ƒê√£ x√≥a ph∆∞∆°ng ph√°p.');
            }
        });
    }

    function toggleMethod(methodId) {
        const s = getCurrentSubtopic();
        if (!s) return;
        const method = s.learningMethods.find(m => m.id === methodId);
        if (method) {
            method.completed = !method.completed;
            store.save();
            renderLearningMethods();
        }
    }

    function clearChat() {
        const s = getCurrentSubtopic();
        if (!s) { toast("Vui l√≤ng ch·ªçn subtopic."); return; }
        showConfirmModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ chat c·ªßa subtopic n√†y?', (ok) => {
            if (ok) {
                s.chatHistory = [];
                store.save();
                renderChat();
                toast("ƒê√£ x√≥a l·ªãch s·ª≠ chat.");
            }
        });
    }

    // =============================
    // Socratic Questions
    // =============================
    const socraticQuestions = [
        { title: '1. C√¢u h·ªèi l√†m r√µ', content: `"B·∫°n c√≥ th·ªÉ n√≥i r√µ h∆°n v·ªÅ ƒëi·ªÅu ƒë√≥ kh√¥ng?"\n"B·∫°n c√≥ th·ªÉ cho m·ªôt v√≠ d·ª• c·ª• th·ªÉ v·ªÅ ƒëi·ªÅu ƒë√≥ ƒë∆∞·ª£c kh√¥ng?"\n"√ù c·ªßa b·∫°n khi n√≥i '...' l√† g√¨?"\n"T·∫°i sao b·∫°n nghƒ© ƒëi·ªÅu n√†y l·∫°i quan tr·ªçng?"` },
        { title: '2. C√¢u h·ªèi thƒÉm d√≤ gi·∫£ ƒë·ªãnh', content: `"B·∫°n ƒëang gi·∫£ ƒë·ªãnh ƒëi·ªÅu g√¨ khi n√≥i '...'?"\n"L√†m th·∫ø n√†o b·∫°n c√≥ th·ªÉ ki·ªÉm ch·ª©ng gi·∫£ ƒë·ªãnh ƒë√≥?"\n"Gi·∫£ s·ª≠ '...' kh√¥ng ƒë√∫ng, th√¨ ƒëi·ªÅu g√¨ s·∫Ω x·∫£y ra?"` },
        { title: '3. C√¢u h·ªèi thƒÉm d√≤ l√Ω do v√† b·∫±ng ch·ª©ng', content: `"L√†m th·∫ø n√†o b·∫°n bi·∫øt ƒëi·ªÅu ƒë√≥ l√† ƒë√∫ng?"\n"B·∫°n c√≥ b·∫±ng ch·ª©ng n√†o ƒë·ªÉ ·ªßng h·ªô quan ƒëi·ªÉm n√†y kh√¥ng?"\n"T·∫°i sao b·∫°n l·∫°i tin r·∫±ng ƒëi·ªÅu ƒë√≥ ƒë√∫ng?"\n"ƒêi·ªÅu g√¨ s·∫Ω thay ƒë·ªïi suy nghƒ© c·ªßa b·∫°n?"` },
        { title: '4. C√¢u h·ªèi v·ªÅ quan ƒëi·ªÉm v√† g√≥c nh√¨n', content: `"ƒêi·ªÅu n√†y c√≥ √Ω nghƒ©a nh∆∞ th·∫ø n√†o ƒë·ªëi v·ªõi ng∆∞·ªùi kh√°c?"\n"C√≥ ai c√≥ th·ªÉ nh√¨n v·∫•n ƒë·ªÅ n√†y theo c√°ch kh√°c kh√¥ng?"\n"B·∫°n s·∫Ω ph·∫£n ·ª©ng th·∫ø n√†o n·∫øu ·ªü v·ªã tr√≠ c·ªßa ng∆∞·ªùi ƒë√≥?"` },
        { title: '5. C√¢u h·ªèi suy lu·∫≠n v√† h·ªá qu·∫£', content: `"H·∫≠u qu·∫£ c·ªßa vi·ªác n√†y s·∫Ω l√† g√¨?"\n"N·∫øu b·∫°n l√†m ƒëi·ªÅu ƒë√≥, chuy·ªán g√¨ s·∫Ω x·∫£y ra ti·∫øp theo?"\n"L√†m th·∫ø n√†o b·∫°n c√≥ th·ªÉ √°p d·ª•ng ƒëi·ªÅu n√†y v√†o m·ªôt t√¨nh hu·ªëng kh√°c?"` },
        { title: '6. C√¢u h·ªèi v·ªÅ si√™u nh·∫≠n th·ª©c (Metacognitive)', content: `"B·∫°n ƒë√£ ƒë·∫°t ƒë∆∞·ª£c k·∫øt lu·∫≠n n√†y nh∆∞ th·∫ø n√†o?"\n"B·∫°n c·∫£m th·∫•y qu√° tr√¨nh suy nghƒ© c·ªßa m√¨nh di·ªÖn ra nh∆∞ th·∫ø n√†o?"\n"Khi n√†o b·∫°n nghƒ© r·∫±ng b·∫°n n√™n c√¢n nh·∫Øc l·∫°i quan ƒëi·ªÉm c·ªßa m√¨nh?"` }
    ];

    function renderSocraticQuestions() {
        const listEl = $('#socraticMethodsList');
        listEl.innerHTML = '';
        socraticQuestions.forEach(q => {
            const item = document.createElement('details');
            item.className = 'topic-item';
            item.style.padding = '12px';
            item.innerHTML = `
                <summary style="font-weight: 600; cursor: pointer;">${q.title}</summary>
                <div class="concept" style="margin-top: 10px; border: none; padding: 0; white-space: pre-wrap;">${escapeHTML(q.content)}</div>
            `;
            listEl.appendChild(item);
        });
    }


    // =============================
    // YouTube Player
    // =============================
    let ytPlayer;
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('youtube-player-container', {
            height: '0',
            width: '0',
            playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1 },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        updateYouTubePlayer();
    }

    function onPlayerStateChange(event) {
        const btn = $('#btnToggleYtSound');
        if (event.data == YT.PlayerState.PLAYING) {
            btn.textContent = '‚è∏Ô∏è';
        } else {
            btn.textContent = '‚ñ∂Ô∏è';
        }
        if (event.data === YT.PlayerState.ENDED) {
            ytPlayer.playVideo();
        }
    }

    function updateYouTubePlayer() {
        if (!ytPlayer || !ytPlayer.loadVideoById) return;
        const videoId = extractYouTubeID(store.data.settings.youtubeUrl);

        if (store.data.settings.useYtThumbnailAsBg) {
            if (videoId) {
                const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                const img = new Image();
                img.onload = () => {
                    store.data.settings.customBg = thumbUrl;
                    store.save();
                    applyCustomBg();
                };
                img.onerror = () => {
                    const fallbackUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                    store.data.settings.customBg = fallbackUrl;
                    store.save();
                    applyCustomBg();
                }
                img.src = thumbUrl;
            } else {
                store.data.settings.customBg = '';
                store.save();
                applyCustomBg();
            }
        }

        if (videoId) {
            ytPlayer.loadVideoById(videoId);
            ytPlayer.setVolume(store.data.settings.youtubeVolume);
        } else {
            ytPlayer.stopVideo();
        }
    }

    function toggleYtSound() {
        if (!ytPlayer || !ytPlayer.getPlayerState) return;
        const playerState = ytPlayer.getPlayerState();
        if (playerState === YT.PlayerState.PLAYING) {
            ytPlayer.pauseVideo();
        } else {
            ytPlayer.playVideo();
        }
    }

    // =============================
    // Bindings
    // =============================
    function bindEvents(){
      $('#btnAddTopic').addEventListener('click', () => showInputModal('T√™n Topic m·ªõi?', (name) => { if (!name) return; store.data.topics.push({ id: uid('t'), name, subtopics: [] }); store.save(); renderTopics(); }));
      $('#btnExport').addEventListener('click', ()=> store.export());
      $('#importFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) store.import(f); e.target.value=null; });
      $('#btnSettings').addEventListener('click', openSettings);
      
      $('#btnHelpCreateTopic').addEventListener('click', () => {
          switchView('topics');
          $('#btnAddTopic').click();
      });

      $('#btnDashboard').addEventListener('click', () => {
          renderDashboard(); // T·∫°o n·ªôi dung m·ªõi nh·∫•t
          $('#modalDashboard').classList.add('show'); // Hi·ªÉn th·ªã modal
      });

      $('#btnCloseSettings').addEventListener('click', closeSettings);
      $('#btnSaveSettings').addEventListener('click', saveSettings);
      $('#btnDefaults').addEventListener('click', setDefaults);
      $('#btnTestSound').addEventListener('click', ()=>{ ensureAudio(); playSound('work_end'); });

      $('#btnSaveNote').addEventListener('click', ()=>{ const s=getCurrentSubtopic(); if(!s) return; const id=pendingNoteSessionId; const sess=s.sessions.find(x=>x.id===id); if(sess){ sess.note=$('#noteText').value.trim(); store.save(); renderStatsHistory(); toast('ƒê√£ l∆∞u ghi ch√∫'); } closeNoteModal(); });
      $('#btnSkipNote').addEventListener('click', ()=> closeNoteModal());
      $('#btnAddGeneralNote').addEventListener('click', addGeneralNote);

      $('#btnSummarizeNote').addEventListener('click', handleSummarizeNote);
      $('#btnSendMessage').addEventListener('click', handleSendMessage);
      $('#chatInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSendMessage(); });
      $('#btnAddMethod').addEventListener('click', addMethod);
      $('#newMethodNameInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') addMethod(); });
      $('#newMethodConceptInput').addEventListener('keydown', (e) => { if (e.key === 'Enter' && e.ctrlKey) addMethod(); });

      $('#btnClearChat').addEventListener('click', clearChat);
      $('#btnNewChat').addEventListener('click', clearChat);
      $('#btnAddSubtopicTask').addEventListener('click', addSubtopicTask);
      $('#newSubtopicTaskInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') addSubtopicTask(); });

      $('#btnToggleYtSound').addEventListener('click', toggleYtSound);
      $('#ytSoundVolume').addEventListener('input', (e) => {
          const vol = parseInt(e.target.value, 10);
          if (ytPlayer && ytPlayer.setVolume) {
              ytPlayer.setVolume(vol);
          }
      });
      
      $$('.nav-btn[data-view]').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
      
      $$('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
              const tabId = btn.dataset.tab;
              const parent = btn.closest('.aux-panel, .modal-card');
              if (!parent) return;
              parent.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
              btn.classList.add('active');
              parent.querySelectorAll('.tab-content').forEach(c => {
                  c.classList.remove('active');
                  c.style.display = 'none';
              });
              const activeContent = parent.querySelector(`#${tabId}`);
              if(activeContent) {
                  activeContent.classList.add('active');
                  activeContent.style.display = 'block';
                  // N·∫øu l√† modal settings, c·∫ßn display: flex cho c√°c tab
                  if(parent.closest('#modalSettings')) {
                      activeContent.style.display = 'flex';
                  }
              }
          });
      });

      $$('.presets button').forEach(button => {
        button.addEventListener('click', (e) => {
          const newPreset = e.target.dataset.preset;
          timer.setPreset(newPreset);
          renderAll();
        });
      });

      $('#btnStart').addEventListener('click', ()=> timer.start());
      $('#btnPause').addEventListener('click', ()=> timer.pause());
      $('#btnResume').addEventListener('click', ()=> timer.resume());
      $('#btnSkip').addEventListener('click', ()=> timer.skip());
      $('#btnReset').addEventListener('click', ()=> timer.reset());

      $('#uploadBg').addEventListener('change', (e) => { handleFileUpload(e.target.files[0], (dataUrl) => { store.data.settings.customBg = dataUrl; store.save(); applyCustomBg(); toast("ƒê√£ c·∫≠p nh·∫≠t h√¨nh n·ªÅn."); }); e.target.value = null; });
      $('#btnClearBg').addEventListener('click', () => {
          store.data.settings.customBg = '';
          store.data.settings.useYtThumbnailAsBg = false;
          store.save();
          applyCustomBg();
          toast("ƒê√£ x√≥a h√¨nh n·ªÅn t√πy ch·ªânh.");
          if ($('#modalSettings').classList.contains('show')) {
              openSettings();
          }
      });
      $('#uploadSoundWork').addEventListener('change', (e) => { handleFileUpload(e.target.files[0], (dataUrl) => { store.data.settings.customSounds.work_end = dataUrl; store.save(); toast("ƒê√£ l∆∞u √¢m b√°o h·∫øt WORK."); }); e.target.value = null; });
      $('#uploadSoundBreak').addEventListener('change', (e) => { handleFileUpload(e.target.files[0], (dataUrl) => { store.data.settings.customSounds.break_end = dataUrl; store.save(); toast("ƒê√£ l∆∞u √¢m b√°o h·∫øt BREAK."); }); e.target.value = null; });
      $('#uploadSoundLong').addEventListener('change', (e) => { handleFileUpload(e.target.files[0], (dataUrl) => { store.data.settings.customSounds.long_end = dataUrl; store.save(); toast("ƒê√£ l∆∞u √¢m b√°o h·∫øt LONG BREAK."); }); e.target.value = null; });

      $('#btnFullscreen').addEventListener('click', toggleFullScreen);
      document.addEventListener('fullscreenchange', updateFullscreenButton);

      window.addEventListener('keydown', (e)=>{ const tag=(e.target.tagName||'').toLowerCase(); const isTyping=['input','textarea','select'].includes(tag); if(e.code==='Space' && !isTyping){ e.preventDefault(); if(timer.state==='idle'||timer.state==='paused') timer.start(); else timer.pause(); } if(e.key==='n'||e.key==='N'){ if(!isTyping){ e.preventDefault(); timer.skip(); } } if(e.key==='Escape'){ $$('.modal').forEach(m => m.classList.remove('show')); } });
      $$('.modal').forEach(m=> m.addEventListener('click', (ev)=>{ if(ev.target===m) m.classList.remove('show'); }));
    }

    function updateMainViewVisibility() {
        const hasSubtopic = !!getCurrentSubtopic();
        const timerView = $('#view-timer');

        // Hi·ªÉn th·ªã/·∫©n panel ch√†o m·ª´ng
        $('#welcomePanel').classList.toggle('hidden', hasSubtopic);

        // Th√™m/x√≥a class ƒë·ªÉ CSS c√≥ th·ªÉ ·∫©n c√°c ph·∫ßn kh√¥ng c·∫ßn thi·∫øt
        if (hasSubtopic) {
            timerView.classList.remove('no-subtopic-selected');
        } else {
            timerView.classList.add('no-subtopic-selected');
        }
    }

    function renderAll(){
        const currentPreset = store.data.settings.preset;
        $$('.presets button').forEach(button => {
          const isSelected = button.dataset.preset === currentPreset;
          button.classList.toggle('acc', isSelected);
          button.classList.toggle('ghost', !isSelected);
          button.setAttribute('aria-pressed', isSelected);
        });

        updateMainViewVisibility();

        timer.setPreset(store.data.settings.preset, {silent:true});
        renderTopics();
        renderContextBadge();
        renderStatsHistory();
        renderGeneralNotes();
        renderChat();
        renderLearningMethods();
        renderSocraticQuestions();
        applyCustomBg();
        applyPanelOpacity();
        renderSubtopicTasks();
        updateFullscreenButton();
        switchView(store.data.settings.currentView);
    }

    // =============================
    // Fullscreen Logic
    // =============================
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                toast(`L·ªói: Kh√¥ng th·ªÉ b·∫≠t ch·∫ø ƒë·ªô to√†n m√†n h√¨nh: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    function updateFullscreenButton() {
        const btn = $('#btnFullscreen');
        if (document.fullscreenElement) {
            btn.innerHTML = '‚ÜôÔ∏è';
            btn.title = 'Tho√°t to√†n m√†n h√¨nh';
        } else {
            btn.innerHTML = '‚ÜóÔ∏è';
            btn.title = 'To√†n m√†n h√¨nh';
        }
    }

    // Boot
    store.load(); bindEvents(); renderAll(); applyTheme();
    </script>
</body>
</html>