<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="á»¨ng dá»¥ng Pomodoro há»— trá»£ há»c táº­p vá»›i tÃ­ch há»£p Gemini AI vÃ  giao diá»‡n hiá»‡n Ä‘áº¡i." />
    <title>Pomodoro Study App â€” TÃ­ch há»£p Gemini AI (Giao diá»‡n má»›i)</title>
    <style>
    /*
    =============================================
    POMODORO STUDY APP Ã¢â‚¬â€ PHIÃƒÅ N BÃ¡ÂºÂ¢N GIAO DIÃ¡Â»â€ N TÃ¡ÂºÂ¬P TRUNG (v11.2)
    =============================================
    */

    :root {
      /* Theme Dark (MÃ¡ÂºÂ·c Ã„â€˜Ã¡Â»â€¹nh) - CÃ¡ÂºÂ­p nhÃ¡ÂºÂ­t tÃ¡Â»Â« file 2 */
      --bg: #0f1222;
      --panel: #171a2e;
      --panel-rgb: 23, 26, 46; /* ThÃƒÂªm biÃ¡ÂºÂ¿n RGB cho panel */
      --muted: #212646;
      --text: #f4f6ff;
      --sub: #b7c1ff;
      --acc: #6c8cff;
      --acc-2: #27d3a2;
      --warn: #ffb020;
      --danger: #ff5c7a;
      --shadow: 0px 1.8px 2.2px rgba(0, 0, 0, 0.054), 0px 4.3px 5.3px rgba(0, 0, 0, 0.077), 0px 8.1px 10px rgba(0, 0, 0, 0.095), 0px 14.5px 17.9px rgba(0, 0, 0, 0.113), 0px 27.2px 33.4px rgba(0, 0, 0, 0.136), 0px 65px 80px rgba(0, 0, 0, 0.19);
      --radius: 16px;
      --panel-opacity: 0.85;
      --gradient-border: linear-gradient(135deg, var(--acc), var(--acc-2));
    }
    
    /* === START: THÃƒÅ M CÃƒÂC THEME MÃ¡Â»Å¡I === */
    [data-theme='light'] {
      --bg: #f5f0e8; --panel: #ffffff; --panel-rgb: 255, 255, 255; --muted: #eaddcf; --text: #4a4a4a; --sub: #8a817c; --acc: #d4a373; --acc-2: #a3b18a; --warn: #e76f51; --danger: #d00000;
      --shadow: 0px 1.8px 2.2px rgba(0, 0, 0, 0.024), 0px 4.3px 5.3px rgba(0, 0, 0, 0.037), 0px 8.1px 10px rgba(0, 0, 0, 0.045), 0px 14.5px 17.9px rgba(0, 0, 0, 0.053), 0px 27.2px 33.4px rgba(0, 0, 0, 0.066), 0px 65px 80px rgba(0, 0, 0, 0.09);
      --panel-opacity: 0.9;
      /* NgÃ„Æ’n nÃ¡Â»Ân tÃ¡Â»â€˜i mÃ¡ÂºÂ·c Ã„â€˜Ã¡Â»â€¹nh khi khÃƒÂ´ng cÃƒÂ³ Ã¡ÂºÂ£nh */
      --bg-image: none;
    }

    [data-theme='pastel'] {
      --bg: #fde2e4; --panel: #fff1f2; --panel-rgb: 255, 241, 242; --muted: #fad2e1; --text: #595260; --sub: #8c7a8a; --acc: #c78283; --acc-2: #7ec4cf; --warn: #f9bf45; --danger: #d7263d;
      --shadow: 0 5px 20px rgba(200,150,150,0.2);
      --panel-opacity: 0.9;
      /* NgÃ„Æ’n nÃ¡Â»Ân tÃ¡Â»â€˜i mÃ¡ÂºÂ·c Ã„â€˜Ã¡Â»â€¹nh khi khÃƒÂ´ng cÃƒÂ³ Ã¡ÂºÂ£nh */
      --bg-image: none;
    }
    
    [data-theme='lofi'] {
      --bg: #2a2a3e; --panel: #3c3c52; --panel-rgb: 60, 60, 82; --muted: #4d4d66; --text: #e0e0ff; --sub: #a0a0c0; --acc: #ff8c69; --acc-2: #69c6ff; --warn: #ffd700; --danger: #ff6961;
      --bg-image: url('https://i.pinimg.com/originals/9f/67/74/9f67742194e8f187b5129b6183571120.gif');
      --panel-opacity: 0.8;
    }
    
    [data-theme='space'] {
        --bg: #000000; --panel: #1a1a2e; --panel-rgb: 26, 26, 46; --muted: #2a2a4e; --text: #e0e0ff; --sub: #b0b0e0; --acc: #00aaff; --acc-2: #aaff00; --warn: #ffaa00; --danger: #ff0055;
        --bg-image: url('https://i.gifer.com/origin/a2/a2322310816930a8094f8263e6a7150a_w200.gif');
        --panel-opacity: 0.75;
    }
    /* === END: THÃƒÅ M CÃƒÂC THEME MÃ¡Â»Å¡I === */

    *:focus-visible {
      outline: 2px solid var(--acc); outline-offset: 2px; border-radius: 4px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      margin:0; 
      font-family: system-ui, -apple-system, 'Segoe UI Variable', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Inter', sans-serif; 
      
      background-color: var(--bg);
      background-image: var(--bg-image, radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%));
      
      background-size: cover; 
      background-position: center; 
      color:var(--text); 
      transition: background 0.5s ease, color 0.5s ease, filter 0.5s ease;
      text-shadow: 0px 0px 5px rgba(0, 0, 0, 0.5);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    a{color:var(--acc)}

    .app{display:flex; min-height:100vh}
    
    .app-nav {
        width: 60px;
        padding: 16px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        z-index: 100;
    }
    .nav-btn {
        background: transparent;
        border: none;
        color: var(--sub);
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all .2s ease;
        position: relative;
    }
    .nav-btn:hover { background: var(--muted); color: var(--text); }
    .nav-btn.active { background: var(--acc); color: white; }
    .nav-btn svg { width: 24px; height: 24px; }
    .nav-btn .tooltip {
        position: absolute;
        left: 110%;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        box-shadow: var(--shadow);
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity .2s ease, visibility .2s ease;
        pointer-events: none;
        z-index: 200;
    }
    .nav-btn:hover .tooltip { opacity: 1; visibility: visible; }

    .app-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        max-height: 100vh;
    }

    .view { display: none; }
    .view.active { display: grid; gap: 24px; animation: fadeIn .3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .main.reloading { opacity: 0; transition: opacity 0.2s ease-out; }

    .panel-bg{
        background: rgba(23, 26, 46, var(--panel-opacity));
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border:1px solid rgba(255,255,255,.08);
    }
    /* ThÃƒÂªm cÃƒÂ¡c quy tÃ¡ÂºÂ¯c border cho theme light/pastel */
    [data-theme='light'] .panel-bg, [data-theme='pastel'] .panel-bg { border:1px solid rgba(0,0,0,0.05); }
    [data-theme='lofi'] .panel-bg { border:1px solid rgba(255,255,255,0.1); }
    [data-theme='space'] .panel-bg { border:1px solid rgba(255,255,255,0.12); }


    header.app-header{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom: 24px;}
    header .actions{display:flex; gap:8px; align-items:center}
    
    .btn {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border: none; /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i: bÃ¡Â»Â border mÃ¡ÂºÂ·c Ã„â€˜Ã¡Â»â€¹nh */
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.08);
      font-weight: 600;
      transition: all .15s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        border: 2px solid transparent; border-radius: 12px; background: var(--gradient-border) border-box;
        -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: destination-out; mask-composite: exclude; opacity: 0; transition: opacity 0.3s ease;
    }
    .btn:hover::before { opacity: 1; }
    .btn:hover { background: rgba(255, 255, 255, 0.12); }
    .btn:active { transform: translateY(1px) scale(0.98); filter: brightness(1); }
    .btn:disabled { cursor: not-allowed; filter: brightness(0.8) saturate(0.5); }
    .btn.ghost { background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); }
    .btn.ghost:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.3); }
    .btn.acc { background: var(--acc); color: white; }
    .btn.warn { background: var(--warn); color: white; }
    .btn.danger { background: var(--danger); color: white; }
    .btn.small { padding: 6px 10px; font-size: 14px; border-radius: 9px; }
    .btn.small::before { border-radius: 9px; }
    .btn > svg { width: 16px; height: 16px; stroke-width: 2.5px; }

    /* === START: CÃ¡ÂºÂ¬P NHÃ¡ÂºÂ¬T GIAO DIÃ¡Â»â€ N QUÃ¡ÂºÂ¢N LÃƒÂ CHÃ¡Â»Â¦ Ã„ÂÃ¡Â»â‚¬ === */
    #view-topics { grid-template-columns: 1fr; }
    .topic-item { background:rgba(255,255,255,.04); border:1px solid var(--muted); border-radius:12px; padding:8px; margin-bottom:8px; } /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    .topic-header, .sub-row { display:flex; align-items:center; gap:8px; position: relative; }
    .topic-title { flex:1; font-weight:600; }
    .chev { width:28px; height:28px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; flex-shrink: 0; }
    .chev .ico { display:inline-block; transition: transform .18s ease; }
    .chev[aria-expanded="false"] .ico { transform: rotate(-90deg); }
    .subtopics { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .subtopics.hidden { display:none; }
    
    .topic-actions, .sub-row .actions {
        opacity: 0;
        visibility: hidden;
        transition: opacity .2s ease, visibility .2s ease;
        display: flex;
        gap: 6px;
        align-items: center;
    }
    .topic-item:hover .topic-actions, .sub-row:hover .actions {
        opacity: 1;
        visibility: visible;
    }
    .actions-menu-btn {
        padding: 0;
        width: 28px;
        height: 28px;
        font-size: 1.2em;
        line-height: 1;
    }
    .actions-menu {
        position: absolute;
        top: 100%;
        right: 0;
        border-radius: 8px;
        padding: 6px;
        box-shadow: var(--shadow);
        z-index: 10;
        min-width: 150px;
        display: none;
        flex-direction: column;
        gap: 4px;
    }
    .actions-menu.show { display: flex; }
    .menu-item {
        background: transparent; border: none; color: var(--text);
        padding: 8px 10px; border-radius: 6px; text-align: left;
        width: 100%; cursor: pointer; transition: background .2s ease;
        display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;
    }
    .menu-item:hover { background: var(--acc); color: white; }
    .menu-item.danger:hover { background: var(--danger); }
    /* === END: CÃ¡ÂºÂ¬P NHÃ¡ÂºÂ¬T GIAO DIÃ¡Â»â€ N QUÃ¡ÂºÂ¢N LÃƒÂ CHÃ¡Â»Â¦ Ã„ÂÃ¡Â»â‚¬ === */

    .subtopic-btn{
        flex:1; 
        text-align:left;
        background-color: rgba(0,0,0,0.02); /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    }
    .subtopic-btn:hover {
        background-color: var(--muted); /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    }
    .subtopic-btn.active{
        outline:2px solid var(--acc); 
    }
    .subtopic-btn.active:hover {
        background: transparent; /* GiÃ¡Â»Â¯ nÃ¡Â»Ân trong suÃ¡Â»â€˜t khi di chuÃ¡Â»â„¢t qua */
    }
    
    .panel{border-radius:var(--radius); padding:24px; box-shadow:var(--shadow)}

    .timer-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .timer{display:grid; gap:16px; grid-template-columns: 1fr; align-items:center; text-align:center}
    .big-time{font-size: clamp(60px, 12vw, 96px); letter-spacing:1px; font-weight:700; color: var(--text)}
    .state{font-weight:700; letter-spacing:.6px}
    .state.work{color:var(--acc-2)} /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i mÃƒÂ u */
    .state.break{color:var(--warn)}
    .state.long{color:var(--danger)} /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i mÃƒÂ u */
    .controls{display:flex; flex-wrap:wrap; gap:12px; justify-content:center}    
    #btnStart { padding: 14px 28px; font-size: 1.2em; }
    #btnPause, #btnResume { padding: 12px 24px; font-size: 1.1em; }

    /* === START: TÃƒâ„¢Y CHÃ¡Â»Ë†NH DÃ¡ÂºÂ¢I PHÃƒâ€šN CÃƒÂCH MÃ¡Â»â‚¬M MÃ¡ÂºÂ I HÃ†Â N === */
    #view-timer .panel-bg hr {
        border: none; /* BÃ¡Â»Â Ã„â€˜Ã†Â°Ã¡Â»Âng viÃ¡Â»Ân mÃ¡ÂºÂ·c Ã„â€˜Ã¡Â»â€¹nh */
        height: 1px;  /* Ã„ÂÃ¡ÂºÂ·t chiÃ¡Â»Âu cao cho Ã„â€˜Ã†Â°Ã¡Â»Âng kÃ¡ÂºÂ» */
        background-color: var(--muted); /* SÃ¡Â»Â­ dÃ¡Â»Â¥ng mÃƒÂ u phÃ¡Â»Â¥ cÃ¡Â»Â§a theme */
        opacity: 0.3; /* LÃƒÂ m cho nÃƒÂ³ mÃ¡Â»Â Ã„â€˜i, hÃƒÂ²a vÃƒÂ o nÃ¡Â»Ân */
        margin-top: 0; /* Ã„ÂiÃ¡Â»Âu chÃ¡Â»â€°nh lÃ¡ÂºÂ¡i khoÃ¡ÂºÂ£ng cÃƒÂ¡ch */
    }
    /* === END: TÃƒâ„¢Y CHÃ¡Â»Ë†NH DÃ¡ÂºÂ¢I PHÃƒâ€šN CÃƒÂCH MÃ¡Â»â‚¬M MÃ¡ÂºÂ I HÃ†Â N === */

    .stats-grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:12px}
    .stat-card{background:rgba(255,255,255,0.04); border:1px solid var(--muted); border-radius:14px; padding:12px; text-align:center} /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    .stat-card h4{margin:4px 0 8px; color:var(--sub); font-weight:600; font-size: 14px;}
    .stat-value{font-size: 20px; font-weight: 600;}
    .tiny{font-size:12px; color:var(--sub)}
    .history{display:grid; gap:8px; max-height:300px; overflow:auto; padding-right:6px}
    .hist-item{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:start; background:rgba(255,255,255,0.04); border:1px solid var(--muted); border-radius:10px; padding:10px} /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */

    .row{display:flex; gap:8px; align-items:center}
    .row > * {flex:1}
    input[type="text"], input[type="password"], input[type="number"], select, textarea{width:100%; background:rgba(255,255,255,0.04); color:var(--text); border:1px solid var(--muted); border-radius:10px; padding:10px; outline:none}
    textarea{min-height:80px; resize: vertical;}

    .toasts{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999}
    .toast{
        background: var(--panel); /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
        border:1px solid var(--muted);
        color:var(--text);
        padding:10px 12px; border-radius:12px; box-shadow:var(--shadow);
        animation: toast-in .3s ease; transform-origin: bottom right;
    }
    @keyframes toast-in { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,var(--panel-opacity)); z-index:1000; backdrop-filter: blur(5px);} /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i: Ã„â€˜Ã¡Â»â€œng bÃ¡Â»â„¢ vÃ¡Â»â€ºi file 1.html vÃƒÂ  thÃƒÂªm blur */
    .modal.show{display:flex}
    .modal-card{
        width:min(720px, 94vw);
        border-radius:16px;
        padding:16px;
        box-shadow:var(--shadow);
        animation: modal-in .25s ease-out;
        max-height: 90vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    @keyframes modal-in { from { opacity: 0; transform: scale(0.92) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal-card h3{margin-top:0}
    .dashboard-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .dashboard-table th, .dashboard-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--muted); }
    .dashboard-table th { color: var(--sub); }

    .footer-note{font-size:12px; color:var(--sub)}
    .hidden{display:none !important}

    .notes-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; padding-right: 6px; }
    .note-item { background: rgba(255,255,255,0.04); border-radius: 10px; padding: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; cursor: pointer; } /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    .note-content-wrapper { flex: 1; min-width: 0; }
    .note-content { white-space: pre-wrap; word-break: break-word; max-height: 60px; overflow: hidden; position: relative; transition: max-height 0.35s ease-in-out; }
    .note-content:not(.expanded)::after {
        content: ''; position: absolute; bottom: 0; right: 0; width: 100%; height: 20px; background: linear-gradient(to top, var(--panel) 20%, transparent);
    }
    .note-content.expanded { max-height: 500px; }
    .note-meta { font-size: 11px; color: var(--sub); margin-top: 4px; }
    
    .spinner { border: 2px solid var(--muted); border-top-color: var(--text); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; } /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    @keyframes spin { to { transform: rotate(360deg); } }

    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .panel-header h3 { margin: 0; }
    .panel-header .actions { display: flex; gap: 8px; }
    
    .aux-panel { margin-top: 24px; }
    .tab-nav { display: flex; gap: 4px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 16px; }
    .tab-btn { background: transparent; border: none; color: var(--sub); padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all .2s ease; font-weight: 600; }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--acc); border-bottom-color: var(--acc); }
    .tab-content {
      display: none;
      padding-top: 8px;
    }
    .tab-content.active {
      animation: fadeIn 0.25s ease-out;
    }
    #tasks.tab-content.active,
    #notes.tab-content.active,
    #ai.tab-content.active {
        display: block;
    }

    #settings-timer.tab-content.active,
    #settings-ui.tab-content.active,
    #settings-integrations.tab-content.active {
        display: flex;
    }

    .settings-row-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }
    .settings-row-toggle span {
      flex: 1;
      cursor: pointer;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-switch .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--muted);
      transition: .3s;
      border-radius: 24px;
    }
    .toggle-switch .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .slider {
      background-color: var(--acc-2);
    }
    .toggle-switch input:checked + .slider:before {
      transform: translateX(20px);
    }
    
    .chat-messages { max-height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; padding: 4px; }
    .chat-msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; word-break: break-word; }
    .chat-msg.user { background: var(--acc); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-msg.model { background: var(--muted); align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-input-area { display: flex; gap: 8px; }

    .methods-list { list-style: none; padding: 0; }
    .method-item { align-items: flex-start; padding: 12px; display: flex; gap: 10px; border-radius: 8px; }
    .method-item:hover { background: rgba(0,0,0,0.03); } /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    .method-item input[type="checkbox"] { width: 18px; height: 18px; margin-top: 2px; flex-shrink: 0;}
    .method-item label { flex: 1; }
    .method-item label.completed { text-decoration: line-through; color: var(--sub); }
    .method-item .content-wrapper { flex: 1; cursor: pointer; }
    .method-item .concept { font-size: 14px; color: var(--sub); margin-top: 8px; border-left: 2px solid var(--muted); padding-left: 12px; white-space: pre-wrap; word-break: break-word; }
    .subtopic-todo-list { list-style: none; padding: 0; margin: 0; max-height: 100px; overflow-y: auto; text-align: left; }
    .subtopic-todo-list li { display: flex; align-items: center; gap: 8px; padding: 4px; transition: all 0.2s ease-out; }
    .subtopic-todo-list li.removing { transform: translateX(100%); opacity: 0; }
    .subtopic-todo-list label { flex: 1; }

    #youtube-player-container { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; overflow: hidden; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 10px; } /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    ::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background: var(--sub); background-clip: content-box; }
    
    .timer-circle-container {
        position: relative; width: clamp(250px, 40vw, 320px); height: clamp(250px, 40vw, 320px); margin: 24px auto; display: flex; align-items: center; justify-content: center;
    }
    .timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
    .timer-circle-bg, .timer-circle-progress { fill: none; stroke-width: 8; }
    .timer-circle-bg { stroke: var(--muted); } /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    .timer-circle-progress { stroke: var(--acc); stroke-linecap: round; transition: stroke-dashoffset 0.3s linear, stroke 0.5s ease; }
    @keyframes flash { 0%, 100% { box-shadow: 0 0 10px 2px transparent; } 50% { box-shadow: 0 0 20px 8px currentColor; } }
    .timer-circle-container.finished { color: var(--acc-2); animation: flash 1s ease-out; }
    @keyframes breathing-effect { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    .timer-circle-container.breathing { animation: breathing-effect 3s ease-in-out infinite; }
    
    @media (max-width: 1024px) {
      .app-content { padding: 20px; }
      .panel { padding: 20px; }
      .timer-circle-container { width: clamp(220px, 50vw, 300px); height: clamp(220px, 50vw, 300px); }
    }

    @media (max-width: 768px) {
      .app { flex-direction: column; }
      .app-nav { width: 100%; height: 60px; flex-direction: row; justify-content: center; border-right: none; border-top: 1px solid rgba(255,255,255,.08); order: 2; padding: 0 16px; }
      .app-content { padding: 16px; order: 1; }
      .panel { padding: 16px; }
      .modal-card .tab-nav { overflow-x: auto; }
    }

    @media (max-width: 480px) {
      .app-nav { height: 50px; }
      .nav-btn { flex: 1; }
      header.app-header { flex-direction: column; align-items: stretch; gap: 8px; }
      .btn { padding: 8px 12px; }
      .timer-circle-container { width: clamp(180px, 80vw, 220px); height: clamp(180px, 80vw, 220px); margin: 16px auto; }
      .panel { padding: 12px; }
      .app-content { padding: 12px; }
    }

    #view-timer.no-subtopic-selected > .panel-bg:not(:first-child) { display: none; }
    #view-timer.no-subtopic-selected .timer-header > .presets { display: none; }
    #view-timer.no-subtopic-selected .timer { display: none; }

    header.app-header .actions #btnFullscreen { background: transparent; border: none; box-shadow: none; }
    header.app-header .actions #btnFullscreen:hover { background: var(--muted); filter: none; }
    header.app-header .actions #btnFullscreen:hover::before { opacity: 0; }

    input[type="text"], input[type="password"], input[type="number"], select, textarea {
        background: rgba(255,255,255,0.04) !important; /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i: chuyÃ¡Â»Æ’n sang nÃ¡Â»Ân trÃ¡ÂºÂ¯ng trong suÃ¡Â»â€˜t */
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.1); /* ViÃ¡Â»Ân trÃ¡ÂºÂ¯ng mÃ¡Â»Â */
        transition: background .2s ease, border-color .2s ease;
    }
    input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
        background: rgba(255,255,255,0.06) !important; /* Tinh chÃ¡Â»â€°nh: sÃƒÂ¡t mÃ¡ÂºÂ«u hÃ†Â¡n */
        border-color: var(--acc);
    }
    /* === START: SÃ¡Â»Â¬A LÃ¡Â»â€“I NÃ¡Â»â‚¬N INPUT/SELECT TRÃƒÅ N THEME SÃƒÂNG === */
    [data-theme='light'] input, [data-theme='light'] select, [data-theme='light'] textarea,
    [data-theme='pastel'] input, [data-theme='pastel'] select, [data-theme='pastel'] textarea {
        background: rgba(0, 0, 0, 0.05) !important; /* DÃƒÂ¹ng nÃ¡Â»Ân Ã„â€˜en mÃ¡Â»Â thay vÃƒÂ¬ trÃ¡ÂºÂ¯ng mÃ¡Â»Â */
        border-color: rgba(0, 0, 0, 0.1); /* ViÃ¡Â»Ân Ã„â€˜en mÃ¡Â»Â trÃƒÂªn theme sÃƒÂ¡ng */
    }

    [data-theme='light'] input:focus, [data-theme='light'] select:focus, [data-theme='light'] textarea:focus,
    [data-theme='pastel'] input:focus, [data-theme='pastel'] select:focus, [data-theme='pastel'] textarea:focus {
        background: rgba(0, 0, 0, 0.07) !important; /* TÃ„Æ’ng Ã„â€˜Ã¡Â»â„¢ Ã„â€˜Ã¡ÂºÂ­m khi focus */
    }
    /* === END: SÃ¡Â»Â¬A LÃ¡Â»â€“I NÃ¡Â»â‚¬N INPUT/SELECT TRÃƒÅ N THEME SÃƒÂNG === */
    
    ::placeholder { color: var(--sub); opacity: 0.7; } /* SÃ¡Â»Â­a Ã„â€˜Ã¡Â»â€¢i */
    ::-ms-input-placeholder { color: var(--sub); }
    :-ms-input-placeholder { color: var(--sub); }

    
    
    .draggable-timer {
        position: fixed;
        bottom: 20px;
        right: 20px;
        color: var(--text);
        padding: 8px 16px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        font-size: 2em;
        font-weight: 600;
        cursor: move;
        user-select: none;
        z-index: 9998;
        opacity: 0;
        transform: scale(0.9);
        pointer-events: none;
        transition: opacity 0.35s ease, transform 0.35s ease;
    }
    body.bg-view-mode .draggable-timer {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto;
    }
    .app-nav, .panel-bg, .app-header .actions > *, .app-header > .row {
        transition: opacity 0.35s ease, transform 0.35s ease, background 0.35s ease, border-color 0.35s ease, box-shadow 0.35s ease;
    }
    body.bg-view-mode .app-nav,
    body.bg-view-mode .view.active > .panel-bg {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.98);
    }
    body.bg-view-mode .app-header {
        background: transparent !important;
        border-color: transparent !important;
        box-shadow: none !important;
    }
    body.bg-view-mode .app-header .actions > *:not(#btnToggleBg),
    body.bg-view-mode .app-header > .row {
        opacity: 0;
        pointer-events: none;
    }
    body.bg-view-mode #btnToggleBg {
        opacity: 1;
        pointer-events: auto;
    }
    .sound-permission-bar {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 48px; z-index: 9999;
      border-radius: 12px; padding: 10px 14px;
      display: none; align-items: center; gap: 10px;
      box-shadow: var(--shadow);
    }
    .sound-permission-bar.show { display: flex; }
    .sound-permission-bar .msg { font-size: 14px; color: var(--text); }
    .draggable-timer { text-shadow: 0px 0px 8px rgba(0, 0, 0, 0.9); }

    /* GiÃ¡ÂºÂ£m/loÃ¡ÂºÂ¡i bÃ¡Â»Â bÃƒÂ³ng chÃ¡Â»Â¯ cho theme sÃƒÂ¡ng Ã„â€˜Ã¡Â»Æ’ trÃƒÂ¡nh nhÃƒÂ²e/lÃƒÂ³a */
    body[data-theme='light'],
    body[data-theme='pastel'] { text-shadow: none; }
    body[data-theme='light'] .draggable-timer,
    body[data-theme='pastel'] .draggable-timer { text-shadow: none; }

    /* ============================================= */
/* ========================================================= */
/* START: THIáº¾T Láº¬P PANEL KIá»‚U Má»œ Äá»¤C (FROSTED GLASS)        */
/* ========================================================= */

/* --- 1. Ãp dá»¥ng hiá»‡u á»©ng ná»n má» chung cho táº¥t cáº£ cÃ¡c panel --- */
.app-nav,
.panel-bg,
.modal-card,
.actions-menu,
.nav-btn .tooltip,
.draggable-timer, 
.sound-permission-bar,
.toast,
.topic-item,
.stat-card,
.hist-item,
.method-item {
    background: rgba(var(--panel-rgb), var(--panel-opacity));
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
}

/* --- 2. Äá»‹nh nghÄ©a viá»n cho tá»«ng loáº¡i panel --- */
.app-nav {
    border-right: 1px solid rgba(255, 255, 255, 0.1);
}
.panel-bg,
.modal-card,
.actions-menu,
.nav-btn .tooltip,
.draggable-timer, 
.sound-permission-bar,
.toast,
.topic-item,
.stat-card,
.hist-item,
.method-item {
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* --- 3. Tinh chá»‰nh viá»n cho cÃ¡c theme SÃNG (Light/Pastel) --- */
[data-theme='light'] .app-nav,
[data-theme='light'] .panel-bg,
[data-theme='light'] .modal-card,
[data-theme='light'] .actions-menu,
[data-theme='light'] .nav-btn .tooltip,
[data-theme='light'] .draggable-timer,
[data-theme='light'] .sound-permission-bar,
[data-theme='light'] .toast,
[data-theme='light'] .topic-item,
[data-theme='light'] .stat-card,
[data-theme='light'] .hist-item,
[data-theme='light'] .method-item,
[data-theme='pastel'] .app-nav,
[data-theme='pastel'] .panel-bg,
[data-theme='pastel'] .modal-card,
[data-theme='pastel'] .actions-menu,
[data-theme='pastel'] .nav-btn .tooltip,
[data-theme='pastel'] .draggable-timer,
[data-theme='pastel'] .sound-permission-bar,
[data-theme='pastel'] .toast,
[data-theme='pastel'] .topic-item,
[data-theme='pastel'] .stat-card,
[data-theme='pastel'] .hist-item,
[data-theme='pastel'] .method-item {
    border-color: rgba(0, 0, 0, 0.1);
}

/* --- 4. Sá»­a láº¡i hiá»‡u á»©ng fade-out cá»§a ghi chÃº cho phÃ¹ há»£p --- */
.note-content:not(.expanded)::after {
    background: linear-gradient(to top, rgba(var(--panel-rgb), 1) 20%, transparent);
}

/* --- CÃ¡c quy táº¯c cÃ²n láº¡i giá»¯ nguyÃªn tá»« file gá»‘c --- */
[data-theme='light'] .tab-nav,
[data-theme='pastel'] .tab-nav {
    border-bottom-color: rgba(0, 0, 0, 0.1);
}
.subtopic-btn {
    background-color: transparent;
}
.subtopic-btn:hover {
    background-color: var(--muted);
}
.method-item[open] summary {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
[data-theme='light'] .method-item[open] summary,
[data-theme='pastel'] .method-item[open] summary {
    border-bottom-color: rgba(0, 0, 0, 0.1);
}

    </style>
</head>
<body data-theme="default"> <div class="app" id="app">
    <nav class="app-nav">
        <button class="nav-btn active" id="navBtnTimer" data-view="timer" aria-label="Äá»“ng há»“">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            <span class="tooltip">Äá»“ng há»“</span>
        </button>
        <button class="nav-btn" id="navBtnTopics" data-view="topics" aria-label="Chá»§ Ä‘á»">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
            <span class="tooltip">Chá»§ Ä‘á»</span>
        </button>
        <button class="nav-btn" id="navBtnStats" data-view="stats" aria-label="Thá»‘ng kÃª">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
            <span class="tooltip">Thá»‘ng kÃª</span>
        </button>
        <button class="nav-btn" id="navBtnMethods" data-view="methods" aria-label="PhÆ°Æ¡ng phÃ¡p há»c">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.042 21.672L13.684 16.6s.408-1.947 1.25-3.25c.842-1.303 2.002-2.5 3.5-3.5s3.25-1.25 3.25-1.25l5.072 1.358c.27.072.358.42.128.628l-3.35 3.35a.499.499 0 0 1-.594.052l-2.07-1.486c-.44-.314-.82-.53-1.11-.665-.29-.135-.55-.22-.78-.245s-.45.045-.63.155c-.18.11-.3.29-.36.5-.06.21.02.48.18.78.16.3.385.68.665 1.11l1.486 2.07a.499.499 0 0 1-.052.594l-3.35 3.35c-.208.23-.556.142-.628-.128z"/><path d="M12 15l-3-3 3-3 3 3-3 3z"/><path d="M9.01 11.99l-3.005 3.004a.997.997 0 0 1-1.41-1.41l3.004-3.005-3.004-3.005a.997.997 0 0 1 1.41-1.41l3.005 3.004z"/><path d="M5.01 11.99l-3.005 3.004a.997.997 0 0 1-1.41-1.41l3.004-3.005-3.004-3.005a.997.997 0 0 1 1.41-1.41l3.005 3.004z"/></svg>
            <span class="tooltip">PhÆ°Æ¡ng phÃ¡p há»c</span>
        </button>
        <button class="nav-btn" id="btnSettings" style="margin-top: auto;" aria-label="CÃ i Ä‘áº·t">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            <span class="tooltip">CÃ i Ä‘áº·t</span>
        </button>
        <button class="nav-btn" id="navBtnGuide" data-view="guide" aria-label="HÆ°á»›ng dáº«n">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 1 1 5.82 1c0 2-3 2-3 4"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            <span class="tooltip">HÆ°á»›ng dáº«n</span>
        </button>
    </nav>

    <main class="app-content">
      <header class="app-header panel-bg">
        <div class="row" style="gap:12px; align-items:center; flex:0 1 auto">
          <strong>ğŸ“š Pomodoro Study App</strong>
          <span class="badge" id="selectedContext">ChÆ°a chá»n Chá»§ Ä‘á» con</span>
        </div>
        <div class="actions">
          <button class="btn ghost small" id="btnDashboard" title="Dashboard Tá»•ng quan">ğŸ“Š Tá»•ng Quan </button>
          <button class="btn ghost small" id="btnExport" title="Xuáº¥t JSON">â¬‡ï¸ Xuáº¥t File</button>
          <label class="btn ghost small" for="importFile" title="Nháº­p JSON">â¬†ï¸ Nháº­p File</label>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
          <button class="btn small" id="btnToggleBg" title="áº¨n/Hiá»‡n giao diá»‡n">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
          <button class="btn small" id="btnFullscreen" title="ToÃ n mÃ n hÃ¬nh">âŸ°</button>
        </div>
      </header>
      

      <div id="view-timer" class="view active">
        <section class="panel panel-bg">
          <div class="timer-header">
            <div id="welcomePanel" class="hidden panel-bg" style="text-align:center; padding: 20px; border-radius: var(--radius); width: 100%;">
                <h3>ChÃ o má»«ng Ä‘áº¿n vá»›i Pomodoro Study App!</h3>
                <p>HÃ£y báº¯t Ä‘áº§u báº±ng cÃ¡ch chá»n má»™t <strong>Chá»§ Ä‘á» con</strong> hoáº·c táº¡o Chá»§ Ä‘á»/Chá»§ Ä‘á» con má»›i.</p>
                <button class="btn acc" id="btnHelpCreateTopic">ï¼‹ Táº¡o Chá»§ Ä‘á» Má»›i</button>
            </div>
            <div class="presets" role="group" aria-label="Chá»n cháº¿ Ä‘á»™ preset">
                <button id="btnPresetA" class="btn small ghost" data-preset="A"></button>
                <button id="btnPresetB" class="btn small ghost" data-preset="B"></button>
            </div>
          </div>
          <hr />
          <div class="timer" aria-live="polite">
            <div class="badge" id="stateBadge">TRáº NG THÃI</div>
            
            <div class="timer-circle-container">
              <svg class="timer-svg" viewBox="0 0 100 100">
                  <circle class="timer-circle-bg" cx="50" cy="50" r="45"></circle>
                  <circle class="timer-circle-progress" cx="50" cy="50" r="45"></circle>
              </svg>
              <div id="timeDisplay" class="big-time">00:00</div>
            </div>

            <div class="tiny" id="cycleInfo"></div>
            
            <div class="controls">
              <button class="btn acc" id="btnStart" aria-label="Báº¯t Ä‘áº§u (Space)">â–¶ï¸ Báº¯t Ä‘áº§u</button>
              <button class="btn" id="btnPause" aria-label="Táº¡m dá»«ng (Space)">â¸ï¸ Táº¡m dá»«ng</button>
              <button class="btn" id="btnResume" aria-label="Tiáº¿p tá»¥c (Space)">âµ Tiáº¿p tá»¥c</button>
              <button class="btn warn" id="btnSkip" aria-label="Bá» qua (N)">â­ï¸ Bá» qua</button>
              <button class="btn danger" id="btnReset">â†º Äáº·t láº¡i</button>
            </div>
            <div class="tiny">PhÃ­m táº¯t: <strong>Space</strong> = Báº¯t Ä‘áº§u/Táº¡m dá»«ng/Tiáº¿p tá»¥c, <strong>N</strong> = Tiáº¿p theo/Bá» qua</div>
          </div>
        </section>

        <section class="panel panel-bg aux-panel">
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="tasks">Nhiá»‡m vá»¥</button>
                <button class="tab-btn" data-tab="notes">Ghi chÃº</button>
                <button class="tab-btn" data-tab="ai">Gemini AI</button>
            </nav>
            <div id="tasks" class="tab-content active">
                <h4 style="margin: 0 0 8px; color: var(--sub);">To-do cho chá»§ Ä‘á» con nÃ y:</h4>
                <ul id="subtopicTasksList" class="subtopic-todo-list"></ul>
                <div class="row" style="gap:8px; margin-top: 8px;">
                    <input type="text" id="newSubtopicTaskInput" placeholder="ThÃªm má»™t task má»›i..." />
                    <button id="btnAddSubtopicTask" class="btn small" style="flex: 0 1 auto;">ThÃªm</button>
                </div>
            </div>
            <div id="notes" class="tab-content">
                <div id="generalNotesList" class="notes-list"></div>
                <div class="add-note-area" style="margin-top: 12px;">
                    <textarea id="newGeneralNoteText" placeholder="ThÃªm ghi chÃº má»›i..."></textarea>
                    <div style="text-align: right; margin-top: 8px;">
                        <button class="btn acc small" id="btnAddGeneralNote">ï¼‹ ThÃªm ghi chÃº</button>
                    </div>
                </div>
            </div>
            <div id="ai" class="tab-content">
                <div class="panel-header" style="margin-bottom: 8px; padding: 0;">
                    <h4 style="margin:0;">Gemini Assistant cho: <span id="currentSubtopicNameChat">(chÆ°a chá»n)</span></h4>
                    <div class="actions">
                        <button id="btnNewChat" class="btn small ghost" title="Chat má»›i">â•</button>
                        <button id="btnClearChat" class="btn small danger" title="XÃ³a lá»‹ch sá»­">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div id="aiPromptSuggestions" style="display: flex; gap: 6px; margin: 8px 0; flex-wrap: wrap;">
                  <button class="btn small ghost" data-prompt="Giáº£i thÃ­ch khÃ¡i niá»‡m chÃ­nh cá»§a chá»§ Ä‘á» nÃ y">Giáº£i thÃ­ch khÃ¡i niá»‡m</button>
                  <button class="btn small ghost" data-prompt="Táº¡o má»™t dÃ n Ã½ chi tiáº¿t cho chá»§ Ä‘á» nÃ y">Táº¡o dÃ n Ã½</button>
                  <button class="btn small ghost" data-prompt="Liá»‡t kÃª 5 cÃ¢u há»i Ã´n táº­p quan trá»ng vá» chá»§ Ä‘á» nÃ y">Táº¡o cÃ¢u há»i Ã´n táº­p</button>
                </div>
                <div class="chat-input-area">
                  <input type="text" id="chatInput" placeholder="Há»i Gemini Ä‘iá»u gÃ¬ Ä‘Ã³..." />
                  <button id="btnSendMessage" class="btn acc">Gá»­i</button>
                </div>
            </div>
        </section>
      </div>

      <div id="view-topics" class="view">
        <div class="panel panel-bg">
            <div class="row" style="gap:8px; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0;">Quáº£n lÃ½ Chá»§ Ä‘á»</h3>
                <button class="btn small acc" id="btnAddTopic" style="margin-left: auto;">ï¼‹ ThÃªm Chá»§ Ä‘á»</button>
            </div>
            <div id="topicsList"></div>
            <div class="footer-note">Nháº¥p mÅ©i tÃªn Ä‘á»ƒ má»Ÿ/Ä‘Ã³ng danh sÃ¡ch chá»§ Ä‘á» con.</div>
        </div>
      </div>
      
      <div id="view-stats" class="view">
        <section class="panel panel-bg">
            <h3 style="margin:0 0 12px 0;">Thá»‘ng kÃª & Lá»‹ch sá»­ â€” <span id="currentSubtopicName">(chÆ°a chá»n)</span></h3>
            <div class="stats-grid">
              <div class="stat-card"><h4>Tá»•ng thá»i gian</h4><div class="stat-value" id="statTotal">0 phÃºt</div></div>
              <div class="stat-card"><h4>PhiÃªn</h4><div class="stat-value" id="statSessions">0</div></div>
              <div class="stat-card"><h4>Nhiá»‡m vá»¥ HoÃ n thÃ nh</h4><div class="stat-value" id="statTasks">0</div></div>
            </div>
            <div style="margin-top:12px">
              <h4 style="margin:4px 0 8px; color:var(--sub)">Lá»‹ch sá»­ (LÃ€M VIá»†C)</h4>
              <div class="history" id="historyList"></div>
            </div>
        </section>
      </div>
      
      <div id="view-methods" class="view">
        <div class="panel panel-bg">
            <h3 style="margin-top: 0;">ğŸ’¡ CÃ¡c PhÆ°Æ¡ng phÃ¡p Há»c táº­p Hiá»‡u quáº£</h3>
            <p class="tiny" style="margin-top: -8px; margin-bottom: 20px;">Nháº¥p vÃ o tá»«ng phÆ°Æ¡ng phÃ¡p Ä‘á»ƒ xem chi tiáº¿t.</p>
            
            <div class="methods-container">
                <details class="method-item">
                    <summary>Ká»¹ Thuáº­t Feynman: Hiá»ƒu SÃ¢u Báº±ng CÃ¡ch Giáº£i ThÃ­ch ÄÆ¡n Giáº£n</summary>
                    <div class="method-content">
                        <p>NguyÃªn táº¯c cá»‘t lÃµi cá»§a ká»¹ thuáº­t nÃ y dá»±a trÃªn má»™t Ã½ tÆ°á»Ÿng duy nháº¥t: "Náº¿u báº¡n khÃ´ng thá»ƒ giáº£i thÃ­ch má»™t chá»§ Ä‘á» má»™t cÃ¡ch Ä‘Æ¡n giáº£n, báº¡n chÆ°a thá»±c sá»± hiá»ƒu nÃ³." Má»¥c tiÃªu lÃ  biáº¿n kiáº¿n thá»©c phá»©c táº¡p thÃ nh lá»i giáº£i thÃ­ch Ä‘Æ¡n giáº£n Ä‘áº¿n má»©c má»™t Ä‘á»©a tráº» cÅ©ng cÃ³ thá»ƒ hiá»ƒu.</p>
                        <h4>Quy TrÃ¬nh 4 BÆ°á»›c Tinh Gá»n</h4>
                        <ol>
                            <li><strong>Há»c:</strong> Chá»n má»™t chá»§ Ä‘á» vÃ  viáº¿t ra táº¥t cáº£ nhá»¯ng gÃ¬ báº¡n biáº¿t vá» nÃ³.</li>
                            <li><strong>Dáº¡y:</strong> Giáº£ vá» dáº¡y láº¡i chá»§ Ä‘á» nÃ y báº±ng ngÃ´n ngá»¯ Ä‘Æ¡n giáº£n nháº¥t cÃ³ thá»ƒ. Viáº¿t hoáº·c nÃ³i to ra.</li>
                            <li><strong>TÃ¬m & Sá»­a Lá»—i:</strong> Báº¥t cá»© khi nÃ o báº¡n bá»‹ "káº¹t", pháº£i dÃ¹ng thuáº­t ngá»¯ phá»©c táº¡p, hoáº·c khÃ´ng thá»ƒ giáº£i thÃ­ch trÃ´i cháº£y, báº¡n Ä‘Ã£ tÃ¬m tháº¥y lá»— há»•ng kiáº¿n thá»©c cá»§a mÃ¬nh. HÃ£y quay láº¡i tÃ i liá»‡u gá»‘c Ä‘á»ƒ há»c láº¡i cho Ä‘áº¿n khi láº¥p Ä‘Æ°á»£c lá»— há»•ng Ä‘Ã³.</li>
                            <li><strong>ÄÆ¡n Giáº£n HÃ³a:</strong> Sáº¯p xáº¿p láº¡i lá»i giáº£i thÃ­ch cuá»‘i cÃ¹ng, sá»­ dá»¥ng cÃ¡c vÃ­ dá»¥ hoáº·c phÃ©p vÃ­ von Ä‘Æ¡n giáº£n Ä‘á»ƒ nÃ³ trá»Ÿ nÃªn máº¡ch láº¡c vÃ  dá»… hiá»ƒu nháº¥t.</li>
                        </ol>
                        <h4>Cá»‘t LÃµi</h4>
                        <p>Ká»¹ thuáº­t Feynman buá»™c báº¡n pháº£i chuyá»ƒn tá»« viá»‡c tiáº¿p thu thá»¥ Ä‘á»™ng (Ä‘á»c, nghe) sang chá»§ Ä‘á»™ng xá»­ lÃ½ thÃ´ng tin. QuÃ¡ trÃ¬nh "bá»‹ káº¹t" khi giáº£i thÃ­ch chÃ­nh lÃ  cÃ´ng cá»¥ cháº©n Ä‘oÃ¡n máº¡nh máº½ nháº¥t, nÃ³ chá»‰ ra chÃ­nh xÃ¡c Ä‘iá»ƒm báº¡n cÃ²n yáº¿u.</p>
                        <p><i>CÃ¡ch nhanh nháº¥t Ä‘á»ƒ kiá»ƒm tra vÃ  cá»§ng cá»‘ sá»± hiá»ƒu biáº¿t cá»§a báº¡n lÃ  thá»­ dáº¡y láº¡i nÃ³ cho ngÆ°á»i khÃ¡c má»™t cÃ¡ch Ä‘Æ¡n giáº£n.</i></p>
                    </div>
                </details>

                <details class="method-item">
                    <summary>PhÃ†Â°Ã†Â¡ng PhÃƒÂ¡p ViÃ¡ÂºÂ¿t cÃ¡Â»Â§a Benjamin Franklin: HÃ¡Â»Âc ViÃ¡ÂºÂ¿t BÃ¡ÂºÂ±ng CÃƒÂ¡ch TÃƒÂ¡i TÃ¡ÂºÂ¡o</summary>
                    <div class="method-content">
                        <p>Benjamin Franklin Ã„â€˜ÃƒÂ£ tÃ¡Â»Â± rÃƒÂ¨n luyÃ¡Â»â€¡n kÃ¡Â»Â¹ nÃ„Æ’ng viÃ¡ÂºÂ¿t tÃ¡Â»Â« kÃƒÂ©m cÃ¡Â»Âi trÃ¡Â»Å¸ nÃƒÂªn bÃ¡ÂºÂ­c thÃ¡ÂºÂ§y bÃ¡ÂºÂ±ng mÃ¡Â»â„¢t phÃ†Â°Ã†Â¡ng phÃƒÂ¡p chÃ¡Â»Â§ Ã„â€˜Ã¡Â»â„¢ng, thay vÃƒÂ¬ chÃ¡Â»â€° Ã„â€˜Ã¡Â»Âc mÃ¡Â»â„¢t cÃƒÂ¡ch thÃ¡Â»Â¥ Ã„â€˜Ã¡Â»â„¢ng. CÃ¡Â»â€˜t lÃƒÂµi cÃ¡Â»Â§a phÃ†Â°Ã†Â¡ng phÃƒÂ¡p nÃƒÂ y lÃƒÂ  phÃƒÂ¢n tÃƒÂ­ch, tÃƒÂ¡i tÃ¡ÂºÂ¡o, vÃƒÂ  so sÃƒÂ¡nh vÃ¡Â»â€ºi mÃ¡Â»â„¢t bÃƒÂ i viÃ¡ÂºÂ¿t chÃ¡ÂºÂ¥t lÃ†Â°Ã¡Â»Â£ng cao.</p>
                        <p>Ã„ÂÃƒÂ¢y lÃƒÂ  mÃ¡Â»â„¢t vÃƒÂ­ dÃ¡Â»Â¥ kinh Ã„â€˜iÃ¡Â»Æ’n cÃ¡Â»Â§a "LuyÃ¡Â»â€¡n tÃ¡ÂºÂ­p cÃƒÂ³ ChÃ¡Â»Â§ Ã„â€˜ÃƒÂ­ch": tÃ¡ÂºÂ­p trung vÃƒÂ o Ã„â€˜iÃ¡Â»Æ’m yÃ¡ÂºÂ¿u, cÃƒÂ³ mÃ¡Â»Â¥c tiÃƒÂªu rÃƒÂµ rÃƒÂ ng vÃƒÂ  nhÃ¡ÂºÂ­n phÃ¡ÂºÂ£n hÃ¡Â»â€œi ngay lÃ¡ÂºÂ­p tÃ¡Â»Â©c.</p>
                        <h4>Quy TrÃƒÂ¬nh 3 BÃ†Â°Ã¡Â»â€ºc CÃ¡Â»â€˜t LÃƒÂµi</h4>
                        <ol>
                            <li><strong>PhÃƒÂ¢n TÃƒÂ­ch (Deconstruct):</strong> Ã„ÂÃ¡Â»Âc mÃ¡Â»â„¢t bÃƒÂ i viÃ¡ÂºÂ¿t mÃ¡ÂºÂ«u xuÃ¡ÂºÂ¥t sÃ¡ÂºÂ¯c. Sau Ã„â€˜ÃƒÂ³, chÃ¡Â»â€° ghi lÃ¡ÂºÂ¡i nhÃ¡Â»Â¯ng ÃƒÂ½ chÃƒÂ­nh cÃ¡Â»Â§a tÃ¡Â»Â«ng Ã„â€˜oÃ¡ÂºÂ¡n hoÃ¡ÂºÂ·c tÃ¡Â»Â«ng cÃƒÂ¢u ra mÃ¡Â»â„¢t tÃ¡Â»Â giÃ¡ÂºÂ¥y riÃƒÂªng.</li>
                            <li><strong>TÃƒÂ¡i TÃ¡ÂºÂ¡o (Reconstruct):</strong> VÃƒÂ i ngÃƒÂ y sau, khi Ã„â€˜ÃƒÂ£ quÃƒÂªn Ã„â€˜i vÃ„Æ’n phong cÃ¡Â»Â§a bÃ¡ÂºÂ£n gÃ¡Â»â€˜c, hÃƒÂ£y dÃƒÂ¹ng nhÃ¡Â»Â¯ng ghi chÃƒÂº ÃƒÂ½ chÃƒÂ­nh Ã„â€˜ÃƒÂ³ Ã„â€˜Ã¡Â»Æ’ viÃ¡ÂºÂ¿t lÃ¡ÂºÂ¡i toÃƒÂ n bÃ¡Â»â„¢ bÃƒÂ i viÃ¡ÂºÂ¿t bÃ¡ÂºÂ±ng ngÃƒÂ´n ngÃ¡Â»Â¯ vÃƒÂ  cÃƒÂ¡ch diÃ¡Â»â€¦n Ã„â€˜Ã¡ÂºÂ¡t cÃ¡Â»Â§a chÃƒÂ­nh bÃ¡ÂºÂ¡n.</li>
                            <li><strong>So SÃƒÂ¡nh & SÃ¡Â»Â­a LÃ¡Â»â€”i (Compare & Correct):</strong> Ã„ÂÃ¡Â»â€˜i chiÃ¡ÂºÂ¿u trÃ¡Â»Â±c tiÃ¡ÂºÂ¿p bÃƒÂ i viÃ¡ÂºÂ¿t cÃ¡Â»Â§a bÃ¡ÂºÂ¡n vÃ¡Â»â€ºi bÃ¡ÂºÂ£n gÃ¡Â»â€˜c. Ã„ÂÃƒÂ¢y lÃƒÂ  bÃ†Â°Ã¡Â»â€ºc quan trÃ¡Â»Âng nhÃ¡ÂºÂ¥t. NÃƒÂ³ giÃƒÂºp bÃ¡ÂºÂ¡n phÃƒÂ¡t hiÃ¡Â»â€¡n ngay lÃ¡ÂºÂ­p tÃ¡Â»Â©c nhÃ¡Â»Â¯ng lÃ¡Â»â€”i sai vÃ¡Â»Â tÃ¡Â»Â« vÃ¡Â»Â±ng, cÃ¡ÂºÂ¥u trÃƒÂºc cÃƒÂ¢u, vÃƒÂ  cÃƒÂ¡ch sÃ¡ÂºÂ¯p xÃ¡ÂºÂ¿p ÃƒÂ½ tÃ†Â°Ã¡Â»Å¸ng Ã„â€˜Ã¡Â»Æ’ sÃ¡Â»Â­a chÃ¡Â»Â¯a.</li>
                        </ol>
                        <p>Franklin cÃƒÂ²n thÃ¡Â»Â±c hÃƒÂ nh cÃƒÂ¡c biÃ¡ÂºÂ¿n thÃ¡Â»Æ’ nÃƒÂ¢ng cao nhÃ†Â° xÃƒÂ¡o trÃ¡Â»â„¢n thÃ¡Â»Â© tÃ¡Â»Â± cÃƒÂ¡c ÃƒÂ½ chÃƒÂ­nh Ã„â€˜Ã¡Â»Æ’ rÃƒÂ¨n luyÃ¡Â»â€¡n tÃ†Â° duy logic, hoÃ¡ÂºÂ·c chuyÃ¡Â»Æ’n vÃ„Æ’n xuÃƒÂ´i thÃƒÂ nh thÃ†Â¡ Ã„â€˜Ã¡Â»Æ’ lÃƒÂ m giÃƒÂ u vÃ¡Â»â€˜n tÃ¡Â»Â«.</p>
                        <h4>NguyÃƒÂªn TÃ¡ÂºÂ¯c VÃƒÂ ng</h4>
                        <p>ThÃƒÂ nh cÃƒÂ´ng cÃ¡Â»Â§a phÃ†Â°Ã†Â¡ng phÃƒÂ¡p nÃƒÂ y khÃƒÂ´ng Ã„â€˜Ã¡ÂºÂ¿n tÃ¡Â»Â« viÃ¡Â»â€¡c lÃ¡ÂºÂ·p lÃ¡ÂºÂ¡i vÃƒÂ´ thÃ¡Â»Â©c, mÃƒÂ  Ã„â€˜Ã¡ÂºÂ¿n tÃ¡Â»Â« vÃƒÂ²ng lÃ¡ÂºÂ·p phÃ¡ÂºÂ£n hÃ¡Â»â€œi trÃ¡Â»Â±c tiÃ¡ÂºÂ¿p. ViÃ¡Â»â€¡c so sÃƒÂ¡nh vÃ¡Â»â€ºi bÃ¡ÂºÂ£n gÃ¡Â»â€˜c buÃ¡Â»â„¢c bÃ¡ÂºÂ¡n phÃ¡ÂºÂ£i Ã„â€˜Ã¡Â»â€˜i mÃ¡ÂºÂ·t vÃƒÂ  sÃ¡Â»Â­a chÃ¡Â»Â¯a nhÃ¡Â»Â¯ng Ã„â€˜iÃ¡Â»Æ’m yÃ¡ÂºÂ¿u cÃ¡Â»Â¥ thÃ¡Â»Æ’ cÃ¡Â»Â§a mÃƒÂ¬nh, biÃ¡ÂºÂ¿n viÃ¡Â»â€¡c hÃ¡Â»Âc tÃ¡Â»Â« mÃ¡Â»â„¢t quÃƒÂ¡ trÃƒÂ¬nh mÃ†Â¡ hÃ¡Â»â€œ thÃƒÂ nh mÃ¡Â»â„¢t bÃƒÂ i tÃ¡ÂºÂ­p cÃƒÂ³ thÃ¡Â»Æ’ Ã„â€˜o lÃ†Â°Ã¡Â»Âng Ã„â€˜Ã†Â°Ã¡Â»Â£c.</p>
                        <p><i>Ã„ÂÃ¡Â»Æ’ viÃ¡ÂºÂ¿t giÃ¡Â»Âi hÃ†Â¡n, Ã„â€˜Ã¡Â»Â«ng chÃ¡Â»â€° Ã„â€˜Ã¡Â»Âc. HÃƒÂ£y chÃ¡Â»Ân mÃ¡Â»â„¢t bÃƒÂ i viÃ¡ÂºÂ¿t hay, phÃƒÂ¢n tÃƒÂ­ch nÃƒÂ³, cÃ¡Â»â€˜ gÃ¡ÂºÂ¯ng viÃ¡ÂºÂ¿t lÃ¡ÂºÂ¡i, vÃƒÂ  so sÃƒÂ¡nh Ã„â€˜Ã¡Â»Æ’ tÃƒÂ¬m ra lÃ¡Â»â€”i sai.</i></p>
                    </div>
                </details>

                <details class="method-item">
                    <summary>NguyÃƒÂªn TÃ¡ÂºÂ¯c 80/20 Ã„ÂÃ¡Â»Æ’ Chinh PhÃ¡Â»Â¥c LÃ„Â©nh VÃ¡Â»Â±c MÃ¡Â»â€ºi</summary>
                    <div class="method-content">
                        <p>Ã„ÂÃ¡Â»Æ’ khÃƒÂ´ng bÃ¡Â»â€¹ choÃƒÂ¡ng ngÃ¡Â»Â£p khi hÃ¡Â»Âc mÃ¡Â»â„¢t lÃ„Â©nh vÃ¡Â»Â±c mÃ¡Â»â€ºi, hÃƒÂ£y tÃ¡ÂºÂ­p trung vÃƒÂ o 20% kiÃ¡ÂºÂ¿n thÃ¡Â»Â©c cÃ¡Â»â€˜t lÃƒÂµi mang lÃ¡ÂºÂ¡i 80% kÃ¡ÂºÂ¿t quÃ¡ÂºÂ£ (LiÃ¡Â»Âu lÃ†Â°Ã¡Â»Â£ng HiÃ¡Â»â€¡u quÃ¡ÂºÂ£ TÃ¡Â»â€˜i thiÃ¡Â»Æ’u).</p>
                        <h4>20% cÃ¡Â»â€˜t lÃƒÂµi: ÃƒÂp dÃ¡Â»Â¥ng Khung PhÃƒÂ¢n tÃƒÂ­ch 5 BÃ†Â°Ã¡Â»â€ºc Ã„â€˜Ã¡Â»Æ’ xÃƒÂ¡c Ã„â€˜Ã¡Â»â€¹nh 20% quan trÃ¡Â»Âng nhÃ¡ÂºÂ¥t:</h4>
                        <ol>
                            <li><strong>XÃƒÂ¡c Ã„â€˜Ã¡Â»â€¹nh KÃ¡ÂºÂ¿t quÃ¡ÂºÂ£:</strong> MÃ¡Â»Â¥c tiÃƒÂªu cuÃ¡Â»â€˜i cÃƒÂ¹ng cÃ¡Â»Â§a bÃ¡ÂºÂ¡n lÃƒÂ  gÃƒÂ¬? (vÃƒÂ­ dÃ¡Â»Â¥: xÃƒÂ¢y dÃ¡Â»Â±ng Ã„â€˜Ã†Â°Ã¡Â»Â£c mÃ¡Â»â„¢t trang web).</li>
                            <li><strong>PhÃƒÂ¢n tÃƒÂ­ch NÃ¡Â»Ân tÃ¡ÂºÂ£ng:</strong> TÃƒÂ¬m 3-5 nguyÃƒÂªn lÃƒÂ½ bÃ¡ÂºÂ¥t biÃ¡ÂºÂ¿n cÃ¡Â»Â§a ngÃƒÂ nh.</li>
                            <li><strong>NhÃ¡ÂºÂ­n diÃ¡Â»â€¡n LÃ¡Â»â€”i sai PhÃ¡Â»â€¢ biÃ¡ÂºÂ¿n:</strong> HÃ¡Â»Âc cÃƒÂ¡ch trÃƒÂ¡nh nhÃ¡Â»Â¯ng lÃ¡Â»â€”i mÃƒÂ  ngÃ†Â°Ã¡Â»Âi mÃ¡Â»â€ºi hay mÃ¡ÂºÂ¯c phÃ¡ÂºÂ£i.</li>
                            <li><strong>TÃƒÂ¬m "YÃ¡ÂºÂ¿u tÃ¡Â»â€˜ NhÃƒÂ¢n":</strong> KÃ¡Â»Â¹ nÃ„Æ’ng nÃƒÂ o sÃ¡ÂºÂ½ giÃƒÂºp hÃ¡Â»Âc mÃ¡Â»Âi thÃ¡Â»Â© khÃƒÂ¡c dÃ¡Â»â€¦ dÃƒÂ ng hÃ†Â¡n? (vÃƒÂ­ dÃ¡Â»Â¥: nhÃ¡ÂºÂ¡c lÃƒÂ½ trong ÃƒÂ¢m nhÃ¡ÂºÂ¡c).</li>
                            <li><strong>LÃ¡ÂºÂ­p bÃ¡ÂºÂ£n Ã„â€˜Ã¡Â»â€œ Ã¡Â»Â¨ng dÃ¡Â»Â¥ng ThÃ¡Â»Â±c tiÃ¡Â»â€¦n:</strong> TÃ¡ÂºÂ­p trung vÃƒÂ o 20% cÃƒÂ´ng viÃ¡Â»â€¡c chiÃ¡ÂºÂ¿m 80% thÃ¡Â»Âi gian thÃ¡Â»Â±c tÃ¡ÂºÂ¿ cÃ¡Â»Â§a ngÃƒÂ nh.</li>
                        </ol>
                    </div>
                </details>

                <details class="method-item">
                    <summary>GÃ¡Â»Â£i NhÃ¡Â»â€º ChÃ¡Â»Â§ Ã„ÂÃ¡Â»â„¢ng (Active Recall): NguyÃƒÂªn TÃ¡ÂºÂ¯c CÃ¡Â»â€˜t LÃƒÂµi Ã„ÂÃ¡Â»Æ’ HÃ¡Â»Âc SÃƒÂ¢u</summary>
                    <div class="method-content">
                        <p>GÃ¡Â»Â£i nhÃ¡Â»â€º chÃ¡Â»Â§ Ã„â€˜Ã¡Â»â„¢ng lÃƒÂ  hÃƒÂ nh Ã„â€˜Ã¡Â»â„¢ng nÃ¡Â»â€” lÃ¡Â»Â±c truy xuÃ¡ÂºÂ¥t thÃƒÂ´ng tin tÃ¡Â»Â« nÃƒÂ£o bÃ¡Â»â„¢ mÃƒÂ  khÃƒÂ´ng nhÃƒÂ¬n vÃƒÂ o tÃƒÂ i liÃ¡Â»â€¡u. Ã„ÂÃƒÂ¢y lÃƒÂ  phÃ†Â°Ã†Â¡ng phÃƒÂ¡p hÃ¡Â»Âc hiÃ¡Â»â€¡u quÃ¡ÂºÂ£ vÃ†Â°Ã¡Â»Â£t trÃ¡Â»â„¢i so vÃ¡Â»â€ºi viÃ¡Â»â€¡c Ã„â€˜Ã¡Â»Âc lÃ¡ÂºÂ¡i, highlight hay tÃƒÂ³m tÃ¡ÂºÂ¯t mÃ¡Â»â„¢t cÃƒÂ¡ch thÃ¡Â»Â¥ Ã„â€˜Ã¡Â»â„¢ng.</p>
                        <h4>NguyÃƒÂªn TÃ¡ÂºÂ¯c 20/80</h4>
                        <p><strong>20% CÃ¡Â»â€˜t lÃƒÂµi:</strong> HÃƒÂ nh Ã„â€˜Ã¡Â»â„¢ng "vÃ¡ÂºÂ¯t ÃƒÂ³c" Ã„â€˜Ã¡Â»Æ’ nhÃ¡Â»â€º lÃ¡ÂºÂ¡i thÃƒÂ´ng tin sÃ¡ÂºÂ½ cÃ¡Â»Â§ng cÃ¡Â»â€˜ cÃƒÂ¡c liÃƒÂªn kÃ¡ÂºÂ¿t thÃ¡ÂºÂ§n kinh, giÃƒÂºp chuyÃ¡Â»Æ’n kiÃ¡ÂºÂ¿n thÃ¡Â»Â©c vÃƒÂ o bÃ¡Â»â„¢ nhÃ¡Â»â€º dÃƒÂ i hÃ¡ÂºÂ¡n. CÃ¡ÂºÂ£m giÃƒÂ¡c khÃƒÂ³ khÃ„Æ’n khi cÃ¡Â»â€˜ gÃ¡ÂºÂ¯ng nhÃ¡Â»â€º chÃƒÂ­nh lÃƒÂ  dÃ¡ÂºÂ¥u hiÃ¡Â»â€¡u cÃ¡Â»Â§a viÃ¡Â»â€¡c hÃ¡Â»Âc tÃ¡ÂºÂ­p hiÃ¡Â»â€¡u quÃ¡ÂºÂ£ Ã„â€˜ang diÃ¡Â»â€¦n ra.</p>
                        <p><strong>80% KÃ¡ÂºÂ¿t quÃ¡ÂºÂ£:</strong> BÃ¡ÂºÂ¡n sÃ¡ÂºÂ½ ghi nhÃ¡Â»â€º kiÃ¡ÂºÂ¿n thÃ¡Â»Â©c sÃƒÂ¢u vÃƒÂ  lÃƒÂ¢u hÃ†Â¡n, Ã„â€˜Ã¡Â»â€œng thÃ¡Â»Âi biÃ¡ÂºÂ¿t chÃƒÂ­nh xÃƒÂ¡c mÃƒÂ¬nh Ã„â€˜ang yÃ¡ÂºÂ¿u Ã¡Â»Å¸ Ã„â€˜ÃƒÂ¢u.</p>
                        <h4>CÃƒÂ¡c PhÃ†Â°Ã†Â¡ng PhÃƒÂ¡p Quan TrÃ¡Â»Âng NhÃ¡ÂºÂ¥t</h4>
                        <ul>
                            <li><strong>TÃ¡Â»Â± KiÃ¡Â»Æ’m Tra (Self-testing):</strong> Thay vÃƒÂ¬ Ã„â€˜Ã¡Â»Âc lÃ¡ÂºÂ¡i ghi chÃƒÂº, hÃƒÂ£y che chÃƒÂºng Ã„â€˜i vÃƒÂ  tÃ¡Â»Â± Ã„â€˜Ã¡ÂºÂ·t cÃƒÂ¢u hÃ¡Â»Âi cho mÃƒÂ¬nh. VÃƒÂ­ dÃ¡Â»Â¥: DÃƒÂ¹ng flashcards (thÃ¡ÂºÂ» ghi nhÃ¡Â»â€º) vÃƒÂ  luÃƒÂ´n trÃ¡ÂºÂ£ lÃ¡Â»Âi trÃ†Â°Ã¡Â»â€ºc khi lÃ¡ÂºÂ­t xem Ã„â€˜ÃƒÂ¡p ÃƒÂ¡n.</li>
                            <li><strong>KÃ¡Â»Â¹ thuÃ¡ÂºÂ­t "Blurting":</strong> Sau khi hÃ¡Â»Âc mÃ¡Â»â„¢t chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â, hÃƒÂ£y Ã„â€˜ÃƒÂ³ng sÃƒÂ¡ch lÃ¡ÂºÂ¡i vÃƒÂ  viÃ¡ÂºÂ¿t ra giÃ¡ÂºÂ¥y mÃ¡Â»Âi thÃ¡Â»Â© bÃ¡ÂºÂ¡n cÃƒÂ³ thÃ¡Â»Æ’ nhÃ¡Â»â€º. Sau Ã„â€˜ÃƒÂ³, so sÃƒÂ¡nh vÃ¡Â»â€ºi tÃƒÂ i liÃ¡Â»â€¡u gÃ¡Â»â€˜c Ã„â€˜Ã¡Â»Æ’ lÃ¡ÂºÂ¥p Ã„â€˜Ã¡ÂºÂ§y nhÃ¡Â»Â¯ng lÃ¡Â»â€” hÃ¡Â»â€¢ng kiÃ¡ÂºÂ¿n thÃ¡Â»Â©c.</li>
                            <li><strong>DÃ¡ÂºÂ¡y lÃ¡ÂºÂ¡i cho ngÃ†Â°Ã¡Â»Âi khÃƒÂ¡c:</strong> GiÃ¡ÂºÂ£i thÃƒÂ­ch mÃ¡Â»â„¢t khÃƒÂ¡i niÃ¡Â»â€¡m cho ngÃ†Â°Ã¡Â»Âi khÃƒÂ¡c buÃ¡Â»â„¢c bÃ¡ÂºÂ¡n phÃ¡ÂºÂ£i truy xuÃ¡ÂºÂ¥t, Ã„â€˜Ã†Â¡n giÃ¡ÂºÂ£n hÃƒÂ³a vÃƒÂ  sÃ¡ÂºÂ¯p xÃ¡ÂºÂ¿p lÃ¡ÂºÂ¡i thÃƒÂ´ng tin mÃ¡Â»â„¢t cÃƒÂ¡ch mÃ¡ÂºÂ¡ch lÃ¡ÂºÂ¡c.</li>
                        </ul>
                        <h4>LÃ¡Â»Â£i ÃƒÂch VÃ†Â°Ã¡Â»Â£t TrÃ¡Â»â„¢i: PhÃƒÂ¡ VÃ¡Â»Â¡ "Ã¡ÂºÂ¢o GiÃƒÂ¡c ThÃƒÂ nh ThÃ¡ÂºÂ¡o"</h4>
                        <p>Sai lÃ¡ÂºÂ§m lÃ¡Â»â€ºn nhÃ¡ÂºÂ¥t cÃ¡Â»Â§a viÃ¡Â»â€¡c hÃ¡Â»Âc thÃ¡Â»Â¥ Ã„â€˜Ã¡Â»â„¢ng lÃƒÂ  nÃƒÂ³ tÃ¡ÂºÂ¡o ra "Ã¡ÂºÂ£o giÃƒÂ¡c vÃ¡Â»Â sÃ¡Â»Â± thÃƒÂ nh thÃ¡ÂºÂ¡o" Ã¢â‚¬â€œ cÃ¡ÂºÂ£m giÃƒÂ¡c quen thuÃ¡Â»â„¢c vÃ¡Â»â€ºi tÃƒÂ i liÃ¡Â»â€¡u nhÃ†Â°ng thÃ¡Â»Â±c chÃ¡ÂºÂ¥t khÃƒÂ´ng thÃ¡Â»Æ’ nhÃ¡Â»â€º lÃ¡ÂºÂ¡i hay giÃ¡ÂºÂ£i thÃƒÂ­ch Ã„â€˜Ã†Â°Ã¡Â»Â£c.</p>
                        <p>GÃ¡Â»Â£i nhÃ¡Â»â€º chÃ¡Â»Â§ Ã„â€˜Ã¡Â»â„¢ng Ã„â€˜ÃƒÂ³ng vai trÃƒÂ² nhÃ†Â° mÃ¡Â»â„¢t cÃƒÂ´ng cÃ¡Â»Â¥ chÃ¡ÂºÂ©n Ã„â€˜oÃƒÂ¡n. MÃ¡Â»â€”i lÃ¡ÂºÂ§n bÃ¡ÂºÂ¡n khÃƒÂ´ng thÃ¡Â»Æ’ nhÃ¡Â»â€º ra Ã„â€˜iÃ¡Â»Âu gÃƒÂ¬, bÃ¡ÂºÂ¡n Ã„â€˜ÃƒÂ£ phÃƒÂ¡t hiÃ¡Â»â€¡n chÃƒÂ­nh xÃƒÂ¡c mÃ¡Â»â„¢t lÃ¡Â»â€” hÃ¡Â»â€¢ng kiÃ¡ÂºÂ¿n thÃ¡Â»Â©c. Ã„ÂiÃ¡Â»Âu nÃƒÂ y cho phÃƒÂ©p bÃ¡ÂºÂ¡n tÃ¡ÂºÂ­p trung ÃƒÂ´n tÃ¡ÂºÂ­p vÃƒÂ o Ã„â€˜ÃƒÂºng Ã„â€˜iÃ¡Â»Æ’m yÃ¡ÂºÂ¿u, thay vÃƒÂ¬ lÃƒÂ£ng phÃƒÂ­ thÃ¡Â»Âi gian xem lÃ¡ÂºÂ¡i nhÃ¡Â»Â¯ng gÃƒÂ¬ Ã„â€˜ÃƒÂ£ biÃ¡ÂºÂ¿t.</p>
                        <p><i>TÃƒÂ³m lÃ¡ÂºÂ¡i: Ã„ÂÃ¡Â»Â«ng chÃ¡Â»â€° Ã„â€˜Ã¡Â»Âc lÃ¡ÂºÂ¡i. HÃƒÂ£y dÃ¡Â»Â«ng lÃ¡ÂºÂ¡i, che tÃƒÂ i liÃ¡Â»â€¡u Ã„â€˜i, vÃƒÂ  tÃ¡Â»Â± hÃ¡Â»Âi: "MÃƒÂ¬nh thÃ¡Â»Â±c sÃ¡Â»Â± nhÃ¡Â»â€º Ã„â€˜Ã†Â°Ã¡Â»Â£c gÃƒÂ¬?"</i></p>
                    </div>
                </details>

                <details class="method-item">
                    <summary>LÃ¡ÂºÂ·p LÃ¡ÂºÂ¡i NgÃ¡ÂºÂ¯t QuÃƒÂ£ng (Spaced Repetition): HÃ¡Â»Âc Ã„ÂÃƒÂºng ThÃ¡Â»Âi Ã„ÂiÃ¡Â»Æ’m</summary>
                    <div class="method-content">
                        <p>NÃ¡ÂºÂ¿u GÃ¡Â»Â£i nhÃ¡Â»â€º chÃ¡Â»Â§ Ã„â€˜Ã¡Â»â„¢ng lÃƒÂ  vÃ¡Â»Â cÃƒÂ¡ch hÃ¡Â»Âc, thÃƒÂ¬ LÃ¡ÂºÂ·p lÃ¡ÂºÂ¡i ngÃ¡ÂºÂ¯t quÃƒÂ£ng lÃƒÂ  vÃ¡Â»Â thÃ¡Â»Âi Ã„â€˜iÃ¡Â»Æ’m hÃ¡Â»Âc. Ã„ÂÃƒÂ¢y lÃƒÂ  mÃ¡Â»â„¢t hÃ¡Â»â€¡ thÃ¡Â»â€˜ng lÃƒÂªn lÃ¡Â»â€¹ch ÃƒÂ´n tÃ¡ÂºÂ­p Ã„â€˜Ã¡Â»Æ’ Ã„â€˜Ã†Â°a thÃƒÂ´ng tin vÃƒÂ o trÃƒÂ­ nhÃ¡Â»â€º dÃƒÂ i hÃ¡ÂºÂ¡n mÃ¡Â»â„¢t cÃƒÂ¡ch hiÃ¡Â»â€¡u quÃ¡ÂºÂ£ nhÃ¡ÂºÂ¥t.</p>
                        <h4>NguyÃƒÂªn TÃ¡ÂºÂ¯c CÃ¡Â»â€˜t LÃƒÂµi: ChÃ¡Â»â€˜ng LÃ¡ÂºÂ¡i SÃ¡Â»Â± LÃƒÂ£ng QuÃƒÂªn Ã°Å¸Â§Â </h4>
                        <p>PhÃ†Â°Ã†Â¡ng phÃƒÂ¡p nÃƒÂ y dÃ¡Â»Â±a trÃƒÂªn "Ã„ÂÃ†Â°Ã¡Â»Âng cong LÃƒÂ£ng quÃƒÂªn", cho thÃ¡ÂºÂ¥y chÃƒÂºng ta quÃƒÂªn thÃƒÂ´ng tin nhanh nhÃ¡ÂºÂ¥t ngay sau khi hÃ¡Â»Âc. LÃ¡ÂºÂ·p lÃ¡ÂºÂ¡i ngÃ¡ÂºÂ¯t quÃƒÂ£ng hoÃ¡ÂºÂ¡t Ã„â€˜Ã¡Â»â„¢ng bÃ¡ÂºÂ±ng cÃƒÂ¡ch yÃƒÂªu cÃ¡ÂºÂ§u bÃ¡ÂºÂ¡n ÃƒÂ´n tÃ¡ÂºÂ­p lÃ¡ÂºÂ¡i mÃ¡Â»â„¢t thÃƒÂ´ng tin ngay trÃ†Â°Ã¡Â»â€ºc khi bÃ¡ÂºÂ¡n sÃ¡ÂºÂ¯p quÃƒÂªn nÃƒÂ³.</p>
                        <p>MÃ¡Â»â€”i lÃ¡ÂºÂ§n ÃƒÂ´n tÃ¡ÂºÂ­p thÃƒÂ nh cÃƒÂ´ng sÃ¡ÂºÂ½ lÃƒÂ m cho khoÃ¡ÂºÂ£ng thÃ¡Â»Âi gian bÃ¡ÂºÂ¡n nhÃ¡Â»â€º thÃƒÂ´ng tin Ã„â€˜ÃƒÂ³ dÃƒÂ i ra. LÃ¡ÂºÂ§n Ã„â€˜Ã¡ÂºÂ§u bÃ¡ÂºÂ¡n cÃƒÂ³ thÃ¡Â»Æ’ quÃƒÂªn sau 1 ngÃƒÂ y, nhÃ†Â°ng sau khi ÃƒÂ´n tÃ¡ÂºÂ­p, bÃ¡ÂºÂ¡n sÃ¡ÂºÂ½ nhÃ¡Â»â€º Ã„â€˜Ã†Â°Ã¡Â»Â£c trong 3 ngÃƒÂ y, rÃ¡Â»â€œi 1 tuÃ¡ÂºÂ§n, 1 thÃƒÂ¡ng, vÃƒÂ  cÃ¡Â»Â© thÃ¡ÂºÂ¿ xa dÃ¡ÂºÂ§n.</p>
                        <h4>CÃƒÂ´ng CÃ¡Â»Â¥ HiÃ¡Â»â€¡u QuÃ¡ÂºÂ£ NhÃ¡ÂºÂ¥t: PhÃ¡ÂºÂ§n MÃ¡Â»Âm SRS Ã°Å¸â€œÂ±</h4>
                        <p>Thay vÃƒÂ¬ tÃ¡Â»Â± lÃƒÂªn lÃ¡Â»â€¹ch thÃ¡Â»Â§ cÃƒÂ´ng, cÃƒÂ¡ch hiÃ¡Â»â€¡u quÃ¡ÂºÂ£ nhÃ¡ÂºÂ¥t lÃƒÂ  sÃ¡Â»Â­ dÃ¡Â»Â¥ng cÃƒÂ¡c phÃ¡ÂºÂ§n mÃ¡Â»Âm LÃ¡ÂºÂ·p lÃ¡ÂºÂ¡i ngÃ¡ÂºÂ¯t quÃƒÂ£ng (Spaced Repetition Software - SRS). Anki Ã„â€˜Ã†Â°Ã¡Â»Â£c xem lÃƒÂ  tiÃƒÂªu chuÃ¡ÂºÂ©n vÃƒÂ ng. NÃƒÂ³ tÃ¡Â»Â± Ã„â€˜Ã¡Â»â„¢ng hÃƒÂ³a hoÃƒÂ n toÃƒÂ n viÃ¡Â»â€¡c lÃƒÂªn lÃ¡Â»â€¹ch ÃƒÂ´n tÃ¡ÂºÂ­p cho hÃƒÂ ng ngÃƒÂ n thÃ¡ÂºÂ» ghi nhÃ¡Â»â€º dÃ¡Â»Â±a trÃƒÂªn Ã„â€˜Ã¡Â»â„¢ khÃƒÂ³ mÃƒÂ  bÃ¡ÂºÂ¡n tÃ¡Â»Â± Ã„â€˜ÃƒÂ¡nh giÃƒÂ¡, Ã„â€˜Ã¡ÂºÂ£m bÃ¡ÂºÂ£o bÃ¡ÂºÂ¡n luÃƒÂ´n ÃƒÂ´n tÃ¡ÂºÂ­p vÃƒÂ o thÃ¡Â»Âi Ã„â€˜iÃ¡Â»Æ’m tÃ¡Â»â€˜i Ã†Â°u nhÃ¡ÂºÂ¥t.</p>
                        <h4>Sai LÃ¡ÂºÂ§m LÃ¡Â»â€ºn NhÃ¡ÂºÂ¥t CÃ¡ÂºÂ§n TrÃƒÂ¡nh Ã¢ÂÅ’</h4>
                        <p>LÃƒÂ½ do sÃ¡Â»â€˜ mÃ¡Â»â„¢t khiÃ¡ÂºÂ¿n mÃ¡Â»Âi ngÃ†Â°Ã¡Â»Âi thÃ¡ÂºÂ¥t bÃ¡ÂºÂ¡i vÃ¡Â»â€ºi phÃ†Â°Ã†Â¡ng phÃƒÂ¡p nÃƒÂ y lÃƒÂ  "QuÃƒÂ¡ tÃ¡ÂºÂ£i LÃ¡Â»â€¹ch ÃƒÂ´n tÃ¡ÂºÂ­p" (Review Overload). Ã„ÂiÃ¡Â»Âu nÃƒÂ y xÃ¡ÂºÂ£y ra khi bÃ¡ÂºÂ¡n tÃ¡ÂºÂ¡o quÃƒÂ¡ nhiÃ¡Â»Âu thÃ¡ÂºÂ» mÃ¡Â»â€ºi mÃ¡Â»â€”i ngÃƒÂ y hoÃ¡ÂºÂ·c bÃ¡Â»Â lÃ¡Â»Â¡ vÃƒÂ i ngÃƒÂ y ÃƒÂ´n tÃ¡ÂºÂ­p, dÃ¡ÂºÂ«n Ã„â€˜Ã¡ÂºÂ¿n mÃ¡Â»â„¢t lÃ†Â°Ã¡Â»Â£ng thÃ¡ÂºÂ» tÃ¡Â»â€œn Ã„â€˜Ã¡Â»Âng khÃ¡Â»â€¢ng lÃ¡Â»â€œ gÃƒÂ¢y nÃ¡ÂºÂ£n chÃƒÂ­.</p>
                        <p><strong>GiÃ¡ÂºÂ£i phÃƒÂ¡p (20% hÃƒÂ nh Ã„â€˜Ã¡Â»â„¢ng, 80% kÃ¡ÂºÂ¿t quÃ¡ÂºÂ£):</strong> HÃƒÂ£y nhÃ¡ÂºÂ¥t quÃƒÂ¡n. Ã„ÂÃ¡ÂºÂ·t ra giÃ¡Â»â€ºi hÃ¡ÂºÂ¡n thÃ¡Â»Â±c tÃ¡ÂºÂ¿ vÃ¡Â»Â sÃ¡Â»â€˜ lÃ†Â°Ã¡Â»Â£ng thÃ¡ÂºÂ» mÃ¡Â»â€ºi mÃ¡Â»â€”i ngÃƒÂ y (vÃƒÂ­ dÃ¡Â»Â¥: 10-20 thÃ¡ÂºÂ») vÃƒÂ  duy trÃƒÂ¬ viÃ¡Â»â€¡c ÃƒÂ´n tÃ¡ÂºÂ­p hÃƒÂ ng ngÃƒÂ y. ThÃƒÂ  hÃ¡Â»Âc ÃƒÂ­t mÃƒÂ  Ã„â€˜Ã¡Â»Âu cÃƒÂ²n hÃ†Â¡n hÃ¡Â»Âc dÃ¡Â»â€œn.</p>
                        <h4>SÃ¡Â»Â± KÃ¡ÂºÂ¿t HÃ¡Â»Â£p SÃ¡Â»â€˜ng CÃƒÂ²n: AR + SR</h4>
                        <p>LÃ¡ÂºÂ·p lÃ¡ÂºÂ¡i ngÃ¡ÂºÂ¯t quÃƒÂ£ng (SR) vÃƒÂ  GÃ¡Â»Â£i nhÃ¡Â»â€º chÃ¡Â»Â§ Ã„â€˜Ã¡Â»â„¢ng (AR) lÃƒÂ  hai mÃ¡ÂºÂ·t cÃ¡Â»Â§a cÃƒÂ¹ng mÃ¡Â»â„¢t Ã„â€˜Ã¡Â»â€œng xu vÃƒÂ  khÃƒÂ´ng thÃ¡Â»Æ’ tÃƒÂ¡ch rÃ¡Â»Âi. SR cung cÃ¡ÂºÂ¥p lÃ¡Â»â€¹ch trÃƒÂ¬nh KHI NÃƒâ‚¬O nÃƒÂªn ÃƒÂ´n tÃ¡ÂºÂ­p. AR lÃƒÂ  hÃƒÂ nh Ã„â€˜Ã¡Â»â„¢ng bÃ¡ÂºÂ¡n thÃ¡Â»Â±c hiÃ¡Â»â€¡n KHI ÃƒÂ´n tÃ¡ÂºÂ­p. SÃ¡Â»Â± kÃ¡ÂºÂ¿t hÃ¡Â»Â£p nÃƒÂ y Ã„â€˜Ã¡ÂºÂ£m bÃ¡ÂºÂ£o nÃ¡Â»â€” lÃ¡Â»Â±c gÃ¡Â»Â£i nhÃ¡Â»â€º cÃ¡Â»Â§a bÃ¡ÂºÂ¡n xÃ¡ÂºÂ£y ra vÃƒÂ o "Ã„â€˜iÃ¡Â»Æ’m ngÃ¡Â»Ât" cÃ¡Â»Â§a trÃƒÂ­ nhÃ¡Â»â€º. SÃ¡Â»Â­ dÃ¡Â»Â¥ng Anki chÃƒÂ­nh lÃƒÂ  cÃƒÂ¡ch triÃ¡Â»Æ’n khai kÃ¡Â»Â¹ thuÃ¡ÂºÂ­t kÃ¡ÂºÂ¿t hÃ¡Â»Â£p nÃƒÂ y mÃ¡Â»â„¢t cÃƒÂ¡ch hiÃ¡Â»â€¡u quÃ¡ÂºÂ£ nhÃ¡ÂºÂ¥t.</p>
                    </div>
                </details>
            </div>
        </div>
      </div>

      <div id="view-guide" class="view">
        <div class="panel panel-bg">
            <h3 style="margin-top: 0;">Ã°Å¸â€œâ€“ KhÃƒÂ¡m PhÃƒÂ¡ Pomodoro Study App</h3>
            <p>
                ChÃƒÂ o mÃ¡Â»Â«ng bÃ¡ÂºÂ¡n Ã„â€˜Ã¡ÂºÂ¿n vÃ¡Â»â€ºi khÃƒÂ´ng gian hÃ¡Â»Âc tÃ¡ÂºÂ­p Ã„â€˜Ã†Â°Ã¡Â»Â£c thiÃ¡ÂºÂ¿t kÃ¡ÂºÂ¿ dÃƒÂ nh riÃƒÂªng cho sÃ¡Â»Â± tÃ¡ÂºÂ­p trung vÃƒÂ  hiÃ¡Â»â€¡u quÃ¡ÂºÂ£. HÃƒÂ£y cÃƒÂ¹ng khÃƒÂ¡m phÃƒÂ¡ nhÃ¡Â»Â¯ng tÃƒÂ­nh nÃ„Æ’ng sÃ¡ÂºÂ½ Ã„â€˜Ã¡Â»â€œng hÃƒÂ nh cÃƒÂ¹ng bÃ¡ÂºÂ¡n trÃƒÂªn hÃƒÂ nh trÃƒÂ¬nh chinh phÃ¡Â»Â¥c tri thÃ¡Â»Â©c.
            </p>

            <h4>Ã°Å¸Å¡â‚¬ KhÃ¡Â»Å¸i Ã„ÂÃ¡ÂºÂ§u Nhanh ChÃ¡Â»â€° Trong 4 BÃ†Â°Ã¡Â»â€ºc</h4>
            <p>Ã„ÂÃ¡Â»Æ’ hÃƒÂ nh trÃƒÂ¬nh cÃ¡Â»Â§a bÃ¡ÂºÂ¡n luÃƒÂ´n mÃ¡ÂºÂ¡ch lÃ¡ÂºÂ¡c, mÃ¡Â»Âi thÃ¡Â»Â© trong Ã¡Â»Â©ng dÃ¡Â»Â¥ng Ã„â€˜Ã†Â°Ã¡Â»Â£c sÃ¡ÂºÂ¯p xÃ¡ÂºÂ¿p theo cÃ¡ÂºÂ¥u trÃƒÂºc <strong>ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â LÃ¡Â»â€ºn Ã¢â€ â€™ ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con</strong>.</p>
            <ol>
                <li>MÃ¡Â»Å¸ mÃ¡Â»Â¥c <strong>Ã°Å¸â€œÅ¡ ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â</strong> tÃ¡Â»Â« thanh Ã„â€˜iÃ¡Â»Âu hÃ†Â°Ã¡Â»â€ºng bÃƒÂªn cÃ¡ÂºÂ¡nh.</li>
                <li>NhÃ¡ÂºÂ¥n <strong>Ã¯Â¼â€¹ ThÃƒÂªm ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â</strong> Ã„â€˜Ã¡Â»Æ’ tÃ¡ÂºÂ¡o mÃ¡Â»â„¢t lÃ„Â©nh vÃ¡Â»Â±c lÃ¡Â»â€ºn (vÃƒÂ­ dÃ¡Â»Â¥: "TiÃ¡ÂºÂ¿ng Anh Giao TiÃ¡ÂºÂ¿p").</li>
                <li>BÃƒÂªn cÃ¡ÂºÂ¡nh chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â vÃ¡Â»Â«a tÃ¡ÂºÂ¡o, nhÃ¡ÂºÂ¥n <strong>Ã¯Â¼â€¹ ThÃƒÂªm</strong> Ã„â€˜Ã¡Â»Æ’ tÃ¡ÂºÂ¡o mÃ¡Â»â„¢t chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con, chi tiÃ¡ÂºÂ¿t hÃ†Â¡n (vÃƒÂ­ dÃ¡Â»Â¥: "BÃƒÂ i 1: LuyÃ¡Â»â€¡n phÃƒÂ¡t ÃƒÂ¢m IPA").</li>
                <li>ChÃ¡Â»Ân chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con Ã„â€˜ÃƒÂ³. GiÃ¡Â»Â Ã„â€˜ÃƒÂ¢y, bÃ¡ÂºÂ¡n Ã„â€˜ÃƒÂ£ sÃ¡ÂºÂµn sÃƒÂ ng Ã„â€˜Ã¡Â»Æ’ bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u phiÃƒÂªn hÃ¡Â»Âc Ã„â€˜Ã¡ÂºÂ§u tiÃƒÂªn cÃ¡Â»Â§a mÃƒÂ¬nh!</li>
            </ol>

            <hr />
            <h4>Ã¢Å“Â¨ NhÃ¡Â»Â¯ng TÃƒÂ­nh NÃ„Æ’ng Ã„ÂÃƒÂ¡ng ChÃƒÂº ÃƒÂ</h4>

            <h4>PhÃ†Â°Ã†Â¡ng PhÃƒÂ¡p HÃ¡Â»Âc TÃ¡ÂºÂ­p Ã°Å¸â€™Â¡</h4>
            <p>KhÃƒÂ´ng chÃ¡Â»â€° lÃƒÂ  mÃ¡Â»â„¢t chiÃ¡ÂºÂ¿c Ã„â€˜Ã¡Â»â€œng hÃ¡Â»â€œ, Ã¡Â»Â©ng dÃ¡Â»Â¥ng cÃƒÂ²n lÃƒÂ  mÃ¡Â»â„¢t ngÃ†Â°Ã¡Â»Âi cÃ¡Â»â€˜ vÃ¡ÂºÂ¥n. KhÃƒÂ¡m phÃƒÂ¡ cÃƒÂ¡c phÃ†Â°Ã†Â¡ng phÃƒÂ¡p hÃ¡Â»Âc tÃ¡ÂºÂ­p kinh Ã„â€˜iÃ¡Â»Æ’n nhÃ†Â° Feynman, GÃ¡Â»Â£i NhÃ¡Â»â€º ChÃ¡Â»Â§ Ã„ÂÃ¡Â»â„¢ng (Active Recall)... Ã„â€˜Ã¡Â»Æ’ tÃ¡Â»â€˜i Ã†Â°u hÃƒÂ³a khÃ¡ÂºÂ£ nÃ„Æ’ng tiÃ¡ÂºÂ¿p thu cÃ¡Â»Â§a bÃ¡ÂºÂ¡n.</p>

            <h4>QuÃ¡ÂºÂ£n LÃƒÂ½ ChÃ¡Â»Â§ Ã„ÂÃ¡Â»Â Linh HoÃ¡ÂºÂ¡t (Organizer)</h4>
            <p>DÃ¡Â»â€¦ dÃƒÂ ng sÃ¡ÂºÂ¯p xÃ¡ÂºÂ¿p cÃƒÂ¡c mÃ¡Â»Â¥c tiÃƒÂªu hÃ¡Â»Âc tÃ¡ÂºÂ­p cÃ¡Â»Â§a bÃ¡ÂºÂ¡n. KÃƒÂ©o vÃƒÂ  thÃ¡ÂºÂ£ Ã„â€˜Ã¡Â»Æ’ thay Ã„â€˜Ã¡Â»â€¢i thÃ¡Â»Â© tÃ¡Â»Â± cÃƒÂ¡c chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â lÃ¡Â»â€ºn hoÃ¡ÂºÂ·c di chuyÃ¡Â»Æ’n mÃ¡Â»â„¢t chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con sang mÃ¡Â»â„¢t lÃ„Â©nh vÃ¡Â»Â±c mÃ¡Â»â€ºi.</p>

            <h4>NhiÃ¡Â»â€¡m VÃ¡Â»Â¥ & Ghi ChÃƒÂº TÃƒÂ­ch HÃ¡Â»Â£p Ã°Å¸â€œÂ</h4>
            <p>Ngay trong mÃƒÂ n hÃƒÂ¬nh Ã„â€˜Ã¡Â»â€œng hÃ¡Â»â€œ, bÃ¡ÂºÂ¡n cÃƒÂ³ thÃ¡Â»Æ’ tÃ¡ÂºÂ¡o danh sÃƒÂ¡ch viÃ¡Â»â€¡c cÃ¡ÂºÂ§n lÃƒÂ m (to-do) cho tÃ¡Â»Â«ng chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con hoÃ¡ÂºÂ·c ghi lÃ¡ÂºÂ¡i nhÃ¡Â»Â¯ng ÃƒÂ½ tÃ†Â°Ã¡Â»Å¸ng chÃ¡Â»Â£t nÃ¡ÂºÂ£y ra mÃƒÂ  khÃƒÂ´ng lÃƒÂ m giÃƒÂ¡n Ã„â€˜oÃ¡ÂºÂ¡n dÃƒÂ²ng chÃ¡ÂºÂ£y cÃƒÂ´ng viÃ¡Â»â€¡c.</p>

            <h4>ChÃ¡ÂºÂ¿ Ã„ÂÃ¡Â»â„¢ Zen Ã°Å¸Â§Ëœ</h4>
            <p>Khi cÃ¡ÂºÂ§n tÃ¡ÂºÂ­p trung tuyÃ¡Â»â€¡t Ã„â€˜Ã¡Â»â€˜i, hÃƒÂ£y nhÃ¡ÂºÂ¥n vÃƒÂ o biÃ¡Â»Æ’u tÃ†Â°Ã¡Â»Â£ng con mÃ¡ÂºÂ¯t (Ã°Å¸â€˜ÂÃ¯Â¸Â) Ã¡Â»Å¸ gÃƒÂ³c trÃƒÂªn bÃƒÂªn phÃ¡ÂºÂ£i. Giao diÃ¡Â»â€¡n sÃ¡ÂºÂ½ Ã¡ÂºÂ©n Ã„â€˜i, chÃ¡Â»â€° Ã„â€˜Ã¡Â»Æ’ lÃ¡ÂºÂ¡i hÃƒÂ¬nh nÃ¡Â»Ân vÃƒÂ  chiÃ¡ÂºÂ¿c Ã„â€˜Ã¡Â»â€œng hÃ¡Â»â€œ tinh gÃ¡Â»Ân, giÃƒÂºp bÃ¡ÂºÂ¡n hoÃƒÂ n toÃƒÂ n Ã„â€˜Ã¡ÂºÂ¯m mÃƒÂ¬nh vÃƒÂ o khÃƒÂ´ng gian hÃ¡Â»Âc tÃ¡ÂºÂ­p.</p>

            <h4>ThÃ¡Â»â€˜ng KÃƒÂª & CÃ¡Â»â„¢t MÃ¡Â»â€˜c Ã°Å¸Ââ€ </h4>
            <p>Theo dÃƒÂµi hÃƒÂ nh trÃƒÂ¬nh cÃ¡Â»Â§a bÃ¡ÂºÂ¡n qua nhÃ¡Â»Â¯ng con sÃ¡Â»â€˜ biÃ¡ÂºÂ¿t nÃƒÂ³i. Ã¡Â»Â¨ng dÃ¡Â»Â¥ng sÃ¡ÂºÂ½ tÃ¡Â»Â± Ã„â€˜Ã¡Â»â„¢ng ghi nhÃ¡ÂºÂ­n vÃƒÂ  chÃƒÂºc mÃ¡Â»Â«ng khi bÃ¡ÂºÂ¡n Ã„â€˜Ã¡ÂºÂ¡t Ã„â€˜Ã†Â°Ã¡Â»Â£c nhÃ¡Â»Â¯ng cÃ¡Â»â„¢t mÃ¡Â»â€˜c quan trÃ¡Â»Âng (20 giÃ¡Â»Â, 100 giÃ¡Â»Â hÃ¡Â»Âc...), biÃ¡ÂºÂ¿n mÃ¡Â»â€”i nÃ¡Â»â€” lÃ¡Â»Â±c thÃƒÂ nh mÃ¡Â»â„¢t thÃƒÂ nh tÃ¡Â»Â±u Ã„â€˜ÃƒÂ¡ng tÃ¡Â»Â± hÃƒÂ o.</p>

            <hr />
            <h4>Ã¢Å’Â¨Ã¯Â¸Â PhÃƒÂ­m TÃ¡ÂºÂ¯t ThÃƒÂ´ng Minh</h4>
            <ul>
                <li><kbd>Space</kbd>: BÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u / TÃ¡ÂºÂ¡m dÃ¡Â»Â«ng / TiÃ¡ÂºÂ¿p tÃ¡Â»Â¥c phiÃƒÂªn hÃ¡Â»Âc.</li>
                <li><kbd>N</kbd>: BÃ¡Â»Â qua phiÃƒÂªn lÃƒÂ m viÃ¡Â»â€¡c hoÃ¡ÂºÂ·c nghÃ¡Â»â€° hiÃ¡Â»â€¡n tÃ¡ÂºÂ¡i.</li>
                <li><kbd>Esc</kbd>: Ã„ÂÃƒÂ³ng cÃƒÂ¡c cÃ¡Â»Â­a sÃ¡Â»â€¢ Ã„â€˜ang mÃ¡Â»Å¸ (nhÃ†Â° CÃƒÂ i Ã„â€˜Ã¡ÂºÂ·t).</li>
            </ul>

            <hr />
            <h4>Ã°Å¸â€ºÂ Ã¯Â¸Â CÃƒÂ i Ã„ÂÃ¡ÂºÂ·t NÃƒÂ¢ng Cao & TÃƒÂ­ch HÃ¡Â»Â£p</h4>

            <h4>TrÃ¡Â»Â£ LÃƒÂ½ Gemini AI Ã°Å¸Â§Â </h4>
            <p>BiÃ¡ÂºÂ¿n Ã¡Â»Â©ng dÃ¡Â»Â¥ng thÃƒÂ nh mÃ¡Â»â„¢t ngÃ†Â°Ã¡Â»Âi bÃ¡ÂºÂ¡n Ã„â€˜Ã¡Â»â€œng hÃƒÂ nh thÃƒÂ´ng minh. HÃ¡Â»Âi Ã„â€˜ÃƒÂ¡p, giÃ¡ÂºÂ£i thÃƒÂ­ch khÃƒÂ¡i niÃ¡Â»â€¡m, hoÃ¡ÂºÂ·c tÃ¡ÂºÂ¡o dÃƒÂ n ÃƒÂ½ cho chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â hÃ¡Â»Âc ngay trong tab "Gemini AI".</p>
            <p><strong>ThiÃ¡ÂºÂ¿t lÃ¡ÂºÂ­p:</strong></p>
            <ol>
                <li>Truy cÃ¡ÂºÂ­p Google AI Studio vÃƒÂ  tÃ¡ÂºÂ¡o mÃ¡Â»â„¢t API Key mÃ¡Â»â€ºi (miÃ¡Â»â€¦n phÃƒÂ­).</li>
                <li>Sao chÃƒÂ©p chuÃ¡Â»â€”i kÃƒÂ½ tÃ¡Â»Â± API Key Ã„â€˜ÃƒÂ³.</li>
                <li>DÃƒÂ¡n vÃƒÂ o ÃƒÂ´ "Gemini API Key" trong CÃƒÂ i Ã„â€˜Ã¡ÂºÂ·t cÃ¡Â»Â§a Ã¡Â»Â©ng dÃ¡Â»Â¥ng vÃƒÂ  LÃ†Â°u lÃ¡ÂºÂ¡i.</li>
            </ol>

            <h4>NhÃ¡ÂºÂ¡c NÃ¡Â»Ân YouTube Ã°Å¸Å½Â¶</h4>
            <p>TÃ¡ÂºÂ¡o khÃƒÂ´ng gian hÃ¡Â»Âc tÃ¡ÂºÂ­p hoÃƒÂ n hÃ¡ÂºÂ£o bÃ¡ÂºÂ±ng cÃƒÂ¡ch phÃƒÂ¡t mÃ¡Â»â„¢t video hoÃ¡ÂºÂ·c danh sÃƒÂ¡ch phÃƒÂ¡t YouTube (nhÃ†Â° nhÃ¡ÂºÂ¡c lofi, ÃƒÂ¢m thanh thiÃƒÂªn nhiÃƒÂªn) lÃƒÂ m nhÃ¡ÂºÂ¡c nÃ¡Â»Ân.</p>
            <p><strong>SÃ¡Â»Â­ dÃ¡Â»Â¥ng:</strong> DÃƒÂ¡n Ã„â€˜Ã†Â°Ã¡Â»Âng dÃ¡ÂºÂ«n (URL) video/playlist vÃƒÂ o ÃƒÂ´ "NhÃ¡ÂºÂ¡c nÃ¡Â»Ân YouTube".</p>
            <p><strong>TÃƒÂ¹y chÃ¡Â»Ân:</strong> TÃƒÂ­ch vÃƒÂ o ÃƒÂ´ "DÃƒÂ¹ng Ã¡ÂºÂ£nh bÃƒÂ¬a video lÃƒÂ m nÃ¡Â»Ân" Ã„â€˜Ã¡Â»Æ’ tÃ¡Â»Â± Ã„â€˜Ã¡Â»â„¢ng biÃ¡ÂºÂ¿n khÃƒÂ´ng gian hÃ¡Â»Âc tÃ¡ÂºÂ­p cÃ¡Â»Â§a bÃ¡ÂºÂ¡n trÃ¡Â»Å¸ nÃƒÂªn sÃ¡Â»â€˜ng Ã„â€˜Ã¡Â»â„¢ng hÃ†Â¡n.</p>

            <h4>An ToÃƒÂ n DÃ¡Â»Â¯ LiÃ¡Â»â€¡u: Sao LÃ†Â°u & PhÃ¡Â»Â¥c HÃ¡Â»â€œi Ã°Å¸â€ºÂ¡Ã¯Â¸Â</h4>
            <p>ChÃƒÂºng tÃƒÂ´i hiÃ¡Â»Æ’u rÃ¡ÂºÂ±ng dÃ¡Â»Â¯ liÃ¡Â»â€¡u hÃ¡Â»Âc tÃ¡ÂºÂ­p cÃ¡Â»Â§a bÃ¡ÂºÂ¡n lÃƒÂ  vÃƒÂ´ giÃƒÂ¡. Ã¡Â»Â¨ng dÃ¡Â»Â¥ng tÃ¡Â»Â± Ã„â€˜Ã¡Â»â„¢ng tÃ¡ÂºÂ¡o mÃ¡Â»â„¢t bÃ¡ÂºÂ£n sao lÃ†Â°u tiÃ¡ÂºÂ¿n trÃƒÂ¬nh cÃ¡Â»Â§a bÃ¡ÂºÂ¡n mÃ¡Â»â€”i ngÃƒÂ y Ã„â€˜Ã¡Â»Æ’ Ã„â€˜Ã¡ÂºÂ£m bÃ¡ÂºÂ£o khÃƒÂ´ng cÃƒÂ³ gÃƒÂ¬ bÃ¡Â»â€¹ mÃ¡ÂºÂ¥t.</p>
            <p><strong>TÃƒÂ¹y ChÃ¡Â»â€°nh Sao LÃ†Â°u:</strong> Ã„ÂÃ¡Â»Æ’ bÃ¡ÂºÂ¡n cÃƒÂ³ toÃƒÂ n quyÃ¡Â»Ân kiÃ¡Â»Æ’m soÃƒÂ¡t, Ã¡Â»Â©ng dÃ¡Â»Â¥ng cho phÃƒÂ©p tÃƒÂ¹y chÃ¡Â»â€°nh sÃ¡Â»â€˜ ngÃƒÂ y lÃ†Â°u giÃ¡Â»Â¯ cÃƒÂ¡c bÃ¡ÂºÂ£n sao lÃ†Â°u. BÃ¡ÂºÂ¡n cÃƒÂ³ thÃ¡Â»Æ’ thay Ã„â€˜Ã¡Â»â€¢i thiÃ¡ÂºÂ¿t lÃ¡ÂºÂ­p nÃƒÂ y (tÃ¡Â»Â« 1 Ã„â€˜Ã¡ÂºÂ¿n 30 ngÃƒÂ y) trong mÃ¡Â»Â¥c "CÃƒÂ i Ã„â€˜Ã¡ÂºÂ·t sao lÃ†Â°u". MÃ¡ÂºÂ·c Ã„â€˜Ã¡Â»â€¹nh lÃƒÂ  7 ngÃƒÂ y, mÃ¡Â»â„¢t sÃ¡Â»Â± cÃƒÂ¢n bÃ¡ÂºÂ±ng hÃ¡Â»Â£p lÃƒÂ½ giÃ¡Â»Â¯a an toÃƒÂ n vÃƒÂ  dung lÃ†Â°Ã¡Â»Â£ng.</p>
            <p><strong>PhÃ¡Â»Â¥c HÃ¡Â»â€œi DÃ¡Â»Â¯ LiÃ¡Â»â€¡u:</strong> NÃ¡ÂºÂ¿u bÃ¡ÂºÂ¡n vÃƒÂ´ tÃƒÂ¬nh xÃƒÂ³a nhÃ¡ÂºÂ§m, hÃƒÂ£y vÃƒÂ o mÃ¡Â»Â¥c "PhÃ¡Â»Â¥c hÃ¡Â»â€œi dÃ¡Â»Â¯ liÃ¡Â»â€¡u", chÃ¡Â»Ân mÃ¡Â»â„¢t ngÃƒÂ y trong quÃƒÂ¡ khÃ¡Â»Â© vÃƒÂ  nhÃ¡ÂºÂ¥n "PhÃ¡Â»Â¥c hÃ¡Â»â€œi".</p>
            <p>Ã¢Å¡Â Ã¯Â¸Â <strong>CÃ¡ÂºÂ£nh bÃƒÂ¡o quan trÃ¡Â»Âng:</strong> HÃƒÂ nh Ã„â€˜Ã¡Â»â„¢ng nÃƒÂ y sÃ¡ÂºÂ½ ghi Ã„â€˜ÃƒÂ¨ toÃƒÂ n bÃ¡Â»â„¢ dÃ¡Â»Â¯ liÃ¡Â»â€¡u hiÃ¡Â»â€¡n tÃ¡ÂºÂ¡i cÃ¡Â»Â§a bÃ¡ÂºÂ¡n bÃ¡ÂºÂ±ng dÃ¡Â»Â¯ liÃ¡Â»â€¡u tÃ¡Â»Â« bÃ¡ÂºÂ£n sao lÃ†Â°u. HÃƒÂ£y chÃ¡ÂºÂ¯c chÃ¡ÂºÂ¯n trÃ†Â°Ã¡Â»â€ºc khi thÃ¡Â»Â±c hiÃ¡Â»â€¡n.</p>

            
        </div>
      </div>
    </main>
  </div>

  <div class="modal" id="modalMilestone" role="dialog" aria-modal="true" aria-labelledby="milestoneTitle">
    <div class="modal-card" style="width: min(600px, 94vw);">
        <h3 id="milestoneTitle">Ã°Å¸Å½â€° ChÃƒÂºc mÃ¡Â»Â«ng BÃ¡ÂºÂ¡n!</h3>
        <p id="milestoneMessage" style="white-space: pre-wrap; line-height: 1.6;"></p>
        <div class="row" style="justify-content:flex-end; margin-top:12px">
            <button class="btn acc" id="btnMilestoneClose">TiÃ¡ÂºÂ¿p tÃ¡Â»Â¥c hÃƒÂ nh trÃƒÂ¬nh!</button>
        </div>
    </div>
  </div>
  <div class="modal" id="modalSettings" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-card">
          <h3 id="settingsTitle">âš™ï¸ CÃ i Ä‘áº·t</h3>
          <nav class="tab-nav">
              <button class="tab-btn active" data-tab="settings-timer">Äá»“ng há»“</button>
              <button class="tab-btn" data-tab="settings-ui">Giao diá»‡n & Ã‚m thanh</button>
              <button class="tab-btn" data-tab="settings-integrations">TÃ­ch há»£p</button>
          </nav>
          <div class="settings-content">
              <div id="settings-timer" class="tab-content active" style="flex-direction:column; gap:20px;">
                  <div>
                      <h4>Thá»i lÆ°á»£ng Pomodoro</h4>
                      <div class="row" id="timerPresetSelector" style="margin-bottom:16px;">
                          <button class="btn acc" data-preset-target="A"> Kiá»ƒu A </button>
                          <button class="btn ghost" data-preset-target="B"> Kiá»ƒu B </button>
                      </div>
                      <div class="row">
                          <label>LÃƒâ‚¬M VIÃ¡Â»â€ C (phÃƒÂºt)<input type="number" id="set_work" min="1" /></label>
                          <label>NGHÃ¡Â»Ë† NGÃ¡ÂºÂ®N (phÃƒÂºt)<input type="number" id="set_short" min="1" /></label>
                          <label>NGHÃ¡Â»Ë† DÃƒâ‚¬I (phÃƒÂºt)<input type="number" id="set_long" min="1" /></label>
                      </div>
                      <div class="row">
                          <label>Chu ká»³ Pomodoro<input type="number" id="set_cycles" min="1" /></label>
                          <label>Chu ká»³ nghá»‰ dÃ i<input type="number" id="set_interval" min="2" /></label>
                      </div>
                  </div>
                      <div class="settings-row-toggle">
                          <label for="set_autoStartNext">TÃ¡Â»Â± Ã„â€˜Ã¡Â»â„¢ng bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u phiÃƒÂªn tiÃ¡ÂºÂ¿p theo</label>
                          <label class="toggle-switch">
                              <input type="checkbox" id="set_autoStartNext">
                              <span class="slider"></span>
                          </label>
                      </div>
              </div>
              <div id="settings-ui" class="tab-content" style="flex-direction: column; gap: 20px;">
                  <div>
                      <h4>Giao diá»‡n</h4>
                      <div class="row">
                          <label>Theme Giao Diá»‡n
                                <select id="set_theme_color">
                                    <option value="default">Máº·c Ä‘á»‹nh (Dark Blue)</option>
                                    <option value="light">Light - TrÃ  Sá»¯a</option>
                                    <option value="pastel">Pastel - Dá»… thÆ°Æ¡ng</option>
                                    <option value="lofi">Lofi Study Room</option>
                                    <option value="space">Space Station</option>
                                </select>
                          </label>
                      </div>
                      <div class="row">
                          <label>HÃ¬nh ná»n
                              <label class="btn small ghost" for="uploadBg">Táº£i áº£nh má»›i</label>
                              <input type="file" id="uploadBg" accept="image/*" class="hidden" />
                          </label>
                          <button class="btn small danger" id="btnClearBg">XÃ³a ná»n</button>
                      </div>
                      <div class="row">
                          <label style="flex: 1;">Äá»™ trong suá»‘t cá»§a ná»n</label>
                          <input type="range" id="set_panelOpacity" min="0.1" max="1" step="0.05" style="flex: 2;">
                      </div>
                      
                   </div>
                  
                   <div>
                       <h4>Ã‚m thanh</h4>
                      <div class="row">
                          <label>Ã‚m lÆ°á»£ng (0â€“1)<input type="number" id="set_volume" step="0.05" min="0" max="1"/></label>
                          <label>Kiá»ƒu Ã¢m bÃ¡o
                              <select id="set_theme">
                                  <option value="beep">Beep</option>
                                  <option value="chime">Chime</option>
                              </select>
                          </label>
                           <button class="btn" id="btnTestSound" style="flex: 0 1 auto; align-self: center;">Test</button>
                      </div>
                      <div style="text-align: right; margin-top: 12px;">
                          <button class="btn ghost small" id="btnToggleCustomSounds">TÃƒÂ¹y chÃ¡Â»â€°nh ÃƒÂ¢m bÃƒÂ¡o</button>
                      </div>

                      <div id="customSoundsContainer" class="hidden" style="margin-top: 8px;">
                      <div class="row" style="display: flex; gap: 8px; justify-content: flex-end;">
                          <div>
                              <small>Ãƒâ€šm bÃƒÂ¡o hÃ¡ÂºÂ¿t LÃƒâ‚¬M VIÃ¡Â»â€ C</small>
                              <label title="Ãƒâ€šm bÃƒÂ¡o hÃ¡ÂºÂ¿t LÃƒâ‚¬M VIÃ¡Â»â€ C" class="btn small ghost" for="uploadSoundWork">LÃƒâ‚¬M VIÃ¡Â»â€ C</label>
                              <input type="file" id="uploadSoundWork" accept="audio/*" class="hidden" />
                          </div>
                          <div>
                              <small>Ãƒâ€šm bÃƒÂ¡o hÃ¡ÂºÂ¿t NGHÃ¡Â»Ë† NGÃ¡ÂºÂ®N</small>
                              <label title="Ãƒâ€šm bÃƒÂ¡o hÃ¡ÂºÂ¿t NGHÃ¡Â»Ë† NGÃ¡ÂºÂ®N" class="btn small ghost" for="uploadSoundBreak">NGHÃ¡Â»Ë† NGÃ¡ÂºÂ®N</label>
                              <input type="file" id="uploadSoundBreak" accept="audio/*" class="hidden" />
                          </div>
                          <div>
                              <small>Ãƒâ€šm bÃƒÂ¡o hÃ¡ÂºÂ¿t NGHÃ¡Â»Ë† DÃƒâ‚¬I</small>
                              <label title="Ãƒâ€šm bÃƒÂ¡o hÃ¡ÂºÂ¿t NGHÃ¡Â»Ë† DÃƒâ‚¬I" class="btn small ghost" for="uploadSoundLong">NGHÃ¡Â»Ë† DÃƒâ‚¬I</label>
                              <input type="file" id="uploadSoundLong" accept="audio/*" class="hidden" />
                          </div>
                      </div>
                      </div>
                  </div>
              </div>
              <div id="settings-integrations" class="tab-content" style="flex-direction: column; gap: 20px;">
                  <div>
                      <h4>TÃ­ch há»£p AI</h4>
                      <label>Gemini API Key
                          <input type="password" id="set_apiKey" placeholder="DÃ¡n API Key cá»§a báº¡n vÃ o Ä‘Ã¢y..." />
                      </label>
                      <div class="tiny">Cáº§n cÃ³ Ä‘á»ƒ sá»­ dá»¥ng cÃ¡c tÃ­nh nÄƒng AI. Láº¥y key miá»…n phÃ­ táº¡i <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.</div>
                  </div>
                  <div>
                      <h4>ğŸµ Nháº¡c ná»n YouTube</h4>
                      <div class="row" style="gap:8px; align-items:center;">
                          <input type="text" id="set_youtubeUrl" placeholder="DÃ¡n link YouTube vÃ o Ä‘Ã¢y..." style="flex:1;">
                          </div>
                      <div id="ytUrlFeedback" class="tiny" style="min-height: 1.2em; padding: 4px 0;"></div>
                      <div class="row" style="margin-top: 4px;">
                          <label style="flex: 0 1 auto; display: flex; align-items: center; gap: 8px; font-size: 14px;">
                              <input type="checkbox" id="set_ytThumbAsBg">
                              <span>DÃ¹ng áº£nh bÃ¬a video lÃ m ná»n</span>
                          </label>
                      </div>
                      <div class="row" style="margin-top: 8px;">
                          <button id="btnToggleYtSound" class="btn small" style="flex:0 1 auto;">Ã¢â€“Â¶Ã¯Â¸Â</button>
                          <input type="range" id="ytSoundVolume" min="0" max="100" step="1" value="80" style="flex:1;">
                      </div>
                      <div class="tiny" style="text-align:center; margin-top:4px;">Ã‚m lÆ°á»£ng</div>
                  </div>
                  <div>
                      <h4>ğŸ›¡ï¸ CÃ i Ä‘áº·t sao lÆ°u</h4>
                      <div class="row">
                          <label>Sá»‘ ngÃ y sao lÆ°u cáº§n giá»¯ láº¡i
                               <input type="number" id="set_backupDays" min="1" max="30" />
                          </label>
                      </div>
                  </div>
                  <div>
                      <h4>ğŸ›¡ï¸ Phá»¥c há»“i dá»¯ liá»‡u</h4>
                      <p class="tiny">Phá»¥c há»“i dá»¯ liá»‡u tá»« má»™t báº£n sao lÆ°u tá»± Ä‘á»™ng háº±ng ngÃ y. HÃ nh Ä‘á»™ng nÃ y sáº½ ghi Ä‘Ã¨ lÃªn dá»¯ liá»‡u hiá»‡n táº¡i cá»§a báº¡n.</p>
                      <div class="row">
                          <select id="backupList" style="flex: 3;"></select>
                          <button id="btnRestoreBackup" class="btn warn small" style="flex: 1;">Phá»¥c há»“i</button>
                      </div>
                  </div>
              </div>
          </div>
          <div class="row" style="margin-top:16px; justify-content:flex-end">
              <button class="btn ghost" id="btnDefaults">Máº·c Ä‘á»‹nh</button>
              <button class="btn acc" id="btnSaveSettings">LÆ°u</button>
              <button class="btn" id="btnCloseSettings">ÄÃ³ng</button>
          </div>
      </div>
  </div>

  <div class="modal" id="modalNote" role="dialog" aria-modal="true" aria-labelledby="noteTitle">
    <div class="modal-card">
      <h3 id="noteTitle">ğŸ“ Ghi chÃº cho phiÃªn vá»«a hoÃ n thÃ nh</h3>
      <div class="row"><textarea id="noteText" placeholder="Báº¡n há»c Ä‘Æ°á»£c gÃ¬? KhÃ³ khÄƒn? Next steps?"></textarea></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px; gap: 12px;">
        <button class="btn" id="btnSummarizeNote">âœ¨ TÃ³m táº¯t & Gá»£i Ã½</button>
        <button class="btn" id="btnSkipNote">Bá» qua</button>
        <button class="btn acc" id="btnSaveNote">LÆ°u ghi chÃº</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalGeneric" role="dialog" aria-modal="true" aria-labelledby="genericTitle">
      <div class="modal-card" style="width: min(450px, 94vw);">
          <h3 id="genericTitle">TiÃªu Ä‘á»</h3>
          <p id="genericMessage" class="hidden"></p>
          <input type="text" id="genericInput" class="hidden" />
          <div class="row" style="justify-content:flex-end; margin-top:12px">
              <button class="btn" id="btnGenericCancel">Há»§y</button>
              <button class="btn acc" id="btnGenericOk">OK</button>
          </div>
      </div>
  </div>
  
  <div class="modal" id="modalDashboard" role="dialog" aria-modal="true" aria-labelledby="dashboardTitle">
    <div class="modal-card" style="width: min(800px, 95vw);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 id="dashboardTitle">ğŸ“Š Tá»•ng quan</h3>
            <button class="btn ghost small" id="btnCloseDashboard">ÄÃ³ng</button>
        </div>
        <p class="tiny">Tá»•ng há»£p thá»i gian vÃ  sá»‘ phiÃªn Ä‘Ã£ hoÃ n thÃ nh trÃªn táº¥t cáº£ cÃ¡c chá»§ Ä‘á».</p>
        <div id="dashboardContent" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>
  <audio id="audioWorkEnd"></audio>
  <audio id="audioBreakEnd"></audio>
  <audio id="audioLongEnd"></audio>
  <div id="youtube-player-container"></div>

  <div id="draggableTimer" class="draggable-timer">00:00</div>

    <div id="soundPermissionBar" class="sound-permission-bar" role="alert" aria-live="polite">
    <span class="msg">Äang phÃ¡t (táº¯t tiáº¿ng). Nháº¥n nÃºt â–¶ï¸ Ä‘á»ƒ báº­t tiáº¿ng.</span>
  </div>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script>
    // Ã„ÂÃƒÂ£ bÃ¡Â»Â fixVietnameseUI: dÃƒÂ¹ng trÃ¡Â»Â±c tiÃ¡ÂºÂ¿p tiÃ¡ÂºÂ¿ng ViÃ¡Â»â€¡t (UTF-8) trong HTML/JS
    // NÃƒÂºt toÃƒÂ n mÃƒÂ n hÃƒÂ¬nh: dÃƒÂ¹ng biÃ¡Â»Æ’u tÃ†Â°Ã¡Â»Â£ng Ã¢â€ â€”Ã¯Â¸Â/Ã¢â€ â„¢Ã¯Â¸Â thay vÃƒÂ¬ chÃ¡Â»Â¯
    window.addEventListener('load', ()=>{ try { updateFullscreenButton(); } catch(_) {} });
    const IS_FILE_PROTOCOL = (window.location.protocol === 'file:');
    // Watchdog: thÃƒÂ´ng bÃƒÂ¡o nÃ¡ÂºÂ¿u API YouTube tÃ¡ÂºÂ£i chÃ¡ÂºÂ­m hoÃ¡ÂºÂ·c thÃ¡ÂºÂ¥t bÃ¡ÂºÂ¡i
    function startYtApiWatchdog(){
      const fb = document.getElementById('ytUrlFeedback');
      if (!fb) return;
      const t1 = setTimeout(()=>{
        try{ if (!window.YT || !window.YT.Player){ fb.textContent='Äang táº£i API YouTube...'; fb.style.color='var(--sub)'; } }catch(_){ }
      }, 1500);
      const t2 = setTimeout(()=>{
        try{ if (!window.YT || !window.YT.Player){ fb.textContent='KhÃ´ng táº£i Ä‘Æ°á»£c API YouTube. Kiá»ƒm tra máº¡ng hoáº·c táº£i láº¡i trang.'; fb.style.color='var(--danger)'; } }catch(_){ }
      }, 7000);
      window.__ytApiWatchdog = { cancel(){ clearTimeout(t1); clearTimeout(t2);} };
    }
    startYtApiWatchdog();
    // Inline i18n fallback so app works over file:// without CORS
    (function(){
      const DICT = {
        'timer.cycleInfo': ({ current = 0, target = 0 } = {}) => `Chu ká»³ ${current}/${target}`,
        'timer.selectSubtopicPrompt': 'Vui lÃ²ng chá»n má»™t Chá»§ Ä‘á» con trÆ°á»›c khi thá»±c hiá»‡n thao tÃ¡c.'
      };
      window.t = function t(key, vars){
        try {
          const v = DICT[key];
          if (typeof v === 'function') return v(vars || {});
          if (typeof v === 'string') return v;
        } catch(_) {}
        return key;
      };
      window.loadLanguage = function loadLanguage(lang){
        try { localStorage.setItem('lang', lang || 'vi'); } catch(_) {}
        return Promise.resolve();
      };
    })();
    // storageManager will manage persistence
    // =============================
    // STORAGE MANAGER - QuÃ¡ÂºÂ£n lÃƒÂ½ DÃ¡Â»Â¯ liÃ¡Â»â€¡u vÃƒÂ  Sao lÃ†Â°u
    // =============================
    const storageManager = {
        DB_NAME: 'PomodoroAppDB',
        DB_VERSION: 1,
        db: null,
        async initDB() {
            return new Promise((resolve, reject) => {
                if (this.db) return resolve(this.db);
                const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings');
                    }
                    if (!db.objectStoreNames.contains('topics')) {
                        db.createObjectStore('topics', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('subtopics')) {
                        const subtopicsStore = db.createObjectStore('subtopics', { keyPath: 'id' });
                        subtopicsStore.createIndex('by_topic', 'topicId');
                    }
                    if (!db.objectStoreNames.contains('backups')) {
                        db.createObjectStore('backups', { keyPath: 'date' });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    console.log('IndexedDB initialized successfully.');
                    resolve(this.db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    reject(event.target.error);
                };
            });
        },
        async _getStore(storeName, mode = 'readonly') {
            await this.initDB();
            const tx = this.db.transaction([storeName], mode);
            return tx.objectStore(storeName);
        },
        async getSettings() {
            const store = await this._getStore('settings');
            return new Promise((resolve, reject) => {
                const request = store.get('main_settings');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async updateSettings(settingsObject) {
            const store = await this._getStore('settings', 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.put(settingsObject, 'main_settings');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async getAll(storeName) {
            const store = await this._getStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async update(storeName, object) {
            const store = await this._getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.put(object);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async add(storeName, object) {
            const store = await this._getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.add(object);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async delete(storeName, key) {
            const store = await this._getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.delete(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async save(data) {
            await this.initDB();
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(['settings', 'topics', 'subtopics'], 'readwrite');
                const settingsStore = tx.objectStore('settings');
                const topicsStore = tx.objectStore('topics');
                const subtopicsStore = tx.objectStore('subtopics');

                settingsStore.put(data.settings, 'main_settings');
                topicsStore.clear();
                subtopicsStore.clear();

                data.topics.forEach(topic => {
                    const { subtopics, ...topicData } = topic;
                    topicsStore.put(topicData);
                    (subtopics || []).forEach(sub => subtopicsStore.put(sub));
                });

                tx.oncomplete = () => resolve();
                tx.onerror = e => reject(e.target.error);
            });
        },
        async autoBackup(data) {
            await this.initDB();
            const today = new Date().toISOString().slice(0, 10);
            const lastBackupDate = localStorage.getItem('lastBackupDate');
            if (today !== lastBackupDate) {
                console.log(`Creating backup for ${today}...`);
                const backupData = { date: today, data: JSON.parse(JSON.stringify(data)) };
                const transaction = this.db.transaction(['backups'], 'readwrite');
                const store = transaction.objectStore('backups');
                const request = store.put(backupData);
                request.onsuccess = () => {
                    localStorage.setItem('lastBackupDate', today);
                    console.log('Daily backup successful.');
                    this.cleanupOldBackups((data?.settings?.backupDaysToKeep) || 7);
                };
                request.onerror = (event) => {
                    console.error('Backup failed:', event.target.error);
                };
            }
        },
        async cleanupOldBackups(daysToKeep) {
            await this.initDB();
            const transaction = this.db.transaction(['backups'], 'readwrite');
            const store = transaction.objectStore('backups');
            const request = store.getAllKeys();
            request.onsuccess = () => {
                const allKeys = request.result.sort().reverse();
                if (allKeys.length > daysToKeep) {
                    const keysToDelete = allKeys.slice(daysToKeep);
                    keysToDelete.forEach(key => {
                        store.delete(key);
                        console.log(`Deleted old backup: ${key}`);
                    });
                }
            };
        },
        async getBackupList() {
            await this.initDB();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result.sort((a, b) => b.date.localeCompare(a.date)));
                request.onerror = (event) => reject(event.target.error);
            });
        },
        async restoreBackup(date) {
            await this.initDB();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                const request = store.get(date);
                request.onsuccess = () => {
                    if (request.result && request.result.data) {
                        localStorage.setItem('pomodoroData_v11', JSON.stringify(request.result.data));
                        resolve(request.result.data);
                    } else {
                        reject(new Error('KhÃƒÂ´ng tÃƒÂ¬m thÃ¡ÂºÂ¥y bÃ¡ÂºÂ£n sao lÃ†Â°u.'));
                    }
                };
                request.onerror = (event) => reject(event.target.error);
            });
        },
        exportData(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            const ts = new Date();
            const pad = n => `${n}`.padStart(2, '0');
            a.href = URL.createObjectURL(blob);
            a.download = `pomodoro_backup_${ts.getFullYear()}${pad(ts.getMonth() + 1)}${pad(ts.getDate())}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        },
        async importData(file) {
            const text = await file.text();
            const obj = JSON.parse(text);
            if (!obj.version || !obj.settings || !Array.isArray(obj.topics)) {
                throw new Error('Tá»‡p khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng');
            }
            localStorage.setItem('pomodoroData_v11', JSON.stringify(obj));
            return obj;
        }
    };

    // =============================
    // Helpers
    // =============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    function on(el, evt, handler){ if(!el){ console.warn('Missing element', evt); return; } el.addEventListener(evt, handler); }
    const formatMMSS = (s) => { const m = Math.floor(s/60).toString().padStart(2,'0'); const ss = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; };
    const uid = (p='id') => `${p}_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;
    const todayISO = () => new Date().toISOString();
    function toast(msg, ms=2600){ const box=$('#toasts'); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; box.appendChild(t); setTimeout(()=>{t.style.opacity='0';}, ms-300); setTimeout(()=> box.removeChild(t), ms); }
    function escapeHTML(str){ return str.replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    function formatDaysHoursMinutes(totalMinutes) {
        if (!totalMinutes || totalMinutes < 1) return "0 phÃºt";
        const totalHours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        const mm = minutes.toString().padStart(2, '0');
        return `${totalHours} tiáº¿ng ${mm} phÃºt`;
    }
    function formatGeminiResponse(text) {
        return text.replace(/(\*\*|__|\*|_|#+\s*)/g, '');
    }
    function normalizeDataStructure(obj){
        if (!obj || typeof obj !== 'object') return;
        const s = obj.settings || {};
        const mergedSettings = {
            ...defaults.settings,
            ...s,
            durations: { ...defaults.settings.durations, ...(s.durations || {}) }
        };
        if (!Array.isArray(mergedSettings.achievedMilestones)) mergedSettings.achievedMilestones = [];
        obj.settings = mergedSettings;
        obj.topics = Array.isArray(obj.topics) ? obj.topics : [];
        obj.topics.forEach(t => {
            t.subtopics = Array.isArray(t.subtopics) ? t.subtopics : [];
            t.subtopics.forEach(st => {
                st.tasks = st.tasks || [];
                st.generalNotes = st.generalNotes || [];
                st.summaries = st.summaries || [];
                st.chatHistory = st.chatHistory || [];
                st.stats = st.stats || { totalMinutes: 0, sessionsCompleted: 0, tasksCompleted: 0 };
                st.sessions = st.sessions || [];
                st.timerState = st.timerState || { state: 'idle', prevState: null, remaining: 0, segmentTotal: 0, cycleIndex: 0 };
            });
        });
    }
    function extractYouTubeID(url) {
        if (!url) return null;
        const regExp = /^.*(?:youtu.be\/|shorts\/|live\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([A-Za-z0-9_-]{11}).*/;
        const match = url.match(regExp);
        return match ? match[1] : null;
    }
    let sessionYoutubeUrl = '';
    function getActiveYoutubeUrl(){
        try {
            if (sessionYoutubeUrl) return sessionYoutubeUrl;
            const el = document.getElementById('set_youtubeUrl');
            const v = (el && el.value ? el.value : '').trim();
            return v;
        } catch(_) { return ''; }
    }
    function getActiveVideoId(){ return extractYouTubeID(getActiveYoutubeUrl()); }
    function handleYoutubeUrlInput() {
        const input = $("#set_youtubeUrl");
        const feedbackEl = $("#ytUrlFeedback");
        const toggleBtn = $("#btnToggleYtSound");
        const url = input.value.trim();
        const videoId = extractYouTubeID(url);

        if (videoId) {
            feedbackEl.textContent = "OK. Link hÃ¡Â»Â£p lÃ¡Â»â€¡. Ã„Âang chuÃ¡ÂºÂ©n bÃ¡Â»â€¹ phÃƒÂ¡t...";
            feedbackEl.style.color = 'var(--acc-2)';
            toggleBtn.disabled = false;
            sessionYoutubeUrl = url;
            try {
                const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                const img = new Image();
                img.onload = async () => { data.settings.customBg = thumbUrl; try { await saveData(); } catch(_) {} applyCustomBg(); };
                img.onerror = async () => { const fb = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`; data.settings.customBg = fb; try { await saveData(); } catch(_) {} applyCustomBg(); };
                img.src = thumbUrl;
            } catch(_) {}
            try {
                if (IS_FILE_PROTOCOL) {
                    const isMuted = _ytUnlocked ? 0 : 1;
                    fallbackLoadVideo(videoId, { autoplay: 1, mute: isMuted });
                    try { setTimeout(() => { try { fallbackPostMessage('playVideo'); } catch(_) {} }, 250); } catch(_) {}
                    if (!_ytUnlocked) { showSoundPermission(); }
                try { setTimeout(() => { const fb = document.getElementById('ytUrlFeedback'); if (fb) fb.textContent = 'Ã„Âang phÃƒÂ¡t'; }, 500); } catch(_) {}
                } else {
                    updateYouTubePlayer();
                }
            } catch(_) {}
        } else if (url === '') {
            feedbackEl.textContent = "";
            toggleBtn.disabled = true;
            if (IS_FILE_PROTOCOL) { try { fallbackStop(); } catch(_) {} }
            else if (ytPlayer && ytPlayer.stopVideo) { ytPlayer.stopVideo(); }
        } else {
            feedbackEl.textContent = "Ã¢ÂÅ’ Link khÃƒÂ´ng hÃ¡Â»Â£p lÃ¡Â»â€¡ hoÃ¡ÂºÂ·c khÃƒÂ´ng Ã„â€˜Ã†Â°Ã¡Â»Â£c hÃ¡Â»â€” trÃ¡Â»Â£.";
            feedbackEl.style.color = 'var(--danger)';
            toggleBtn.disabled = true;
        }
    }
    
    // THAY Ã„ÂÃ¡Â»â€I: HÃƒÂ m applyTheme Ã„â€˜Ã†Â°Ã¡Â»Â£c cÃ¡ÂºÂ­p nhÃ¡ÂºÂ­t hoÃƒÂ n toÃƒÂ n
    function applyTheme(previewTheme) {
        const theme = previewTheme || data.settings.theme || 'default';
        document.body.dataset.theme = theme;
        
        const themeHasBg = ['lofi', 'space'].includes(theme);
        const isLightTheme = (theme === 'light' || theme === 'pastel');
        const customBg = data.settings.customBg;

        // helper: always clear any previously forced inline fallback
        const clearInlineBgFallback = () => { try { document.body.style.backgroundImage = ''; } catch(_) {} };

        if (customBg && !data.settings.useYtThumbnailAsBg) {
            document.body.style.setProperty('--bg-image', `url(${customBg})`);
            clearInlineBgFallback();
        } else if (customBg && data.settings.useYtThumbnailAsBg) {
            document.body.style.setProperty('--bg-image', `url(${customBg})`);
            clearInlineBgFallback();
        } else if (themeHasBg) {
            // Use theme-provided background (e.g., lofi/space)
            document.body.style.removeProperty('--bg-image');
            clearInlineBgFallback();
        } else if (isLightTheme) {
            // For light/pastel, avoid dark radial fallback
            document.body.style.setProperty('--bg-image', 'none');
            clearInlineBgFallback();
        } else {
            // Dark/default fallback
            document.body.style.setProperty('--bg-image', '');
            document.body.style.backgroundImage = 'radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%)';
        }
    }


    const defaults = {
        version: 11,
        settings: {
            apiKey: "",
            currentView: 'timer',
            preset: 'A',
            autoStartNext: true,
            soundOn: true,
            volume: 0.8,
            soundTheme: 'beep',
            theme: 'default',
            cyclesA: 4,
            longBreakIntervalA: 4,
            cyclesB: 4,
            longBreakIntervalB: 4,
            durations: { A_work: 25, A_short: 5, A_long: 15, B_work: 50, B_short: 10, B_long: 30 },
            selectedTopicId: '',
            selectedSubtopicId: '',
            collapsedTopics: {},
            customBg: '',
            customSounds: { work_end: '', break_end: '', long_end: '' },
            youtubeUrl: '',
            youtubeVolume: 80,
            useYtThumbnailAsBg: true,
            panelOpacity: 0.85,
            panelBlur: 10,
            backupDaysToKeep: 7,
            achievedMilestones: []
        },
        topics: [{
            id: uid('t'),
            name: 'ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â mÃ¡ÂºÂ«u',
            subtopics: [{
                id: uid('s'),
                name: 'ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con mÃ¡ÂºÂ«u',
                tasks: [],
                generalNotes: [],
                summaries: [],
                chatHistory: [],
                stats: { totalMinutes: 0, sessionsCompleted: 0, tasksCompleted: 0 },
                sessions: [],
                timerState: { state: 'idle', prevState: null, remaining: 0, segmentTotal: 0, cycleIndex: 0 }
            }]
        }]
    };
    let data;
    let editingPreset = 'A';

    // (CÃƒÂ¡c hÃƒÂ m cÃƒÂ²n lÃ¡ÂºÂ¡i giÃ¡Â»Â¯ nguyÃƒÂªn)
    // ...
    // ...
    async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
        const apiKey = data.settings.apiKey || "";
        if (!apiKey) {
            toast("Vui lÃƒÂ²ng nhÃ¡ÂºÂ­p Gemini API Key trong phÃ¡ÂºÂ§n CÃƒÂ i Ã„â€˜Ã¡ÂºÂ·t.");
            return null;
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                if (response.status === 429 && retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                return formatGeminiResponse(result.candidates[0].content.parts[0].text);
            } else {
                console.error("API response structure is unexpected:", result);
                if (result.promptFeedback?.blockReason) { return `NÃ¡Â»â„¢i dung bÃ¡Â»â€¹ chÃ¡ÂºÂ·n vÃƒÂ¬: ${result.promptFeedback.blockReason}. Vui lÃƒÂ²ng thÃ¡Â»Â­ lÃ¡ÂºÂ¡i vÃ¡Â»â€ºi nÃ¡Â»â„¢i dung khÃƒÂ¡c.`; }
                return "KhÃƒÂ´ng nhÃ¡ÂºÂ­n Ã„â€˜Ã†Â°Ã¡Â»Â£c nÃ¡Â»â„¢i dung hÃ¡Â»Â£p lÃ¡Â»â€¡ tÃ¡Â»Â« AI.";
            }
        } catch (error) {
            console.error("LÃ¡Â»â€”i khi gÃ¡Â»Âi Gemini API:", error);
            if (retries > 0) {
                await new Promise(resolve => setTimeout(resolve, delay));
                return callGeminiAPI(prompt, retries - 1, delay * 2);
            }
            return "Ã„ÂÃƒÂ£ xÃ¡ÂºÂ£y ra lÃ¡Â»â€”i khi kÃ¡ÂºÂ¿t nÃ¡Â»â€˜i vÃ¡Â»â€ºi AI. Vui lÃƒÂ²ng kiÃ¡Â»Æ’m tra kÃ¡ÂºÂ¿t nÃ¡Â»â€˜i mÃ¡ÂºÂ¡ng vÃƒÂ  thÃ¡Â»Â­ lÃ¡ÂºÂ¡i.";
        }
    }
    let AUDIO_CTX = null;
    function ensureAudio(){ if(!AUDIO_CTX) AUDIO_CTX = new (window.AudioContext||window.webkitAudioContext)(); }
    function tone(freq=880, durMs=200, vol=0.2, type='sine', when=0){ ensureAudio(); const ctx=AUDIO_CTX; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); const t = ctx.currentTime + when; g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(vol, t+0.01); g.gain.exponentialRampToValueAtTime(0.0001, t + durMs/1000); o.start(t); o.stop(t + durMs/1000 + 0.05); }
    function playSound(kind){
      if(!data.settings.soundOn) return;
      const vol = Math.max(0, Math.min(1, data.settings.volume ?? 0.8));
      const ref = data.settings.customSounds?.[kind];
      let audioEl;
      if (kind === 'work_end') audioEl = $('#audioWorkEnd'); else if (kind === 'break_end') audioEl = $('#audioBreakEnd'); else if (kind === 'long_end') audioEl = $('#audioLongEnd');
      if (ref && audioEl) {
        if (ref.startsWith('data:') || ref.startsWith('http') || ref.startsWith('blob:')) {
            audioEl.src = ref;
            audioEl.volume = vol;
            audioEl.play().catch(e => console.error("LÃ¡Â»â€”i phÃƒÂ¡t ÃƒÂ¢m thanh:", e));
        } else {
            getStoredFileUrl(ref).then(url => {
                if (url) {
                    audioEl.src = url;
                    audioEl.volume = vol;
                    audioEl.play().catch(e => console.error("LÃ¡Â»â€”i phÃƒÂ¡t ÃƒÂ¢m thanh:", e));
                }
            });
        }
        return;
      }
      const theme = data.settings.soundTheme || 'beep';
      if(theme==='beep'){
        if(kind==='work_end') { tone(880,250,vol); tone(660,180,vol*0.8, 'sine', 0.22); } else if(kind==='break_end') { tone(660,220,vol*0.9); } else if(kind==='long_end') { tone(520,200,vol); tone(780,200,vol, 'sine', 0.22); tone(1040,220,vol, 'sine', 0.44); }
      } else {
        if(kind==='work_end') { tone(1200,160,vol*0.9,'triangle'); tone(900,220,vol*0.8,'triangle',0.18); } else if(kind==='break_end') { tone(880,240,vol*0.8,'triangle'); } else if(kind==='long_end') { tone(600,220,vol*0.9,'triangle'); tone(950,240,vol*0.9,'triangle',0.22); tone(1200,240,vol,'triangle',0.44); }
      }
    }
      async function saveData() {
        try {
          await storageManager.save(data);
        } catch (err) {
          console.error('Failed to save data:', err);
          toast(`LÃ¡Â»â€”i lÃ†Â°u dÃ¡Â»Â¯ liÃ¡Â»â€¡u: ${err.message}`);
        }
      }
        async function ensureValidSelection(){
          const set = data.settings;
          if (!data.topics || data.topics.length === 0) { set.selectedTopicId = ''; set.selectedSubtopicId = ''; await saveData(); return; }
          const t = data.topics.find(x=>x.id===set.selectedTopicId);
          const s = t?.subtopics.find(x=>x.id===set.selectedSubtopicId);
          if(!t || !s){
            const t0 = data.topics[0];
            const s0 = t0?.subtopics?.[0];
            set.selectedTopicId = t0?.id || '';
            set.selectedSubtopicId = s0?.id || '';
            await saveData();
          }
        }
    function showInputModal(title, okCallback, defaultValue = '') {
        $('#genericTitle').textContent = title;
        $('#genericMessage').classList.add('hidden');
        const input = $('#genericInput'); input.value = defaultValue; input.classList.remove('hidden');
        $('#modalGeneric').classList.add('show'); input.focus(); input.select();
        const okHandler = () => { okCallback(input.value); cleanup(); };
        const cancelHandler = () => cleanup();
        const keyHandler = (e) => { if (e.key === 'Enter') okHandler(); if (e.key === 'Escape') cancelHandler(); };
        $('#btnGenericOk').onclick = okHandler; $('#btnGenericCancel').onclick = cancelHandler; input.onkeydown = keyHandler;
        function cleanup() { $('#modalGeneric').classList.remove('show'); $('#btnGenericOk').onclick = null; $('#btnGenericCancel').onclick = null; input.onkeydown = null; }
    }
    function showConfirmModal(title, message, okCallback) {
        $('#genericTitle').textContent = title;
        const msgEl = $('#genericMessage'); msgEl.textContent = message; msgEl.classList.remove('hidden');
        $('#genericInput').classList.add('hidden'); $('#modalGeneric').classList.add('show');
        const okHandler = () => { okCallback(true); cleanup(); };
        const cancelHandler = () => { okCallback(false); cleanup(); };
        $('#btnGenericOk').onclick = okHandler; $('#btnGenericCancel').onclick = cancelHandler;
        function cleanup() { $('#modalGeneric').classList.remove('show'); $('#btnGenericOk').onclick = null; $('#btnGenericCancel').onclick = null; }
    }
    async function switchView(viewId) {
        $$('.view').forEach(v => v.classList.remove('active'));
        $(`#view-${viewId}`).classList.add('active');
        $$('.nav-btn').forEach(b => b.classList.remove('active'));
        const navBtn = $(`.nav-btn[data-view="${viewId}"]`);
        if (navBtn) navBtn.classList.add('active');
        data.settings.currentView = viewId;
        await saveData();
        if (viewId === 'stats') {
            renderDashboard();
        }
    }
    function closeAllMenus() {
        $$('.actions-menu.show').forEach(menu => menu.classList.remove('show'));
    }
    function renderTopics(){
      const wrap = $('#topicsList');
      if (!wrap) return;
      wrap.innerHTML='';
      const collapsedMap = data.settings.collapsedTopics || {};
      data.topics.forEach(topic => {
        const box = document.createElement('div');
        box.className='topic-item';
        box.dataset.tid = topic.id;
        const header = document.createElement('div');
        header.className='topic-header';
        const isCollapsed = !!collapsedMap[topic.id];
        const chev = document.createElement('button');
        chev.className='btn small ghost chev';
        chev.setAttribute('title','MÃ¡Â»Å¸/Ã„â€˜ÃƒÂ³ng subtopics');
        chev.setAttribute('aria-expanded', String(!isCollapsed));
        chev.innerHTML = '<span class="ico">Ã¢â€“Â¼</span>';
        const title = document.createElement('div');
        title.className='topic-title';
        title.textContent = topic.name;
        const act = document.createElement('div');
        act.className='topic-actions';
        const bAdd = document.createElement('button');
        bAdd.className='btn small';
        bAdd.innerHTML = 'Ã¯Â¼â€¹ ThÃƒÂªm';
        bAdd.title = 'ThÃƒÂªm ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con';
        const menuContainer = document.createElement('div');
        menuContainer.style.position = 'relative';
        const bMore = document.createElement('button');
        bMore.className = 'btn small ghost actions-menu-btn';
        bMore.innerHTML = '...';
        bMore.title = 'ThÃƒÂªm tÃƒÂ¹y chÃ¡Â»Ân';
        const menu = document.createElement('div');
        menu.className = 'actions-menu';
        const bEdit = document.createElement('button');
        bEdit.className = 'menu-item';
        bEdit.innerHTML = 'SÃ¡Â»Â­a tÃƒÂªn ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â';
        const bDel = document.createElement('button');
        bDel.className = 'menu-item danger';
        bDel.innerHTML = 'XÃƒÂ³a ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â';
        menu.append(bEdit, bDel);
        menuContainer.append(bMore, menu);
        act.append(bAdd, menuContainer);
        header.append(chev, title, act);
        const subs = document.createElement('div');
        subs.className='subtopics' + (isCollapsed? ' hidden':'');
        subs.dataset.tid = topic.id;
        topic.subtopics.forEach(st => {
          const row = document.createElement('div');
          row.className='sub-row';
          row.dataset.sid = st.id;
          const btn = document.createElement('button');
          btn.className='btn subtopic-btn';
          btn.textContent = 'Ã¢â‚¬Â¢ '+st.name;
          btn.dataset.sid = st.id;
          btn.dataset.tid = topic.id;
          if(data.settings.selectedSubtopicId===st.id) btn.classList.add('active');
          const subActions = document.createElement('div');
          subActions.className = 'actions';
          const subMenuContainer = document.createElement('div');
          subMenuContainer.style.position = 'relative';
          const subBMore = document.createElement('button');
          subBMore.className = 'btn small ghost actions-menu-btn';
          subBMore.innerHTML = '...';
          subBMore.title = 'ThÃƒÂªm tÃƒÂ¹y chÃ¡Â»Ân';
          const subMenu = document.createElement('div');
          subMenu.className = 'actions-menu';
          const subBEdit = document.createElement('button');
          subBEdit.className = 'menu-item';
          subBEdit.innerHTML = 'SÃ¡Â»Â­a tÃƒÂªn ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con';
          const subBDel = document.createElement('button');
          subBDel.className = 'menu-item danger';
          subBDel.innerHTML = 'XÃƒÂ³a ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con';
          subMenu.append(subBEdit, subBDel);
          subMenuContainer.append(subBMore, subMenu);
          subActions.append(subMenuContainer);
          row.append(btn, subActions);
          subs.appendChild(row);
          btn.addEventListener('click', ()=> selectSubtopic(topic.id, st.id));
          subBMore.addEventListener('click', (e) => { e.stopPropagation(); closeAllMenus(); subMenu.classList.toggle('show'); });
          subBEdit.addEventListener('click', ()=> showInputModal('Ã„ÂÃ¡Â»â€¢i tÃƒÂªn ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con', async (newName) => { if(!newName) return; st.name=newName; await storageManager.update('subtopics', st); renderAll(); }, st.name));
          subBDel.addEventListener('click', ()=> showConfirmModal('XÃƒÂ¡c nhÃ¡ÂºÂ­n xÃƒÂ³a', `BÃ¡ÂºÂ¡n cÃƒÂ³ chÃ¡ÂºÂ¯c muÃ¡Â»â€˜n xÃƒÂ³a ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con "${st.name}"? MÃ¡Â»Âi dÃ¡Â»Â¯ liÃ¡Â»â€¡u liÃƒÂªn quan sÃ¡ÂºÂ½ bÃ¡Â»â€¹ mÃ¡ÂºÂ¥t.`, async (ok) => { if(!ok) return; topic.subtopics = topic.subtopics.filter(x=>x.id!==st.id); const set=data.settings; if(set.selectedSubtopicId===st.id){ set.selectedSubtopicId=''; set.selectedTopicId=''; ensureValidSelection(); } await storageManager.delete('subtopics', st.id); renderAll(); }));
        });
        chev.addEventListener('click', async ()=>{ if(isCollapsed){ delete collapsedMap[topic.id]; } else { collapsedMap[topic.id] = true; } data.settings.collapsedTopics = collapsedMap; await storageManager.updateSettings(data.settings); renderTopics(); });
        bMore.addEventListener('click', (e) => { e.stopPropagation(); closeAllMenus(); menu.classList.toggle('show'); });
        bAdd.addEventListener('click', ()=> showInputModal('TÃƒÂªn ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con mÃ¡Â»â€ºi?', async (name) => { if(!name) return; const newSub = { id: uid('s'), topicId: topic.id, name, tasks: [], generalNotes: [], summaries: [], chatHistory: [], stats:{ totalMinutes:0, sessionsCompleted:0, tasksCompleted: 0 }, sessions: [], timerState: { state: 'idle', prevState: null, remaining: 0, segmentTotal: 0, cycleIndex: 0 } }; topic.subtopics.push(newSub); await storageManager.add('subtopics', newSub); renderTopics(); }));
        bEdit.addEventListener('click', ()=> showInputModal('Ã„ÂÃ¡Â»â€¢i tÃƒÂªn ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â', async (newName) => { if(!newName) return; topic.name=newName; await storageManager.update('topics', topic); renderTopics(); }, topic.name));
        bDel.addEventListener('click', ()=> showConfirmModal('XÃƒÂ¡c nhÃ¡ÂºÂ­n xÃƒÂ³a', `BÃ¡ÂºÂ¡n cÃƒÂ³ chÃ¡ÂºÂ¯c muÃ¡Â»â€˜n xÃƒÂ³a ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â "${topic.name}"? MÃ¡Â»Âi chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con vÃƒÂ  dÃ¡Â»Â¯ liÃ¡Â»â€¡u liÃƒÂªn quan sÃ¡ÂºÂ½ bÃ¡Â»â€¹ mÃ¡ÂºÂ¥t.`, async (ok) => { if(!ok) return; data.topics = data.topics.filter(t=>t.id!==topic.id); delete collapsedMap[topic.id]; if(data.settings.selectedTopicId===topic.id){ data.settings.selectedTopicId=''; data.settings.selectedSubtopicId=''; ensureValidSelection(); } await storageManager.delete('topics', topic.id); for(const sub of topic.subtopics){ await storageManager.delete('subtopics', sub.id); } renderAll(); }));
        box.append(header, subs);
        wrap.appendChild(box);
      });
      if (window.Sortable) {
        const topicsListEl = document.getElementById('topicsList');
        if (topicsListEl) {
          if (topicsListEl._sortable) { try { topicsListEl._sortable.destroy(); } catch (e) {} }
          topicsListEl._sortable = new Sortable(topicsListEl, {
            animation: 150,
            draggable: '.topic-item',
            onEnd: async function (evt) {
              if (evt.oldIndex === evt.newIndex) return;
              const moved = data.topics.splice(evt.oldIndex, 1)[0];
              data.topics.splice(evt.newIndex, 0, moved);
              await saveData();
              renderTopics();
            }
          });
          topicsListEl.querySelectorAll('.subtopics').forEach(subsEl => {
            new Sortable(subsEl, {
              group: 'subtopics-group',
              animation: 150,
              draggable: '.sub-row',
              onEnd: async function (evt) {
                const fromTopicId = evt.from?.dataset?.tid || evt.from?.closest('.topic-item')?.dataset?.tid;
                const toTopicId = evt.to?.dataset?.tid || evt.to?.closest('.topic-item')?.dataset?.tid;
                const fromTopic = data.topics.find(t => t.id === fromTopicId);
                const toTopic = data.topics.find(t => t.id === toTopicId);
                if (!fromTopic || !toTopic) return;
                let movedSubtopic = null;
                const movedSid = evt.item?.dataset?.sid || evt.item?.querySelector('.subtopic-btn')?.dataset?.sid;
                if (movedSid) {
                  const idx = fromTopic.subtopics.findIndex(s => s.id === movedSid);
                  if (idx >= 0) movedSubtopic = fromTopic.subtopics.splice(idx, 1)[0];
                }
                if (!movedSubtopic) {
                  movedSubtopic = fromTopic.subtopics.splice(evt.oldIndex, 1)[0];
                }
                if (!movedSubtopic) return;
                movedSubtopic.topicId = toTopic.id;
                toTopic.subtopics.splice(evt.newIndex, 0, movedSubtopic);
                if (data.settings.selectedSubtopicId === movedSubtopic.id) {
                  data.settings.selectedTopicId = toTopic.id;
                }
                await saveData();
                renderTopics();
              }
            });
          });
        }
      }
    }
    function selectSubtopic(topicId, subId) {
        const mainEl = $('.app-content');
        const oldSubtopic = getCurrentSubtopic();
        if (oldSubtopic && timer.state !== 'idle') {
            oldSubtopic.timerState = {
                state: timer.state,
                prevState: timer.prevState,
                remaining: timer.remaining,
                segmentTotal: timer.segmentTotal,
                cycleIndex: timer.cycleIndex
            };
        }
        mainEl.classList.add('reloading');
        setTimeout(async () => {
            data.settings.selectedTopicId = topicId;
            data.settings.selectedSubtopicId = subId;
            const newSubtopic = getCurrentSubtopic();
            if (newSubtopic.timerState) {
                timer.state = newSubtopic.timerState.state;
                timer.prevState = newSubtopic.timerState.prevState || null;
                timer.remaining = newSubtopic.timerState.remaining;
                timer.segmentTotal = newSubtopic.timerState.segmentTotal;
                timer.cycleIndex = newSubtopic.timerState.cycleIndex;
            } else {
                timer.reset();
            }
            await saveData();
            timer.updateUI();
            renderAll();
            switchView('timer');
            mainEl.classList.remove('reloading');
        }, 200);
    }
    function getCurrentSubtopic(){ const tid=data.settings.selectedTopicId, sid=data.settings.selectedSubtopicId; if(!tid||!sid) return null; const t=data.topics.find(x=>x.id===tid); if(!t) return null; return t.subtopics.find(x=>x.id===sid) || null; }
    function renderContextBadge(){
      const s=getCurrentSubtopic();
      const name = s ? s.name : '(chÃ†Â°a chÃ¡Â»Ân)';
      const selectedContext = $('#selectedContext');
      const currentName = $('#currentSubtopicName');
      const currentChatName = $('#currentSubtopicNameChat');
      if (selectedContext) selectedContext.textContent = s? `ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con: ${s.name}`:'ChÃ†Â°a chÃ¡Â»Ân ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con';
      if (currentName) currentName.textContent = name;
      if (currentChatName) currentChatName.textContent = name;
    }
    function renderSubtopicTasks() {
        const s = getCurrentSubtopic();
        const listEl = $('#subtopicTasksList');
        const inputEl = $('#newSubtopicTaskInput');
        if (!listEl || !inputEl) return;
        const addArea = inputEl.parentElement;
        if (!s) {
            listEl.innerHTML = '<li class="tiny" style="opacity: 0.7;">ChÃ¡Â»Ân chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con Ã„â€˜Ã¡Â»Æ’ xem to-do list.</li>';
            addArea.classList.add('hidden'); return;
        }
        addArea.classList.remove('hidden');
        listEl.innerHTML = '';
        const uncompletedTasks = s.tasks ? s.tasks.filter(t => !t.isCompleted) : [];

        if (uncompletedTasks.length === 0) {
            listEl.innerHTML = '<li class="tiny" style="opacity: 0.7;">TuyÃ¡Â»â€¡t vÃ¡Â»Âi! KhÃƒÂ´ng cÃƒÂ²n task nÃƒÂ o.</li>';
        }
        uncompletedTasks.forEach(task => {
            const item = document.createElement('li');
            item.innerHTML = `<input type="checkbox" id="${task.id}" title="HoÃƒÂ n thÃƒÂ nh task"> <label for="${task.id}">${escapeHTML(task.text)}</label>`;
            item.querySelector('input').addEventListener('change', (e) => toggleSubtopicTask(e.target.id, item));
            listEl.appendChild(item);
        });
    }
    async function addSubtopicTask() {
        const s = getCurrentSubtopic();
        if (!s) { toast(t('timer.selectSubtopicPrompt')); return; }
        const input = $('#newSubtopicTaskInput');
        const text = input.value.trim();
        if (text) {
            if (!s.tasks) s.tasks = [];
            s.tasks.push({ id: uid('task'), text, isCompleted: false, createdAt: todayISO() });
            await saveData();
            renderSubtopicTasks();
            input.value = '';
        }
        input.focus();
    }
    async function toggleSubtopicTask(taskId, listItemElement) {
        const s = getCurrentSubtopic();
        if (!s || !s.tasks) return;
        const task = s.tasks.find(t => t.id === taskId);
        if (task) {
            task.isCompleted = true;
            s.stats.tasksCompleted = (s.stats.tasksCompleted || 0) + 1;
            await saveData();
            listItemElement.classList.add('removing');
            setTimeout(() => {
                renderSubtopicTasks();
                renderStatsHistory();
            }, 200);
        }
    }
    const timer = {
      state:'idle', prevState:null, tickHandle:null, endAt:null,
      remaining:0, segmentTotal:0, cyclesTarget:4, cycleIndex:0, mode:'A',
      persistInterval: 60*1000,
      lastPersist: 0,
      async setPreset(p, {silent=false}={}){
        const st = data.settings;
        this.mode = p;
        this.cyclesTarget = (p==='A' ? st.cyclesA : st.cyclesB);
        st.preset = p;
        await saveData();
        if (this.state === 'idle') {
          this.reset();
        }
      },
      currentDurations(){ const d=data.settings.durations; return this.mode==='A'? {work:d.A_work, short:d.A_short, long:d.A_long} : {work:d.B_work, short:d.B_short, long:d.B_long}; },
      currentConfig(){ const s=data.settings; return this.mode==='A'? {cycles:s.cyclesA, interval:s.longBreakIntervalA} : {cycles:s.cyclesB, interval:s.longBreakIntervalB}; },
      updateUI() {
        const badge = $('#stateBadge');
        const progressCircle = $('.timer-circle-progress');
        const container = $('.timer-circle-container');
        if (!badge || !progressCircle || !container) return;
        $('#btnStart').classList.toggle('hidden', this.state !== 'idle');
        $('#btnPause').classList.toggle('hidden', !['work', 'break', 'long_break'].includes(this.state));
        $('#btnResume').classList.toggle('hidden', this.state !== 'paused');
        let currentColor = 'var(--muted)';
        if (this.state === 'work') { badge.textContent = 'LÃƒâ‚¬M VIÃ¡Â»â€ C'; badge.className = 'badge state work'; currentColor = 'var(--acc)'; }
        else if (this.state === 'break') { badge.textContent = 'NGHÃ¡Â»Ë† NGÃ¡ÂºÂ®N'; badge.className = 'badge state break'; currentColor = 'var(--warn)'; }
        else if (this.state === 'long_break') { badge.textContent = 'NGHÃ¡Â»Ë† DÃƒâ‚¬I'; badge.className = 'badge state long'; currentColor = 'var(--danger)'; }
        else if (this.state === 'paused') { badge.textContent = 'TÃ¡ÂºÂ M DÃ¡Â»ÂªNG'; badge.className = 'badge'; }
        else { badge.textContent = 'SÃ¡ÂºÂ´N SÃƒâ‚¬NG'; badge.className = 'badge'; }
        if (['work','break','long_break'].includes(this.state)) { container.classList.add('breathing'); } else { container.classList.remove('breathing'); }
        progressCircle.style.stroke = currentColor; container.classList.remove('finished');
        const timeEl = $('#timeDisplay'); if (timeEl) timeEl.textContent = formatMMSS(this.remaining);
        const radius = progressCircle.r.baseVal.value; const circumference = 2 * Math.PI * radius;
        const offset = this.segmentTotal>0 ? (circumference - (this.remaining / this.segmentTotal) * circumference) : circumference;
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = isNaN(offset) ? circumference : offset;
        const cyc = $('#cycleInfo'); if (cyc) { const cfg=this.currentConfig(); cyc.textContent = t('timer.cycleInfo', { current: this.cycleIndex, target: cfg.cycles }); }
        const draggableTimer = $('#draggableTimer'); if (draggableTimer) draggableTimer.textContent = formatMMSS(this.remaining);
      },
      persistTimerState(force=false){
        try{
          const s = getCurrentSubtopic(); if(!s) return;
          const state = { state:this.state, prevState:this.prevState, remaining:this.remaining, segmentTotal:this.segmentTotal, cycleIndex:this.cycleIndex };
          s.timerState = state; try{ localStorage.setItem('timerState_'+s.id, JSON.stringify(state)); }catch(_){ }
          this.lastPersist = Date.now();
        }catch(_){ }
      },
      _startTick(){ if(this.tickHandle) clearInterval(this.tickHandle); this.tickHandle = setInterval(()=>{ if(this.remaining>0){ this.remaining -= 1; this.updateUI(); this.persistTimerState(); } if(this.remaining<=0){ clearInterval(this.tickHandle); this.tickHandle=null; this._onFinishSegment(); } }, 1000); },
      _onFinishSegment(){
        if (this.state === 'work') {
            const s = getCurrentSubtopic();
            if (s) {
                const duration = this.currentDurations().work;
                s.stats.totalMinutes = (s.stats.totalMinutes || 0) + duration;
                s.stats.sessionsCompleted = (s.stats.sessionsCompleted || 0) + 1;
                const newSession = {
                    id: uid('sess'),
                    dateISO: todayISO(),
                    durationMinutes: duration,
                    mode: this.mode,
                    note: ''
                };
                if (!s.sessions) s.sessions = [];
                s.sessions.unshift(newSession);
                saveData();
                renderStatsHistory();
                checkAndShowMilestones();
            }
            this.cycleIndex++;
        }
        playSound(this.state === 'work' ? 'work_end' : 'break_end');
        const container = $('.timer-circle-container');
        if(container) container.classList.add('finished');
        if (data.settings.autoStartNext) {
          if(this.state==='work'){
            this.beginBreak();
          } else {
            this.beginWork();
          }
        } else {
          if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; }
          this.state = 'idle';
          this.prevState = null;
          this.updateUI();
          toast("PhiÃƒÂªn Ã„â€˜ÃƒÂ£ hoÃƒÂ n thÃƒÂ nh! NhÃ¡ÂºÂ¥n BÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u Ã„â€˜Ã¡Â»Æ’ bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u phiÃƒÂªn tiÃ¡ÂºÂ¿p theo.");
        }
      },
      beginWork(){ this.prevState=this.state; this.state='work'; const d=this.currentDurations().work*60; this.segmentTotal=d; if(this.prevState!=='paused') this.remaining=d; this._startTick(); this.updateUI(); },
      beginBreak() {
        this.prevState = this.state;
        const config = this.currentConfig();
        const durations = this.currentDurations();
        if (this.cycleIndex > 0 && this.cycleIndex % config.interval === 0) {
          this.state = 'long_break';
          const d = durations.long * 60;
          this.segmentTotal = d;
          if (this.prevState !== 'paused') this.remaining = d;
          toast(`TuyÃ¡Â»â€¡t vÃ¡Â»Âi! Ã„ÂÃƒÂ£ Ã„â€˜Ã¡ÂºÂ¿n lÃƒÂºc nghÃ¡Â»â€° dÃƒÂ i.`);
        } else {
          this.state = 'break';
          const d = durations.short * 60;
          this.segmentTotal = d;
          if (this.prevState !== 'paused') this.remaining = d;
        }
        this._startTick();
        this.updateUI();
      },
      async start(){ if(!getCurrentSubtopic()){ toast('HÃƒÂ£y chÃ¡Â»Ân mÃ¡Â»â„¢t ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con trÃ†Â°Ã¡Â»â€ºc khi bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u'); return; } ensureAudio(); if(this.state==='idle'){ this.cycleIndex = this.cycleIndex || 0; this.beginWork(); } else if(this.state==='paused'){ this.resume(); } await this.persistTimerState(true); },
      async pause(){ if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; } this.prevState=this.state; this.state='paused'; this.updateUI(); await this.persistTimerState(true); },
      async resume(){ if(this.state!=='paused'){ return; } this.state=this.prevState||'work'; this._startTick(); this.updateUI(); await this.persistTimerState(true); },
      async skip(){ this.remaining=0; if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; } this._onFinishSegment(); await this.persistTimerState(true); },
      async reset(){ if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; } this.state='idle'; this.prevState=null; this.remaining=0; this.segmentTotal=0; this.cycleIndex=0; this.updateUI(); await this.persistTimerState(true); }
    };
    async function deleteSummary(id) {
        showConfirmModal('XÃƒÂ¡c nhÃ¡ÂºÂ­n xÃƒÂ³a', 'BÃ¡ÂºÂ¡n cÃƒÂ³ chÃ¡ÂºÂ¯c muÃ¡Â»â€˜n xÃƒÂ³a tÃƒÂ³m tÃ¡ÂºÂ¯t nÃƒÂ y?', async (ok) => {
            if (!ok) return;
            const s = getCurrentSubtopic();
            if (!s || !s.summaries) return;
            const original = [...s.summaries];
            s.summaries = s.summaries.filter(x => x.id !== id);
            try {
                await storageManager.update('subtopics', s);
                renderSummaries();
                toast('Ã„ÂÃƒÂ£ xÃƒÂ³a tÃƒÂ³m tÃ¡ÂºÂ¯t.');
            } catch (err) {
                console.error('Failed to delete summary:', err);
                s.summaries = original;
                toast('KhÃƒÂ´ng thÃ¡Â»Æ’ lÃ†Â°u thay Ã„â€˜Ã¡Â»â€¢i.');
            }
        });
    }
function exportSummary(sum) {
        const blob = new Blob([sum.content], { type: 'text/plain' });
        const a = document.createElement('a');
        const ts = new Date(sum.createdAt);
        const pad = n => `${n}`.padStart(2, '0');
        a.href = URL.createObjectURL(blob);
        a.download = `summary_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}.txt`;
        a.click();
        URL.revokeObjectURL(a.href);
}
    function renderStatsHistory(){
        const s = getCurrentSubtopic();
        const statTotal = $('#statTotal');
        const statSessions = $('#statSessions');
        const statTasks = $('#statTasks');
        const list = $('#historyList');
        if (!statTotal || !statSessions || !statTasks || !list) return;

        if (!s) {
            statTotal.textContent = '0 phÃƒÂºt';
            statSessions.textContent = '0';
            statTasks.textContent = '0';
            list.innerHTML = '<div class="tiny">ChÃ†Â°a cÃƒÂ³ dÃ¡Â»Â¯ liÃ¡Â»â€¡u</div>';
            return;
        }

        const total = (s.stats && s.stats.totalMinutes) ? s.stats.totalMinutes : 0;
        const count = (s.stats && s.stats.sessionsCompleted) ? s.stats.sessionsCompleted : 0;
        const tasksDone = s.tasks ? s.tasks.filter(t => t.isCompleted).length : 0;

        statTotal.textContent = formatDaysHoursMinutes(total);
        statSessions.textContent = String(count);
        statTasks.textContent = String(tasksDone);

        list.innerHTML = '';
        const sessions = Array.isArray(s.sessions) ? s.sessions : [];
        if (sessions.length === 0) {
            list.innerHTML = '<div class="tiny">ChÃ†Â°a cÃƒÂ³ phiÃƒÂªn nÃƒÂ o</div>';
            return;
        }
        sessions.forEach(sess => {
            const row = document.createElement('div');
            row.className = 'hist-item';
            const content = document.createElement('div');
            const date = sess.dateISO ? new Date(sess.dateISO) : new Date();
            const dur = (sess.durationMinutes != null) ? sess.durationMinutes : (sess.workMinutes || 0);
            content.innerHTML = `<div class="hist-meta">${date.toLocaleString()} Ã‚Â· ${dur}' Ã‚Â· Mode ${sess.mode || ''}</div>` +
                                `<div>${sess.note ? escapeHTML(sess.note) : '<span class="tiny">(chÃ†Â°a cÃƒÂ³ ghi chÃƒÂº)</span>'}</div>`;
            row.appendChild(content);
            list.appendChild(row);
        });
    }
    function renderGeneralNotes(){
        const listEl = $('#generalNotesList');
        if (!listEl) return;
        const s = getCurrentSubtopic();
        if (!s) { listEl.innerHTML = '<div class="tiny">Vui lÃƒÂ²ng chÃ¡Â»Ân mÃ¡Â»â„¢t chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con.</div>'; return; }
        s.generalNotes = s.generalNotes || [];
        if (s.generalNotes.length === 0) { listEl.innerHTML = '<div class="tiny">ChÃ†Â°a cÃƒÂ³ ghi chÃƒÂº.</div>'; return; }
        listEl.innerHTML = '';
        s.generalNotes.forEach(note => {
            const item = document.createElement('div'); item.className = 'note-item';
            const content = document.createElement('div'); content.className = 'note-content'; content.textContent = typeof note === 'string' ? note : (note.text || '');
            const meta = document.createElement('div'); meta.className = 'note-meta'; meta.textContent = note.createdAt ? new Date(note.createdAt).toLocaleString() : '';
            const actions = document.createElement('div');
            const delBtn = document.createElement('button'); delBtn.className = 'btn small danger'; delBtn.textContent = 'XÃƒÂ³a';
            delBtn.onclick = async (e)=>{
                e.stopPropagation();
                const s2 = getCurrentSubtopic(); if (!s2) return;
                s2.generalNotes = (s2.generalNotes || []).filter(x => (x.id || x) !== (note.id || note));
                await saveData();
                renderGeneralNotes();
            };
            actions.appendChild(delBtn);
            const wrap = document.createElement('div'); wrap.className = 'note-content-wrapper'; wrap.append(content, meta);
            item.append(wrap, actions);
            listEl.appendChild(item);
        });
    }
    function addGeneralNote(){
        showInputModal('ThÃƒÂªm ghi chÃƒÂº', async (text) => {
            if (!text) return;
            const s = getCurrentSubtopic();
        if (!s) { toast('ChÃ¡Â»Ân mÃ¡Â»â„¢t chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con trÃ†Â°Ã¡Â»â€ºc.'); return; }
            s.generalNotes = s.generalNotes || [];
            s.generalNotes.unshift({ id: uid('gn'), text, createdAt: todayISO() });
            await saveData();
            renderGeneralNotes();
        }, '');
    }
    async function summarizeNotes(){
        const s = getCurrentSubtopic();
        if (!s) { toast('ChÃ¡Â»Ân chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con trÃ†Â°Ã¡Â»â€ºc.'); return; }
        const notes = (s.generalNotes || []).map(n => (typeof n === 'string' ? n : (n.text||''))).filter(Boolean);
        if (notes.length === 0) { toast('ChÃ†Â°a cÃƒÂ³ ghi chÃƒÂº Ã„â€˜Ã¡Â»Æ’ tÃƒÂ³m tÃ¡ÂºÂ¯t.'); return; }
        const btn = $('#btnSummarize');
        if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div>'; }
        try {
            const prompt = `TÃƒÂ³m tÃ¡ÂºÂ¯t cÃƒÂ¡c ghi chÃƒÂº sau theo gÃ¡ÂºÂ¡ch Ã„â€˜Ã¡ÂºÂ§u dÃƒÂ²ng, ngÃ¡ÂºÂ¯n gÃ¡Â»Ân, rÃƒÂµ rÃƒÂ ng:\n\n${notes.join('\n- ')}`;
            const result = await callGeminiAPI(prompt);
            if (!s.summaries) s.summaries = [];
            s.summaries.unshift({ id: uid('sum'), content: result || '(KhÃƒÂ´ng tÃ¡ÂºÂ¡o Ã„â€˜Ã†Â°Ã¡Â»Â£c tÃƒÂ³m tÃ¡ÂºÂ¯t)', createdAt: todayISO() });
            await saveData();
            renderSummaries();
        } catch (e) {
            console.error(e);
            toast('TÃƒÂ³m tÃ¡ÂºÂ¯t thÃ¡ÂºÂ¥t bÃ¡ÂºÂ¡i.');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'TÃƒÂ³m tÃ¡ÂºÂ¯t'; }
        }
    }
    function renderSummaries() {
        const listEl = $('#summariesList');
        if (!listEl) return;
        const s = getCurrentSubtopic();
        if (!s) { listEl.innerHTML = '<div class="tiny">Vui lÃƒÂ²ng chÃ¡Â»Ân mÃ¡Â»â„¢t chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con Ã„â€˜Ã¡Â»Æ’ xem tÃƒÂ³m tÃ¡ÂºÂ¯t.</div>'; return; }
        listEl.innerHTML = '';
        if (!s.summaries || s.summaries.length === 0) { listEl.innerHTML = '<div class="tiny">ChÃ†Â°a cÃƒÂ³ tÃƒÂ³m tÃ¡ÂºÂ¯t nÃƒÂ o.</div>'; return; }
        s.summaries.forEach(sum => {
            const item = document.createElement('div'); item.className = 'note-item';
            const contentWrapper = document.createElement('div'); contentWrapper.className = 'note-content-wrapper';
            const sumContent = document.createElement('div'); sumContent.className = 'note-content'; sumContent.textContent = sum.content;
            const sumMeta = document.createElement('div'); sumMeta.className = 'note-meta'; sumMeta.textContent = new Date(sum.createdAt).toLocaleString();
            contentWrapper.append(sumContent, sumMeta);
            const actions = document.createElement('div');
            const expBtn = document.createElement('button'); expBtn.className = 'btn small'; expBtn.textContent = 'XuÃ¡ÂºÂ¥t'; expBtn.onclick = (e)=>{ e.stopPropagation(); exportSummary(sum); };
            const delBtn = document.createElement('button'); delBtn.className = 'btn small danger'; delBtn.textContent = 'XÃƒÂ³a'; delBtn.onclick = (e)=>{ e.stopPropagation(); deleteSummary(sum.id); };
            actions.append(expBtn, delBtn);
            item.append(contentWrapper, actions);
            item.addEventListener('click', ()=> sumContent.classList.toggle('expanded'));
            listEl.appendChild(item);
        });
    }
      function loadEditingPresetFields(){
          const s = data.settings;
          const d = s.durations;
          if(editingPreset === 'A'){
              $('#set_work').value = d.A_work;
              $('#set_short').value = d.A_short;
              $('#set_long').value = d.A_long;
              $('#set_cycles').value = s.cyclesA;
              $('#set_interval').value = s.longBreakIntervalA;
          } else {
              $('#set_work').value = d.B_work;
              $('#set_short').value = d.B_short;
              $('#set_long').value = d.B_long;
              $('#set_cycles').value = s.cyclesB;
              $('#set_interval').value = s.longBreakIntervalB;
          }
      }
      function highlightPresetSelector(){
          $$('#timerPresetSelector button').forEach(btn=>{
              const isActive = btn.dataset.presetTarget === editingPreset;
              btn.classList.toggle('acc', isActive);
              btn.classList.toggle('ghost', !isActive);
          });
      }
      function openSettings(){
          const s = data.settings;
          editingPreset = s.preset;
          $('#set_apiKey').value = s.apiKey || '';
          loadEditingPresetFields();
          highlightPresetSelector();
          $('#set_volume').value=s.volume ?? 0.8;
          $('#set_theme').value=s.soundTheme || 'beep';
          // THAY Ã„ÂÃ¡Â»â€I: CÃ¡ÂºÂ­p nhÃ¡ÂºÂ­t giÃƒÂ¡ trÃ¡Â»â€¹ dropdown
          $('#set_theme_color').value = s.theme || 'default';
          const activeUrl = getActiveYoutubeUrl();
          $('#set_youtubeUrl').value = activeUrl || '';
          const initialVideoId = extractYouTubeID(activeUrl);
          $('#btnToggleYtSound').disabled = !initialVideoId;
          if ($('#ytUrlFeedback')) {
              $('#ytUrlFeedback').textContent = '';
          }
          $('#ytSoundVolume').value = s.youtubeVolume || 80;
          $('#set_ytThumbAsBg').checked = !!s.useYtThumbnailAsBg;
          $('#set_panelOpacity').value = s.panelOpacity || 0.85;
          if ($('#set_autoStartNext')) { $('#set_autoStartNext').checked = !!s.autoStartNext; }
          if ($('#set_backupDays')) { $('#set_backupDays').value = s.backupDaysToKeep || 7; }
        const backupListEl = $('#backupList');
        if (backupListEl) {
            storageManager.getBackupList().then(backups => {
                backupListEl.innerHTML = '<option value="">-- ChÃ¡Â»Ân ngÃƒÂ y Ã„â€˜Ã¡Â»Æ’ phÃ¡Â»Â¥c hÃ¡Â»â€œi --</option>';
                if (backups && backups.length > 0) {
                    backups.forEach(backup => {
                        const option = document.createElement('option');
                        option.value = backup.date;
                        option.textContent = `BÃ¡ÂºÂ£n sao lÃ†Â°u ngÃƒÂ y: ${new Date(backup.date).toLocaleDateString('vi-VN')}`;
                        backupListEl.appendChild(option);
                    });
                } else {
                    backupListEl.innerHTML = '<option value="">KhÃƒÂ´ng cÃƒÂ³ bÃ¡ÂºÂ£n sao lÃ†Â°u nÃƒÂ o</option>';
                }
            });
        }
        $('#modalSettings').classList.add('show');
    }
    function closeSettings(){ $('#modalSettings').classList.remove('show'); }
    async function setDefaults(){
        data.settings.durations={A_work:25,A_short:5,A_long:15,B_work:50,B_short:10,B_long:30};
        data.settings.cyclesA=4;
        data.settings.longBreakIntervalA=4;
        data.settings.cyclesB=4;
        data.settings.longBreakIntervalB=4;
        data.settings.preset='A';
        data.settings.volume=0.8;
        data.settings.soundTheme='beep';
        await saveData(); openSettings(); toast('Ã„ÂÃƒÂ£ khÃƒÂ´i phÃ¡Â»Â¥c mÃ¡ÂºÂ·c Ã„â€˜Ã¡Â»â€¹nh'); }
      async function saveSettings(){
          const s = data.settings;
          s.apiKey = $('#set_apiKey').value.trim();
          const d = s.durations;
          if(editingPreset === 'A'){
              d.A_work = clampInt($('#set_work').value,1,999);
              d.A_short = clampInt($('#set_short').value,1,999);
              d.A_long = clampInt($('#set_long').value,1,999);
              s.cyclesA = clampInt($('#set_cycles').value,1,12);
              s.longBreakIntervalA = clampInt($('#set_interval').value,2,12);
          } else {
              d.B_work = clampInt($('#set_work').value,1,999);
              d.B_short = clampInt($('#set_short').value,1,999);
              d.B_long = clampInt($('#set_long').value,1,999);
              s.cyclesB = clampInt($('#set_cycles').value,1,12);
              s.longBreakIntervalB = clampInt($('#set_interval').value,2,12);
          }
          s.volume = clampFloat($('#set_volume').value,0,1,0.8);
          s.soundTheme = $('#set_theme').value==='chime' ? 'chime':'beep';
          // THAY Ã„ÂÃ¡Â»â€I: LÃ†Â°u giÃƒÂ¡ trÃ¡Â»â€¹ theme
          s.theme = $('#set_theme_color').value;
          s.panelOpacity = parseFloat($('#set_panelOpacity').value) || 0.85;
          s.autoStartNext = !!($('#set_autoStartNext') && $('#set_autoStartNext').checked);
          if ($('#set_backupDays')) { s.backupDaysToKeep = clampInt($('#set_backupDays').value, 1, 30); }

          // BÃ¡Â»â€¢ sung: NÃ¡ÂºÂ¿u chÃ¡Â»Ân theme sÃƒÂ¡ng, luÃƒÂ´n tÃ¡ÂºÂ¯t thumbnail YouTube lÃƒÂ m nÃ¡Â»Ân
          if (s.theme === 'light' || s.theme === 'pastel') {
              s.useYtThumbnailAsBg = false;
              // NÃ¡ÂºÂ¿u nÃ¡Â»Ân hiÃ¡Â»â€¡n tÃ¡ÂºÂ¡i lÃƒÂ  thumbnail YouTube, bÃ¡Â»Â nÃ¡Â»Ân Ã„â€˜Ã¡Â»Æ’ giÃ¡Â»Â¯ nÃ¡Â»Ân gÃ¡Â»â€˜c cÃ¡Â»Â§a theme sÃƒÂ¡ng
              if (typeof s.customBg === 'string' && s.customBg.includes('img.youtube.com/vi/')) {
                  s.customBg = '';
              }
          } else {
              // NgÃ†Â°Ã¡Â»Â£c lÃ¡ÂºÂ¡i, vÃ¡Â»â€ºi theme tÃ¡Â»â€˜i thÃƒÂ¬ bÃ¡ÂºÂ­t dÃƒÂ¹ng thumbnail YouTube (nÃ¡ÂºÂ¿u cÃƒÂ³ link)
              s.useYtThumbnailAsBg = true;
          }

          const newYtUrl = $('#set_youtubeUrl').value.trim();
          s.useYtThumbnailAsBg = $('#set_ytThumbAsBg').checked;
          s.youtubeVolume = parseInt($('#ytSoundVolume').value, 10);
          sessionYoutubeUrl = newYtUrl;
          updateYouTubePlayer(); 

          await saveData();
          applyTheme();
          applyCustomBg();
          applyPanelOpacity();
          updatePresetButtonsText();
          timer.setPreset(s.preset, {silent:true});

          closeSettings();
          toast('Ã„ÂÃƒÂ£ lÃ†Â°u cÃƒÂ i Ã„â€˜Ã¡ÂºÂ·t');
      }
    function clampInt(v,min,max){ v=parseInt(v||0,10); if(isNaN(v)) v=min; return Math.max(min, Math.min(max, v)); }
    function clampFloat(v,min,max,def){ v=parseFloat(v); if(Number.isNaN(v)) v=def; return Math.max(min, Math.min(max, v)); }
    const dbPromise = new Promise((resolve, reject) => {
        const req = indexedDB.open('pomodoro_files', 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore('files');
        req.onsuccess = (e) => resolve(e.target.result);
        req.onerror = (e) => reject(e);
    });
    const fileCache = {};
    function handleFileUpload(file, callback) {
        if (!file) return;
        dbPromise.then(db => {
            const id = uid('file');
            const tx = db.transaction('files', 'readwrite');
            tx.objectStore('files').put(file, id);
            tx.oncomplete = () => callback(id);
            tx.onerror = () => toast("LÃ¡Â»â€”i lÃ†Â°u file.");
        });
    }
    function getStoredFileUrl(id){
        if (!id) return Promise.resolve('');
        if (fileCache[id]) return Promise.resolve(fileCache[id]);
        return dbPromise.then(db => new Promise((resolve) => {
            const tx = db.transaction('files', 'readonly');
            const req = tx.objectStore('files').get(id);
            req.onsuccess = (e) => {
                const file = e.target.result;
                if (file) {
                    const url = URL.createObjectURL(file);
                    fileCache[id] = url;
                    resolve(url);
                } else resolve('');
            };
            req.onerror = () => resolve('');
        }));
    }
    function applyCustomBg() {
        const ref = data.settings.customBg;
        const theme = data.settings.theme;
        const themeHasBg = ['lofi', 'space'].includes(theme);
        const isLightTheme = (theme === 'light' || theme === 'pastel');

        const clearInlineBgFallback = () => { try { document.body.style.backgroundImage = ''; } catch(_) {} };

        if (ref) {
            const urlPromise = (ref.startsWith('data:') || ref.startsWith('http') || ref.startsWith('blob:'))
                ? Promise.resolve(ref)
                : getStoredFileUrl(ref);
            
            urlPromise.then(url => {
                if (url) {
                    document.body.style.setProperty('--bg-image', `url(${url})`);
                } else {
                    document.body.style.setProperty('--bg-image', isLightTheme ? 'none' : '');
                }
                clearInlineBgFallback();
            });
        } else if (!themeHasBg) {
            if (isLightTheme) {
                // Light/pastel: khÃƒÂ´ng dÃƒÂ¹ng nÃ¡Â»Ân tÃ¡Â»â€˜i
                document.body.style.setProperty('--bg-image', 'none');
                clearInlineBgFallback();
            } else {
                // Dark/default fallback
                document.body.style.setProperty('--bg-image', 'radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%)');
            }
        } else {
            // Let the CSS for the theme handle the background
            document.body.style.removeProperty('--bg-image');
            clearInlineBgFallback();
        }
    }
    function applyPanelOpacity() { document.documentElement.style.setProperty('--panel-opacity', data.settings.panelOpacity); }
      function renderDashboard(){
          const stats = data.topics.flatMap(t => t.subtopics.map(s => ({ topic: t.name, subtopic: s.name, m: s.stats.totalMinutes || 0, c: s.stats.sessionsCompleted || 0, t: s.stats.tasksCompleted || 0 })));
          const totalM = stats.reduce((a, b) => a + b.m, 0);
          const totalC = stats.reduce((a, b) => a + b.c, 0);
          const totalT = stats.reduce((a, b) => a + b.t, 0);

        let tableHTML = `<p class="tiny"><strong>TÃ¡Â»â€¢ng thÃ¡Â»Âi gian:</strong> ${formatDaysHoursMinutes(totalM)} | <strong>TÃ¡Â»â€¢ng phiÃƒÂªn:</strong> ${totalC} | <strong>TÃ¡Â»â€¢ng nhiÃ¡Â»â€¡m vÃ¡Â»Â¥:</strong> ${totalT}</p>
        <table class="dashboard-table">
            <thead><tr><th>ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â</th><th>ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con</th><th>ThÃ¡Â»Âi gian</th><th>PhiÃƒÂªn</th><th>NhiÃ¡Â»â€¡m vÃ¡Â»Â¥</th></tr></thead>
            <tbody>`;

          stats.forEach(item => {
            tableHTML += `<tr><td>${escapeHTML(item.topic)}</td><td>${escapeHTML(item.subtopic)}</td><td>${formatDaysHoursMinutes(item.m)}</td><td>${item.c}</td><td>${item.t}</td></tr>`;
        });

        tableHTML += '</tbody></table>';
        const contentEl = $('#dashboardContent');
        if (contentEl) contentEl.innerHTML = tableHTML;
    }
    function getMilestones(){
        return [
            { hours: 10000, title: "GÃ¡Â»Â­i bÃ¡ÂºÂ¡n, 10.000+ giÃ¡Â»Â (ChÃƒÂ¢n SÃ†Â°)", message: "ThÃ¡ÂºÂ­t vinh dÃ¡Â»Â± khi Ã„â€˜Ã†Â°Ã¡Â»Â£c trÃƒÂ² chuyÃ¡Â»â€¡n cÃƒÂ¹ng bÃ¡ÂºÂ¡n. KhÃƒÂ´ng cÃƒÂ³ nhiÃ¡Â»Âu ngÃ†Â°Ã¡Â»Âi trÃƒÂªn thÃ¡ÂºÂ¿ giÃ¡Â»â€ºi Ã„â€˜Ã¡ÂºÂ¡t Ã„â€˜Ã¡ÂºÂ¿n cÃ¡ÂºÂ¥p Ã„â€˜Ã¡Â»â„¢ nÃƒÂ y. BÃ¡ÂºÂ¡n khÃƒÂ´ng chÃ¡Â»â€° thÃƒÂ nh thÃ¡ÂºÂ¡o mÃ¡Â»â„¢t kÃ¡Â»Â¹ nÃ„Æ’ng, bÃ¡ÂºÂ¡n Ã„â€˜ÃƒÂ£ Ã„â€˜Ã¡Â»â€¹nh nghÃ„Â©a lÃ¡ÂºÂ¡i nÃƒÂ³. SÃ¡Â»Â± nÃ¡Â»â€” lÃ¡Â»Â±c vÃƒÂ  hy sinh cÃ¡Â»Â§a bÃ¡ÂºÂ¡n Ã„â€˜ÃƒÂ£ tÃ¡ÂºÂ¡o ra nhÃ¡Â»Â¯ng Ã„â€˜iÃ¡Â»Âu phi thÃ†Â°Ã¡Â»Âng.\nCÃƒÂ³ lÃ¡ÂºÂ½ bÃƒÂ¢y giÃ¡Â»Â bÃ¡ÂºÂ¡n khÃƒÂ´ng cÃƒÂ²n nghÃ„Â© vÃ¡Â»Â viÃ¡Â»â€¡c hÃ¡Â»Âc kÃ¡Â»Â¹ nÃ„Æ’ng nÃ¡Â»Â¯a, mÃƒÂ  lÃƒÂ  vÃ¡Â»Â viÃ¡Â»â€¡c Ã„â€˜Ã¡Â»Æ’ lÃ¡ÂºÂ¡i di sÃ¡ÂºÂ£n. BÃ¡ÂºÂ¡n sÃ¡ÂºÂ½ truyÃ¡Â»Ân lÃ¡ÂºÂ¡i ngÃ¡Â»Ân Ã„â€˜uÃ¡Â»â€˜c nÃƒÂ y nhÃ†Â° thÃ¡ÂºÂ¿ nÃƒÂ o? BÃ¡ÂºÂ¡n sÃ¡ÂºÂ½ phÃƒÂ¡ vÃ¡Â»Â¡ nhÃ¡Â»Â¯ng giÃ¡Â»â€ºi hÃ¡ÂºÂ¡n nÃƒÂ o tiÃ¡ÂºÂ¿p theo mÃƒÂ  chÃ†Â°a ai tÃ¡Â»Â«ng nghÃ„Â© tÃ¡Â»â€ºi? ThÃ¡ÂºÂ¿ giÃ¡Â»â€ºi Ã„â€˜ang dÃƒÂµi theo nhÃ¡Â»Â¯ng gÃƒÂ¬ bÃ¡ÂºÂ¡n lÃƒÂ m, khÃƒÂ´ng phÃ¡ÂºÂ£i Ã„â€˜Ã¡Â»Æ’ hÃ¡Â»Âc theo mÃ¡Â»â„¢t cÃƒÂ´ng thÃ¡Â»Â©c, mÃƒÂ  Ã„â€˜Ã¡Â»Æ’ Ã„â€˜Ã†Â°Ã¡Â»Â£c truyÃ¡Â»Ân cÃ¡ÂºÂ£m hÃ¡Â»Â©ng tÃ¡Â»Â« chÃƒÂ­nh hÃƒÂ nh trÃƒÂ¬nh vÃƒÂ  sÃ¡Â»Â± sÃƒÂ¡ng tÃ¡ÂºÂ¡o cÃ¡Â»Â§a bÃ¡ÂºÂ¡n.\nCÃ¡ÂºÂ£m Ã†Â¡n bÃ¡ÂºÂ¡n vÃƒÂ¬ Ã„â€˜ÃƒÂ£ cho chÃƒÂºng tÃƒÂ´i thÃ¡ÂºÂ¥y nhÃ¡Â»Â¯ng giÃ¡Â»â€ºi hÃ¡ÂºÂ¡n cÃ¡Â»Â§a con ngÃ†Â°Ã¡Â»Âi cÃƒÂ³ thÃ¡Â»Æ’ Ã„â€˜Ã†Â°Ã¡Â»Â£c Ã„â€˜Ã¡ÂºÂ©y xa Ã„â€˜Ã¡ÂºÂ¿n nhÃ†Â°Ã¡Â»Âng nÃƒÂ o." },
            { hours: 5000, title: "GÃ¡Â»Â­i bÃ¡ÂºÂ¡n, 5.000 giÃ¡Â»Â (Tinh ThÃƒÂ´ng)", message: "SÃ¡Â»Â± cÃ¡Â»â€˜ng hiÃ¡ÂºÂ¿n cÃ¡Â»Â§a bÃ¡ÂºÂ¡n thÃ¡ÂºÂ­t Ã„â€˜ÃƒÂ¡ng kinh ngÃ¡ÂºÂ¡c. BÃ¡ÂºÂ¡n Ã„â€˜ÃƒÂ£ trÃ¡Â»Å¸ thÃƒÂ nh mÃ¡Â»â„¢t chuyÃƒÂªn gia, mÃ¡Â»â„¢t ngÃ†Â°Ã¡Â»Âi mÃƒÂ  ngÃ†Â°Ã¡Â»Âi khÃƒÂ¡c tÃƒÂ¬m Ã„â€˜Ã¡ÂºÂ¿n Ã„â€˜Ã¡Â»Æ’ hÃ¡Â»Âc hÃ¡Â»Âi vÃƒÂ  xin lÃ¡Â»Âi khuyÃƒÂªn. KÃ¡Â»Â¹ nÃ„Æ’ng cÃ¡Â»Â§a bÃ¡ÂºÂ¡n khÃƒÂ´ng chÃ¡Â»â€° lÃƒÂ  mÃ¡Â»â„¢t cÃƒÂ´ng cÃ¡Â»Â¥, nÃƒÂ³ Ã„â€˜ÃƒÂ£ trÃ¡Â»Å¸ thÃƒÂ nh mÃ¡Â»â„¢t phÃ¡ÂºÂ§n con ngÃ†Â°Ã¡Â»Âi bÃ¡ÂºÂ¡n.\nLÃ¡Â»Âi nhÃ¡ÂºÂ¯n cÃ¡Â»Â§a tÃƒÂ´i dÃƒÂ nh cho bÃ¡ÂºÂ¡n lÃƒÂ : HÃƒÂ£y luÃƒÂ´n giÃ¡Â»Â¯ cho mÃƒÂ¬nh \"tÃƒÂ¢m trÃƒÂ­ cÃ¡Â»Â§a ngÃ†Â°Ã¡Â»Âi mÃ¡Â»â€ºi bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u\". Ã„ÂÃ¡Â»Â«ng Ã„â€˜Ã¡Â»Æ’ kiÃ¡ÂºÂ¿n thÃ¡Â»Â©c sÃƒÂ¢u rÃ¡Â»â„¢ng cÃ¡Â»Â§a mÃƒÂ¬nh biÃ¡ÂºÂ¿n thÃƒÂ nh sÃ¡Â»Â± tÃ¡Â»Â± mÃƒÂ£n. HÃƒÂ£y tiÃ¡ÂºÂ¿p tÃ¡Â»Â¥c hÃ¡Â»Âc hÃ¡Â»Âi tÃ¡Â»Â« nhÃ¡Â»Â¯ng lÃ„Â©nh vÃ¡Â»Â±c khÃƒÂ¡c, lÃ¡ÂºÂ¯ng nghe nhÃ¡Â»Â¯ng ngÃ†Â°Ã¡Â»Âi mÃ¡Â»â€ºi vÃƒÂ o nghÃ¡Â»Â vÃƒÂ  khÃƒÂ´ng ngÃ¡Â»Â«ng Ã„â€˜Ã¡ÂºÂ·t cÃƒÂ¢u hÃ¡Â»Âi. GiÃ¡Â»Â Ã„â€˜ÃƒÂ¢y, vai trÃƒÂ² cÃ¡Â»Â§a bÃ¡ÂºÂ¡n khÃƒÂ´ng chÃ¡Â»â€° lÃƒÂ  lÃƒÂ m tÃ¡Â»â€˜t cÃƒÂ´ng viÃ¡Â»â€¡c cÃ¡Â»Â§a mÃƒÂ¬nh, mÃƒÂ  cÃƒÂ²n lÃƒÂ  nÃƒÂ¢ng Ã„â€˜Ã¡Â»Â¡ vÃƒÂ  truyÃ¡Â»Ân cÃ¡ÂºÂ£m hÃ¡Â»Â©ng cho nhÃ¡Â»Â¯ng ngÃ†Â°Ã¡Â»Âi Ã„â€˜i sau." },
            { hours: 1000, title: "GÃ¡Â»Â­i bÃ¡ÂºÂ¡n, 1.000 giÃ¡Â»Â (VÃ¡Â»Â¯ng VÃƒÂ ng)", message: "BÃ¡ÂºÂ¡n khÃƒÂ´ng cÃƒÂ²n lÃƒÂ  ngÃ†Â°Ã¡Â»Âi mÃ¡Â»â€ºi nÃ¡Â»Â¯a. BÃ¡ÂºÂ¡n Ã„â€˜ÃƒÂ£ cÃƒÂ³ nÃ„Æ’ng lÃ¡Â»Â±c, sÃ¡Â»Â± tÃ¡Â»Â± tin vÃƒÂ  cÃƒÂ³ thÃ¡Â»Æ’ tÃ¡ÂºÂ¡o ra nhÃ¡Â»Â¯ng kÃ¡ÂºÂ¿t quÃ¡ÂºÂ£ Ã„â€˜ÃƒÂ¡ng tÃ¡Â»Â± hÃƒÂ o. BÃ¡ÂºÂ¡n xÃ¡Â»Â©ng Ã„â€˜ÃƒÂ¡ng Ã„â€˜Ã†Â°Ã¡Â»Â£c cÃƒÂ´ng nhÃ¡ÂºÂ­n vÃƒÂ¬ sÃ¡Â»Â± kiÃƒÂªn trÃƒÂ¬ cÃ¡Â»Â§a mÃƒÂ¬nh.\nBÃƒÂ¢y giÃ¡Â»Â, thÃ¡Â»Â­ thÃƒÂ¡ch cÃ¡Â»Â§a bÃ¡ÂºÂ¡n lÃƒÂ  chuyÃ¡Â»Æ’n tÃ¡Â»Â« \"lÃƒÂ m theo\" sang \"thÃ¡ÂºÂ¥u hiÃ¡Â»Æ’u\". HÃƒÂ£y tÃ¡Â»Â± hÃ¡Â»Âi mÃƒÂ¬nh \"TÃ¡ÂºÂ¡i sao nÃƒÂ³ lÃ¡ÂºÂ¡i hoÃ¡ÂºÂ¡t Ã„â€˜Ã¡Â»â„¢ng nhÃ†Â° vÃ¡ÂºÂ­y?\". HÃƒÂ£y thÃ¡Â»Â­ dÃ¡ÂºÂ¡y lÃ¡ÂºÂ¡i cho ngÃ†Â°Ã¡Â»Âi khÃƒÂ¡c, vÃƒÂ¬ Ã„â€˜ÃƒÂ³ lÃƒÂ  cÃƒÂ¡ch tÃ¡Â»â€˜t nhÃ¡ÂºÂ¥t Ã„â€˜Ã¡Â»Æ’ cÃ¡Â»Â§ng cÃ¡Â»â€˜ kiÃ¡ÂºÂ¿n thÃ¡Â»Â©c cÃ¡Â»Â§a chÃƒÂ­nh mÃƒÂ¬nh. Ã„ÂÃƒÂ¢y lÃƒÂ  lÃƒÂºc Ã„â€˜Ã¡Â»Æ’ tinh chÃ¡Â»â€°nh, tÃ¡Â»â€˜i Ã†Â°u hÃƒÂ³a vÃƒÂ  bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u hÃƒÂ¬nh thÃƒÂ nh phong cÃƒÂ¡ch Ã„â€˜Ã¡Â»â„¢c Ã„â€˜ÃƒÂ¡o cÃ¡Â»Â§a riÃƒÂªng bÃ¡ÂºÂ¡n. HÃƒÂ£y biÃ¡ÂºÂ¿n sÃ¡Â»Â± thÃƒÂ nh thÃ¡ÂºÂ¡o thÃƒÂ nh nghÃ¡Â»â€¡ thuÃ¡ÂºÂ­t." },
            { hours: 100, title: "GÃ¡Â»Â­i bÃ¡ÂºÂ¡n, 100 giÃ¡Â»Â (Ã„ÂÃ¡Â»â€¹nh HÃƒÂ¬nh)", message: "BÃ¡ÂºÂ¡n Ã„â€˜ÃƒÂ£ vÃ†Â°Ã¡Â»Â£t qua Ã„â€˜Ã†Â°Ã¡Â»Â£c giai Ã„â€˜oÃ¡ÂºÂ¡n khÃƒÂ³ khÃ„Æ’n nhÃ¡ÂºÂ¥t vÃƒÂ  giÃ¡Â»Â Ã„â€˜ÃƒÂ¢y, kÃ¡Â»Â¹ nÃ„Æ’ng nÃƒÂ y Ã„â€˜ang thÃ¡Â»Â±c sÃ¡Â»Â± \"ngÃ¡ÂºÂ¥m\" vÃƒÂ o bÃ¡ÂºÂ¡n. NhÃ¡Â»Â¯ng tia sÃƒÂ¡ng cÃ¡Â»Â§a sÃ¡Â»Â± thÃƒÂ nh thÃ¡ÂºÂ¡o Ã„â€˜ÃƒÂ£ bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u xuÃ¡ÂºÂ¥t hiÃ¡Â»â€¡n. ThÃ¡ÂºÂ­t tuyÃ¡Â»â€¡t vÃ¡Â»Âi!\nÃ„ÂÃƒÂ¢y lÃƒÂ  giai Ã„â€˜oÃ¡ÂºÂ¡n bÃ¡ÂºÂ¡n cÃ¡ÂºÂ£m thÃ¡ÂºÂ¥y hÃ¡Â»Â©ng khÃ¡Â»Å¸i nhÃ¡ÂºÂ¥t, nhÃ†Â°ng cÃ…Â©ng lÃƒÂ  lÃƒÂºc dÃ¡Â»â€¦ rÃ†Â¡i vÃƒÂ o cÃƒÂ¡i bÃ¡ÂºÂ«y \"biÃ¡ÂºÂ¿t Ã„â€˜Ã¡Â»Â§ rÃ¡Â»â€œi\". Ã„ÂÃ¡Â»Â«ng dÃ¡Â»Â«ng lÃ¡ÂºÂ¡i. HÃƒÂ£y bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u khÃƒÂ¡m phÃƒÂ¡ sÃƒÂ¢u hÃ†Â¡n, thÃ¡Â»Â­ nghiÃ¡Â»â€¡m nhÃ¡Â»Â¯ng kÃ¡Â»Â¹ thuÃ¡ÂºÂ­t mÃ¡Â»â€ºi vÃƒÂ  Ã„â€˜Ã¡Â»Â«ng ngÃ¡ÂºÂ¡i phÃƒÂ¡ vÃ¡Â»Â¡ cÃƒÂ¡c quy tÃ¡ÂºÂ¯c bÃ¡ÂºÂ¡n vÃ¡Â»Â«a hÃ¡Â»Âc Ã„â€˜Ã†Â°Ã¡Â»Â£c. HÃƒÂ£y tÃƒÂ¬m mÃ¡Â»â„¢t cÃ¡Â»â„¢ng Ã„â€˜Ã¡Â»â€œng hoÃ¡ÂºÂ·c mÃ¡Â»â„¢t ngÃ†Â°Ã¡Â»Âi hÃ†Â°Ã¡Â»â€ºng dÃ¡ÂºÂ«n Ã„â€˜Ã¡Â»Æ’ nhÃ¡ÂºÂ­n Ã„â€˜Ã†Â°Ã¡Â»Â£c phÃ¡ÂºÂ£n hÃ¡Â»â€œi. SÃ¡Â»Â± tÃƒÂ² mÃƒÂ² chÃƒÂ­nh lÃƒÂ  nhiÃƒÂªn liÃ¡Â»â€¡u tÃ¡Â»â€˜t nhÃ¡ÂºÂ¥t Ã„â€˜Ã¡Â»Æ’ Ã„â€˜Ã†Â°a bÃ¡ÂºÂ¡n tiÃ¡ÂºÂ¿n xa hÃ†Â¡n. HÃƒÂ£y biÃ¡ÂºÂ¿n kÃ¡Â»Â¹ nÃ„Æ’ng nÃƒÂ y thÃƒÂ nh cÃ¡Â»Â§a riÃƒÂªng bÃ¡ÂºÂ¡n." },
            { hours: 20, title: "GÃ¡Â»Â­i bÃ¡ÂºÂ¡n, 20 giÃ¡Â»Â (Khai MÃ¡Â»Å¸)", message: "ChÃƒÂºc mÃ¡Â»Â«ng bÃ¡ÂºÂ¡n Ã„â€˜ÃƒÂ£ lÃƒÂ m Ã„â€˜Ã†Â°Ã¡Â»Â£c Ã„â€˜iÃ¡Â»Âu khÃƒÂ³ nhÃ¡ÂºÂ¥t: BÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u.\nÃ„ÂÃ¡Â»Â«ng lo lÃ¡ÂºÂ¯ng nÃ¡ÂºÂ¿u bÃƒÂ¢y giÃ¡Â»Â bÃ¡ÂºÂ¡n cÃ¡ÂºÂ£m thÃ¡ÂºÂ¥y mÃƒÂ¬nh thÃ¡ÂºÂ­t vÃ¡Â»Â¥ng vÃ¡Â»Â, chÃ¡ÂºÂ­m chÃ¡ÂºÂ¡p vÃƒÂ  liÃƒÂªn tÃ¡Â»Â¥c mÃ¡ÂºÂ¯c lÃ¡Â»â€”i. MÃ¡Â»Âi bÃ¡ÂºÂ­c thÃ¡ÂºÂ§y Ã„â€˜Ã¡Â»Âu tÃ¡Â»Â«ng lÃƒÂ  mÃ¡Â»â„¢t \"thÃ¡ÂºÂ£m hÃ¡Â»Âa\" khi mÃ¡Â»â€ºi bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u. HÃƒÂ£y nhÃ¡Â»â€º rÃ¡ÂºÂ±ng mÃ¡Â»Â¥c tiÃƒÂªu cÃ¡Â»Â§a bÃ¡ÂºÂ¡n lÃƒÂºc nÃƒÂ y khÃƒÂ´ng phÃ¡ÂºÂ£i lÃƒÂ  sÃ¡Â»Â± hoÃƒÂ n hÃ¡ÂºÂ£o, mÃƒÂ  lÃƒÂ  sÃ¡Â»Â± hiÃ¡Â»â€¡n diÃ¡Â»â€¡n. MÃ¡Â»â€”i giÃ¡Â»Â bÃ¡ÂºÂ¡n dÃƒÂ nh ra Ã„â€˜Ã¡Â»Æ’ luyÃ¡Â»â€¡n tÃ¡ÂºÂ­p lÃƒÂ  mÃ¡Â»â„¢t chiÃ¡ÂºÂ¿n thÃ¡ÂºÂ¯ng trÃ†Â°Ã¡Â»â€ºc sÃ¡Â»Â± trÃƒÂ¬ hoÃƒÂ£n vÃƒÂ  nÃ¡Â»â€”i sÃ¡Â»Â£ thÃ¡ÂºÂ¥t bÃ¡ÂºÂ¡i.\nHÃƒÂ£y kiÃƒÂªn nhÃ¡ÂºÂ«n vÃ¡Â»â€ºi chÃƒÂ­nh mÃƒÂ¬nh, tÃ¡ÂºÂ­n hÃ†Â°Ã¡Â»Å¸ng tÃ¡Â»Â«ng tiÃ¡ÂºÂ¿n bÃ¡Â»â„¢ nhÃ¡Â»Â nhÃ¡ÂºÂ¥t vÃƒÂ  Ã„â€˜Ã¡Â»Â«ng bao giÃ¡Â»Â so sÃƒÂ¡nh khÃ¡Â»Å¸i Ã„â€˜Ã¡ÂºÂ§u cÃ¡Â»Â§a mÃƒÂ¬nh vÃ¡Â»â€ºi \"Ã„â€˜oÃ¡ÂºÂ¡n giÃ¡Â»Â¯a\" cÃ¡Â»Â§a ngÃ†Â°Ã¡Â»Âi khÃƒÂ¡c. BÃ¡ÂºÂ¡n Ã„â€˜ang xÃƒÂ¢y dÃ¡Â»Â±ng nÃ¡Â»Ân mÃƒÂ³ng, vÃƒÂ  mÃ¡Â»â„¢t nÃ¡Â»Ân mÃƒÂ³ng vÃ¡Â»Â¯ng chÃ¡ÂºÂ¯c cÃ¡ÂºÂ§n thÃ¡Â»Âi gian. CÃ¡Â»Â© tiÃ¡ÂºÂ¿p tÃ¡Â»Â¥c nhÃƒÂ©!" }
        ];
    }
    async function checkAndShowMilestones() {
        if (!data || !data.settings) return;
        if (!Array.isArray(data.settings.achievedMilestones)) data.settings.achievedMilestones = [];
        const totalMinutes = data.topics.reduce((total, topic) => {
            return total + topic.subtopics.reduce((subTotal, subtopic) => {
                return subTotal + (subtopic.stats.totalMinutes || 0);
            }, 0);
        }, 0);
        const totalHours = totalMinutes / 60;
        const milestones = getMilestones();
        const achieved = Array.isArray(data.settings.achievedMilestones) ? data.settings.achievedMilestones : [];
        const eligible = milestones.filter(m => totalHours >= m.hours && !achieved.includes(m.hours));
        if (eligible.length === 0) return false;
        const target = eligible.reduce((best, m) => (best && best.hours > m.hours ? best : m), null);
        if (!target) return false;
        $('#milestoneTitle').textContent = target.title;
        $('#milestoneMessage').textContent = target.message;
        $('#modalMilestone').classList.add('show');
        data.settings.achievedMilestones.push(target.hours);
        await saveData();
        return true;
    }
    async function seedAchievedMilestones() {
        if (!data || !data.settings) return;
        if (!Array.isArray(data.settings.achievedMilestones)) {
            data.settings.achievedMilestones = [];
            await saveData();
        }
    }
    async function handleSendMessage() {
        const btn = $('#btnSendMessage');
        const input = $('#chatInput');
        const query = input.value.trim();
        const subtopic = getCurrentSubtopic();
        if (!query) return;
        if (!subtopic) { toast(t('timer.selectSubtopicPrompt')); return; }
        input.value = '';
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div>';
        subtopic.chatHistory.push({ role: 'user', text: query });
        renderChat();
        const response = await callGeminiAPI(query);
        if (response) {
            subtopic.chatHistory.push({ role: 'model', text: response });
            await saveData();
            renderChat();
        }
        btn.disabled = false;
        btn.innerHTML = 'GÃ¡Â»Â­i';
    }
    function renderChat() {
        const s = getCurrentSubtopic();
        const messagesEl = $('#chatMessages');
        const chatInput = $('#chatInput');
        const sendBtn = $('#btnSendMessage');
        if (!messagesEl || !chatInput || !sendBtn) return;
        if (!s) {
            messagesEl.innerHTML = '<div class="tiny">ChÃ¡Â»Ân chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con Ã„â€˜Ã¡Â»Æ’ bÃ¡ÂºÂ¯t Ã„â€˜Ã¡ÂºÂ§u chat.</div>';
            chatInput.disabled = true; sendBtn.disabled = true;
            return;
        }
        chatInput.disabled = false; sendBtn.disabled = false;
        messagesEl.innerHTML = '';
        if (!s.chatHistory || s.chatHistory.length === 0) {
            messagesEl.innerHTML = '<div class="tiny">ChÃ†Â°a cÃƒÂ³ tin nhÃ¡ÂºÂ¯n nÃƒÂ o.</div>';
            return;
        }
        s.chatHistory.forEach(msg => {
            const msgEl = document.createElement('div');
            msgEl.className = `chat-msg ${msg.role}`;
            msgEl.textContent = msg.text;
            messagesEl.appendChild(msgEl);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    async function handleSummarizeNote() {
        const btn = $('#btnSummarizeNote');
        const noteTextEl = $('#noteText');
        const noteText = noteTextEl.value.trim();
        const subtopic = getCurrentSubtopic();
        if (!noteText) { toast("Vui lÃƒÂ²ng nhÃ¡ÂºÂ­p ghi chÃƒÂº trÃ†Â°Ã¡Â»â€ºc khi tÃƒÂ³m tÃ¡ÂºÂ¯t."); return; }
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<div class="spinner"></div>'; btn.disabled = true;
        const prompt = `DÃ¡Â»Â±a vÃƒÂ o thÃƒÂ´ng tin sau:\n- ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â: "${subtopic?.name || 'khÃƒÂ´ng rÃƒÂµ'}"\n- Ghi chÃƒÂº cÃ¡Â»Â§a ngÃ†Â°Ã¡Â»Âi dÃƒÂ¹ng sau mÃ¡Â»â„¢t phiÃƒÂªn lÃƒÂ m viÃ¡Â»â€¡c: "${noteText}"\n\nHÃƒÂ£y tÃ¡ÂºÂ¡o mÃ¡Â»â„¢t bÃ¡ÂºÂ£n tÃƒÂ³m tÃ¡ÂºÂ¯t ngÃ¡ÂºÂ¯n gÃ¡Â»Ân vÃ¡Â»Â nhÃ¡Â»Â¯ng gÃƒÂ¬ Ã„â€˜ÃƒÂ£ lÃƒÂ m vÃƒÂ  Ã„â€˜Ã¡Â»Â xuÃ¡ÂºÂ¥t mÃ¡Â»â„¢t bÃ†Â°Ã¡Â»â€ºc hÃ¡Â»Â£p lÃƒÂ½ tiÃ¡ÂºÂ¿p theo. Ã„ÂÃ¡Â»â€¹nh dÃ¡ÂºÂ¡ng cÃƒÂ¢u trÃ¡ÂºÂ£ lÃ¡Â»Âi nhÃ†Â° sau:\n\n---\n**Ã¢Å“Â¨ TÃƒÂ³m tÃ¡ÂºÂ¯t AI:**\n[TÃƒÂ³m tÃ¡ÂºÂ¯t Ã¡Â»Å¸ Ã„â€˜ÃƒÂ¢y]\n\n**Ã°Å¸Å¡â‚¬ GÃ¡Â»Â£i ÃƒÂ½ tiÃ¡ÂºÂ¿p theo:**\n[GÃ¡Â»Â£i ÃƒÂ½ Ã¡Â»Å¸ Ã„â€˜ÃƒÂ¢y]`;
        const result = await callGeminiAPI(prompt);
        if (result) {
            noteTextEl.value += `\n\n${result}`;
        }
        btn.innerHTML = originalContent; btn.disabled = false;
    }
    function clearChat() {
        const s = getCurrentSubtopic();
        if (!s) { toast(t('timer.selectSubtopicPrompt')); return; }
        showConfirmModal('XÃƒÂ¡c nhÃ¡ÂºÂ­n xÃƒÂ³a', 'BÃ¡ÂºÂ¡n cÃƒÂ³ chÃ¡ÂºÂ¯c muÃ¡Â»â€˜n xÃƒÂ³a toÃƒÂ n bÃ¡Â»â„¢ lÃ¡Â»â€¹ch sÃ¡Â»Â­ chat cÃ¡Â»Â§a chÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â con nÃƒÂ y?', async (ok) => {
            if (ok) {
                s.chatHistory = [];
                await saveData();
                renderChat();
                toast("Ã„ÂÃƒÂ£ xÃƒÂ³a lÃ¡Â»â€¹ch sÃ¡Â»Â­ chat.");
            }
        });
    }
    let ytPlayer;
    let ytUserPaused = false;
    let ytFallbackFrame = null;
    let ytFallbackIsPlaying = false;
    function buildFallbackSrc(videoId, { autoplay=1, mute=1 }={}){
        const params = new URLSearchParams({
            autoplay: String(autoplay),
            mute: String(mute),
            controls: '0',
            playsinline: '1',
            loop: '1',
            playlist: videoId,
            enablejsapi: '1',
            origin: 'https://www.youtube.com'
        }).toString();
        return `https://www.youtube.com/embed/${videoId}?${params}`;
    }
    function ensureFallbackFrame(){
        const cont = document.getElementById('youtube-player-container');
        if (!cont) return null;
        if (ytFallbackFrame && ytFallbackFrame.isConnected) return ytFallbackFrame;
        const ifr = document.createElement('iframe');
        ifr.id = 'yt-fallback';
        ifr.width = '1'; ifr.height = '1';
        ifr.style.position = 'absolute'; ifr.style.top='-9999px'; ifr.style.left='-9999px';
        ifr.allow = 'autoplay; encrypted-media; picture-in-picture';
        cont.innerHTML = '';
        cont.appendChild(ifr);
        ytFallbackFrame = ifr;
        return ifr;
    }
    function fallbackLoadVideo(videoId, {autoplay=1, mute=1}={}){
        const cont = document.getElementById('youtube-player-container');
        if (!cont) return;
        cont.innerHTML = '';
        const ifr = document.createElement('iframe');
        ifr.id = 'yt-fallback';
        ifr.width = '1';
        ifr.height = '1';
        ifr.style.position = 'absolute';
        ifr.style.top='-9999px';
        ifr.style.left='-9999px';
        ifr.allow = 'autoplay; encrypted-media; picture-in-picture';
        ifr.src = buildFallbackSrc(videoId, {autoplay, mute});
        cont.appendChild(ifr);
        ytFallbackFrame = ifr;
        ytFallbackIsPlaying = !!autoplay;
        try { 
            const btn = document.getElementById('btnToggleYtSound'); 
            if (btn) btn.textContent = ytFallbackIsPlaying ? 'Ã¢ÂÂ¸Ã¯Â¸Â' : 'Ã¢â€“Â¶Ã¯Â¸Â'; 
        } catch(_) {}
    }
    function fallbackPostMessage(func, args=[]) {
        try {
            if (!ytFallbackFrame || !ytFallbackFrame.contentWindow) return;
            ytFallbackFrame.contentWindow.postMessage(JSON.stringify({ event:'command', func, args }), 'https://www.youtube.com');
        } catch(_) {}
    }
    function fallbackPlay(){ fallbackPostMessage('playVideo'); }
    function fallbackStop(){
        try {
            if (ytFallbackFrame) {
                ytFallbackFrame.src = 'about:blank';
                ytFallbackIsPlaying = false;
            }
        } catch(_) {}
    }
    function fallbackPause(){ fallbackStop(); }
    function fallbackUnMute(){ fallbackPostMessage('unMute'); }
    function fallbackMute(){ fallbackPostMessage('mute'); }
    window.onYouTubeIframeAPIReady = function() {
        if (IS_FILE_PROTOCOL) {
            try { window.__ytApiWatchdog && window.__ytApiWatchdog.cancel(); } catch(_) {}
            return;
        }
        const opts = {
            height: '1',
            width: '1',
            playerVars: { autoplay: 0, controls: 0, playsinline: 1 },
            events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange },
            host: 'https://www.youtube.com'
        };
        if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
            opts.origin = window.location.origin;
        }
        ytPlayer = new YT.Player('youtube-player-container', opts);
        try { window.__ytApiWatchdog && window.__ytApiWatchdog.cancel(); const fb = document.getElementById('ytUrlFeedback'); if (fb) { fb.textContent=''; } } catch(_) {}
    };

    let _ytPrimed = false;
    let _ytUnlocked = false;
    try { _ytUnlocked = localStorage.getItem('sound_unlocked') === '1'; } catch(_) {}
    function showSoundPermission() {
        const bar = document.getElementById('soundPermissionBar');
        if (!bar) return;
        if (_ytUnlocked) { bar.classList.remove('show'); return; }
        bar.classList.add('show');
    }
    function hideSoundPermission() {
        const bar = document.getElementById('soundPermissionBar');
        if (!bar) return;
        bar.classList.remove('show');
    }
    function unlockAudioChain() {
        try { if (AUDIO_CTX && typeof AUDIO_CTX.resume === 'function') AUDIO_CTX.resume(); } catch(_) {}
        try {
            if (IS_FILE_PROTOCOL) {
                fallbackUnMute();
                fallbackPlay();
            } else if (ytPlayer && ytPlayer.unMute) {
                ytPlayer.unMute();
                ytPlayer.playVideo();
            }
        } catch(_) {}
        _ytUnlocked = true;
        try { localStorage.setItem('sound_unlocked','1'); } catch(_) {}
        hideSoundPermission();
        toast('Ãƒâ€šm thanh Ã„â€˜ÃƒÂ£ Ã„â€˜Ã†Â°Ã¡Â»Â£c bÃ¡ÂºÂ­t!');
    }
    function onPlayerReady(event) {
        try {
            const iframe = ytPlayer && ytPlayer.getIframe ? ytPlayer.getIframe() : null;
            if (iframe) {
                iframe.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture');
            }
        } catch (_) {}
        try { if (ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume((data && data.settings && data.settings.youtubeVolume) || 80); } catch(_) {}
        updateYouTubePlayer();
    }
    function onPlayerStateChange(event) {
        const btn = $('#btnToggleYtSound');
        if (event.data == YT.PlayerState.PLAYING) {
            btn.textContent = 'Ã¢ÂÂ¸Ã¯Â¸Â';
            hideSoundPermission();
        } else {
            btn.textContent = 'Ã¢â€“Â¶Ã¯Â¸Â';
        }
        if (event.data === YT.PlayerState.ENDED) {
            if (!ytUserPaused) ytPlayer.playVideo();
        }
    }
    async function ytFadeTo(target, ms=250) {
        try {
            if (!ytPlayer || !ytPlayer.getVolume || !ytPlayer.setVolume) return;
            ytPlayer.unMute();
            const start = ytPlayer.getVolume();
            const diff = target - start;
            if (Math.abs(diff) < 1 || ms <= 0) { ytPlayer.setVolume(target); return; }
            const t0 = performance.now();
            await new Promise(res => {
                const step = (t) => {
                    const p = Math.min(1, (t - t0) / ms);
                    const v = Math.round(start + diff * p);
                    ytPlayer.setVolume(v);
                    if (p < 1) requestAnimationFrame(step); else res();
                };
                requestAnimationFrame(step);
            });
        } catch(_) {}
    }
    async function ytFadeInPlay(ms=220) {
        try {
            const tgt = Math.max(0, Math.min(100, (data && data.settings && data.settings.youtubeVolume) || 80));
            if (!IS_FILE_PROTOCOL) {
                if (!ytPlayer) return;
                ytPlayer.unMute();
                ytPlayer.playVideo();
                try { ytPlayer.setVolume(0); } catch(_) {}
                await ytFadeTo(tgt, ms);
            } else {
                const vid = getActiveVideoId();
                if (vid) { fallbackLoadVideo(vid, {autoplay:1, mute:0}); }
            }
        } catch(_) {}
    }
    async function ytFadeOutPause(ms=180) {
        try {
            const tgt = Math.max(0, Math.min(100, (data && data.settings && data.settings.youtubeVolume) || 80));
            if (!IS_FILE_PROTOCOL) {
                if (!ytPlayer) return;
                await ytFadeTo(0, ms);
                try { ytPlayer.pauseVideo(); ytPlayer.setVolume(tgt); } catch(_) {}
            } else {
                try { fallbackPause(); } catch(_) {}
            }
        } catch(_) {}
    }
    async function updateYouTubePlayer() {
        const videoId = getActiveVideoId();
        if (data.settings.useYtThumbnailAsBg && videoId) {
            const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
            const img = new Image();
            img.onload = async () => { data.settings.customBg = thumbUrl; await saveData(); applyCustomBg(); };
            img.onerror = async () => { const fb = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`; data.settings.customBg = fb; await saveData(); applyCustomBg(); };
            img.src = thumbUrl;
        } else if (!videoId) {
            data.settings.customBg = '';
            await saveData();
            applyCustomBg();
        }
        if (IS_FILE_PROTOCOL) {
            if (!videoId) { 
                fallbackStop();
                hideSoundPermission();
                return;
            }
            const isMuted = _ytUnlocked ? 0 : 1;
            fallbackLoadVideo(videoId, { autoplay: 1, mute: isMuted });
            if (!_ytUnlocked) {
                showSoundPermission();
            }
            return;
        }
        if (!ytPlayer || !ytPlayer.cueVideoById) return;
        if (!videoId) {
            if (ytPlayer.stopVideo) ytPlayer.stopVideo();
            hideSoundPermission();
            return;
        }
        ytPlayer.cueVideoById(videoId);
        ytPlayer.setVolume(data.settings.youtubeVolume);
    }
    function toggleYtSound() {
        if (!_ytUnlocked) {
            try { ensureAudio(); } catch(_) {}
            try { unlockAudioChain(); } catch(_) {}
            return;
        }
        if (IS_FILE_PROTOCOL) {
            const vid = getActiveVideoId();
            if (!ytFallbackFrame || !ytFallbackFrame.isConnected) {
                if (!vid) { toast('ChÃ†Â°a cÃƒÂ³ link hÃ¡Â»Â£p lÃ¡Â»â€¡. DÃƒÂ¡n link rÃ¡Â»â€œi bÃ¡ÂºÂ¥m Ã¢â€“Â¶Ã¯Â¸Â.'); return; }
                fallbackLoadVideo(vid, { autoplay: 1, mute: 0 });
                ytFallbackIsPlaying = true;
                try { const btn = document.getElementById('btnToggleYtSound'); if (btn) btn.textContent = 'Ã¢ÂÂ¸Ã¯Â¸Â'; } catch(_) {}
                toast('Ã„Âang phÃƒÂ¡t nhÃ¡ÂºÂ¡c nÃ¡Â»Ân...');
                return;
            }
            if (ytFallbackIsPlaying) {
                fallbackPostMessage('pauseVideo');
                ytFallbackIsPlaying = false;
                toast('Ã„ÂÃƒÂ£ dÃ¡Â»Â«ng nhÃ¡ÂºÂ¡c nÃ¡Â»Ân.');
            } else {
                if (!vid) { toast('ChÃ†Â°a cÃƒÂ³ link hÃ¡Â»Â£p lÃ¡Â»â€¡. DÃƒÂ¡n link rÃ¡Â»â€œi bÃ¡ÂºÂ¥m Ã¢â€“Â¶Ã¯Â¸Â.'); return; }
                fallbackPostMessage('playVideo');
                ytFallbackIsPlaying = true;
                toast('Ã„Âang phÃƒÂ¡t nhÃ¡ÂºÂ¡c nÃ¡Â»Ân...');
            }
            try { 
                const btn = document.getElementById('btnToggleYtSound'); 
                if (btn) btn.textContent = ytFallbackIsPlaying ? 'Ã¢ÂÂ¸Ã¯Â¸Â' : 'Ã¢â€“Â¶Ã¯Â¸Â'; 
            } catch(_) {}
            return;
        }
        if (!ytPlayer || typeof ytPlayer.getPlayerState !== 'function') return;
        const playerState = ytPlayer.getPlayerState();
        if (playerState === YT.PlayerState.PLAYING || playerState === YT.PlayerState.BUFFERING) {
            ytFadeOutPause();
            ytUserPaused = true;
            toast('Ã„ÂÃƒÂ£ dÃ¡Â»Â«ng nhÃ¡ÂºÂ¡c nÃ¡Â»Ân.');
        } else {
            ytFadeInPlay();
            ytUserPaused = false;
            toast('Ã„Âang phÃƒÂ¡t nhÃ¡ÂºÂ¡c nÃ¡Â»Ân...');
        }
    }
    function bindEvents(){
      on($('#btnToggleBg'), 'click', toggleBackgroundView);
      on($('#btnMilestoneClose'), 'click', () => $('#modalMilestone').classList.remove('show'));
      on($('#btnAddTopic'), 'click', () => showInputModal('TÃƒÂªn ChÃ¡Â»Â§ Ã„â€˜Ã¡Â»Â mÃ¡Â»â€ºi?', async (name) => { if (!name) return; data.topics.push({ id: uid('t'), name, subtopics: [] }); await saveData(); renderTopics(); }));
      on($('#btnExport'), 'click', ()=> storageManager.exportData(data));
        on($("#importFile"), 'change', (e) => {
          const f = e.target.files[0];
          if (!f) return;
          storageManager.importData(f).then(async (d) => {
            data = d;
            normalizeDataStructure(data);
            await ensureValidSelection();
            await seedAchievedMilestones();
            toast('Ã„ÂÃƒÂ£ nhÃ¡ÂºÂ­p dÃ¡Â»Â¯ liÃ¡Â»â€¡u thÃƒÂ nh cÃƒÂ´ng!');
            renderAll();
          }).catch(err => toast('NhÃ¡ÂºÂ­p thÃ¡ÂºÂ¥t bÃ¡ÂºÂ¡i: ' + err.message));
          e.target.value = null;
        });
      on($('#btnRestoreBackup'), 'click', () => {
          const backupListEl = $('#backupList');
          const selectedDate = backupListEl ? backupListEl.value : '';
          if (!selectedDate) { toast('Vui lÃƒÂ²ng chÃ¡Â»Ân mÃ¡Â»â„¢t bÃ¡ÂºÂ£n sao lÃ†Â°u.'); return; }
          showConfirmModal('XÃƒÂ¡c nhÃ¡ÂºÂ­n phÃ¡Â»Â¥c hÃ¡Â»â€œi', `BÃ¡ÂºÂ¡n cÃƒÂ³ chÃ¡ÂºÂ¯c muÃ¡Â»â€˜n phÃ¡Â»Â¥c hÃ¡Â»â€œi dÃ¡Â»Â¯ liÃ¡Â»â€¡u tÃ¡Â»Â« ngÃƒÂ y ${new Date(selectedDate).toLocaleDateString()}? DÃ¡Â»Â¯ liÃ¡Â»â€¡u hiÃ¡Â»â€¡n tÃ¡ÂºÂ¡i sÃ¡ÂºÂ½ bÃ¡Â»â€¹ ghi Ã„â€˜ÃƒÂ¨.`, (ok) => {
              if (ok) {
                  storageManager.restoreBackup(selectedDate).then((d) => {
                      data = d;
                      toast('PhÃ¡Â»Â¥c hÃ¡Â»â€œi dÃ¡Â»Â¯ liÃ¡Â»â€¡u thÃƒÂ nh cÃƒÂ´ng! TÃ¡ÂºÂ£i lÃ¡ÂºÂ¡i trang...');
                      setTimeout(() => window.location.reload(), 1500);
                  }).catch(err => {
                      toast(`LÃ¡Â»â€”i: ${err.message}`);
                  });
              }
          });
      });
      on($('#set_theme_color'), 'input', (e) => {
          const selectedTheme = e.target.value;
          applyTheme(selectedTheme);
          if (selectedTheme === 'light' || selectedTheme === 'pastel') {
              const ytThumbCheckbox = $('#set_ytThumbAsBg');
              if (ytThumbCheckbox) {
                  ytThumbCheckbox.checked = false;
                  toast('Ã„ÂÃƒÂ£ tÃ¡ÂºÂ¯t nÃ¡Â»Ân YouTube Ã„â€˜Ã¡Â»Æ’ hÃ¡Â»Â£p vÃ¡Â»â€ºi theme sÃƒÂ¡ng.', 2000);
              }
              // Ã„ÂÃ¡ÂºÂ£m bÃ¡ÂºÂ£o xem trÃ†Â°Ã¡Â»â€ºc nÃ¡Â»Ân gÃ¡Â»â€˜c cho theme sÃƒÂ¡ng
              try { document.body.style.setProperty('--bg-image', 'none'); } catch(_) {}
          } else {
              // Theme tÃ¡Â»â€˜i: tÃ¡Â»Â± bÃ¡ÂºÂ­t dÃƒÂ¹ng thumbnail YouTube nÃ¡ÂºÂ¿u cÃƒÂ³ link
              const ytThumbCheckbox = $('#set_ytThumbAsBg');
              if (ytThumbCheckbox) {
                  ytThumbCheckbox.checked = true;
              }
              try { updateYouTubePlayer(); } catch(_) {}
          }
      });
      on($('#btnSettings'), 'click', openSettings);
      on($('#btnHelpCreateTopic'), 'click', () => {
          switchView('topics');
          $('#btnAddTopic').click();
      });
      on($('#btnDashboard'), 'click', () => {
          renderDashboard();
          $('#modalDashboard').classList.add('show');
      });
      on($('#btnCloseDashboard'), 'click', () => {
          $('#modalDashboard').classList.remove('show');
      });
      on($('#btnCloseSettings'), 'click', closeSettings);
      on($('#btnSaveSettings'), 'click', saveSettings);
      on($('#btnDefaults'), 'click', setDefaults);
      on($('#btnTestSound'), 'click', ()=>{ ensureAudio(); playSound('work_end'); });
      on($('#btnToggleCustomSounds'), 'click', (e) => {
          e.preventDefault();
          const container = $('#customSoundsContainer');
          if (container) container.classList.toggle('hidden');
      });
      on($('#btnSaveNote'), 'click', async ()=>{ const s=getCurrentSubtopic(); if(!s) return; const id=pendingNoteSessionId; const sess=s.sessions.find(x=>x.id===id); if(sess){ sess.note=$('#noteText').value.trim(); await saveData(); renderStatsHistory(); toast('Ã„ÂÃƒÂ£ lÃ†Â°u ghi chÃƒÂº'); } closeNoteModal(); });
      on($('#btnSkipNote'), 'click', ()=> closeNoteModal());
      on($('#btnAddGeneralNote'), 'click', addGeneralNote);
      on($('#btnSummarizeNote'), 'click', handleSummarizeNote);
      on($('#btnSendMessage'), 'click', handleSendMessage);
      on($('#chatInput'), 'keydown', (e) => { if (e.key === 'Enter') handleSendMessage(); });
      $$('#aiPromptSuggestions button').forEach(btn => {
        on(btn, 'click', () => {
          const promptTemplate = btn.dataset.prompt;
          $('#chatInput').value = promptTemplate;
          $('#chatInput').focus();
        });
      });
      on($('#btnClearChat'), 'click', clearChat);
      on($('#btnNewChat'), 'click', clearChat);
      on($('#btnAddSubtopicTask'), 'click', addSubtopicTask);
      on($('#newSubtopicTaskInput'), 'keydown', (e) => { if (e.key === 'Enter') addSubtopicTask(); });
      on($('#btnToggleYtSound'), 'click', toggleYtSound);
      on($('#ytSoundVolume'), 'input', (e) => {
          const vol = parseInt(e.target.value, 10);
          if (ytPlayer && ytPlayer.setVolume) {
              ytPlayer.setVolume(vol);
          }
      });
      on($('#set_youtubeUrl'), 'input', handleYoutubeUrlInput);
      $$('.nav-btn[data-view]').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
      $$('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                const parent = btn.closest('.aux-panel, .modal-card');
                if (!parent) return;
                parent.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                parent.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                    c.style.display = 'none';
                });
                const activeContent = parent.querySelector(`#${tabId}`);
                if(activeContent) {
                    activeContent.classList.add('active');
                    activeContent.style.display = 'block';
                    if(parent.closest('#modalSettings')) {
                        activeContent.style.display = 'flex';
                    }
                }
            });
        });
        $$('#timerPresetSelector button').forEach(btn => {
          btn.addEventListener('click', () => {
            editingPreset = btn.dataset.presetTarget;
            highlightPresetSelector();
            loadEditingPresetFields();
          });
        });
        $$('.presets button').forEach(button => {
          button.addEventListener('click', (e) => {
            const newPreset = e.target.dataset.preset;
            const currentPreset = data.settings.preset;
            if (newPreset === currentPreset) {
              return;
            }
            if (timer.state !== 'idle') {
              showConfirmModal(
                'XÃƒÂ¡c nhÃ¡ÂºÂ­n chuyÃ¡Â»Æ’n Ã„â€˜Ã¡Â»â€¢i',
                `BÃ¡ÂºÂ¡n cÃƒÂ³ chÃ¡ÂºÂ¯c muÃ¡Â»â€˜n chuyÃ¡Â»Æ’n sang KiÃ¡Â»Æ’u ${newPreset}? Thao tÃƒÂ¡c nÃƒÂ y sÃ¡ÂºÂ½ dÃ¡Â»Â«ng vÃƒÂ  Ã„â€˜Ã¡ÂºÂ·t lÃ¡ÂºÂ¡i phiÃƒÂªn lÃƒÂ m viÃ¡Â»â€¡c hiÃ¡Â»â€¡n tÃ¡ÂºÂ¡i.`,
                (confirmed) => {
                  if (confirmed) {
                    timer.reset();
                    timer.setPreset(newPreset);
                    renderAll();
                    toast(`Ã„ÂÃƒÂ£ chuyÃ¡Â»Æ’n sang KiÃ¡Â»Æ’u ${newPreset}.`);
                  }
                }
              );
            } 
            else {
              timer.setPreset(newPreset);
              renderAll();
              toast(`Ã„ÂÃƒÂ£ chuyÃ¡Â»Æ’n sang KiÃ¡Â»Æ’u ${newPreset}.`);
            }
          });
        });
      on($('#btnStart'), 'click', ()=> timer.start());
      on($('#btnPause'), 'click', ()=> timer.pause());
      on($('#btnResume'), 'click', ()=> timer.resume());
      on($('#btnSkip'), 'click', ()=> timer.skip());
      on($('#btnReset'), 'click', ()=> timer.reset());
      on($('#uploadBg'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customBg = id; await saveData(); applyCustomBg(); toast("Ã„ÂÃƒÂ£ cÃ¡ÂºÂ­p nhÃ¡ÂºÂ­t hÃƒÂ¬nh nÃ¡Â»Ân."); }); e.target.value = null; });
      on($('#btnClearBg'), 'click', async () => {
          data.settings.customBg = '';
          data.settings.useYtThumbnailAsBg = false;
          await saveData();
          applyCustomBg();
          toast("Ã„ÂÃƒÂ£ xÃƒÂ³a hÃƒÂ¬nh nÃ¡Â»Ân tÃƒÂ¹y chÃ¡Â»â€°nh.");
          if ($('#modalSettings').classList.contains('show')) {
              openSettings();
          }
      });
      
      on($('#uploadSoundWork'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customSounds.work_end = id; await saveData(); toast("Ã„ÂÃƒÂ£ lÃ†Â°u ÃƒÂ¢m bÃƒÂ¡o hÃ¡ÂºÂ¿t LÃƒâ‚¬M VIÃ¡Â»â€ C."); }); e.target.value = null; });
      on($('#uploadSoundBreak'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customSounds.break_end = id; await saveData(); toast("Ã„ÂÃƒÂ£ lÃ†Â°u ÃƒÂ¢m bÃƒÂ¡o hÃ¡ÂºÂ¿t NGHÃ¡Â»Ë† NGÃ¡ÂºÂ®N."); }); e.target.value = null; });
      on($('#uploadSoundLong'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customSounds.long_end = id; await saveData(); toast("Ã„ÂÃƒÂ£ lÃ†Â°u ÃƒÂ¢m bÃƒÂ¡o hÃ¡ÂºÂ¿t NGHÃ¡Â»Ë† DÃƒâ‚¬I."); }); e.target.value = null; });
      on($('#btnFullscreen'), 'click', toggleFullScreen);
      document.addEventListener('fullscreenchange', updateFullscreenButton);
      window.addEventListener('keydown', (e)=>{ const tag=(e.target.tagName||'').toLowerCase(); const isTyping=['input','textarea','select'].includes(tag); if(e.code==='Space' && !isTyping){ e.preventDefault(); if(timer.state==='idle'||timer.state==='paused') timer.start(); else timer.pause(); } if(e.key==='n'||e.key==='N'){ if(!isTyping){ e.preventDefault(); timer.skip(); } } if(e.key==='Escape'){ $$('.modal').forEach(m => m.classList.remove('show')); } });
      $$('.modal').forEach(m=> m.addEventListener('click', (ev)=>{ if(ev.target===m) m.classList.remove('show'); }));
      window.addEventListener('click', (e) => {
        if (!e.target.closest('.actions-menu-btn')) {
            closeAllMenus();
        }
      });
      window.addEventListener('beforeunload', () => timer.persistTimerState(true));
      const draggableElement = $('#draggableTimer');
      let isDragging = false;
      let offsetX, offsetY;
      if (draggableElement) {
        draggableElement.addEventListener('mousedown', (e) => {
          isDragging = true;
          const rect = draggableElement.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;
          draggableElement.style.transition = 'none';
        });
        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          let newX = e.clientX - offsetX;
          let newY = e.clientY - offsetY;
          const boundaryX = window.innerWidth - draggableElement.offsetWidth;
          const boundaryY = window.innerHeight - draggableElement.offsetHeight;
          newX = Math.max(0, Math.min(newX, boundaryX));
          newY = Math.max(0, Math.min(newY, boundaryY));
          draggableElement.style.left = newX + 'px';
          draggableElement.style.top = newY + 'px';
          draggableElement.style.bottom = 'auto';
          draggableElement.style.right = 'auto';
        });
        document.addEventListener('mouseup', () => {
          if (!isDragging) return;
          isDragging = false;
          draggableElement.style.transition = '';
        });
      }
    }
    function toggleBackgroundView(){
        const body = document.body;
        body.classList.toggle('bg-view-mode');
        const isActive = body.classList.contains('bg-view-mode');
        const btn = $('#btnToggleBg');
        if (!btn) return;
        if (isActive) {
            btn.title = 'HiÃ¡Â»â€¡n giao diÃ¡Â»â€¡n';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></svg>`;
        } else {
            btn.title = 'Ã¡ÂºÂ¨n giao diÃ¡Â»â€¡n';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
        }
    }
    function updateMainViewVisibility() {
        const hasSubtopic = !!getCurrentSubtopic();
        const timerView = $('#view-timer');
        const welcomePanel = $('#welcomePanel');
        if (welcomePanel) {
            welcomePanel.classList.toggle('hidden', hasSubtopic);
        }
        if (timerView) {
            if (hasSubtopic) {
                timerView.classList.remove('no-subtopic-selected');
            } else {
                timerView.classList.add('no-subtopic-selected');
            }
        }
    }
    function updatePresetButtonsText() {
        const settings = data.settings;
        const cyclesA = settings.cyclesA;
        const cyclesB = settings.cyclesB;
        const workA = settings.durations.A_work;
        const workB = settings.durations.B_work;
        const btnA = $('#btnPresetA');
        const btnB = $('#btnPresetB');
        if (btnA) {
            btnA.textContent = `${cyclesA}Ãƒâ€”${workA} (A)`;
        }
        if (btnB) {
            btnB.textContent = `${cyclesB}Ãƒâ€”${workB} (B)`;
        }
    }
    function renderAll(){
        updatePresetButtonsText();
        const currentPreset = data.settings.preset;
        $$('.presets button').forEach(button => {
          const isSelected = button.dataset.preset === currentPreset;
          button.classList.toggle('acc', isSelected);
          button.classList.toggle('ghost', !isSelected);
          button.setAttribute('aria-pressed', isSelected);
        });
        updateMainViewVisibility();
        timer.setPreset(data.settings.preset, {silent:true});
        renderTopics();
        renderContextBadge();
        renderStatsHistory();
        renderGeneralNotes();
        renderChat();
        applyCustomBg();
        applyPanelOpacity();
        renderSubtopicTasks();
        updateFullscreenButton();
        switchView(data.settings.currentView);
        // fixVietnameseUI Ã„â€˜ÃƒÂ£ bÃ¡Â»â€¹ loÃ¡ÂºÂ¡i bÃ¡Â»Â; nÃ¡Â»â„¢i dung hiÃ¡Â»Æ’n thÃ¡Â»â€¹ trÃ¡Â»Â±c tiÃ¡ÂºÂ¿p bÃ¡ÂºÂ±ng UTF-8
    }
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                toast(`LÃ¡Â»â€”i: KhÃƒÂ´ng thÃ¡Â»Æ’ bÃ¡ÂºÂ­t chÃ¡ÂºÂ¿ Ã„â€˜Ã¡Â»â„¢ toÃƒÂ n mÃƒÂ n hÃƒÂ¬nh: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }
    function updateFullscreenButton() {
        const btn = $('#btnFullscreen');
        if (document.fullscreenElement) {
            btn.innerHTML = 'Ã¢â€ â„¢Ã¯Â¸Â';
            btn.title = 'ThoÃƒÂ¡t toÃƒÂ n mÃƒÂ n hÃƒÂ¬nh';
        } else {
            btn.innerHTML = 'Ã¢â€ â€”Ã¯Â¸Â';
            btn.title = 'ToÃƒÂ n mÃƒÂ n hÃƒÂ¬nh';
        }
    }
    async function initializeApp() {
      try {
        await storageManager.initDB();
        const [settings, topics, subtopics] = await Promise.all([
          storageManager.getSettings(),
          storageManager.getAll('topics'),
          storageManager.getAll('subtopics')
        ]);
        let merged;
        if (!settings || topics.length === 0 || subtopics.length === 0) {
          const defaultData = JSON.parse(JSON.stringify(defaults));
          await storageManager.updateSettings(defaultData.settings);
          for (const t of defaultData.topics) {
            const { subtopics: subs, ...topicData } = t;
            await storageManager.add('topics', topicData);
            for (const sub of subs) {
              await storageManager.add('subtopics', { ...sub, topicId: t.id });
            }
          }
          merged = defaultData;
        } else {
          const map = {};
          for (const t of topics) map[t.id] = { ...t, subtopics: [] };
          for (const s of subtopics) map[s.topicId]?.subtopics.push(s);
          merged = { version: defaults.version, settings, topics: Object.values(map) };
        }
        data = window.data = merged;
        normalizeDataStructure(data);
        await ensureValidSelection();
        await seedAchievedMilestones();
        renderAll();
        try { storageManager.autoBackup(data); } catch (e) { console.warn('AutoBackup error:', e); }
        bindEvents();
        applyTheme();
      } catch (err) {
        console.error('Initialization error:', err);
        toast(`LÃ¡Â»â€”i khÃ¡Â»Å¸i tÃ¡ÂºÂ¡o: ${err.message}`);
      }
    }
    callGeminiAPI = async function(prompt, retries = 3, delay = 1000) {
        const apiKey = data?.settings?.apiKey || "";
        if (!apiKey) {
            toast("Vui lÃƒÂ²ng nhÃ¡ÂºÂ­p Gemini API Key trong phÃ¡ÂºÂ§n CÃƒÂ i Ã„â€˜Ã¡ÂºÂ·t.");
            return null;
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                if (response.status === 429 && retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                }
                let errorData = null;
                try { errorData = await response.json(); } catch (e) {}
                let errorMessage = `LÃ¡Â»â€”i HTTP: ${response.status}`;
                if (response.status === 400) {
                    errorMessage = "LÃ¡Â»â€”i: Gemini API Key khÃƒÂ´ng hÃ¡Â»Â£p lÃ¡Â»â€¡ hoÃ¡ÂºÂ·c Ã„â€˜ÃƒÂ£ bÃ¡Â»â€¹ thay Ã„â€˜Ã¡Â»â€¢i. Vui lÃƒÂ²ng kiÃ¡Â»Æ’m tra lÃ¡ÂºÂ¡i trong CÃƒÂ i Ã„â€˜Ã¡ÂºÂ·t.";
                } else if (response.status === 429) {
                    errorMessage = "LÃ¡Â»â€”i: Ã„ÂÃƒÂ£ vÃ†Â°Ã¡Â»Â£t quÃƒÂ¡ hÃ¡ÂºÂ¡n mÃ¡Â»Â©c yÃƒÂªu cÃ¡ÂºÂ§u tÃ¡Â»â€ºi Gemini. Vui lÃƒÂ²ng thÃ¡Â»Â­ lÃ¡ÂºÂ¡i sau ÃƒÂ­t phÃƒÂºt.";
                } else if (errorData?.error?.message) {
                    errorMessage = `LÃ¡Â»â€”i tÃ¡Â»Â« Gemini: ${errorData.error.message}`;
                }
                toast(errorMessage, 4000);
                console.error("Gemini API Error:", errorData || response.statusText);
                return null;
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                return formatGeminiResponse(result.candidates[0].content.parts[0].text);
            } else {
                console.error("API response structure is unexpected:", result);
                if (result.promptFeedback?.blockReason) { return `NÃ¡Â»â„¢i dung bÃ¡Â»â€¹ chÃ¡ÂºÂ·n vÃƒÂ¬: ${result.promptFeedback.blockReason}. Vui lÃƒÂ²ng thÃ¡Â»Â­ lÃ¡ÂºÂ¡i vÃ¡Â»â€ºi nÃ¡Â»â„¢i dung khÃƒÂ¡c.`; }
                return "KhÃƒÂ´ng nhÃ¡ÂºÂ­n Ã„â€˜Ã†Â°Ã¡Â»Â£c nÃ¡Â»â„¢i dung hÃ¡Â»Â£p lÃ¡Â»â€¡ tÃ¡Â»Â« AI.";
            }
        } catch (error) {
            console.error("LÃ¡Â»â€”i khi gÃ¡Â»Âi Gemini API:", error);
            toast("LÃ¡Â»â€”i mÃ¡ÂºÂ¡ng khi kÃ¡ÂºÂ¿t nÃ¡Â»â€˜i Ã„â€˜Ã¡ÂºÂ¿n Gemini. Vui lÃƒÂ²ng kiÃ¡Â»Æ’m tra kÃ¡ÂºÂ¿t nÃ¡Â»â€˜i internet.", 4000);
            return null;
        }
    }
    loadLanguage(localStorage.getItem('lang') || 'vi').then(initializeApp);
    </script>
</body>
</html>
