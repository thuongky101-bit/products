<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="·ª®ng d·ª•ng Pomodoro h·ªó tr·ª£ h·ªçc t·∫≠p v·ªõi t√≠ch h·ª£p Gemini AI v√† giao di·ªán hi·ªán ƒë·∫°i." />
    <title>Pomodoro Study App ‚Äî T√≠ch h·ª£p Gemini AI (Giao di·ªán m·ªõi)</title>
    <style>
    /*
    =============================================
    POMODORO STUDY APP ‚Äî PHI√äN B·∫¢N GIAO DI·ªÜN T·∫¨P TRUNG (v11.2)
    =============================================
    */

    :root {
      /* Theme Dark (M·∫∑c ƒë·ªãnh) - C·∫≠p nh·∫≠t t·ª´ file 2 */
      --bg: #0f1222;
      --panel: #171a2e;
      --panel-rgb: 23, 26, 46; /* Th√™m bi·∫øn RGB cho panel */
      --muted: #212646;
      --text: #f4f6ff;
      --sub: #b7c1ff;
      --acc: #6c8cff;
      --acc-2: #27d3a2;
      --warn: #ffb020;
      --danger: #ff5c7a;
      --shadow: 0px 1.8px 2.2px rgba(0, 0, 0, 0.054), 0px 4.3px 5.3px rgba(0, 0, 0, 0.077), 0px 8.1px 10px rgba(0, 0, 0, 0.095), 0px 14.5px 17.9px rgba(0, 0, 0, 0.113), 0px 27.2px 33.4px rgba(0, 0, 0, 0.136), 0px 65px 80px rgba(0, 0, 0, 0.19);
      --radius: 16px;
      --panel-opacity: 0.85;
      --gradient-border: linear-gradient(135deg, var(--acc), var(--acc-2));
    }
    
    /* === START: TH√äM C√ÅC THEME M·ªöI === */
    [data-theme='light'] {
      --bg: #f5f0e8; --panel: #ffffff; --panel-rgb: 255, 255, 255; --muted: #eaddcf; --text: #4a4a4a; --sub: #8a817c; --acc: #d4a373; --acc-2: #a3b18a; --warn: #e76f51; --danger: #d00000;
      --shadow: 0px 1.8px 2.2px rgba(0, 0, 0, 0.024), 0px 4.3px 5.3px rgba(0, 0, 0, 0.037), 0px 8.1px 10px rgba(0, 0, 0, 0.045), 0px 14.5px 17.9px rgba(0, 0, 0, 0.053), 0px 27.2px 33.4px rgba(0, 0, 0, 0.066), 0px 65px 80px rgba(0, 0, 0, 0.09);
      --panel-opacity: 0.9;
      /* NgƒÉn n·ªÅn t·ªëi m·∫∑c ƒë·ªãnh khi kh√¥ng c√≥ ·∫£nh */
      --bg-image: none;
    }

    [data-theme='pastel'] {
      --bg: #fde2e4; --panel: #fff1f2; --panel-rgb: 255, 241, 242; --muted: #fad2e1; --text: #595260; --sub: #8c7a8a; --acc: #c78283; --acc-2: #7ec4cf; --warn: #f9bf45; --danger: #d7263d;
      --shadow: 0 5px 20px rgba(200,150,150,0.2);
      --panel-opacity: 0.9;
      /* NgƒÉn n·ªÅn t·ªëi m·∫∑c ƒë·ªãnh khi kh√¥ng c√≥ ·∫£nh */
      --bg-image: none;
    }
    
    [data-theme='lofi'] {
      --bg: #2a2a3e; --panel: #3c3c52; --panel-rgb: 60, 60, 82; --muted: #4d4d66; --text: #e0e0ff; --sub: #a0a0c0; --acc: #ff8c69; --acc-2: #69c6ff; --warn: #ffd700; --danger: #ff6961;
      --bg-image: url('https://i.pinimg.com/originals/9f/67/74/9f67742194e8f187b5129b6183571120.gif');
      --panel-opacity: 0.8;
    }
    
    [data-theme='space'] {
        --bg: #000000; --panel: #1a1a2e; --panel-rgb: 26, 26, 46; --muted: #2a2a4e; --text: #e0e0ff; --sub: #b0b0e0; --acc: #00aaff; --acc-2: #aaff00; --warn: #ffaa00; --danger: #ff0055;
        --bg-image: url('https://i.gifer.com/origin/a2/a2322310816930a8094f8263e6a7150a_w200.gif');
        --panel-opacity: 0.75;
    }
    /* === END: TH√äM C√ÅC THEME M·ªöI === */

    *:focus-visible {
      outline: 2px solid var(--acc); outline-offset: 2px; border-radius: 4px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      margin:0; 
      font-family: system-ui, -apple-system, 'Segoe UI Variable', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Inter', sans-serif; 
      
      background-color: var(--bg);
      background-image: var(--bg-image, radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%));
      
      background-size: cover; 
      background-position: center; 
      color:var(--text); 
      transition: background 0.5s ease, color 0.5s ease, filter 0.5s ease;
      text-shadow: 0px 0px 5px rgba(0, 0, 0, 0.5);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    a{color:var(--acc)}

    .app{display:flex; min-height:100vh}
    
    .app-nav {
        width: 60px;
        background: rgba(var(--panel-rgb), var(--panel-opacity));
        border-right: 1px solid rgba(255,255,255,.08);
        padding: 16px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        z-index: 100;
    }
    .nav-btn {
        background: transparent;
        border: none;
        color: var(--sub);
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all .2s ease;
        position: relative;
    }
    .nav-btn:hover { background: var(--muted); color: var(--text); }
    .nav-btn.active { background: var(--acc); color: white; }
    .nav-btn svg { width: 24px; height: 24px; }
    .nav-btn .tooltip {
        position: absolute;
        left: 110%;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(var(--panel-rgb), var(--panel-opacity));
        border: 1px solid rgba(255,255,255,0.12);
        color: var(--text);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        box-shadow: var(--shadow);
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity .2s ease, visibility .2s ease;
        pointer-events: none;
        z-index: 200;
    }
    .nav-btn:hover .tooltip { opacity: 1; visibility: visible; }

    .app-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        max-height: 100vh;
    }

    .view { display: none; }
    .view.active { display: grid; gap: 24px; animation: fadeIn .3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .main.reloading { opacity: 0; transition: opacity 0.2s ease-out; }

    .panel-bg{
        background: rgba(var(--panel-rgb), var(--panel-opacity)); /* S·ª¨A ƒê·ªîI QUAN TR·ªåNG */
        border:1px solid rgba(127,127,127,0.1);
        transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Th√™m transition */
    }
    /* Th√™m c√°c quy t·∫Øc border cho theme light/pastel */
    [data-theme='light'] .panel-bg, [data-theme='pastel'] .panel-bg { border:1px solid rgba(0,0,0,0.05); }
    [data-theme='lofi'] .panel-bg { border:1px solid rgba(255,255,255,0.1); }
    [data-theme='space'] .panel-bg { border:1px solid rgba(255,255,255,0.12); }


    header.app-header{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom: 24px;}
    header .actions{display:flex; gap:8px; align-items:center}
    
    .btn {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border: none; /* S·ª≠a ƒë·ªïi: b·ªè border m·∫∑c ƒë·ªãnh */
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.08);
      font-weight: 600;
      transition: all .15s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        border: 2px solid transparent; border-radius: 12px; background: var(--gradient-border) border-box;
        -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: destination-out; mask-composite: exclude; opacity: 0; transition: opacity 0.3s ease;
    }
    .btn:hover::before { opacity: 1; }
    .btn:hover { background: rgba(255, 255, 255, 0.12); }
    .btn:active { transform: translateY(1px) scale(0.98); filter: brightness(1); }
    .btn:disabled { cursor: not-allowed; filter: brightness(0.8) saturate(0.5); }
    .btn.ghost { background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); }
    .btn.ghost:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.3); }
    .btn.acc { background: var(--acc); color: white; }
    .btn.warn { background: var(--warn); color: white; }
    .btn.danger { background: var(--danger); color: white; }
    .btn.small { padding: 6px 10px; font-size: 14px; border-radius: 9px; }
    .btn.small::before { border-radius: 9px; }
    .btn > svg { width: 16px; height: 16px; stroke-width: 2.5px; }

    /* === START: C·∫¨P NH·∫¨T GIAO DI·ªÜN QU·∫¢N L√ù CH·ª¶ ƒê·ªÄ === */
    #view-topics { grid-template-columns: 1fr; }
    .topic-item { background:rgba(255,255,255,.04); border:1px solid var(--muted); border-radius:12px; padding:8px; margin-bottom:8px; } /* S·ª≠a ƒë·ªïi */
    .topic-header, .sub-row { display:flex; align-items:center; gap:8px; position: relative; }
    .topic-title { flex:1; font-weight:600; }
    .chev { width:28px; height:28px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; flex-shrink: 0; }
    .chev .ico { display:inline-block; transition: transform .18s ease; }
    .chev[aria-expanded="false"] .ico { transform: rotate(-90deg); }
    .subtopics { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .subtopics.hidden { display:none; }
    
    .topic-actions, .sub-row .actions {
        opacity: 0;
        visibility: hidden;
        transition: opacity .2s ease, visibility .2s ease;
        display: flex;
        gap: 6px;
        align-items: center;
    }
    .topic-item:hover .topic-actions, .sub-row:hover .actions {
        opacity: 1;
        visibility: visible;
    }
    .actions-menu-btn {
        padding: 0;
        width: 28px;
        height: 28px;
        font-size: 1.2em;
        line-height: 1;
    }
    .actions-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: rgba(var(--panel-rgb), var(--panel-opacity));
        border: 1px solid var(--muted); /* S·ª≠a ƒë·ªïi */
        border-radius: 8px;
        padding: 6px;
        box-shadow: var(--shadow);
        z-index: 10;
        min-width: 150px;
        display: none;
        flex-direction: column;
        gap: 4px;
    }
    .actions-menu.show { display: flex; }
    .menu-item {
        background: transparent; border: none; color: var(--text);
        padding: 8px 10px; border-radius: 6px; text-align: left;
        width: 100%; cursor: pointer; transition: background .2s ease;
        display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;
    }
    .menu-item:hover { background: var(--acc); color: white; }
    .menu-item.danger:hover { background: var(--danger); }
    /* === END: C·∫¨P NH·∫¨T GIAO DI·ªÜN QU·∫¢N L√ù CH·ª¶ ƒê·ªÄ === */

    .subtopic-btn{
        flex:1; 
        text-align:left;
        background-color: rgba(0,0,0,0.02); /* S·ª≠a ƒë·ªïi */
    }
    .subtopic-btn:hover {
        background-color: var(--muted); /* S·ª≠a ƒë·ªïi */
    }
    .subtopic-btn.active{
        outline:2px solid var(--acc); 
    }
    .subtopic-btn.active:hover {
        background: transparent; /* Gi·ªØ n·ªÅn trong su·ªët khi di chu·ªôt qua */
    }
    
    .panel{border-radius:var(--radius); padding:24px; box-shadow:var(--shadow)}

    .timer-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .timer{display:grid; gap:16px; grid-template-columns: 1fr; align-items:center; text-align:center}
    .big-time{font-size: clamp(60px, 12vw, 96px); letter-spacing:1px; font-weight:700; color: var(--text)}
    .state{font-weight:700; letter-spacing:.6px}
    .state.work{color:var(--acc-2)} /* S·ª≠a ƒë·ªïi m√†u */
    .state.break{color:var(--warn)}
    .state.long{color:var(--danger)} /* S·ª≠a ƒë·ªïi m√†u */
    .controls{display:flex; flex-wrap:wrap; gap:12px; justify-content:center}    
    #btnStart { padding: 14px 28px; font-size: 1.2em; }
    #btnPause, #btnResume { padding: 12px 24px; font-size: 1.1em; }

    /* === START: T√ôY CH·ªàNH D·∫¢I PH√ÇN C√ÅCH M·ªÄM M·∫†I H∆†N === */
    #view-timer .panel-bg hr {
        border: none; /* B·ªè ƒë∆∞·ªùng vi·ªÅn m·∫∑c ƒë·ªãnh */
        height: 1px;  /* ƒê·∫∑t chi·ªÅu cao cho ƒë∆∞·ªùng k·∫ª */
        background-color: var(--muted); /* S·ª≠ d·ª•ng m√†u ph·ª• c·ªßa theme */
        opacity: 0.3; /* L√†m cho n√≥ m·ªù ƒëi, h√≤a v√†o n·ªÅn */
        margin-top: 0; /* ƒêi·ªÅu ch·ªânh l·∫°i kho·∫£ng c√°ch */
    }
    /* === END: T√ôY CH·ªàNH D·∫¢I PH√ÇN C√ÅCH M·ªÄM M·∫†I H∆†N === */

    .stats-grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:12px}
    .stat-card{background:rgba(255,255,255,0.04); border:1px solid var(--muted); border-radius:14px; padding:12px; text-align:center} /* S·ª≠a ƒë·ªïi */
    .stat-card h4{margin:4px 0 8px; color:var(--sub); font-weight:600; font-size: 14px;}
    .stat-value{font-size: 20px; font-weight: 600;}
    .tiny{font-size:12px; color:var(--sub)}
    .history{display:grid; gap:8px; max-height:300px; overflow:auto; padding-right:6px}
    .hist-item{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:start; background:rgba(255,255,255,0.04); border:1px solid var(--muted); border-radius:10px; padding:10px} /* S·ª≠a ƒë·ªïi */

    .row{display:flex; gap:8px; align-items:center}
    .row > * {flex:1}
    input[type="text"], input[type="password"], input[type="number"], select, textarea{width:100%; background:rgba(255,255,255,0.04); color:var(--text); border:1px solid var(--muted); border-radius:10px; padding:10px; outline:none}
    textarea{min-height:80px; resize: vertical;}

    .toasts{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999}
    .toast{
        background: var(--panel); /* S·ª≠a ƒë·ªïi */
        border:1px solid var(--muted);
        color:var(--text);
        padding:10px 12px; border-radius:12px; box-shadow:var(--shadow);
        animation: toast-in .3s ease; transform-origin: bottom right;
    }
    @keyframes toast-in { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.65); z-index:1000;} /* S·ª≠a ƒë·ªïi */
    .modal.show{display:flex}
    .modal-card{
        width:min(720px, 94vw);
        background: rgba(var(--panel-rgb), var(--panel-opacity));
        border:1px solid var(--muted);
        border-radius:16px;
        padding:16px;
        box-shadow:var(--shadow);
        animation: modal-in .25s ease-out;
        max-height: 90vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    @keyframes modal-in { from { opacity: 0; transform: scale(0.92) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal-card h3{margin-top:0}
    .dashboard-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .dashboard-table th, .dashboard-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--muted); }
    .dashboard-table th { color: var(--sub); }

    .footer-note{font-size:12px; color:var(--sub)}
    .hidden{display:none !important}

    .notes-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; padding-right: 6px; }
    .note-item { background: rgba(255,255,255,0.04); border-radius: 10px; padding: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; cursor: pointer; } /* S·ª≠a ƒë·ªïi */
    .note-content-wrapper { flex: 1; min-width: 0; }
    .note-content { white-space: pre-wrap; word-break: break-word; max-height: 60px; overflow: hidden; position: relative; transition: max-height 0.35s ease-in-out; }
    .note-content:not(.expanded)::after {
        content: ''; position: absolute; bottom: 0; right: 0; width: 100%; height: 20px; background: linear-gradient(to top, var(--panel) 20%, transparent);
    }
    .note-content.expanded { max-height: 500px; }
    .note-meta { font-size: 11px; color: var(--sub); margin-top: 4px; }
    
    .spinner { border: 2px solid var(--muted); border-top-color: var(--text); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; } /* S·ª≠a ƒë·ªïi */
    @keyframes spin { to { transform: rotate(360deg); } }

    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .panel-header h3 { margin: 0; }
    .panel-header .actions { display: flex; gap: 8px; }
    
    .aux-panel { margin-top: 24px; }
    .tab-nav { display: flex; gap: 4px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 16px; }
    .tab-btn { background: transparent; border: none; color: var(--sub); padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all .2s ease; font-weight: 600; }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--acc); border-bottom-color: var(--acc); }
    .tab-content {
      display: none;
      padding-top: 8px;
    }
    .tab-content.active {
      animation: fadeIn 0.25s ease-out;
    }
    #tasks.tab-content.active,
    #notes.tab-content.active,
    #ai.tab-content.active {
        display: block;
    }

    #settings-timer.tab-content.active,
    #settings-ui.tab-content.active,
    #settings-integrations.tab-content.active {
        display: flex;
    }

    .settings-row-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }
    .settings-row-toggle span {
      flex: 1;
      cursor: pointer;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-switch .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--muted);
      transition: .3s;
      border-radius: 24px;
    }
    .toggle-switch .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .slider {
      background-color: var(--acc-2);
    }
    .toggle-switch input:checked + .slider:before {
      transform: translateX(20px);
    }
    
    .chat-messages { max-height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; padding: 4px; }
    .chat-msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; word-break: break-word; }
    .chat-msg.user { background: var(--acc); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-msg.model { background: var(--muted); align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-input-area { display: flex; gap: 8px; }

    .methods-list { list-style: none; padding: 0; }
    .method-item { align-items: flex-start; padding: 12px; display: flex; gap: 10px; border-radius: 8px; }
    .method-item:hover { background: rgba(0,0,0,0.03); } /* S·ª≠a ƒë·ªïi */
    .method-item input[type="checkbox"] { width: 18px; height: 18px; margin-top: 2px; flex-shrink: 0;}
    .method-item label { flex: 1; }
    .method-item label.completed { text-decoration: line-through; color: var(--sub); }
    .method-item .content-wrapper { flex: 1; cursor: pointer; }
    .method-item .concept { font-size: 14px; color: var(--sub); margin-top: 8px; border-left: 2px solid var(--muted); padding-left: 12px; white-space: pre-wrap; word-break: break-word; }
    .subtopic-todo-list { list-style: none; padding: 0; margin: 0; max-height: 100px; overflow-y: auto; text-align: left; }
    .subtopic-todo-list li { display: flex; align-items: center; gap: 8px; padding: 4px; transition: all 0.2s ease-out; }
    .subtopic-todo-list li.removing { transform: translateX(100%); opacity: 0; }
    .subtopic-todo-list label { flex: 1; }

    #youtube-player-container { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; overflow: hidden; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 10px; } /* S·ª≠a ƒë·ªïi */
    ::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background: var(--sub); background-clip: content-box; }
    
    .timer-circle-container {
        position: relative; width: clamp(250px, 40vw, 320px); height: clamp(250px, 40vw, 320px); margin: 24px auto; display: flex; align-items: center; justify-content: center;
    }
    .timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
    .timer-circle-bg, .timer-circle-progress { fill: none; stroke-width: 8; }
    .timer-circle-bg { stroke: var(--muted); } /* S·ª≠a ƒë·ªïi */
    .timer-circle-progress { stroke: var(--acc); stroke-linecap: round; transition: stroke-dashoffset 0.3s linear, stroke 0.5s ease; }
    @keyframes flash { 0%, 100% { box-shadow: 0 0 10px 2px transparent; } 50% { box-shadow: 0 0 20px 8px currentColor; } }
    .timer-circle-container.finished { color: var(--acc-2); animation: flash 1s ease-out; }
    @keyframes breathing-effect { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    .timer-circle-container.breathing { animation: breathing-effect 3s ease-in-out infinite; }
    
    @media (max-width: 1024px) {
      .app-content { padding: 20px; }
      .panel { padding: 20px; }
      .timer-circle-container { width: clamp(220px, 50vw, 300px); height: clamp(220px, 50vw, 300px); }
    }

    @media (max-width: 768px) {
      .app { flex-direction: column; }
      .app-nav { width: 100%; height: 60px; flex-direction: row; justify-content: center; border-right: none; border-top: 1px solid rgba(255,255,255,.08); order: 2; padding: 0 16px; }
      .app-content { padding: 16px; order: 1; }
      .panel { padding: 16px; }
      .modal-card .tab-nav { overflow-x: auto; }
    }

    @media (max-width: 480px) {
      .app-nav { height: 50px; }
      .nav-btn { flex: 1; }
      header.app-header { flex-direction: column; align-items: stretch; gap: 8px; }
      .btn { padding: 8px 12px; }
      .timer-circle-container { width: clamp(180px, 80vw, 220px); height: clamp(180px, 80vw, 220px); margin: 16px auto; }
      .panel { padding: 12px; }
      .app-content { padding: 12px; }
    }

    #view-timer.no-subtopic-selected > .panel-bg:not(:first-child) { display: none; }
    #view-timer.no-subtopic-selected .timer-header > .presets { display: none; }
    #view-timer.no-subtopic-selected .timer { display: none; }

    header.app-header .actions #btnFullscreen { background: transparent; border: none; box-shadow: none; }
    header.app-header .actions #btnFullscreen:hover { background: var(--muted); filter: none; }
    header.app-header .actions #btnFullscreen:hover::before { opacity: 0; }

    input[type="text"], input[type="password"], input[type="number"], select, textarea {
        background: rgba(255,255,255,0.04) !important; /* S·ª≠a ƒë·ªïi: chuy·ªÉn sang n·ªÅn tr·∫Øng trong su·ªët */
        color: var(--text);
        border: 1px solid var(--muted);
        transition: background .2s ease, border-color .2s ease;
    }
    input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
        background: rgba(255,255,255,0.06) !important; /* Tinh ch·ªânh: s√°t m·∫´u h∆°n */
        border-color: var(--acc);
    }
    /* === START: S·ª¨A L·ªñI N·ªÄN INPUT/SELECT TR√äN THEME S√ÅNG === */
    [data-theme='light'] input, [data-theme='light'] select, [data-theme='light'] textarea,
    [data-theme='pastel'] input, [data-theme='pastel'] select, [data-theme='pastel'] textarea {
        background: rgba(0, 0, 0, 0.05) !important; /* D√πng n·ªÅn ƒëen m·ªù thay v√¨ tr·∫Øng m·ªù */
    }

    [data-theme='light'] input:focus, [data-theme='light'] select:focus, [data-theme='light'] textarea:focus,
    [data-theme='pastel'] input:focus, [data-theme='pastel'] select:focus, [data-theme='pastel'] textarea:focus {
        background: rgba(0, 0, 0, 0.07) !important; /* TƒÉng ƒë·ªô ƒë·∫≠m khi focus */
    }
    /* === END: S·ª¨A L·ªñI N·ªÄN INPUT/SELECT TR√äN THEME S√ÅNG === */
    
    ::placeholder { color: var(--sub); opacity: 0.7; } /* S·ª≠a ƒë·ªïi */
    ::-ms-input-placeholder { color: var(--sub); }
    :-ms-input-placeholder { color: var(--sub); }

    
    
    .draggable-timer {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(var(--panel-rgb), var(--panel-opacity));
        color: var(--text);
        padding: 8px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow);
        font-size: 2em;
        font-weight: 600;
        cursor: move;
        user-select: none;
        z-index: 9998;
        opacity: 0;
        transform: scale(0.9);
        pointer-events: none;
        transition: opacity 0.35s ease, transform 0.35s ease;
    }
    body.bg-view-mode .draggable-timer {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto;
    }
    .app-nav, .panel-bg, .app-header .actions > *, .app-header > .row {
        transition: opacity 0.35s ease, transform 0.35s ease, background 0.35s ease, border-color 0.35s ease, box-shadow 0.35s ease;
    }
    body.bg-view-mode .app-nav,
    body.bg-view-mode .view.active > .panel-bg {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.98);
    }
    body.bg-view-mode .app-header {
        background: transparent !important;
        border-color: transparent !important;
        box-shadow: none !important;
    }
    body.bg-view-mode .app-header .actions > *:not(#btnToggleBg),
    body.bg-view-mode .app-header > .row {
        opacity: 0;
        pointer-events: none;
    }
    body.bg-view-mode #btnToggleBg {
        opacity: 1;
        pointer-events: auto;
    }
    .sound-permission-bar {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 48px; z-index: 9999;
      background: rgba(var(--panel-rgb), var(--panel-opacity));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px; padding: 10px 14px;
      display: none; align-items: center; gap: 10px;
      box-shadow: var(--shadow);
    }
    .sound-permission-bar.show { display: flex; }
    .sound-permission-bar .msg { font-size: 14px; color: var(--text); }
    .draggable-timer { text-shadow: 0px 0px 8px rgba(0, 0, 0, 0.9); }

    /* Gi·∫£m/lo·∫°i b·ªè b√≥ng ch·ªØ cho theme s√°ng ƒë·ªÉ tr√°nh nh√≤e/l√≥a */
    body[data-theme='light'],
    body[data-theme='pastel'] { text-shadow: none; }
    body[data-theme='light'] .draggable-timer,
    body[data-theme='pastel'] .draggable-timer { text-shadow: none; }

    /* ============================================= */
    /* START: B·ªò L·ªåC N√ÇNG CAO N·ªÄN CHO THEME T·ªêI      */
    /* ============================================= */
    
    /* √Åp d·ª•ng cho theme M·∫∑c ƒë·ªãnh, Lofi v√† Space */
    body[data-theme='default'],
    body[data-theme='lofi'],
    body[data-theme='space'] {
        /* TƒÉng ƒë·ªô s√°ng l√™n 115% v√† ƒë·ªô b√£o h√≤a m√†u l√™n 110% */
        filter: brightness(115%) saturate(110%);
    }
    
    /* G·ª° b·ªè b·ªô l·ªçc cho c√°c theme s√°ng ƒë·ªÉ gi·ªØ m√†u g·ªëc */
    body[data-theme='light'],
    body[data-theme='pastel'] {
        filter: none;
    }
    
    /* ============================================= */
    /* END: B·ªò L·ªåC N√ÇNG CAO N·ªÄN CHO THEME T·ªêI        */
    /* ============================================= */

    /* ========================================================= */
    /* START: THI·∫æT L·∫¨P PANEL M√ÄU ƒê·∫∂C (KH√îNG TRONG SU·ªêT)           */
    /* ========================================================= */
    .app-nav, 
    .modal-card, 
    .actions-menu, 
    .draggable-timer, 
    .sound-permission-bar, 
    .nav-btn .tooltip {
        background: rgba(var(--panel-rgb), var(--panel-opacity)); /* D√πng n·ªÅn b√°n trong su·ªët c·ªßa theme */
        border: 1px solid rgba(127, 127, 127, 0.1); /* Th√™m vi·ªÅn nh·∫π ƒë·ªÉ panel n·ªïi kh·ªëi h∆°n */
    }

    /* L·ªõp ph·ªß c·ªßa Modal c≈©ng kh√¥ng c·∫ßn blur */
    .modal {
        background: rgba(0, 0, 0, 0.65);
    }

    /* ========================================================= */
    /* START: T·∫†O L·ªöP N·ªÄN M·ªú TO√ÄN M√ÄN H√åNH                        */
    /* ========================================================= */
    body::before {
        content: '';
        position: fixed; /* C·ªë ƒë·ªãnh ƒë·ªÉ che to√†n b·ªô m√†n h√¨nh */
        inset: 0; /* (vi·∫øt t·∫Øt c·ªßa top: 0; left: 0; right: 0; bottom: 0;) */
        
        /* T·ª± ƒë·ªông l·∫•y ·∫£nh n·ªÅn ƒë∆∞·ª£c thi·∫øt l·∫≠p trong <body> */
        background-image: inherit; 
        background-size: cover;
        background-position: center;
        
        /* ƒê√¢y l√† ch√¨a kh√≥a:
          - blur(20px): ƒê·ªô m·ªù, b·∫°n c√≥ th·ªÉ tƒÉng/gi·∫£m (v√≠ d·ª• 15px, 25px)
          - brightness(0.8): Gi·∫£m ƒë·ªô s√°ng n·ªÅn ƒëi 20% ƒë·ªÉ ch·ªØ n·ªïi b·∫≠t h∆°n
          - saturate(1.2): TƒÉng ƒë·ªô b√£o h√≤a m√†u l√™n 20% cho ·∫£nh s·ªëng ƒë·ªông h∆°n
        */
        filter: blur(20px) brightness(0.8) saturate(1.2);
        
        /* ƒê·∫∑t l·ªõp n·ªÅn n√†y n·∫±m ·ªü ph√≠a sau c√πng, d∆∞·ªõi t·∫•t c·∫£ n·ªôi dung kh√°c */
        z-index: -1;
    }

    /* === START: L√ÄM M·ªú VI·ªÄN TAB CHO THEME S√ÅNG === */
    [data-theme='light'] .tab-nav,
    [data-theme='pastel'] .tab-nav {
        border-bottom-color: rgba(0, 0, 0, 0.1); /* Vi·ªÅn ƒëen trong su·ªët */
    }
    /* === END: L√ÄM M·ªú VI·ªÄN TAB CHO THEME S√ÅNG === */

    /* === START: ƒê·ªíNG B·ªò GIAO DI·ªÜN C√ÅC PANEL PH·ª§ === */
    .topic-item, .stat-card, .hist-item, .hist-item {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08); /* L√†m vi·ªÅn m·ªù h∆°n m·ªôt ch√∫t */
    }

    .subtopic-btn {
        background-color: transparent; /* B·ªè n·ªÅn c≈© */
    }

    /* √Åp d·ª•ng n·ªÅn v√† vi·ªÅn ri√™ng cho theme s√°ng ƒë·ªÉ d·ªÖ nh√¨n h∆°n */
    [data-theme='light'] .topic-item,
    [data-theme='light'] .stat-card,
    [data-theme='light'] .hist-item,
    [data-theme='pastel'] .topic-item,
    [data-theme='pastel'] .stat-card,
    [data-theme='pastel'] .hist-item {
        background: rgba(0, 0, 0, 0.02); /* M·ªôt l·ªõp n·ªÅn ƒëen r·∫•t m·ªù */
        border: 1px solid rgba(0, 0, 0, 0.06); /* Vi·ªÅn ƒëen m·ªù */
    }
    /* === END: ƒê·ªíNG B·ªò GIAO DI·ªÜN C√ÅC PANEL PH·ª§ === */

    </style>
</head>
<body data-theme="default"> <div class="app" id="app">
    <nav class="app-nav">
        <button class="nav-btn active" id="navBtnTimer" data-view="timer" aria-label="ƒê·ªìng h·ªì">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            <span class="tooltip">ƒê·ªìng h·ªì</span>
        </button>
        <button class="nav-btn" id="navBtnTopics" data-view="topics" aria-label="Ch·ªß ƒë·ªÅ">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
            <span class="tooltip">Ch·ªß ƒë·ªÅ</span>
        </button>
        <button class="nav-btn" id="navBtnStats" data-view="stats" aria-label="Th·ªëng k√™">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
            <span class="tooltip">Th·ªëng k√™</span>
        </button>
        <button class="nav-btn" id="btnSettings" style="margin-top: auto;" aria-label="C√†i ƒë·∫∑t">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            <span class="tooltip">C√†i ƒë·∫∑t</span>
        </button>
        <button class="nav-btn" id="navBtnGuide" data-view="guide" aria-label="H∆∞·ªõng d·∫´n">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 1 1 5.82 1c0 2-3 2-3 4"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            <span class="tooltip">H∆∞·ªõng d·∫´n</span>
        </button>
    </nav>

    <main class="app-content">
      <header class="app-header panel-bg">
        <div class="row" style="gap:12px; align-items:center; flex:0 1 auto">
          <strong>üìö Pomodoro Study App</strong>
          <span class="badge" id="selectedContext">Ch∆∞a ch·ªçn Ch·ªß ƒë·ªÅ con</span>
        </div>
        <div class="actions">
          <button class="btn ghost small" id="btnDashboard" title="Dashboard T·ªïng quan">üìä T·ªïng Quan </button>
          <button class="btn ghost small" id="btnExport" title="Xu·∫•t JSON">‚¨áÔ∏è Xu·∫•t File</button>
          <label class="btn ghost small" for="importFile" title="Nh·∫≠p JSON">‚¨ÜÔ∏è Nh·∫≠p File</label>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
          <button class="btn small" id="btnToggleBg" title="·∫®n/Hi·ªán giao di·ªán">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
          <button class="btn small" id="btnFullscreen" title="To√†n m√†n h√¨nh">‚ÜóÔ∏è</button>
        </div>
      </header>
      

      <div id="view-timer" class="view active">
        <section class="panel panel-bg">
          <div class="timer-header">
            <div id="welcomePanel" class="hidden panel-bg" style="text-align:center; padding: 20px; border-radius: var(--radius); width: 100%;">
                <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi Pomodoro Study App!</h3>
                <p>H√£y b·∫Øt ƒë·∫ßu b·∫±ng c√°ch ch·ªçn m·ªôt <strong>Ch·ªß ƒë·ªÅ con</strong> ho·∫∑c t·∫°o Ch·ªß ƒë·ªÅ/Ch·ªß ƒë·ªÅ con m·ªõi.</p>
                <button class="btn acc" id="btnHelpCreateTopic">Ôºã T·∫°o Ch·ªß ƒë·ªÅ M·ªõi</button>
            </div>
            <div class="presets" role="group" aria-label="Ch·ªçn ch·∫ø ƒë·ªô preset">
                <button id="btnPresetA" class="btn small ghost" data-preset="A"></button>
                <button id="btnPresetB" class="btn small ghost" data-preset="B"></button>
            </div>
          </div>
          <hr />
          <div class="timer" aria-live="polite">
            <div class="badge" id="stateBadge">TR·∫†NG TH√ÅI</div>
            
            <div class="timer-circle-container">
              <svg class="timer-svg" viewBox="0 0 100 100">
                  <circle class="timer-circle-bg" cx="50" cy="50" r="45"></circle>
                  <circle class="timer-circle-progress" cx="50" cy="50" r="45"></circle>
              </svg>
              <div id="timeDisplay" class="big-time">00:00</div>
            </div>

            <div class="tiny" id="cycleInfo"></div>
            
            <div class="controls">
              <button class="btn acc" id="btnStart" aria-label="B·∫Øt ƒë·∫ßu (Space)">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu</button>
              <button class="btn" id="btnPause" aria-label="T·∫°m d·ª´ng (Space)">‚è∏Ô∏è T·∫°m d·ª´ng</button>
              <button class="btn" id="btnResume" aria-label="Ti·∫øp t·ª•c (Space)">‚èµ Ti·∫øp t·ª•c</button>
              <button class="btn warn" id="btnSkip" aria-label="B·ªè qua (N)">‚è≠Ô∏è B·ªè qua</button>
              <button class="btn danger" id="btnReset">‚Ü∫ ƒê·∫∑t l·∫°i</button>
            </div>
            <div class="tiny">Ph√≠m t·∫Øt: <strong>Space</strong> = B·∫Øt ƒë·∫ßu/T·∫°m d·ª´ng/Ti·∫øp t·ª•c, <strong>N</strong> = Ti·∫øp theo/B·ªè qua</div>
          </div>
        </section>

        <section class="panel panel-bg aux-panel">
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="tasks">Nhi·ªám v·ª•</button>
                <button class="tab-btn" data-tab="notes">Ghi ch√∫</button>
                <button class="tab-btn" data-tab="ai">Gemini AI</button>
            </nav>
            <div id="tasks" class="tab-content active">
                <h4 style="margin: 0 0 8px; color: var(--sub);">To-do cho ch·ªß ƒë·ªÅ con n√†y:</h4>
                <ul id="subtopicTasksList" class="subtopic-todo-list"></ul>
                <div class="row" style="gap:8px; margin-top: 8px;">
                    <input type="text" id="newSubtopicTaskInput" placeholder="Th√™m m·ªôt task m·ªõi..." />
                    <button id="btnAddSubtopicTask" class="btn small" style="flex: 0 1 auto;">Th√™m</button>
                </div>
            </div>
            <div id="notes" class="tab-content">
                <div id="generalNotesList" class="notes-list"></div>
                <div class="add-note-area" style="margin-top: 12px;">
                    <textarea id="newGeneralNoteText" placeholder="Th√™m ghi ch√∫ m·ªõi..."></textarea>
                    <div style="text-align: right; margin-top: 8px;">
                        <button class="btn acc small" id="btnAddGeneralNote">Ôºã Th√™m ghi ch√∫</button>
                    </div>
                </div>
            </div>
            <div id="ai" class="tab-content">
                <div class="panel-header" style="margin-bottom: 8px; padding: 0;">
                    <h4 style="margin:0;">Gemini Assistant cho: <span id="currentSubtopicNameChat">(ch∆∞a ch·ªçn)</span></h4>
                    <div class="actions">
                        <button id="btnNewChat" class="btn small ghost" title="Chat m·ªõi">‚ûï</button>
                        <button id="btnClearChat" class="btn small danger" title="X√≥a l·ªãch s·ª≠">üóëÔ∏è</button>
                    </div>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div id="aiPromptSuggestions" style="display: flex; gap: 6px; margin: 8px 0; flex-wrap: wrap;">
                  <button class="btn small ghost" data-prompt="Gi·∫£i th√≠ch kh√°i ni·ªám ch√≠nh c·ªßa ch·ªß ƒë·ªÅ n√†y">Gi·∫£i th√≠ch kh√°i ni·ªám</button>
                  <button class="btn small ghost" data-prompt="T·∫°o m·ªôt d√†n √Ω chi ti·∫øt cho ch·ªß ƒë·ªÅ n√†y">T·∫°o d√†n √Ω</button>
                  <button class="btn small ghost" data-prompt="Li·ªát k√™ 5 c√¢u h·ªèi √¥n t·∫≠p quan tr·ªçng v·ªÅ ch·ªß ƒë·ªÅ n√†y">T·∫°o c√¢u h·ªèi √¥n t·∫≠p</button>
                </div>
                <div class="chat-input-area">
                  <input type="text" id="chatInput" placeholder="H·ªèi Gemini ƒëi·ªÅu g√¨ ƒë√≥..." />
                  <button id="btnSendMessage" class="btn acc">G·ª≠i</button>
                </div>
            </div>
        </section>
      </div>

      <div id="view-topics" class="view">
        <div class="panel panel-bg">
            <div class="row" style="gap:8px; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0;">Qu·∫£n l√Ω Ch·ªß ƒë·ªÅ</h3>
                <button class="btn small acc" id="btnAddTopic" style="margin-left: auto;">Ôºã Th√™m Ch·ªß ƒë·ªÅ</button>
            </div>
            <div id="topicsList"></div>
            <div class="footer-note">Nh·∫•p m≈©i t√™n ƒë·ªÉ m·ªü/ƒë√≥ng danh s√°ch ch·ªß ƒë·ªÅ con.</div>
        </div>
      </div>
      
      <div id="view-stats" class="view">
        <section class="panel panel-bg">
            <h3 style="margin:0 0 12px 0;">Th·ªëng k√™ & L·ªãch s·ª≠ ‚Äî <span id="currentSubtopicName">(ch∆∞a ch·ªçn)</span></h3>
            <div class="stats-grid">
              <div class="stat-card"><h4>T·ªïng th·ªùi gian</h4><div class="stat-value" id="statTotal">0 ph√∫t</div></div>
              <div class="stat-card"><h4>Phi√™n</h4><div class="stat-value" id="statSessions">0</div></div>
              <div class="stat-card"><h4>Nhi·ªám v·ª• Ho√†n th√†nh</h4><div class="stat-value" id="statTasks">0</div></div>
            </div>
            <div style="margin-top:12px">
              <h4 style="margin:4px 0 8px; color:var(--sub)">L·ªãch s·ª≠ (L√ÄM VI·ªÜC)</h4>
              <div class="history" id="historyList"></div>
            </div>
        </section>
      </div>

      <div id="view-guide" class="view">
        <div class="panel panel-bg">
            <h3 style="margin-top: 0;">üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Pomodoro Study App</h3>
            <h4>B·∫Øt ƒë·∫ßu nhanh</h4>
            <p>
                ·ª®ng d·ª•ng ƒë∆∞·ª£c t·ªï ch·ª©c theo c·∫•u tr√∫c <strong>Ch·ªß ƒë·ªÅ</strong> v√† <strong>Ch·ªß ƒë·ªÅ con</strong>.
            </p>
            <ol>
                <li>V√†o m·ª•c <strong>"Ch·ªß ƒë·ªÅ"</strong> t·ª´ thanh ƒëi·ªÅu h∆∞·ªõng.</li>
                <li>Nh·∫•n <strong>"+ Th√™m Ch·ªß ƒë·ªÅ"</strong> ƒë·ªÉ t·∫°o m·ªôt ch·ªß ƒë·ªÅ m·ªõi (v√≠ d·ª•: "H·ªçc L·∫≠p tr√¨nh Web").</li>
                <li>Nh·∫•n n√∫t <strong>"Ôºã Th√™m"</strong> b√™n c·∫°nh ch·ªß ƒë·ªÅ v·ª´a t·∫°o ƒë·ªÉ th√™m m·ªôt ch·ªß ƒë·ªÅ con (v√≠ d·ª•: "ReactJS C∆° b·∫£n").</li>
                <li>Ch·ªçn ch·ªß ƒë·ªÅ con b·∫°n v·ª´a t·∫°o. B√¢y gi·ªù b·∫°n ƒë√£ s·∫µn s√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu m·ªôt phi√™n Pomodoro!</li>
            </ol>
            <hr />
            <h4>C√°c T√≠nh NƒÉng Ch√≠nh</h4>
            <ul>
                <li><strong>ƒê·ªìng h·ªì (Timer):</strong> N∆°i b·∫°n th·ª±c hi·ªán c√°c phi√™n h·ªçc Pomodoro. B·∫°n c√≥ th·ªÉ ch·ªçn gi·ªØa 2 c·∫•u h√¨nh (Preset A/B) trong ph·∫ßn C√†i ƒë·∫∑t.</li>
                <li><strong>Tab Nhi·ªám v·ª•:</strong> Trong m√†n h√¨nh ƒë·ªìng h·ªì, b·∫°n c√≥ th·ªÉ th√™m c√°c vi·ªác c·∫ßn l√†m (to-do) cho ch·ªß ƒë·ªÅ con hi·ªán t·∫°i.</li>
                <li><strong>Ch·∫ø ƒë·ªô Zen (Zen Mode):</strong> Nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng con m·∫Øt üëÅÔ∏è ·ªü g√≥c tr√™n b√™n ph·∫£i ƒë·ªÉ ·∫©n m·ªçi th·ª© v√† ch·ªâ t·∫≠p trung v√†o h√¨nh n·ªÅn v√† ƒë·ªìng h·ªì.</li>
                <li><strong>Th·ªëng k√™ (Stats):</strong> Theo d√µi t·ªïng th·ªùi gian h·ªçc, s·ªë phi√™n ho√†n th√†nh v√† nhi·ªám v·ª• ƒë√£ l√†m cho m·ªói ch·ªß ƒë·ªÅ con.</li>
            </ul>
            <hr />
            <h4>Ph√≠m t·∫Øt</h4>
            <ul>
                <li><kbd>Space</kbd>: B·∫Øt ƒë·∫ßu / T·∫°m d·ª´ng / Ti·∫øp t·ª•c ƒë·ªìng h·ªì.</li>
                <li><kbd>N</kbd>: B·ªè qua (Skip) phi√™n l√†m vi·ªác ho·∫∑c ngh·ªâ hi·ªán t·∫°i.</li>
                <li><kbd>Esc</kbd>: ƒê√≥ng c√°c c·ª≠a s·ªï pop-up (nh∆∞ C√†i ƒë·∫∑t).</li>
            </ul>
            <hr />
            <h4>C√†i ƒë·∫∑t & T√≠ch h·ª£p N√¢ng cao</h4>
            <p>B·∫°n c√≥ th·ªÉ truy c·∫≠p t·∫•t c·∫£ c√°c m·ª•c n√†y trong ph·∫ßn <strong>C√†i ƒë·∫∑t</strong> ‚öôÔ∏è.</p>
            <strong style="display: block; margin-top: 1em;">üß† T√≠ch h·ª£p Gemini AI</strong>
            <p>
                T√≠nh nƒÉng n√†y k·∫øt n·ªëi ·ª©ng d·ª•ng v·ªõi tr√≠ tu·ªá nh√¢n t·∫°o c·ªßa Google, cho ph√©p b·∫°n s·ª≠ d·ª•ng tr·ª£ l√Ω AI trong tab "Gemini AI". B·∫°n c√≥ th·ªÉ h·ªèi ƒë√°p, y√™u c·∫ßu gi·∫£i th√≠ch c√°c kh√°i ni·ªám kh√≥, ho·∫∑c t√≥m t·∫Øt ghi ch√∫.
            </p>
            <ul>
                <li><strong>C√°ch thi·∫øt l·∫≠p:</strong> B·∫°n c·∫ßn m·ªôt <strong>API Key</strong>.
                    <ol>
                        <li>Truy c·∫≠p <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> v√† ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Google.</li>
                        <li>Nh·∫•n "Create API key in new project" ƒë·ªÉ t·∫°o m·ªôt key m·ªõi.</li>
                        <li>Sao ch√©p (copy) chu·ªói k√Ω t·ª± API Key ƒë√≥.</li>
                        <li>D√°n v√†o √¥ "Gemini API Key" trong ph·∫ßn C√†i ƒë·∫∑t c·ªßa ·ª©ng d·ª•ng v√† nh·∫•n L∆∞u.</li>
                    </ol>
                </li>
            </ul>
            <strong style="display: block; margin-top: 1em;">üé∂ Nh·∫°c n·ªÅn YouTube</strong>
            <p>
                T·ª± ƒë·ªông ph√°t m·ªôt video ho·∫∑c m·ªôt danh s√°ch ph√°t t·ª´ YouTube l√†m nh·∫°c n·ªÅn trong khi b·∫°n h·ªçc. R·∫•t tuy·ªát v·ªùi cho c√°c playlist nh·∫°c lofi ho·∫∑c √¢m thanh t·ª± nhi√™n.
            </p>
            <ul>
                <li><strong>C√°ch s·ª≠ d·ª•ng:</strong>
                    <ol>
                        <li>T√¨m m·ªôt video tr√™n YouTube (v√≠ d·ª•: "lofi hip hop radio").</li>
                        <li>Sao ch√©p ƒë∆∞·ªùng d·∫´n (URL) c·ªßa video ƒë√≥.</li>
                        <li>D√°n v√†o √¥ "Nh·∫°c n·ªÅn YouTube" trong C√†i ƒë·∫∑t.</li>
                    </ol>
                </li>
                <li><strong>T√πy ch·ªçn th√™m:</strong> B·∫°n c√≥ th·ªÉ t√≠ch v√†o √¥ "D√πng ·∫£nh b√¨a video l√†m n·ªÅn" ƒë·ªÉ t·ª± ƒë·ªông ƒë·ªïi h√¨nh n·ªÅn c·ªßa ·ª©ng d·ª•ng th√†nh thumbnail c·ªßa video.</li>
            </ul>
            <strong style="display: block; margin-top: 1em;">üõ°Ô∏è Ph·ª•c h·ªìi d·ªØ li·ªáu</strong>
            <p>
                ƒê√¢y l√† m·ªôt t√≠nh nƒÉng an to√†n. ·ª®ng d·ª•ng s·∫Ω t·ª± ƒë·ªông t·∫°o m·ªôt b·∫£n sao l∆∞u d·ªØ li·ªáu c·ªßa b·∫°n m·ªói ng√†y. N·∫øu b·∫°n v√¥ t√¨nh x√≥a m·∫•t m·ªôt ch·ªß ƒë·ªÅ quan tr·ªçng, b·∫°n c√≥ th·ªÉ d√πng t√≠nh nƒÉng n√†y ƒë·ªÉ quay tr·ªü l·∫°i.
            </p>
            <ul>
                <li><strong>C√°ch s·ª≠ d·ª•ng:</strong>
                    <ol>
                        <li>M·ªü danh s√°ch th·∫£ xu·ªëng ƒë·ªÉ xem c√°c b·∫£n sao l∆∞u c√≥ s·∫µn theo ng√†y.</li>
                        <li>Ch·ªçn ng√†y b·∫°n mu·ªën ph·ª•c h·ªìi.</li>
                        <li>Nh·∫•n n√∫t "Ph·ª•c h·ªìi".</li>
                    </ol>
                </li>
                <li>‚ö†Ô∏è <strong>C·∫£nh b√°o quan tr·ªçng:</strong> H√†nh ƒë·ªông n√†y s·∫Ω <strong>ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i</strong> c·ªßa b·∫°n b·∫±ng d·ªØ li·ªáu c·ªßa ng√†y ƒë√£ ch·ªçn. H√£y ch·∫Øc ch·∫Øn tr∆∞·ªõc khi th·ª±c hi·ªán.</li>
            </ul>
        </div>
      </div>
    </main>
  </div>

  <div class="modal" id="modalMilestone" role="dialog" aria-modal="true" aria-labelledby="milestoneTitle">
    <div class="modal-card" style="width: min(600px, 94vw);">
        <h3 id="milestoneTitle">üéâ Ch√∫c m·ª´ng B·∫°n!</h3>
        <p id="milestoneMessage" style="white-space: pre-wrap; line-height: 1.6;"></p>
        <div class="row" style="justify-content:flex-end; margin-top:12px">
            <button class="btn acc" id="btnMilestoneClose">Ti·∫øp t·ª•c h√†nh tr√¨nh!</button>
        </div>
    </div>
  </div>
  <div class="modal" id="modalSettings" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-card">
          <h3 id="settingsTitle">‚öôÔ∏è C√†i ƒë·∫∑t</h3>
          <nav class="tab-nav">
              <button class="tab-btn active" data-tab="settings-timer">ƒê·ªìng h·ªì</button>
              <button class="tab-btn" data-tab="settings-ui">Giao di·ªán & √Çm thanh</button>
              <button class="tab-btn" data-tab="settings-integrations">T√≠ch h·ª£p</button>
          </nav>
          <div class="settings-content">
              <div id="settings-timer" class="tab-content active" style="flex-direction:column; gap:20px;">
                  <div>
                      <h4>Th·ªùi l∆∞·ª£ng Pomodoro</h4>
                      <div class="row" id="timerPresetSelector" style="margin-bottom:16px;">
                          <button class="btn acc" data-preset-target="A"> Ki·ªÉu A </button>
                          <button class="btn ghost" data-preset-target="B"> Ki·ªÉu B </button>
                      </div>
                      <div class="row">
                          <label>L√ÄM VI·ªÜC (ph√∫t)<input type="number" id="set_work" min="1" /></label>
                          <label>NGH·ªà NG·∫ÆN (ph√∫t)<input type="number" id="set_short" min="1" /></label>
                          <label>NGH·ªà D√ÄI (ph√∫t)<input type="number" id="set_long" min="1" /></label>
                      </div>
                      <div class="row">
                          <label>Chu k·ª≥ Pomodoro<input type="number" id="set_cycles" min="1" /></label>
                          <label>Chu k·ª≥ ngh·ªâ d√†i<input type="number" id="set_interval" min="2" /></label>
                      </div>
                  </div>
                      <div class="settings-row-toggle">
                          <label for="set_autoStartNext">T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu phi√™n ti·∫øp theo</label>
                          <label class="toggle-switch">
                              <input type="checkbox" id="set_autoStartNext">
                              <span class="slider"></span>
                          </label>
                      </div>
              </div>
              <div id="settings-ui" class="tab-content" style="flex-direction: column; gap: 20px;">
                  <div>
                      <h4>Giao di·ªán</h4>
                      <div class="row">
                          <label>Theme Giao Di·ªán
                                <select id="set_theme_color">
                                    <option value="default">M·∫∑c ƒë·ªãnh (Dark Blue)</option>
                                    <option value="light">Light - Tr√† S·ªØa</option>
                                    <option value="pastel">Pastel - D·ªÖ th∆∞∆°ng</option>
                                    <option value="lofi">Lofi Study Room</option>
                                    <option value="space">Space Station</option>
                                </select>
                          </label>
                      </div>
                      <div class="row">
                          <label>H√¨nh n·ªÅn
                              <label class="btn small ghost" for="uploadBg">T·∫£i ·∫£nh m·ªõi</label>
                              <input type="file" id="uploadBg" accept="image/*" class="hidden" />
                          </label>
                          <button class="btn small danger" id="btnClearBg">X√≥a n·ªÅn</button>
                      </div>
                      <div class="row">
                          <label style="flex: 1;">ƒê·ªô trong su·ªët c·ªßa n·ªÅn</label>
                          <input type="range" id="set_panelOpacity" min="0.1" max="1" step="0.05" style="flex: 2;">
                      </div>
                      
                   </div>
                  
                   <div>
                      <h4>√Çm thanh</h4>
                      <div class="row">
                          <label>√Çm l∆∞·ª£ng (0‚Äì1)<input type="number" id="set_volume" step="0.05" min="0" max="1"/></label>
                          <label>Ki·ªÉu √¢m b√°o
                              <select id="set_theme">
                                  <option value="beep">Beep</option>
                                  <option value="chime">Chime</option>
                              </select>
                          </label>
                           <button class="btn" id="btnTestSound" style="flex: 0 1 auto; align-self: center;">Test</button>
                      </div>
                      <div style="text-align: right; margin-top: 12px;">
                          <button class="btn ghost small" id="btnToggleCustomSounds">T√πy ch·ªânh √¢m b√°o</button>
                      </div>

                      <div id="customSoundsContainer" class="hidden" style="margin-top: 8px;">
                      <div class="row" style="display: flex; gap: 8px; justify-content: flex-end;">
                          <div>
                              <small>√Çm b√°o h·∫øt L√ÄM VI·ªÜC</small>
                              <label title="√Çm b√°o h·∫øt L√ÄM VI·ªÜC" class="btn small ghost" for="uploadSoundWork">L√ÄM VI·ªÜC</label>
                              <input type="file" id="uploadSoundWork" accept="audio/*" class="hidden" />
                          </div>
                          <div>
                              <small>√Çm b√°o h·∫øt NGH·ªà NG·∫ÆN</small>
                              <label title="√Çm b√°o h·∫øt NGH·ªà NG·∫ÆN" class="btn small ghost" for="uploadSoundBreak">NGH·ªà NG·∫ÆN</label>
                              <input type="file" id="uploadSoundBreak" accept="audio/*" class="hidden" />
                          </div>
                          <div>
                              <small>√Çm b√°o h·∫øt NGH·ªà D√ÄI</small>
                              <label title="√Çm b√°o h·∫øt NGH·ªà D√ÄI" class="btn small ghost" for="uploadSoundLong">NGH·ªà D√ÄI</label>
                              <input type="file" id="uploadSoundLong" accept="audio/*" class="hidden" />
                          </div>
                      </div>
                      </div>
                  </div>
              </div>
              <div id="settings-integrations" class="tab-content" style="flex-direction: column; gap: 20px;">
                  <div>
                      <h4>T√≠ch h·ª£p AI</h4>
                      <label>Gemini API Key
                          <input type="password" id="set_apiKey" placeholder="D√°n API Key c·ªßa b·∫°n v√†o ƒë√¢y..." />
                      </label>
                      <div class="tiny">C·∫ßn c√≥ ƒë·ªÉ s·ª≠ d·ª•ng c√°c t√≠nh nƒÉng AI. L·∫•y key mi·ªÖn ph√≠ t·∫°i <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.</div>
                  </div>
                  <div>
                      <h4>üéµ Nh·∫°c n·ªÅn YouTube</h4>
                      <div class="row" style="gap:8px; align-items:center;">
                          <input type="text" id="set_youtubeUrl" placeholder="D√°n link YouTube v√†o ƒë√¢y..." style="flex:1;">
                          </div>
                      <div id="ytUrlFeedback" class="tiny" style="min-height: 1.2em; padding: 4px 0;"></div>
                      <div class="row" style="margin-top: 4px;">
                          <label style="flex: 0 1 auto; display: flex; align-items: center; gap: 8px; font-size: 14px;">
                              <input type="checkbox" id="set_ytThumbAsBg">
                              <span>D√πng ·∫£nh b√¨a video l√†m n·ªÅn</span>
                          </label>
                      </div>
                      <div class="row" style="margin-top: 8px;">
                          <button id="btnToggleYtSound" class="btn small" style="flex:0 1 auto;">‚ñ∂Ô∏è</button>
                          <input type="range" id="ytSoundVolume" min="0" max="100" step="1" value="80" style="flex:1;">
                      </div>
                      <div class="tiny" style="text-align:center; margin-top:4px;">√Çm l∆∞·ª£ng</div>
                  </div>
                  <div>
                      <h4>üõ°Ô∏è C√†i ƒë·∫∑t sao l∆∞u</h4>
                      <div class="row">
                          <label>S·ªë ng√†y sao l∆∞u c·∫ßn gi·ªØ l·∫°i
                               <input type="number" id="set_backupDays" min="1" max="30" />
                          </label>
                      </div>
                  </div>
                  <div>
                      <h4>üõ°Ô∏è Ph·ª•c h·ªìi d·ªØ li·ªáu</h4>
                      <p class="tiny">Ph·ª•c h·ªìi d·ªØ li·ªáu t·ª´ m·ªôt b·∫£n sao l∆∞u t·ª± ƒë·ªông h√†ng ng√†y. H√†nh ƒë·ªông n√†y s·∫Ω ghi ƒë√® l√™n d·ªØ li·ªáu hi·ªán t·∫°i c·ªßa b·∫°n.</p>
                      <div class="row">
                          <select id="backupList" style="flex: 3;"></select>
                          <button id="btnRestoreBackup" class="btn warn small" style="flex: 1;">Ph·ª•c h·ªìi</button>
                      </div>
                  </div>
              </div>
          </div>
          <div class="row" style="margin-top:16px; justify-content:flex-end">
              <button class="btn ghost" id="btnDefaults">M·∫∑c ƒë·ªãnh</button>
              <button class="btn acc" id="btnSaveSettings">L∆∞u</button>
              <button class="btn" id="btnCloseSettings">ƒê√≥ng</button>
          </div>
      </div>
  </div>

  <div class="modal" id="modalNote" role="dialog" aria-modal="true" aria-labelledby="noteTitle">
    <div class="modal-card">
      <h3 id="noteTitle">üìù Ghi ch√∫ cho phi√™n v·ª´a ho√†n th√†nh</h3>
      <div class="row"><textarea id="noteText" placeholder="B·∫°n h·ªçc ƒë∆∞·ª£c g√¨? Kh√≥ khƒÉn? Next steps?"></textarea></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px; gap: 12px;">
        <button class="btn" id="btnSummarizeNote">‚ú® T√≥m t·∫Øt & G·ª£i √Ω</button>
        <button class="btn" id="btnSkipNote">B·ªè qua</button>
        <button class="btn acc" id="btnSaveNote">L∆∞u ghi ch√∫</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalGeneric" role="dialog" aria-modal="true" aria-labelledby="genericTitle">
      <div class="modal-card" style="width: min(450px, 94vw);">
          <h3 id="genericTitle">Ti√™u ƒë·ªÅ</h3>
          <p id="genericMessage" class="hidden"></p>
          <input type="text" id="genericInput" class="hidden" />
          <div class="row" style="justify-content:flex-end; margin-top:12px">
              <button class="btn" id="btnGenericCancel">H·ªßy</button>
              <button class="btn acc" id="btnGenericOk">OK</button>
          </div>
      </div>
  </div>
  
  <div class="modal" id="modalDashboard" role="dialog" aria-modal="true" aria-labelledby="dashboardTitle">
    <div class="modal-card" style="width: min(800px, 95vw);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 id="dashboardTitle">üìä T·ªïng quan</h3>
            <button class="btn ghost small" id="btnCloseDashboard">ƒê√≥ng</button>
        </div>
        <p class="tiny">T·ªïng h·ª£p th·ªùi gian v√† s·ªë phi√™n ƒë√£ ho√†n th√†nh tr√™n t·∫•t c·∫£ c√°c ch·ªß ƒë·ªÅ.</p>
        <div id="dashboardContent" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>
  <audio id="audioWorkEnd"></audio>
  <audio id="audioBreakEnd"></audio>
  <audio id="audioLongEnd"></audio>
  <div id="youtube-player-container"></div>

  <div id="draggableTimer" class="draggable-timer">00:00</div>

    <div id="soundPermissionBar" class="sound-permission-bar" role="alert" aria-live="polite">
    <span class="msg">ƒêang ph√°t (t·∫Øt ti·∫øng). Nh·∫•n n√∫t ‚ñ∂Ô∏è ƒë·ªÉ b·∫≠t ti·∫øng.</span>
  </div>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script>
    // ƒê√£ b·ªè fixVietnameseUI: d√πng tr·ª±c ti·∫øp ti·∫øng Vi·ªát (UTF-8) trong HTML/JS
    // N√∫t to√†n m√†n h√¨nh: d√πng bi·ªÉu t∆∞·ª£ng ‚ÜóÔ∏è/‚ÜôÔ∏è thay v√¨ ch·ªØ
    window.addEventListener('load', ()=>{ try { updateFullscreenButton(); } catch(_) {} });
    const IS_FILE_PROTOCOL = (window.location.protocol === 'file:');
    // Watchdog: th√¥ng b√°o n·∫øu API YouTube t·∫£i ch·∫≠m ho·∫∑c th·∫•t b·∫°i
    function startYtApiWatchdog(){
      const fb = document.getElementById('ytUrlFeedback');
      if (!fb) return;
      const t1 = setTimeout(()=>{
        try{ if (!window.YT || !window.YT.Player){ fb.textContent='ƒêang t·∫£i API YouTube...'; fb.style.color='var(--sub)'; } }catch(_){ }
      }, 1500);
      const t2 = setTimeout(()=>{
        try{ if (!window.YT || !window.YT.Player){ fb.textContent='Kh√¥ng t·∫£i ƒë∆∞·ª£c API YouTube. Ki·ªÉm tra m·∫°ng ho·∫∑c t·∫£i l·∫°i trang.'; fb.style.color='var(--danger)'; } }catch(_){ }
      }, 7000);
      window.__ytApiWatchdog = { cancel(){ clearTimeout(t1); clearTimeout(t2);} };
    }
    startYtApiWatchdog();
    // Inline i18n fallback so app works over file:// without CORS
    (function(){
      const DICT = {
        'timer.cycleInfo': ({ current = 0, target = 0 } = {}) => `Chu k·ª≥ ${current}/${target}`,
        'timer.selectSubtopicPrompt': 'Vui l√≤ng ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con tr∆∞·ªõc khi th·ª±c hi·ªán thao t√°c.'
      };
      window.t = function t(key, vars){
        try {
          const v = DICT[key];
          if (typeof v === 'function') return v(vars || {});
          if (typeof v === 'string') return v;
        } catch(_) {}
        return key;
      };
      window.loadLanguage = function loadLanguage(lang){
        try { localStorage.setItem('lang', lang || 'vi'); } catch(_) {}
        return Promise.resolve();
      };
    })();
    // storageManager will manage persistence
    // =============================
    // STORAGE MANAGER - Qu·∫£n l√Ω D·ªØ li·ªáu v√† Sao l∆∞u
    // =============================
    const storageManager = {
        DB_NAME: 'PomodoroAppDB',
        DB_VERSION: 1,
        db: null,
        async initDB() {
            return new Promise((resolve, reject) => {
                if (this.db) return resolve(this.db);
                const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings');
                    }
                    if (!db.objectStoreNames.contains('topics')) {
                        db.createObjectStore('topics', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('subtopics')) {
                        const subtopicsStore = db.createObjectStore('subtopics', { keyPath: 'id' });
                        subtopicsStore.createIndex('by_topic', 'topicId');
                    }
                    if (!db.objectStoreNames.contains('backups')) {
                        db.createObjectStore('backups', { keyPath: 'date' });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    console.log('IndexedDB initialized successfully.');
                    resolve(this.db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    reject(event.target.error);
                };
            });
        },
        async _getStore(storeName, mode = 'readonly') {
            await this.initDB();
            const tx = this.db.transaction([storeName], mode);
            return tx.objectStore(storeName);
        },
        async getSettings() {
            const store = await this._getStore('settings');
            return new Promise((resolve, reject) => {
                const request = store.get('main_settings');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async updateSettings(settingsObject) {
            const store = await this._getStore('settings', 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.put(settingsObject, 'main_settings');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async getAll(storeName) {
            const store = await this._getStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async update(storeName, object) {
            const store = await this._getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.put(object);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async add(storeName, object) {
            const store = await this._getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.add(object);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async delete(storeName, key) {
            const store = await this._getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.delete(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async save(data) {
            await this.initDB();
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(['settings', 'topics', 'subtopics'], 'readwrite');
                const settingsStore = tx.objectStore('settings');
                const topicsStore = tx.objectStore('topics');
                const subtopicsStore = tx.objectStore('subtopics');

                settingsStore.put(data.settings, 'main_settings');
                topicsStore.clear();
                subtopicsStore.clear();

                data.topics.forEach(topic => {
                    const { subtopics, ...topicData } = topic;
                    topicsStore.put(topicData);
                    (subtopics || []).forEach(sub => subtopicsStore.put(sub));
                });

                tx.oncomplete = () => resolve();
                tx.onerror = e => reject(e.target.error);
            });
        },
        async autoBackup(data) {
            await this.initDB();
            const today = new Date().toISOString().slice(0, 10);
            const lastBackupDate = localStorage.getItem('lastBackupDate');
            if (today !== lastBackupDate) {
                console.log(`Creating backup for ${today}...`);
                const backupData = { date: today, data: JSON.parse(JSON.stringify(data)) };
                const transaction = this.db.transaction(['backups'], 'readwrite');
                const store = transaction.objectStore('backups');
                const request = store.put(backupData);
                request.onsuccess = () => {
                    localStorage.setItem('lastBackupDate', today);
                    console.log('Daily backup successful.');
                    this.cleanupOldBackups((data?.settings?.backupDaysToKeep) || 7);
                };
                request.onerror = (event) => {
                    console.error('Backup failed:', event.target.error);
                };
            }
        },
        async cleanupOldBackups(daysToKeep) {
            await this.initDB();
            const transaction = this.db.transaction(['backups'], 'readwrite');
            const store = transaction.objectStore('backups');
            const request = store.getAllKeys();
            request.onsuccess = () => {
                const allKeys = request.result.sort().reverse();
                if (allKeys.length > daysToKeep) {
                    const keysToDelete = allKeys.slice(daysToKeep);
                    keysToDelete.forEach(key => {
                        store.delete(key);
                        console.log(`Deleted old backup: ${key}`);
                    });
                }
            };
        },
        async getBackupList() {
            await this.initDB();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result.sort((a, b) => b.date.localeCompare(a.date)));
                request.onerror = (event) => reject(event.target.error);
            });
        },
        async restoreBackup(date) {
            await this.initDB();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                const request = store.get(date);
                request.onsuccess = () => {
                    if (request.result && request.result.data) {
                        localStorage.setItem('pomodoroData_v11', JSON.stringify(request.result.data));
                        resolve(request.result.data);
                    } else {
                        reject(new Error('Kh√¥ng t√¨m th·∫•y b·∫£n sao l∆∞u.'));
                    }
                };
                request.onerror = (event) => reject(event.target.error);
            });
        },
        exportData(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            const ts = new Date();
            const pad = n => `${n}`.padStart(2, '0');
            a.href = URL.createObjectURL(blob);
            a.download = `pomodoro_backup_${ts.getFullYear()}${pad(ts.getMonth() + 1)}${pad(ts.getDate())}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        },
        async importData(file) {
            const text = await file.text();
            const obj = JSON.parse(text);
            if (!obj.version || !obj.settings || !Array.isArray(obj.topics)) {
                throw new Error('T·ªáp kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
            }
            localStorage.setItem('pomodoroData_v11', JSON.stringify(obj));
            return obj;
        }
    };

    // =============================
    // Helpers
    // =============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    function on(el, evt, handler){ if(!el){ console.warn('Missing element', evt); return; } el.addEventListener(evt, handler); }
    const formatMMSS = (s) => { const m = Math.floor(s/60).toString().padStart(2,'0'); const ss = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; };
    const uid = (p='id') => `${p}_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;
    const todayISO = () => new Date().toISOString();
    function toast(msg, ms=2600){ const box=$('#toasts'); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; box.appendChild(t); setTimeout(()=>{t.style.opacity='0';}, ms-300); setTimeout(()=> box.removeChild(t), ms); }
    function escapeHTML(str){ return str.replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    function formatDaysHoursMinutes(totalMinutes) {
        if (!totalMinutes || totalMinutes < 1) return "0 ph√∫t";
        const totalHours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        const mm = minutes.toString().padStart(2, '0');
        return `${totalHours} ti·∫øng ${mm} ph√∫t`;
    }
    function formatGeminiResponse(text) {
        return text.replace(/(\*\*|__|\*|_|#+\s*)/g, '');
    }
    function normalizeDataStructure(obj){
        if (!obj || typeof obj !== 'object') return;
        const s = obj.settings || {};
        const mergedSettings = {
            ...defaults.settings,
            ...s,
            durations: { ...defaults.settings.durations, ...(s.durations || {}) }
        };
        if (!Array.isArray(mergedSettings.achievedMilestones)) mergedSettings.achievedMilestones = [];
        obj.settings = mergedSettings;
        obj.topics = Array.isArray(obj.topics) ? obj.topics : [];
        obj.topics.forEach(t => {
            t.subtopics = Array.isArray(t.subtopics) ? t.subtopics : [];
            t.subtopics.forEach(st => {
                st.tasks = st.tasks || [];
                st.generalNotes = st.generalNotes || [];
                st.summaries = st.summaries || [];
                st.chatHistory = st.chatHistory || [];
                st.stats = st.stats || { totalMinutes: 0, sessionsCompleted: 0, tasksCompleted: 0 };
                st.sessions = st.sessions || [];
                st.timerState = st.timerState || { state: 'idle', prevState: null, remaining: 0, segmentTotal: 0, cycleIndex: 0 };
            });
        });
    }
    function extractYouTubeID(url) {
        if (!url) return null;
        const regExp = /^.*(?:youtu.be\/|shorts\/|live\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([A-Za-z0-9_-]{11}).*/;
        const match = url.match(regExp);
        return match ? match[1] : null;
    }
    let sessionYoutubeUrl = '';
    function getActiveYoutubeUrl(){
        try {
            if (sessionYoutubeUrl) return sessionYoutubeUrl;
            const el = document.getElementById('set_youtubeUrl');
            const v = (el && el.value ? el.value : '').trim();
            return v;
        } catch(_) { return ''; }
    }
    function getActiveVideoId(){ return extractYouTubeID(getActiveYoutubeUrl()); }
    function handleYoutubeUrlInput() {
        const input = $("#set_youtubeUrl");
        const feedbackEl = $("#ytUrlFeedback");
        const toggleBtn = $("#btnToggleYtSound");
        const url = input.value.trim();
        const videoId = extractYouTubeID(url);

        if (videoId) {
            feedbackEl.textContent = "OK. Link h·ª£p l·ªá. ƒêang chu·∫©n b·ªã ph√°t...";
            feedbackEl.style.color = 'var(--acc-2)';
            toggleBtn.disabled = false;
            sessionYoutubeUrl = url;
            try {
                const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                const img = new Image();
                img.onload = async () => { data.settings.customBg = thumbUrl; try { await saveData(); } catch(_) {} applyCustomBg(); };
                img.onerror = async () => { const fb = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`; data.settings.customBg = fb; try { await saveData(); } catch(_) {} applyCustomBg(); };
                img.src = thumbUrl;
            } catch(_) {}
            try {
                if (IS_FILE_PROTOCOL) {
                    const isMuted = _ytUnlocked ? 0 : 1;
                    fallbackLoadVideo(videoId, { autoplay: 1, mute: isMuted });
                    try { setTimeout(() => { try { fallbackPostMessage('playVideo'); } catch(_) {} }, 250); } catch(_) {}
                    if (!_ytUnlocked) { showSoundPermission(); }
                try { setTimeout(() => { const fb = document.getElementById('ytUrlFeedback'); if (fb) fb.textContent = 'ƒêang ph√°t'; }, 500); } catch(_) {}
                } else {
                    updateYouTubePlayer();
                }
            } catch(_) {}
        } else if (url === '') {
            feedbackEl.textContent = "";
            toggleBtn.disabled = true;
            if (IS_FILE_PROTOCOL) { try { fallbackStop(); } catch(_) {} }
            else if (ytPlayer && ytPlayer.stopVideo) { ytPlayer.stopVideo(); }
        } else {
            feedbackEl.textContent = "‚ùå Link kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£.";
            feedbackEl.style.color = 'var(--danger)';
            toggleBtn.disabled = true;
        }
    }
    
    // THAY ƒê·ªîI: H√†m applyTheme ƒë∆∞·ª£c c·∫≠p nh·∫≠t ho√†n to√†n
    function applyTheme(previewTheme) {
        const theme = previewTheme || data.settings.theme || 'default';
        document.body.dataset.theme = theme;
        
        const themeHasBg = ['lofi', 'space'].includes(theme);
        const isLightTheme = (theme === 'light' || theme === 'pastel');
        const customBg = data.settings.customBg;

        // helper: always clear any previously forced inline fallback
        const clearInlineBgFallback = () => { try { document.body.style.backgroundImage = ''; } catch(_) {} };

        if (customBg && !data.settings.useYtThumbnailAsBg) {
            document.body.style.setProperty('--bg-image', `url(${customBg})`);
            clearInlineBgFallback();
        } else if (customBg && data.settings.useYtThumbnailAsBg) {
            document.body.style.setProperty('--bg-image', `url(${customBg})`);
            clearInlineBgFallback();
        } else if (themeHasBg) {
            // Use theme-provided background (e.g., lofi/space)
            document.body.style.removeProperty('--bg-image');
            clearInlineBgFallback();
        } else if (isLightTheme) {
            // For light/pastel, avoid dark radial fallback
            document.body.style.setProperty('--bg-image', 'none');
            clearInlineBgFallback();
        } else {
            // Dark/default fallback
            document.body.style.setProperty('--bg-image', '');
            document.body.style.backgroundImage = 'radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%)';
        }
    }


    const defaults = {
        version: 11,
        settings: {
            apiKey: "",
            currentView: 'timer',
            preset: 'A',
            autoStartNext: true,
            soundOn: true,
            volume: 0.8,
            soundTheme: 'beep',
            theme: 'default',
            cyclesA: 4,
            longBreakIntervalA: 4,
            cyclesB: 4,
            longBreakIntervalB: 4,
            durations: { A_work: 25, A_short: 5, A_long: 15, B_work: 50, B_short: 10, B_long: 30 },
            selectedTopicId: '',
            selectedSubtopicId: '',
            collapsedTopics: {},
            customBg: '',
            customSounds: { work_end: '', break_end: '', long_end: '' },
            youtubeUrl: '',
            youtubeVolume: 80,
            useYtThumbnailAsBg: true,
            panelOpacity: 0.85,
            panelBlur: 10,
            backupDaysToKeep: 7,
            achievedMilestones: []
        },
        topics: [{
            id: uid('t'),
            name: 'Ch·ªß ƒë·ªÅ m·∫´u',
            subtopics: [{
                id: uid('s'),
                name: 'Ch·ªß ƒë·ªÅ con m·∫´u',
                tasks: [],
                generalNotes: [],
                summaries: [],
                chatHistory: [],
                stats: { totalMinutes: 0, sessionsCompleted: 0, tasksCompleted: 0 },
                sessions: [],
                timerState: { state: 'idle', prevState: null, remaining: 0, segmentTotal: 0, cycleIndex: 0 }
            }]
        }]
    };
    let data;
    let editingPreset = 'A';

    // (C√°c h√†m c√≤n l·∫°i gi·ªØ nguy√™n)
    // ...
    // ...
    async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
        const apiKey = data.settings.apiKey || "";
        if (!apiKey) {
            toast("Vui l√≤ng nh·∫≠p Gemini API Key trong ph·∫ßn C√†i ƒë·∫∑t.");
            return null;
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                if (response.status === 429 && retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                return formatGeminiResponse(result.candidates[0].content.parts[0].text);
            } else {
                console.error("API response structure is unexpected:", result);
                if (result.promptFeedback?.blockReason) { return `N·ªôi dung b·ªã ch·∫∑n v√¨: ${result.promptFeedback.blockReason}. Vui l√≤ng th·ª≠ l·∫°i v·ªõi n·ªôi dung kh√°c.`; }
                return "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung h·ª£p l·ªá t·ª´ AI.";
            }
        } catch (error) {
            console.error("L·ªói khi g·ªçi Gemini API:", error);
            if (retries > 0) {
                await new Promise(resolve => setTimeout(resolve, delay));
                return callGeminiAPI(prompt, retries - 1, delay * 2);
            }
            return "ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.";
        }
    }
    let AUDIO_CTX = null;
    function ensureAudio(){ if(!AUDIO_CTX) AUDIO_CTX = new (window.AudioContext||window.webkitAudioContext)(); }
    function tone(freq=880, durMs=200, vol=0.2, type='sine', when=0){ ensureAudio(); const ctx=AUDIO_CTX; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); const t = ctx.currentTime + when; g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(vol, t+0.01); g.gain.exponentialRampToValueAtTime(0.0001, t + durMs/1000); o.start(t); o.stop(t + durMs/1000 + 0.05); }
    function playSound(kind){
      if(!data.settings.soundOn) return;
      const vol = Math.max(0, Math.min(1, data.settings.volume ?? 0.8));
      const ref = data.settings.customSounds?.[kind];
      let audioEl;
      if (kind === 'work_end') audioEl = $('#audioWorkEnd'); else if (kind === 'break_end') audioEl = $('#audioBreakEnd'); else if (kind === 'long_end') audioEl = $('#audioLongEnd');
      if (ref && audioEl) {
        if (ref.startsWith('data:') || ref.startsWith('http') || ref.startsWith('blob:')) {
            audioEl.src = ref;
            audioEl.volume = vol;
            audioEl.play().catch(e => console.error("L·ªói ph√°t √¢m thanh:", e));
        } else {
            getStoredFileUrl(ref).then(url => {
                if (url) {
                    audioEl.src = url;
                    audioEl.volume = vol;
                    audioEl.play().catch(e => console.error("L·ªói ph√°t √¢m thanh:", e));
                }
            });
        }
        return;
      }
      const theme = data.settings.soundTheme || 'beep';
      if(theme==='beep'){
        if(kind==='work_end') { tone(880,250,vol); tone(660,180,vol*0.8, 'sine', 0.22); } else if(kind==='break_end') { tone(660,220,vol*0.9); } else if(kind==='long_end') { tone(520,200,vol); tone(780,200,vol, 'sine', 0.22); tone(1040,220,vol, 'sine', 0.44); }
      } else {
        if(kind==='work_end') { tone(1200,160,vol*0.9,'triangle'); tone(900,220,vol*0.8,'triangle',0.18); } else if(kind==='break_end') { tone(880,240,vol*0.8,'triangle'); } else if(kind==='long_end') { tone(600,220,vol*0.9,'triangle'); tone(950,240,vol*0.9,'triangle',0.22); tone(1200,240,vol,'triangle',0.44); }
      }
    }
      async function saveData() {
        try {
          await storageManager.save(data);
        } catch (err) {
          console.error('Failed to save data:', err);
          toast(`L·ªói l∆∞u d·ªØ li·ªáu: ${err.message}`);
        }
      }
        async function ensureValidSelection(){
          const set = data.settings;
          if (!data.topics || data.topics.length === 0) { set.selectedTopicId = ''; set.selectedSubtopicId = ''; await saveData(); return; }
          const t = data.topics.find(x=>x.id===set.selectedTopicId);
          const s = t?.subtopics.find(x=>x.id===set.selectedSubtopicId);
          if(!t || !s){
            const t0 = data.topics[0];
            const s0 = t0?.subtopics?.[0];
            set.selectedTopicId = t0?.id || '';
            set.selectedSubtopicId = s0?.id || '';
            await saveData();
          }
        }
    function showInputModal(title, okCallback, defaultValue = '') {
        $('#genericTitle').textContent = title;
        $('#genericMessage').classList.add('hidden');
        const input = $('#genericInput'); input.value = defaultValue; input.classList.remove('hidden');
        $('#modalGeneric').classList.add('show'); input.focus(); input.select();
        const okHandler = () => { okCallback(input.value); cleanup(); };
        const cancelHandler = () => cleanup();
        const keyHandler = (e) => { if (e.key === 'Enter') okHandler(); if (e.key === 'Escape') cancelHandler(); };
        $('#btnGenericOk').onclick = okHandler; $('#btnGenericCancel').onclick = cancelHandler; input.onkeydown = keyHandler;
        function cleanup() { $('#modalGeneric').classList.remove('show'); $('#btnGenericOk').onclick = null; $('#btnGenericCancel').onclick = null; input.onkeydown = null; }
    }
    function showConfirmModal(title, message, okCallback) {
        $('#genericTitle').textContent = title;
        const msgEl = $('#genericMessage'); msgEl.textContent = message; msgEl.classList.remove('hidden');
        $('#genericInput').classList.add('hidden'); $('#modalGeneric').classList.add('show');
        const okHandler = () => { okCallback(true); cleanup(); };
        const cancelHandler = () => { okCallback(false); cleanup(); };
        $('#btnGenericOk').onclick = okHandler; $('#btnGenericCancel').onclick = cancelHandler;
        function cleanup() { $('#modalGeneric').classList.remove('show'); $('#btnGenericOk').onclick = null; $('#btnGenericCancel').onclick = null; }
    }
    async function switchView(viewId) {
        $$('.view').forEach(v => v.classList.remove('active'));
        $(`#view-${viewId}`).classList.add('active');
        $$('.nav-btn').forEach(b => b.classList.remove('active'));
        const navBtn = $(`.nav-btn[data-view="${viewId}"]`);
        if (navBtn) navBtn.classList.add('active');
        data.settings.currentView = viewId;
        await saveData();
        if (viewId === 'stats') {
            renderDashboard();
        }
    }
    function closeAllMenus() {
        $$('.actions-menu.show').forEach(menu => menu.classList.remove('show'));
    }
    function renderTopics(){
      const wrap = $('#topicsList');
      if (!wrap) return;
      wrap.innerHTML='';
      const collapsedMap = data.settings.collapsedTopics || {};
      data.topics.forEach(topic => {
        const box = document.createElement('div');
        box.className='topic-item';
        box.dataset.tid = topic.id;
        const header = document.createElement('div');
        header.className='topic-header';
        const isCollapsed = !!collapsedMap[topic.id];
        const chev = document.createElement('button');
        chev.className='btn small ghost chev';
        chev.setAttribute('title','M·ªü/ƒë√≥ng subtopics');
        chev.setAttribute('aria-expanded', String(!isCollapsed));
        chev.innerHTML = '<span class="ico">‚ñº</span>';
        const title = document.createElement('div');
        title.className='topic-title';
        title.textContent = topic.name;
        const act = document.createElement('div');
        act.className='topic-actions';
        const bAdd = document.createElement('button');
        bAdd.className='btn small';
        bAdd.innerHTML = 'Ôºã Th√™m';
        bAdd.title = 'Th√™m Ch·ªß ƒë·ªÅ con';
        const menuContainer = document.createElement('div');
        menuContainer.style.position = 'relative';
        const bMore = document.createElement('button');
        bMore.className = 'btn small ghost actions-menu-btn';
        bMore.innerHTML = '...';
        bMore.title = 'Th√™m t√πy ch·ªçn';
        const menu = document.createElement('div');
        menu.className = 'actions-menu';
        const bEdit = document.createElement('button');
        bEdit.className = 'menu-item';
        bEdit.innerHTML = 'S·ª≠a t√™n Ch·ªß ƒë·ªÅ';
        const bDel = document.createElement('button');
        bDel.className = 'menu-item danger';
        bDel.innerHTML = 'X√≥a Ch·ªß ƒë·ªÅ';
        menu.append(bEdit, bDel);
        menuContainer.append(bMore, menu);
        act.append(bAdd, menuContainer);
        header.append(chev, title, act);
        const subs = document.createElement('div');
        subs.className='subtopics' + (isCollapsed? ' hidden':'');
        subs.dataset.tid = topic.id;
        topic.subtopics.forEach(st => {
          const row = document.createElement('div');
          row.className='sub-row';
          row.dataset.sid = st.id;
          const btn = document.createElement('button');
          btn.className='btn subtopic-btn';
          btn.textContent = '‚Ä¢ '+st.name;
          btn.dataset.sid = st.id;
          btn.dataset.tid = topic.id;
          if(data.settings.selectedSubtopicId===st.id) btn.classList.add('active');
          const subActions = document.createElement('div');
          subActions.className = 'actions';
          const subMenuContainer = document.createElement('div');
          subMenuContainer.style.position = 'relative';
          const subBMore = document.createElement('button');
          subBMore.className = 'btn small ghost actions-menu-btn';
          subBMore.innerHTML = '...';
          subBMore.title = 'Th√™m t√πy ch·ªçn';
          const subMenu = document.createElement('div');
          subMenu.className = 'actions-menu';
          const subBEdit = document.createElement('button');
          subBEdit.className = 'menu-item';
          subBEdit.innerHTML = 'S·ª≠a t√™n Ch·ªß ƒë·ªÅ con';
          const subBDel = document.createElement('button');
          subBDel.className = 'menu-item danger';
          subBDel.innerHTML = 'X√≥a Ch·ªß ƒë·ªÅ con';
          subMenu.append(subBEdit, subBDel);
          subMenuContainer.append(subBMore, subMenu);
          subActions.append(subMenuContainer);
          row.append(btn, subActions);
          subs.appendChild(row);
          btn.addEventListener('click', ()=> selectSubtopic(topic.id, st.id));
          subBMore.addEventListener('click', (e) => { e.stopPropagation(); closeAllMenus(); subMenu.classList.toggle('show'); });
          subBEdit.addEventListener('click', ()=> showInputModal('ƒê·ªïi t√™n Ch·ªß ƒë·ªÅ con', async (newName) => { if(!newName) return; st.name=newName; await storageManager.update('subtopics', st); renderAll(); }, st.name));
          subBDel.addEventListener('click', ()=> showConfirmModal('X√°c nh·∫≠n x√≥a', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Ch·ªß ƒë·ªÅ con "${st.name}"? M·ªçi d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã m·∫•t.`, async (ok) => { if(!ok) return; topic.subtopics = topic.subtopics.filter(x=>x.id!==st.id); const set=data.settings; if(set.selectedSubtopicId===st.id){ set.selectedSubtopicId=''; set.selectedTopicId=''; ensureValidSelection(); } await storageManager.delete('subtopics', st.id); renderAll(); }));
        });
        chev.addEventListener('click', async ()=>{ if(isCollapsed){ delete collapsedMap[topic.id]; } else { collapsedMap[topic.id] = true; } data.settings.collapsedTopics = collapsedMap; await storageManager.updateSettings(data.settings); renderTopics(); });
        bMore.addEventListener('click', (e) => { e.stopPropagation(); closeAllMenus(); menu.classList.toggle('show'); });
        bAdd.addEventListener('click', ()=> showInputModal('T√™n Ch·ªß ƒë·ªÅ con m·ªõi?', async (name) => { if(!name) return; const newSub = { id: uid('s'), topicId: topic.id, name, tasks: [], generalNotes: [], summaries: [], chatHistory: [], stats:{ totalMinutes:0, sessionsCompleted:0, tasksCompleted: 0 }, sessions: [], timerState: { state: 'idle', prevState: null, remaining: 0, segmentTotal: 0, cycleIndex: 0 } }; topic.subtopics.push(newSub); await storageManager.add('subtopics', newSub); renderTopics(); }));
        bEdit.addEventListener('click', ()=> showInputModal('ƒê·ªïi t√™n Ch·ªß ƒë·ªÅ', async (newName) => { if(!newName) return; topic.name=newName; await storageManager.update('topics', topic); renderTopics(); }, topic.name));
        bDel.addEventListener('click', ()=> showConfirmModal('X√°c nh·∫≠n x√≥a', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Ch·ªß ƒë·ªÅ "${topic.name}"? M·ªçi ch·ªß ƒë·ªÅ con v√† d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã m·∫•t.`, async (ok) => { if(!ok) return; data.topics = data.topics.filter(t=>t.id!==topic.id); delete collapsedMap[topic.id]; if(data.settings.selectedTopicId===topic.id){ data.settings.selectedTopicId=''; data.settings.selectedSubtopicId=''; ensureValidSelection(); } await storageManager.delete('topics', topic.id); for(const sub of topic.subtopics){ await storageManager.delete('subtopics', sub.id); } renderAll(); }));
        box.append(header, subs);
        wrap.appendChild(box);
      });
      if (window.Sortable) {
        const topicsListEl = document.getElementById('topicsList');
        if (topicsListEl) {
          if (topicsListEl._sortable) { try { topicsListEl._sortable.destroy(); } catch (e) {} }
          topicsListEl._sortable = new Sortable(topicsListEl, {
            animation: 150,
            draggable: '.topic-item',
            onEnd: async function (evt) {
              if (evt.oldIndex === evt.newIndex) return;
              const moved = data.topics.splice(evt.oldIndex, 1)[0];
              data.topics.splice(evt.newIndex, 0, moved);
              await saveData();
              renderTopics();
            }
          });
          topicsListEl.querySelectorAll('.subtopics').forEach(subsEl => {
            new Sortable(subsEl, {
              group: 'subtopics-group',
              animation: 150,
              draggable: '.sub-row',
              onEnd: async function (evt) {
                const fromTopicId = evt.from?.dataset?.tid || evt.from?.closest('.topic-item')?.dataset?.tid;
                const toTopicId = evt.to?.dataset?.tid || evt.to?.closest('.topic-item')?.dataset?.tid;
                const fromTopic = data.topics.find(t => t.id === fromTopicId);
                const toTopic = data.topics.find(t => t.id === toTopicId);
                if (!fromTopic || !toTopic) return;
                let movedSubtopic = null;
                const movedSid = evt.item?.dataset?.sid || evt.item?.querySelector('.subtopic-btn')?.dataset?.sid;
                if (movedSid) {
                  const idx = fromTopic.subtopics.findIndex(s => s.id === movedSid);
                  if (idx >= 0) movedSubtopic = fromTopic.subtopics.splice(idx, 1)[0];
                }
                if (!movedSubtopic) {
                  movedSubtopic = fromTopic.subtopics.splice(evt.oldIndex, 1)[0];
                }
                if (!movedSubtopic) return;
                movedSubtopic.topicId = toTopic.id;
                toTopic.subtopics.splice(evt.newIndex, 0, movedSubtopic);
                if (data.settings.selectedSubtopicId === movedSubtopic.id) {
                  data.settings.selectedTopicId = toTopic.id;
                }
                await saveData();
                renderTopics();
              }
            });
          });
        }
      }
    }
    function selectSubtopic(topicId, subId) {
        const mainEl = $('.app-content');
        const oldSubtopic = getCurrentSubtopic();
        if (oldSubtopic && timer.state !== 'idle') {
            oldSubtopic.timerState = {
                state: timer.state,
                prevState: timer.prevState,
                remaining: timer.remaining,
                segmentTotal: timer.segmentTotal,
                cycleIndex: timer.cycleIndex
            };
        }
        mainEl.classList.add('reloading');
        setTimeout(async () => {
            data.settings.selectedTopicId = topicId;
            data.settings.selectedSubtopicId = subId;
            const newSubtopic = getCurrentSubtopic();
            if (newSubtopic.timerState) {
                timer.state = newSubtopic.timerState.state;
                timer.prevState = newSubtopic.timerState.prevState || null;
                timer.remaining = newSubtopic.timerState.remaining;
                timer.segmentTotal = newSubtopic.timerState.segmentTotal;
                timer.cycleIndex = newSubtopic.timerState.cycleIndex;
            } else {
                timer.reset();
            }
            await saveData();
            timer.updateUI();
            renderAll();
            switchView('timer');
            mainEl.classList.remove('reloading');
        }, 200);
    }
    function getCurrentSubtopic(){ const tid=data.settings.selectedTopicId, sid=data.settings.selectedSubtopicId; if(!tid||!sid) return null; const t=data.topics.find(x=>x.id===tid); if(!t) return null; return t.subtopics.find(x=>x.id===sid) || null; }
    function renderContextBadge(){
      const s=getCurrentSubtopic();
      const name = s ? s.name : '(ch∆∞a ch·ªçn)';
      const selectedContext = $('#selectedContext');
      const currentName = $('#currentSubtopicName');
      const currentChatName = $('#currentSubtopicNameChat');
      if (selectedContext) selectedContext.textContent = s? `Ch·ªß ƒë·ªÅ con: ${s.name}`:'Ch∆∞a ch·ªçn Ch·ªß ƒë·ªÅ con';
      if (currentName) currentName.textContent = name;
      if (currentChatName) currentChatName.textContent = name;
    }
    function renderSubtopicTasks() {
        const s = getCurrentSubtopic();
        const listEl = $('#subtopicTasksList');
        const inputEl = $('#newSubtopicTaskInput');
        if (!listEl || !inputEl) return;
        const addArea = inputEl.parentElement;
        if (!s) {
            listEl.innerHTML = '<li class="tiny" style="opacity: 0.7;">Ch·ªçn ch·ªß ƒë·ªÅ con ƒë·ªÉ xem to-do list.</li>';
            addArea.classList.add('hidden'); return;
        }
        addArea.classList.remove('hidden');
        listEl.innerHTML = '';
        const uncompletedTasks = s.tasks ? s.tasks.filter(t => !t.isCompleted) : [];

        if (uncompletedTasks.length === 0) {
            listEl.innerHTML = '<li class="tiny" style="opacity: 0.7;">Tuy·ªát v·ªùi! Kh√¥ng c√≤n task n√†o.</li>';
        }
        uncompletedTasks.forEach(task => {
            const item = document.createElement('li');
            item.innerHTML = `<input type="checkbox" id="${task.id}" title="Ho√†n th√†nh task"> <label for="${task.id}">${escapeHTML(task.text)}</label>`;
            item.querySelector('input').addEventListener('change', (e) => toggleSubtopicTask(e.target.id, item));
            listEl.appendChild(item);
        });
    }
    async function addSubtopicTask() {
        const s = getCurrentSubtopic();
        if (!s) { toast(t('timer.selectSubtopicPrompt')); return; }
        const input = $('#newSubtopicTaskInput');
        const text = input.value.trim();
        if (text) {
            if (!s.tasks) s.tasks = [];
            s.tasks.push({ id: uid('task'), text, isCompleted: false, createdAt: todayISO() });
            await saveData();
            renderSubtopicTasks();
            input.value = '';
        }
        input.focus();
    }
    async function toggleSubtopicTask(taskId, listItemElement) {
        const s = getCurrentSubtopic();
        if (!s || !s.tasks) return;
        const task = s.tasks.find(t => t.id === taskId);
        if (task) {
            task.isCompleted = true;
            s.stats.tasksCompleted = (s.stats.tasksCompleted || 0) + 1;
            await saveData();
            listItemElement.classList.add('removing');
            setTimeout(() => {
                renderSubtopicTasks();
                renderStatsHistory();
            }, 200);
        }
    }
    const timer = {
      state:'idle', prevState:null, tickHandle:null, endAt:null,
      remaining:0, segmentTotal:0, cyclesTarget:4, cycleIndex:0, mode:'A',
      persistInterval: 60*1000,
      lastPersist: 0,
      async setPreset(p, {silent=false}={}){
        const st = data.settings;
        this.mode = p;
        this.cyclesTarget = (p==='A' ? st.cyclesA : st.cyclesB);
        st.preset = p;
        await saveData();
        if (this.state === 'idle') {
          this.reset();
        }
      },
      currentDurations(){ const d=data.settings.durations; return this.mode==='A'? {work:d.A_work, short:d.A_short, long:d.A_long} : {work:d.B_work, short:d.B_short, long:d.B_long}; },
      currentConfig(){ const s=data.settings; return this.mode==='A'? {cycles:s.cyclesA, interval:s.longBreakIntervalA} : {cycles:s.cyclesB, interval:s.longBreakIntervalB}; },
      updateUI() {
        const badge = $('#stateBadge');
        const progressCircle = $('.timer-circle-progress');
        const container = $('.timer-circle-container');
        if (!badge || !progressCircle || !container) return;
        $('#btnStart').classList.toggle('hidden', this.state !== 'idle');
        $('#btnPause').classList.toggle('hidden', !['work', 'break', 'long_break'].includes(this.state));
        $('#btnResume').classList.toggle('hidden', this.state !== 'paused');
        let currentColor = 'var(--muted)';
        if (this.state === 'work') { badge.textContent = 'L√ÄM VI·ªÜC'; badge.className = 'badge state work'; currentColor = 'var(--acc)'; }
        else if (this.state === 'break') { badge.textContent = 'NGH·ªà NG·∫ÆN'; badge.className = 'badge state break'; currentColor = 'var(--warn)'; }
        else if (this.state === 'long_break') { badge.textContent = 'NGH·ªà D√ÄI'; badge.className = 'badge state long'; currentColor = 'var(--danger)'; }
        else if (this.state === 'paused') { badge.textContent = 'T·∫†M D·ª™NG'; badge.className = 'badge'; }
        else { badge.textContent = 'S·∫¥N S√ÄNG'; badge.className = 'badge'; }
        if (['work','break','long_break'].includes(this.state)) { container.classList.add('breathing'); } else { container.classList.remove('breathing'); }
        progressCircle.style.stroke = currentColor; container.classList.remove('finished');
        const timeEl = $('#timeDisplay'); if (timeEl) timeEl.textContent = formatMMSS(this.remaining);
        const radius = progressCircle.r.baseVal.value; const circumference = 2 * Math.PI * radius;
        const offset = this.segmentTotal>0 ? (circumference - (this.remaining / this.segmentTotal) * circumference) : circumference;
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = isNaN(offset) ? circumference : offset;
        const cyc = $('#cycleInfo'); if (cyc) { const cfg=this.currentConfig(); cyc.textContent = t('timer.cycleInfo', { current: this.cycleIndex, target: cfg.cycles }); }
        const draggableTimer = $('#draggableTimer'); if (draggableTimer) draggableTimer.textContent = formatMMSS(this.remaining);
      },
      persistTimerState(force=false){
        try{
          const s = getCurrentSubtopic(); if(!s) return;
          const state = { state:this.state, prevState:this.prevState, remaining:this.remaining, segmentTotal:this.segmentTotal, cycleIndex:this.cycleIndex };
          s.timerState = state; try{ localStorage.setItem('timerState_'+s.id, JSON.stringify(state)); }catch(_){ }
          this.lastPersist = Date.now();
        }catch(_){ }
      },
      _startTick(){ if(this.tickHandle) clearInterval(this.tickHandle); this.tickHandle = setInterval(()=>{ if(this.remaining>0){ this.remaining -= 1; this.updateUI(); this.persistTimerState(); } if(this.remaining<=0){ clearInterval(this.tickHandle); this.tickHandle=null; this._onFinishSegment(); } }, 1000); },
      _onFinishSegment(){
        if (this.state === 'work') {
            const s = getCurrentSubtopic();
            if (s) {
                const duration = this.currentDurations().work;
                s.stats.totalMinutes = (s.stats.totalMinutes || 0) + duration;
                s.stats.sessionsCompleted = (s.stats.sessionsCompleted || 0) + 1;
                const newSession = {
                    id: uid('sess'),
                    dateISO: todayISO(),
                    durationMinutes: duration,
                    mode: this.mode,
                    note: ''
                };
                if (!s.sessions) s.sessions = [];
                s.sessions.unshift(newSession);
                saveData();
                renderStatsHistory();
                checkAndShowMilestones();
            }
            this.cycleIndex++;
        }
        playSound(this.state === 'work' ? 'work_end' : 'break_end');
        const container = $('.timer-circle-container');
        if(container) container.classList.add('finished');
        if (data.settings.autoStartNext) {
          if(this.state==='work'){
            this.beginBreak();
          } else {
            this.beginWork();
          }
        } else {
          if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; }
          this.state = 'idle';
          this.prevState = null;
          this.updateUI();
          toast("Phi√™n ƒë√£ ho√†n th√†nh! Nh·∫•n B·∫Øt ƒë·∫ßu ƒë·ªÉ b·∫Øt ƒë·∫ßu phi√™n ti·∫øp theo.");
        }
      },
      beginWork(){ this.prevState=this.state; this.state='work'; const d=this.currentDurations().work*60; this.segmentTotal=d; if(this.prevState!=='paused') this.remaining=d; this._startTick(); this.updateUI(); },
      beginBreak() {
        this.prevState = this.state;
        const config = this.currentConfig();
        const durations = this.currentDurations();
        if (this.cycleIndex > 0 && this.cycleIndex % config.interval === 0) {
          this.state = 'long_break';
          const d = durations.long * 60;
          this.segmentTotal = d;
          if (this.prevState !== 'paused') this.remaining = d;
          toast(`Tuy·ªát v·ªùi! ƒê√£ ƒë·∫øn l√∫c ngh·ªâ d√†i.`);
        } else {
          this.state = 'break';
          const d = durations.short * 60;
          this.segmentTotal = d;
          if (this.prevState !== 'paused') this.remaining = d;
        }
        this._startTick();
        this.updateUI();
      },
      async start(){ if(!getCurrentSubtopic()){ toast('H√£y ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu'); return; } ensureAudio(); if(this.state==='idle'){ this.cycleIndex = this.cycleIndex || 0; this.beginWork(); } else if(this.state==='paused'){ this.resume(); } await this.persistTimerState(true); },
      async pause(){ if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; } this.prevState=this.state; this.state='paused'; this.updateUI(); await this.persistTimerState(true); },
      async resume(){ if(this.state!=='paused'){ return; } this.state=this.prevState||'work'; this._startTick(); this.updateUI(); await this.persistTimerState(true); },
      async skip(){ this.remaining=0; if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; } this._onFinishSegment(); await this.persistTimerState(true); },
      async reset(){ if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; } this.state='idle'; this.prevState=null; this.remaining=0; this.segmentTotal=0; this.cycleIndex=0; this.updateUI(); await this.persistTimerState(true); }
    };
    async function deleteSummary(id) {
        showConfirmModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√≥m t·∫Øt n√†y?', async (ok) => {
            if (!ok) return;
            const s = getCurrentSubtopic();
            if (!s || !s.summaries) return;
            const original = [...s.summaries];
            s.summaries = s.summaries.filter(x => x.id !== id);
            try {
                await storageManager.update('subtopics', s);
                renderSummaries();
                toast('ƒê√£ x√≥a t√≥m t·∫Øt.');
            } catch (err) {
                console.error('Failed to delete summary:', err);
                s.summaries = original;
                toast('Kh√¥ng th·ªÉ l∆∞u thay ƒë·ªïi.');
            }
        });
    }
function exportSummary(sum) {
        const blob = new Blob([sum.content], { type: 'text/plain' });
        const a = document.createElement('a');
        const ts = new Date(sum.createdAt);
        const pad = n => `${n}`.padStart(2, '0');
        a.href = URL.createObjectURL(blob);
        a.download = `summary_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}.txt`;
        a.click();
        URL.revokeObjectURL(a.href);
}
    function renderStatsHistory(){
        const s = getCurrentSubtopic();
        const statTotal = $('#statTotal');
        const statSessions = $('#statSessions');
        const statTasks = $('#statTasks');
        const list = $('#historyList');
        if (!statTotal || !statSessions || !statTasks || !list) return;

        if (!s) {
            statTotal.textContent = '0 ph√∫t';
            statSessions.textContent = '0';
            statTasks.textContent = '0';
            list.innerHTML = '<div class="tiny">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
            return;
        }

        const total = (s.stats && s.stats.totalMinutes) ? s.stats.totalMinutes : 0;
        const count = (s.stats && s.stats.sessionsCompleted) ? s.stats.sessionsCompleted : 0;
        const tasksDone = s.tasks ? s.tasks.filter(t => t.isCompleted).length : 0;

        statTotal.textContent = formatDaysHoursMinutes(total);
        statSessions.textContent = String(count);
        statTasks.textContent = String(tasksDone);

        list.innerHTML = '';
        const sessions = Array.isArray(s.sessions) ? s.sessions : [];
        if (sessions.length === 0) {
            list.innerHTML = '<div class="tiny">Ch∆∞a c√≥ phi√™n n√†o</div>';
            return;
        }
        sessions.forEach(sess => {
            const row = document.createElement('div');
            row.className = 'hist-item';
            const content = document.createElement('div');
            const date = sess.dateISO ? new Date(sess.dateISO) : new Date();
            const dur = (sess.durationMinutes != null) ? sess.durationMinutes : (sess.workMinutes || 0);
            content.innerHTML = `<div class="hist-meta">${date.toLocaleString()} ¬∑ ${dur}' ¬∑ Mode ${sess.mode || ''}</div>` +
                                `<div>${sess.note ? escapeHTML(sess.note) : '<span class="tiny">(ch∆∞a c√≥ ghi ch√∫)</span>'}</div>`;
            row.appendChild(content);
            list.appendChild(row);
        });
    }
    function renderGeneralNotes(){
        const listEl = $('#generalNotesList');
        if (!listEl) return;
        const s = getCurrentSubtopic();
        if (!s) { listEl.innerHTML = '<div class="tiny">Vui l√≤ng ch·ªçn m·ªôt ch·ªß ƒë·ªÅ con.</div>'; return; }
        s.generalNotes = s.generalNotes || [];
        if (s.generalNotes.length === 0) { listEl.innerHTML = '<div class="tiny">Ch∆∞a c√≥ ghi ch√∫.</div>'; return; }
        listEl.innerHTML = '';
        s.generalNotes.forEach(note => {
            const item = document.createElement('div'); item.className = 'note-item';
            const content = document.createElement('div'); content.className = 'note-content'; content.textContent = typeof note === 'string' ? note : (note.text || '');
            const meta = document.createElement('div'); meta.className = 'note-meta'; meta.textContent = note.createdAt ? new Date(note.createdAt).toLocaleString() : '';
            const actions = document.createElement('div');
            const delBtn = document.createElement('button'); delBtn.className = 'btn small danger'; delBtn.textContent = 'X√≥a';
            delBtn.onclick = async (e)=>{
                e.stopPropagation();
                const s2 = getCurrentSubtopic(); if (!s2) return;
                s2.generalNotes = (s2.generalNotes || []).filter(x => (x.id || x) !== (note.id || note));
                await saveData();
                renderGeneralNotes();
            };
            actions.appendChild(delBtn);
            const wrap = document.createElement('div'); wrap.className = 'note-content-wrapper'; wrap.append(content, meta);
            item.append(wrap, actions);
            listEl.appendChild(item);
        });
    }
    function addGeneralNote(){
        showInputModal('Th√™m ghi ch√∫', async (text) => {
            if (!text) return;
            const s = getCurrentSubtopic();
        if (!s) { toast('Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ con tr∆∞·ªõc.'); return; }
            s.generalNotes = s.generalNotes || [];
            s.generalNotes.unshift({ id: uid('gn'), text, createdAt: todayISO() });
            await saveData();
            renderGeneralNotes();
        }, '');
    }
    async function summarizeNotes(){
        const s = getCurrentSubtopic();
        if (!s) { toast('Ch·ªçn ch·ªß ƒë·ªÅ con tr∆∞·ªõc.'); return; }
        const notes = (s.generalNotes || []).map(n => (typeof n === 'string' ? n : (n.text||''))).filter(Boolean);
        if (notes.length === 0) { toast('Ch∆∞a c√≥ ghi ch√∫ ƒë·ªÉ t√≥m t·∫Øt.'); return; }
        const btn = $('#btnSummarize');
        if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div>'; }
        try {
            const prompt = `T√≥m t·∫Øt c√°c ghi ch√∫ sau theo g·∫°ch ƒë·∫ßu d√≤ng, ng·∫Øn g·ªçn, r√µ r√†ng:\n\n${notes.join('\n- ')}`;
            const result = await callGeminiAPI(prompt);
            if (!s.summaries) s.summaries = [];
            s.summaries.unshift({ id: uid('sum'), content: result || '(Kh√¥ng t·∫°o ƒë∆∞·ª£c t√≥m t·∫Øt)', createdAt: todayISO() });
            await saveData();
            renderSummaries();
        } catch (e) {
            console.error(e);
            toast('T√≥m t·∫Øt th·∫•t b·∫°i.');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'T√≥m t·∫Øt'; }
        }
    }
    function renderSummaries() {
        const listEl = $('#summariesList');
        if (!listEl) return;
        const s = getCurrentSubtopic();
        if (!s) { listEl.innerHTML = '<div class="tiny">Vui l√≤ng ch·ªçn m·ªôt ch·ªß ƒë·ªÅ con ƒë·ªÉ xem t√≥m t·∫Øt.</div>'; return; }
        listEl.innerHTML = '';
        if (!s.summaries || s.summaries.length === 0) { listEl.innerHTML = '<div class="tiny">Ch∆∞a c√≥ t√≥m t·∫Øt n√†o.</div>'; return; }
        s.summaries.forEach(sum => {
            const item = document.createElement('div'); item.className = 'note-item';
            const contentWrapper = document.createElement('div'); contentWrapper.className = 'note-content-wrapper';
            const sumContent = document.createElement('div'); sumContent.className = 'note-content'; sumContent.textContent = sum.content;
            const sumMeta = document.createElement('div'); sumMeta.className = 'note-meta'; sumMeta.textContent = new Date(sum.createdAt).toLocaleString();
            contentWrapper.append(sumContent, sumMeta);
            const actions = document.createElement('div');
            const expBtn = document.createElement('button'); expBtn.className = 'btn small'; expBtn.textContent = 'Xu·∫•t'; expBtn.onclick = (e)=>{ e.stopPropagation(); exportSummary(sum); };
            const delBtn = document.createElement('button'); delBtn.className = 'btn small danger'; delBtn.textContent = 'X√≥a'; delBtn.onclick = (e)=>{ e.stopPropagation(); deleteSummary(sum.id); };
            actions.append(expBtn, delBtn);
            item.append(contentWrapper, actions);
            item.addEventListener('click', ()=> sumContent.classList.toggle('expanded'));
            listEl.appendChild(item);
        });
    }
      function loadEditingPresetFields(){
          const s = data.settings;
          const d = s.durations;
          if(editingPreset === 'A'){
              $('#set_work').value = d.A_work;
              $('#set_short').value = d.A_short;
              $('#set_long').value = d.A_long;
              $('#set_cycles').value = s.cyclesA;
              $('#set_interval').value = s.longBreakIntervalA;
          } else {
              $('#set_work').value = d.B_work;
              $('#set_short').value = d.B_short;
              $('#set_long').value = d.B_long;
              $('#set_cycles').value = s.cyclesB;
              $('#set_interval').value = s.longBreakIntervalB;
          }
      }
      function highlightPresetSelector(){
          $$('#timerPresetSelector button').forEach(btn=>{
              const isActive = btn.dataset.presetTarget === editingPreset;
              btn.classList.toggle('acc', isActive);
              btn.classList.toggle('ghost', !isActive);
          });
      }
      function openSettings(){
          const s = data.settings;
          editingPreset = s.preset;
          $('#set_apiKey').value = s.apiKey || '';
          loadEditingPresetFields();
          highlightPresetSelector();
          $('#set_volume').value=s.volume ?? 0.8;
          $('#set_theme').value=s.soundTheme || 'beep';
          // THAY ƒê·ªîI: C·∫≠p nh·∫≠t gi√° tr·ªã dropdown
          $('#set_theme_color').value = s.theme || 'default';
          const activeUrl = getActiveYoutubeUrl();
          $('#set_youtubeUrl').value = activeUrl || '';
          const initialVideoId = extractYouTubeID(activeUrl);
          $('#btnToggleYtSound').disabled = !initialVideoId;
          if ($('#ytUrlFeedback')) {
              $('#ytUrlFeedback').textContent = '';
          }
          $('#ytSoundVolume').value = s.youtubeVolume || 80;
          $('#set_ytThumbAsBg').checked = !!s.useYtThumbnailAsBg;
          $('#set_panelOpacity').value = s.panelOpacity || 0.85;
          if ($('#set_autoStartNext')) { $('#set_autoStartNext').checked = !!s.autoStartNext; }
          if ($('#set_backupDays')) { $('#set_backupDays').value = s.backupDaysToKeep || 7; }
        const backupListEl = $('#backupList');
        if (backupListEl) {
            storageManager.getBackupList().then(backups => {
                backupListEl.innerHTML = '<option value="">-- Ch·ªçn ng√†y ƒë·ªÉ ph·ª•c h·ªìi --</option>';
                if (backups && backups.length > 0) {
                    backups.forEach(backup => {
                        const option = document.createElement('option');
                        option.value = backup.date;
                        option.textContent = `B·∫£n sao l∆∞u ng√†y: ${new Date(backup.date).toLocaleDateString('vi-VN')}`;
                        backupListEl.appendChild(option);
                    });
                } else {
                    backupListEl.innerHTML = '<option value="">Kh√¥ng c√≥ b·∫£n sao l∆∞u n√†o</option>';
                }
            });
        }
        $('#modalSettings').classList.add('show');
    }
    function closeSettings(){ $('#modalSettings').classList.remove('show'); }
    async function setDefaults(){
        data.settings.durations={A_work:25,A_short:5,A_long:15,B_work:50,B_short:10,B_long:30};
        data.settings.cyclesA=4;
        data.settings.longBreakIntervalA=4;
        data.settings.cyclesB=4;
        data.settings.longBreakIntervalB=4;
        data.settings.preset='A';
        data.settings.volume=0.8;
        data.settings.soundTheme='beep';
        await saveData(); openSettings(); toast('ƒê√£ kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh'); }
      async function saveSettings(){
          const s = data.settings;
          s.apiKey = $('#set_apiKey').value.trim();
          const d = s.durations;
          if(editingPreset === 'A'){
              d.A_work = clampInt($('#set_work').value,1,999);
              d.A_short = clampInt($('#set_short').value,1,999);
              d.A_long = clampInt($('#set_long').value,1,999);
              s.cyclesA = clampInt($('#set_cycles').value,1,12);
              s.longBreakIntervalA = clampInt($('#set_interval').value,2,12);
          } else {
              d.B_work = clampInt($('#set_work').value,1,999);
              d.B_short = clampInt($('#set_short').value,1,999);
              d.B_long = clampInt($('#set_long').value,1,999);
              s.cyclesB = clampInt($('#set_cycles').value,1,12);
              s.longBreakIntervalB = clampInt($('#set_interval').value,2,12);
          }
          s.volume = clampFloat($('#set_volume').value,0,1,0.8);
          s.soundTheme = $('#set_theme').value==='chime' ? 'chime':'beep';
          // THAY ƒê·ªîI: L∆∞u gi√° tr·ªã theme
          s.theme = $('#set_theme_color').value;
          s.panelOpacity = parseFloat($('#set_panelOpacity').value) || 0.85;
          s.autoStartNext = !!($('#set_autoStartNext') && $('#set_autoStartNext').checked);
          if ($('#set_backupDays')) { s.backupDaysToKeep = clampInt($('#set_backupDays').value, 1, 30); }

          // B·ªï sung: N·∫øu ch·ªçn theme s√°ng, lu√¥n t·∫Øt thumbnail YouTube l√†m n·ªÅn
          if (s.theme === 'light' || s.theme === 'pastel') {
              s.useYtThumbnailAsBg = false;
              // N·∫øu n·ªÅn hi·ªán t·∫°i l√† thumbnail YouTube, b·ªè n·ªÅn ƒë·ªÉ gi·ªØ n·ªÅn g·ªëc c·ªßa theme s√°ng
              if (typeof s.customBg === 'string' && s.customBg.includes('img.youtube.com/vi/')) {
                  s.customBg = '';
              }
          } else {
              // Ng∆∞·ª£c l·∫°i, v·ªõi theme t·ªëi th√¨ b·∫≠t d√πng thumbnail YouTube (n·∫øu c√≥ link)
              s.useYtThumbnailAsBg = true;
          }

          const newYtUrl = $('#set_youtubeUrl').value.trim();
          s.useYtThumbnailAsBg = $('#set_ytThumbAsBg').checked;
          s.youtubeVolume = parseInt($('#ytSoundVolume').value, 10);
          sessionYoutubeUrl = newYtUrl;
          updateYouTubePlayer(); 

          await saveData();
          applyTheme();
          applyCustomBg();
          applyPanelOpacity();
          updatePresetButtonsText();
          timer.setPreset(s.preset, {silent:true});

          closeSettings();
          toast('ƒê√£ l∆∞u c√†i ƒë·∫∑t');
      }
    function clampInt(v,min,max){ v=parseInt(v||0,10); if(isNaN(v)) v=min; return Math.max(min, Math.min(max, v)); }
    function clampFloat(v,min,max,def){ v=parseFloat(v); if(Number.isNaN(v)) v=def; return Math.max(min, Math.min(max, v)); }
    const dbPromise = new Promise((resolve, reject) => {
        const req = indexedDB.open('pomodoro_files', 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore('files');
        req.onsuccess = (e) => resolve(e.target.result);
        req.onerror = (e) => reject(e);
    });
    const fileCache = {};
    function handleFileUpload(file, callback) {
        if (!file) return;
        dbPromise.then(db => {
            const id = uid('file');
            const tx = db.transaction('files', 'readwrite');
            tx.objectStore('files').put(file, id);
            tx.oncomplete = () => callback(id);
            tx.onerror = () => toast("L·ªói l∆∞u file.");
        });
    }
    function getStoredFileUrl(id){
        if (!id) return Promise.resolve('');
        if (fileCache[id]) return Promise.resolve(fileCache[id]);
        return dbPromise.then(db => new Promise((resolve) => {
            const tx = db.transaction('files', 'readonly');
            const req = tx.objectStore('files').get(id);
            req.onsuccess = (e) => {
                const file = e.target.result;
                if (file) {
                    const url = URL.createObjectURL(file);
                    fileCache[id] = url;
                    resolve(url);
                } else resolve('');
            };
            req.onerror = () => resolve('');
        }));
    }
    function applyCustomBg() {
        const ref = data.settings.customBg;
        const theme = data.settings.theme;
        const themeHasBg = ['lofi', 'space'].includes(theme);
        const isLightTheme = (theme === 'light' || theme === 'pastel');

        const clearInlineBgFallback = () => { try { document.body.style.backgroundImage = ''; } catch(_) {} };

        if (ref) {
            const urlPromise = (ref.startsWith('data:') || ref.startsWith('http') || ref.startsWith('blob:'))
                ? Promise.resolve(ref)
                : getStoredFileUrl(ref);
            
            urlPromise.then(url => {
                if (url) {
                    document.body.style.setProperty('--bg-image', `url(${url})`);
                } else {
                    document.body.style.setProperty('--bg-image', isLightTheme ? 'none' : '');
                }
                clearInlineBgFallback();
            });
        } else if (!themeHasBg) {
            if (isLightTheme) {
                // Light/pastel: kh√¥ng d√πng n·ªÅn t·ªëi
                document.body.style.setProperty('--bg-image', 'none');
                clearInlineBgFallback();
            } else {
                // Dark/default fallback
                document.body.style.setProperty('--bg-image', 'radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%)');
            }
        } else {
            // Let the CSS for the theme handle the background
            document.body.style.removeProperty('--bg-image');
            clearInlineBgFallback();
        }
    }
    function applyPanelOpacity() { document.documentElement.style.setProperty('--panel-opacity', data.settings.panelOpacity); }
      function renderDashboard(){
          const stats = data.topics.flatMap(t => t.subtopics.map(s => ({ topic: t.name, subtopic: s.name, m: s.stats.totalMinutes || 0, c: s.stats.sessionsCompleted || 0, t: s.stats.tasksCompleted || 0 })));
          const totalM = stats.reduce((a, b) => a + b.m, 0);
          const totalC = stats.reduce((a, b) => a + b.c, 0);
          const totalT = stats.reduce((a, b) => a + b.t, 0);

        let tableHTML = `<p class="tiny"><strong>T·ªïng th·ªùi gian:</strong> ${formatDaysHoursMinutes(totalM)} | <strong>T·ªïng phi√™n:</strong> ${totalC} | <strong>T·ªïng nhi·ªám v·ª•:</strong> ${totalT}</p>
        <table class="dashboard-table">
            <thead><tr><th>Ch·ªß ƒë·ªÅ</th><th>Ch·ªß ƒë·ªÅ con</th><th>Th·ªùi gian</th><th>Phi√™n</th><th>Nhi·ªám v·ª•</th></tr></thead>
            <tbody>`;

          stats.forEach(item => {
            tableHTML += `<tr><td>${escapeHTML(item.topic)}</td><td>${escapeHTML(item.subtopic)}</td><td>${formatDaysHoursMinutes(item.m)}</td><td>${item.c}</td><td>${item.t}</td></tr>`;
        });

        tableHTML += '</tbody></table>';
        const contentEl = $('#dashboardContent');
        if (contentEl) contentEl.innerHTML = tableHTML;
    }
    function getMilestones(){
        return [
            { hours: 10000, title: "G·ª≠i b·∫°n, 10.000+ gi·ªù (Ch√¢n S∆∞)", message: "Th·∫≠t vinh d·ª± khi ƒë∆∞·ª£c tr√≤ chuy·ªán c√πng b·∫°n. Kh√¥ng c√≥ nhi·ªÅu ng∆∞·ªùi tr√™n th·∫ø gi·ªõi ƒë·∫°t ƒë·∫øn c·∫•p ƒë·ªô n√†y. B·∫°n kh√¥ng ch·ªâ th√†nh th·∫°o m·ªôt k·ªπ nƒÉng, b·∫°n ƒë√£ ƒë·ªãnh nghƒ©a l·∫°i n√≥. S·ª± n·ªó l·ª±c v√† hy sinh c·ªßa b·∫°n ƒë√£ t·∫°o ra nh·ªØng ƒëi·ªÅu phi th∆∞·ªùng.\nC√≥ l·∫Ω b√¢y gi·ªù b·∫°n kh√¥ng c√≤n nghƒ© v·ªÅ vi·ªác h·ªçc k·ªπ nƒÉng n·ªØa, m√† l√† v·ªÅ vi·ªác ƒë·ªÉ l·∫°i di s·∫£n. B·∫°n s·∫Ω truy·ªÅn l·∫°i ng·ªçn ƒëu·ªëc n√†y nh∆∞ th·∫ø n√†o? B·∫°n s·∫Ω ph√° v·ª° nh·ªØng gi·ªõi h·∫°n n√†o ti·∫øp theo m√† ch∆∞a ai t·ª´ng nghƒ© t·ªõi? Th·∫ø gi·ªõi ƒëang d√µi theo nh·ªØng g√¨ b·∫°n l√†m, kh√¥ng ph·∫£i ƒë·ªÉ h·ªçc theo m·ªôt c√¥ng th·ª©c, m√† ƒë·ªÉ ƒë∆∞·ª£c truy·ªÅn c·∫£m h·ª©ng t·ª´ ch√≠nh h√†nh tr√¨nh v√† s·ª± s√°ng t·∫°o c·ªßa b·∫°n.\nC·∫£m ∆°n b·∫°n v√¨ ƒë√£ cho ch√∫ng t√¥i th·∫•y nh·ªØng gi·ªõi h·∫°n c·ªßa con ng∆∞·ªùi c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·∫©y xa ƒë·∫øn nh∆∞·ªùng n√†o." },
            { hours: 5000, title: "G·ª≠i b·∫°n, 5.000 gi·ªù (Tinh Th√¥ng)", message: "S·ª± c·ªëng hi·∫øn c·ªßa b·∫°n th·∫≠t ƒë√°ng kinh ng·∫°c. B·∫°n ƒë√£ tr·ªü th√†nh m·ªôt chuy√™n gia, m·ªôt ng∆∞·ªùi m√† ng∆∞·ªùi kh√°c t√¨m ƒë·∫øn ƒë·ªÉ h·ªçc h·ªèi v√† xin l·ªùi khuy√™n. K·ªπ nƒÉng c·ªßa b·∫°n kh√¥ng ch·ªâ l√† m·ªôt c√¥ng c·ª•, n√≥ ƒë√£ tr·ªü th√†nh m·ªôt ph·∫ßn con ng∆∞·ªùi b·∫°n.\nL·ªùi nh·∫Øn c·ªßa t√¥i d√†nh cho b·∫°n l√†: H√£y lu√¥n gi·ªØ cho m√¨nh \"t√¢m tr√≠ c·ªßa ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu\". ƒê·ª´ng ƒë·ªÉ ki·∫øn th·ª©c s√¢u r·ªông c·ªßa m√¨nh bi·∫øn th√†nh s·ª± t·ª± m√£n. H√£y ti·∫øp t·ª•c h·ªçc h·ªèi t·ª´ nh·ªØng lƒ©nh v·ª±c kh√°c, l·∫Øng nghe nh·ªØng ng∆∞·ªùi m·ªõi v√†o ngh·ªÅ v√† kh√¥ng ng·ª´ng ƒë·∫∑t c√¢u h·ªèi. Gi·ªù ƒë√¢y, vai tr√≤ c·ªßa b·∫°n kh√¥ng ch·ªâ l√† l√†m t·ªët c√¥ng vi·ªác c·ªßa m√¨nh, m√† c√≤n l√† n√¢ng ƒë·ª° v√† truy·ªÅn c·∫£m h·ª©ng cho nh·ªØng ng∆∞·ªùi ƒëi sau." },
            { hours: 1000, title: "G·ª≠i b·∫°n, 1.000 gi·ªù (V·ªØng V√†ng)", message: "B·∫°n kh√¥ng c√≤n l√† ng∆∞·ªùi m·ªõi n·ªØa. B·∫°n ƒë√£ c√≥ nƒÉng l·ª±c, s·ª± t·ª± tin v√† c√≥ th·ªÉ t·∫°o ra nh·ªØng k·∫øt qu·∫£ ƒë√°ng t·ª± h√†o. B·∫°n x·ª©ng ƒë√°ng ƒë∆∞·ª£c c√¥ng nh·∫≠n v√¨ s·ª± ki√™n tr√¨ c·ªßa m√¨nh.\nB√¢y gi·ªù, th·ª≠ th√°ch c·ªßa b·∫°n l√† chuy·ªÉn t·ª´ \"l√†m theo\" sang \"th·∫•u hi·ªÉu\". H√£y t·ª± h·ªèi m√¨nh \"T·∫°i sao n√≥ l·∫°i ho·∫°t ƒë·ªông nh∆∞ v·∫≠y?\". H√£y th·ª≠ d·∫°y l·∫°i cho ng∆∞·ªùi kh√°c, v√¨ ƒë√≥ l√† c√°ch t·ªët nh·∫•t ƒë·ªÉ c·ªßng c·ªë ki·∫øn th·ª©c c·ªßa ch√≠nh m√¨nh. ƒê√¢y l√† l√∫c ƒë·ªÉ tinh ch·ªânh, t·ªëi ∆∞u h√≥a v√† b·∫Øt ƒë·∫ßu h√¨nh th√†nh phong c√°ch ƒë·ªôc ƒë√°o c·ªßa ri√™ng b·∫°n. H√£y bi·∫øn s·ª± th√†nh th·∫°o th√†nh ngh·ªá thu·∫≠t." },
            { hours: 100, title: "G·ª≠i b·∫°n, 100 gi·ªù (ƒê·ªãnh H√¨nh)", message: "B·∫°n ƒë√£ v∆∞·ª£t qua ƒë∆∞·ª£c giai ƒëo·∫°n kh√≥ khƒÉn nh·∫•t v√† gi·ªù ƒë√¢y, k·ªπ nƒÉng n√†y ƒëang th·ª±c s·ª± \"ng·∫•m\" v√†o b·∫°n. Nh·ªØng tia s√°ng c·ªßa s·ª± th√†nh th·∫°o ƒë√£ b·∫Øt ƒë·∫ßu xu·∫•t hi·ªán. Th·∫≠t tuy·ªát v·ªùi!\nƒê√¢y l√† giai ƒëo·∫°n b·∫°n c·∫£m th·∫•y h·ª©ng kh·ªüi nh·∫•t, nh∆∞ng c≈©ng l√† l√∫c d·ªÖ r∆°i v√†o c√°i b·∫´y \"bi·∫øt ƒë·ªß r·ªìi\". ƒê·ª´ng d·ª´ng l·∫°i. H√£y b·∫Øt ƒë·∫ßu kh√°m ph√° s√¢u h∆°n, th·ª≠ nghi·ªám nh·ªØng k·ªπ thu·∫≠t m·ªõi v√† ƒë·ª´ng ng·∫°i ph√° v·ª° c√°c quy t·∫Øc b·∫°n v·ª´a h·ªçc ƒë∆∞·ª£c. H√£y t√¨m m·ªôt c·ªông ƒë·ªìng ho·∫∑c m·ªôt ng∆∞·ªùi h∆∞·ªõng d·∫´n ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi. S·ª± t√≤ m√≤ ch√≠nh l√† nhi√™n li·ªáu t·ªët nh·∫•t ƒë·ªÉ ƒë∆∞a b·∫°n ti·∫øn xa h∆°n. H√£y bi·∫øn k·ªπ nƒÉng n√†y th√†nh c·ªßa ri√™ng b·∫°n." },
            { hours: 20, title: "G·ª≠i b·∫°n, 20 gi·ªù (Khai M·ªü)", message: "Ch√∫c m·ª´ng b·∫°n ƒë√£ l√†m ƒë∆∞·ª£c ƒëi·ªÅu kh√≥ nh·∫•t: B·∫Øt ƒë·∫ßu.\nƒê·ª´ng lo l·∫Øng n·∫øu b√¢y gi·ªù b·∫°n c·∫£m th·∫•y m√¨nh th·∫≠t v·ª•ng v·ªÅ, ch·∫≠m ch·∫°p v√† li√™n t·ª•c m·∫Øc l·ªói. M·ªçi b·∫≠c th·∫ßy ƒë·ªÅu t·ª´ng l√† m·ªôt \"th·∫£m h·ªça\" khi m·ªõi b·∫Øt ƒë·∫ßu. H√£y nh·ªõ r·∫±ng m·ª•c ti√™u c·ªßa b·∫°n l√∫c n√†y kh√¥ng ph·∫£i l√† s·ª± ho√†n h·∫£o, m√† l√† s·ª± hi·ªán di·ªán. M·ªói gi·ªù b·∫°n d√†nh ra ƒë·ªÉ luy·ªán t·∫≠p l√† m·ªôt chi·∫øn th·∫Øng tr∆∞·ªõc s·ª± tr√¨ ho√£n v√† n·ªói s·ª£ th·∫•t b·∫°i.\nH√£y ki√™n nh·∫´n v·ªõi ch√≠nh m√¨nh, t·∫≠n h∆∞·ªüng t·ª´ng ti·∫øn b·ªô nh·ªè nh·∫•t v√† ƒë·ª´ng bao gi·ªù so s√°nh kh·ªüi ƒë·∫ßu c·ªßa m√¨nh v·ªõi \"ƒëo·∫°n gi·ªØa\" c·ªßa ng∆∞·ªùi kh√°c. B·∫°n ƒëang x√¢y d·ª±ng n·ªÅn m√≥ng, v√† m·ªôt n·ªÅn m√≥ng v·ªØng ch·∫Øc c·∫ßn th·ªùi gian. C·ª© ti·∫øp t·ª•c nh√©!" }
        ];
    }
    async function checkAndShowMilestones() {
        if (!data || !data.settings) return;
        if (!Array.isArray(data.settings.achievedMilestones)) data.settings.achievedMilestones = [];
        const totalMinutes = data.topics.reduce((total, topic) => {
            return total + topic.subtopics.reduce((subTotal, subtopic) => {
                return subTotal + (subtopic.stats.totalMinutes || 0);
            }, 0);
        }, 0);
        const totalHours = totalMinutes / 60;
        const milestones = getMilestones();
        const achieved = Array.isArray(data.settings.achievedMilestones) ? data.settings.achievedMilestones : [];
        const eligible = milestones.filter(m => totalHours >= m.hours && !achieved.includes(m.hours));
        if (eligible.length === 0) return false;
        const target = eligible.reduce((best, m) => (best && best.hours > m.hours ? best : m), null);
        if (!target) return false;
        $('#milestoneTitle').textContent = target.title;
        $('#milestoneMessage').textContent = target.message;
        $('#modalMilestone').classList.add('show');
        data.settings.achievedMilestones.push(target.hours);
        await saveData();
        return true;
    }
    async function seedAchievedMilestones() {
        if (!data || !data.settings) return;
        if (!Array.isArray(data.settings.achievedMilestones)) {
            data.settings.achievedMilestones = [];
            await saveData();
        }
    }
    async function handleSendMessage() {
        const btn = $('#btnSendMessage');
        const input = $('#chatInput');
        const query = input.value.trim();
        const subtopic = getCurrentSubtopic();
        if (!query) return;
        if (!subtopic) { toast(t('timer.selectSubtopicPrompt')); return; }
        input.value = '';
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div>';
        subtopic.chatHistory.push({ role: 'user', text: query });
        renderChat();
        const response = await callGeminiAPI(query);
        if (response) {
            subtopic.chatHistory.push({ role: 'model', text: response });
            await saveData();
            renderChat();
        }
        btn.disabled = false;
        btn.innerHTML = 'G·ª≠i';
    }
    function renderChat() {
        const s = getCurrentSubtopic();
        const messagesEl = $('#chatMessages');
        const chatInput = $('#chatInput');
        const sendBtn = $('#btnSendMessage');
        if (!messagesEl || !chatInput || !sendBtn) return;
        if (!s) {
            messagesEl.innerHTML = '<div class="tiny">Ch·ªçn ch·ªß ƒë·ªÅ con ƒë·ªÉ b·∫Øt ƒë·∫ßu chat.</div>';
            chatInput.disabled = true; sendBtn.disabled = true;
            return;
        }
        chatInput.disabled = false; sendBtn.disabled = false;
        messagesEl.innerHTML = '';
        if (!s.chatHistory || s.chatHistory.length === 0) {
            messagesEl.innerHTML = '<div class="tiny">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</div>';
            return;
        }
        s.chatHistory.forEach(msg => {
            const msgEl = document.createElement('div');
            msgEl.className = `chat-msg ${msg.role}`;
            msgEl.textContent = msg.text;
            messagesEl.appendChild(msgEl);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    async function handleSummarizeNote() {
        const btn = $('#btnSummarizeNote');
        const noteTextEl = $('#noteText');
        const noteText = noteTextEl.value.trim();
        const subtopic = getCurrentSubtopic();
        if (!noteText) { toast("Vui l√≤ng nh·∫≠p ghi ch√∫ tr∆∞·ªõc khi t√≥m t·∫Øt."); return; }
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<div class="spinner"></div>'; btn.disabled = true;
        const prompt = `D·ª±a v√†o th√¥ng tin sau:\n- Ch·ªß ƒë·ªÅ: "${subtopic?.name || 'kh√¥ng r√µ'}"\n- Ghi ch√∫ c·ªßa ng∆∞·ªùi d√πng sau m·ªôt phi√™n l√†m vi·ªác: "${noteText}"\n\nH√£y t·∫°o m·ªôt b·∫£n t√≥m t·∫Øt ng·∫Øn g·ªçn v·ªÅ nh·ªØng g√¨ ƒë√£ l√†m v√† ƒë·ªÅ xu·∫•t m·ªôt b∆∞·ªõc h·ª£p l√Ω ti·∫øp theo. ƒê·ªãnh d·∫°ng c√¢u tr·∫£ l·ªùi nh∆∞ sau:\n\n---\n**‚ú® T√≥m t·∫Øt AI:**\n[T√≥m t·∫Øt ·ªü ƒë√¢y]\n\n**üöÄ G·ª£i √Ω ti·∫øp theo:**\n[G·ª£i √Ω ·ªü ƒë√¢y]`;
        const result = await callGeminiAPI(prompt);
        if (result) {
            noteTextEl.value += `\n\n${result}`;
        }
        btn.innerHTML = originalContent; btn.disabled = false;
    }
    function clearChat() {
        const s = getCurrentSubtopic();
        if (!s) { toast(t('timer.selectSubtopicPrompt')); return; }
        showConfirmModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ chat c·ªßa ch·ªß ƒë·ªÅ con n√†y?', async (ok) => {
            if (ok) {
                s.chatHistory = [];
                await saveData();
                renderChat();
                toast("ƒê√£ x√≥a l·ªãch s·ª≠ chat.");
            }
        });
    }
    let ytPlayer;
    let ytUserPaused = false;
    let ytFallbackFrame = null;
    let ytFallbackIsPlaying = false;
    function buildFallbackSrc(videoId, { autoplay=1, mute=1 }={}){
        const params = new URLSearchParams({
            autoplay: String(autoplay),
            mute: String(mute),
            controls: '0',
            playsinline: '1',
            loop: '1',
            playlist: videoId,
            enablejsapi: '1',
            origin: 'https://www.youtube.com'
        }).toString();
        return `https://www.youtube.com/embed/${videoId}?${params}`;
    }
    function ensureFallbackFrame(){
        const cont = document.getElementById('youtube-player-container');
        if (!cont) return null;
        if (ytFallbackFrame && ytFallbackFrame.isConnected) return ytFallbackFrame;
        const ifr = document.createElement('iframe');
        ifr.id = 'yt-fallback';
        ifr.width = '1'; ifr.height = '1';
        ifr.style.position = 'absolute'; ifr.style.top='-9999px'; ifr.style.left='-9999px';
        ifr.allow = 'autoplay; encrypted-media; picture-in-picture';
        cont.innerHTML = '';
        cont.appendChild(ifr);
        ytFallbackFrame = ifr;
        return ifr;
    }
    function fallbackLoadVideo(videoId, {autoplay=1, mute=1}={}){
        const cont = document.getElementById('youtube-player-container');
        if (!cont) return;
        cont.innerHTML = '';
        const ifr = document.createElement('iframe');
        ifr.id = 'yt-fallback';
        ifr.width = '1';
        ifr.height = '1';
        ifr.style.position = 'absolute';
        ifr.style.top='-9999px';
        ifr.style.left='-9999px';
        ifr.allow = 'autoplay; encrypted-media; picture-in-picture';
        ifr.src = buildFallbackSrc(videoId, {autoplay, mute});
        cont.appendChild(ifr);
        ytFallbackFrame = ifr;
        ytFallbackIsPlaying = !!autoplay;
        try { 
            const btn = document.getElementById('btnToggleYtSound'); 
            if (btn) btn.textContent = ytFallbackIsPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'; 
        } catch(_) {}
    }
    function fallbackPostMessage(func, args=[]) {
        try {
            if (!ytFallbackFrame || !ytFallbackFrame.contentWindow) return;
            ytFallbackFrame.contentWindow.postMessage(JSON.stringify({ event:'command', func, args }), 'https://www.youtube.com');
        } catch(_) {}
    }
    function fallbackPlay(){ fallbackPostMessage('playVideo'); }
    function fallbackStop(){
        try {
            if (ytFallbackFrame) {
                ytFallbackFrame.src = 'about:blank';
                ytFallbackIsPlaying = false;
            }
        } catch(_) {}
    }
    function fallbackPause(){ fallbackStop(); }
    function fallbackUnMute(){ fallbackPostMessage('unMute'); }
    function fallbackMute(){ fallbackPostMessage('mute'); }
    window.onYouTubeIframeAPIReady = function() {
        if (IS_FILE_PROTOCOL) {
            try { window.__ytApiWatchdog && window.__ytApiWatchdog.cancel(); } catch(_) {}
            return;
        }
        const opts = {
            height: '1',
            width: '1',
            playerVars: { autoplay: 0, controls: 0, playsinline: 1 },
            events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange },
            host: 'https://www.youtube.com'
        };
        if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
            opts.origin = window.location.origin;
        }
        ytPlayer = new YT.Player('youtube-player-container', opts);
        try { window.__ytApiWatchdog && window.__ytApiWatchdog.cancel(); const fb = document.getElementById('ytUrlFeedback'); if (fb) { fb.textContent=''; } } catch(_) {}
    };

    let _ytPrimed = false;
    let _ytUnlocked = false;
    try { _ytUnlocked = localStorage.getItem('sound_unlocked') === '1'; } catch(_) {}
    function showSoundPermission() {
        const bar = document.getElementById('soundPermissionBar');
        if (!bar) return;
        if (_ytUnlocked) { bar.classList.remove('show'); return; }
        bar.classList.add('show');
    }
    function hideSoundPermission() {
        const bar = document.getElementById('soundPermissionBar');
        if (!bar) return;
        bar.classList.remove('show');
    }
    function unlockAudioChain() {
        try { if (AUDIO_CTX && typeof AUDIO_CTX.resume === 'function') AUDIO_CTX.resume(); } catch(_) {}
        try {
            if (IS_FILE_PROTOCOL) {
                fallbackUnMute();
                fallbackPlay();
            } else if (ytPlayer && ytPlayer.unMute) {
                ytPlayer.unMute();
                ytPlayer.playVideo();
            }
        } catch(_) {}
        _ytUnlocked = true;
        try { localStorage.setItem('sound_unlocked','1'); } catch(_) {}
        hideSoundPermission();
        toast('√Çm thanh ƒë√£ ƒë∆∞·ª£c b·∫≠t!');
    }
    function onPlayerReady(event) {
        try {
            const iframe = ytPlayer && ytPlayer.getIframe ? ytPlayer.getIframe() : null;
            if (iframe) {
                iframe.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture');
            }
        } catch (_) {}
        try { if (ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume((data && data.settings && data.settings.youtubeVolume) || 80); } catch(_) {}
        updateYouTubePlayer();
    }
    function onPlayerStateChange(event) {
        const btn = $('#btnToggleYtSound');
        if (event.data == YT.PlayerState.PLAYING) {
            btn.textContent = '‚è∏Ô∏è';
            hideSoundPermission();
        } else {
            btn.textContent = '‚ñ∂Ô∏è';
        }
        if (event.data === YT.PlayerState.ENDED) {
            if (!ytUserPaused) ytPlayer.playVideo();
        }
    }
    async function ytFadeTo(target, ms=250) {
        try {
            if (!ytPlayer || !ytPlayer.getVolume || !ytPlayer.setVolume) return;
            ytPlayer.unMute();
            const start = ytPlayer.getVolume();
            const diff = target - start;
            if (Math.abs(diff) < 1 || ms <= 0) { ytPlayer.setVolume(target); return; }
            const t0 = performance.now();
            await new Promise(res => {
                const step = (t) => {
                    const p = Math.min(1, (t - t0) / ms);
                    const v = Math.round(start + diff * p);
                    ytPlayer.setVolume(v);
                    if (p < 1) requestAnimationFrame(step); else res();
                };
                requestAnimationFrame(step);
            });
        } catch(_) {}
    }
    async function ytFadeInPlay(ms=220) {
        try {
            const tgt = Math.max(0, Math.min(100, (data && data.settings && data.settings.youtubeVolume) || 80));
            if (!IS_FILE_PROTOCOL) {
                if (!ytPlayer) return;
                ytPlayer.unMute();
                ytPlayer.playVideo();
                try { ytPlayer.setVolume(0); } catch(_) {}
                await ytFadeTo(tgt, ms);
            } else {
                const vid = getActiveVideoId();
                if (vid) { fallbackLoadVideo(vid, {autoplay:1, mute:0}); }
            }
        } catch(_) {}
    }
    async function ytFadeOutPause(ms=180) {
        try {
            const tgt = Math.max(0, Math.min(100, (data && data.settings && data.settings.youtubeVolume) || 80));
            if (!IS_FILE_PROTOCOL) {
                if (!ytPlayer) return;
                await ytFadeTo(0, ms);
                try { ytPlayer.pauseVideo(); ytPlayer.setVolume(tgt); } catch(_) {}
            } else {
                try { fallbackPause(); } catch(_) {}
            }
        } catch(_) {}
    }
    async function updateYouTubePlayer() {
        const videoId = getActiveVideoId();
        if (data.settings.useYtThumbnailAsBg && videoId) {
            const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
            const img = new Image();
            img.onload = async () => { data.settings.customBg = thumbUrl; await saveData(); applyCustomBg(); };
            img.onerror = async () => { const fb = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`; data.settings.customBg = fb; await saveData(); applyCustomBg(); };
            img.src = thumbUrl;
        } else if (!videoId) {
            data.settings.customBg = '';
            await saveData();
            applyCustomBg();
        }
        if (IS_FILE_PROTOCOL) {
            if (!videoId) { 
                fallbackStop();
                hideSoundPermission();
                return;
            }
            const isMuted = _ytUnlocked ? 0 : 1;
            fallbackLoadVideo(videoId, { autoplay: 1, mute: isMuted });
            if (!_ytUnlocked) {
                showSoundPermission();
            }
            return;
        }
        if (!ytPlayer || !ytPlayer.cueVideoById) return;
        if (!videoId) {
            if (ytPlayer.stopVideo) ytPlayer.stopVideo();
            hideSoundPermission();
            return;
        }
        ytPlayer.cueVideoById(videoId);
        ytPlayer.setVolume(data.settings.youtubeVolume);
    }
    function toggleYtSound() {
        if (!_ytUnlocked) {
            try { ensureAudio(); } catch(_) {}
            try { unlockAudioChain(); } catch(_) {}
            return;
        }
        if (IS_FILE_PROTOCOL) {
            const vid = getActiveVideoId();
            if (!ytFallbackFrame || !ytFallbackFrame.isConnected) {
                if (!vid) { toast('Ch∆∞a c√≥ link h·ª£p l·ªá. D√°n link r·ªìi b·∫•m ‚ñ∂Ô∏è.'); return; }
                fallbackLoadVideo(vid, { autoplay: 1, mute: 0 });
                ytFallbackIsPlaying = true;
                try { const btn = document.getElementById('btnToggleYtSound'); if (btn) btn.textContent = '‚è∏Ô∏è'; } catch(_) {}
                toast('ƒêang ph√°t nh·∫°c n·ªÅn...');
                return;
            }
            if (ytFallbackIsPlaying) {
                fallbackPostMessage('pauseVideo');
                ytFallbackIsPlaying = false;
                toast('ƒê√£ d·ª´ng nh·∫°c n·ªÅn.');
            } else {
                if (!vid) { toast('Ch∆∞a c√≥ link h·ª£p l·ªá. D√°n link r·ªìi b·∫•m ‚ñ∂Ô∏è.'); return; }
                fallbackPostMessage('playVideo');
                ytFallbackIsPlaying = true;
                toast('ƒêang ph√°t nh·∫°c n·ªÅn...');
            }
            try { 
                const btn = document.getElementById('btnToggleYtSound'); 
                if (btn) btn.textContent = ytFallbackIsPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'; 
            } catch(_) {}
            return;
        }
        if (!ytPlayer || typeof ytPlayer.getPlayerState !== 'function') return;
        const playerState = ytPlayer.getPlayerState();
        if (playerState === YT.PlayerState.PLAYING || playerState === YT.PlayerState.BUFFERING) {
            ytFadeOutPause();
            ytUserPaused = true;
            toast('ƒê√£ d·ª´ng nh·∫°c n·ªÅn.');
        } else {
            ytFadeInPlay();
            ytUserPaused = false;
            toast('ƒêang ph√°t nh·∫°c n·ªÅn...');
        }
    }
    function bindEvents(){
      on($('#btnToggleBg'), 'click', toggleBackgroundView);
      on($('#btnMilestoneClose'), 'click', () => $('#modalMilestone').classList.remove('show'));
      on($('#btnAddTopic'), 'click', () => showInputModal('T√™n Ch·ªß ƒë·ªÅ m·ªõi?', async (name) => { if (!name) return; data.topics.push({ id: uid('t'), name, subtopics: [] }); await saveData(); renderTopics(); }));
      on($('#btnExport'), 'click', ()=> storageManager.exportData(data));
        on($("#importFile"), 'change', (e) => {
          const f = e.target.files[0];
          if (!f) return;
          storageManager.importData(f).then(async (d) => {
            data = d;
            normalizeDataStructure(data);
            await ensureValidSelection();
            await seedAchievedMilestones();
            toast('ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!');
            renderAll();
          }).catch(err => toast('Nh·∫≠p th·∫•t b·∫°i: ' + err.message));
          e.target.value = null;
        });
      on($('#btnRestoreBackup'), 'click', () => {
          const backupListEl = $('#backupList');
          const selectedDate = backupListEl ? backupListEl.value : '';
          if (!selectedDate) { toast('Vui l√≤ng ch·ªçn m·ªôt b·∫£n sao l∆∞u.'); return; }
          showConfirmModal('X√°c nh·∫≠n ph·ª•c h·ªìi', `B·∫°n c√≥ ch·∫Øc mu·ªën ph·ª•c h·ªìi d·ªØ li·ªáu t·ª´ ng√†y ${new Date(selectedDate).toLocaleDateString()}? D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®.`, (ok) => {
              if (ok) {
                  storageManager.restoreBackup(selectedDate).then((d) => {
                      data = d;
                      toast('Ph·ª•c h·ªìi d·ªØ li·ªáu th√†nh c√¥ng! T·∫£i l·∫°i trang...');
                      setTimeout(() => window.location.reload(), 1500);
                  }).catch(err => {
                      toast(`L·ªói: ${err.message}`);
                  });
              }
          });
      });
      on($('#set_theme_color'), 'input', (e) => {
          const selectedTheme = e.target.value;
          applyTheme(selectedTheme);
          if (selectedTheme === 'light' || selectedTheme === 'pastel') {
              const ytThumbCheckbox = $('#set_ytThumbAsBg');
              if (ytThumbCheckbox) {
                  ytThumbCheckbox.checked = false;
                  toast('ƒê√£ t·∫Øt n·ªÅn YouTube ƒë·ªÉ h·ª£p v·ªõi theme s√°ng.', 2000);
              }
              // ƒê·∫£m b·∫£o xem tr∆∞·ªõc n·ªÅn g·ªëc cho theme s√°ng
              try { document.body.style.setProperty('--bg-image', 'none'); } catch(_) {}
          } else {
              // Theme t·ªëi: t·ª± b·∫≠t d√πng thumbnail YouTube n·∫øu c√≥ link
              const ytThumbCheckbox = $('#set_ytThumbAsBg');
              if (ytThumbCheckbox) {
                  ytThumbCheckbox.checked = true;
              }
              try { updateYouTubePlayer(); } catch(_) {}
          }
      });
      on($('#btnSettings'), 'click', openSettings);
      on($('#btnHelpCreateTopic'), 'click', () => {
          switchView('topics');
          $('#btnAddTopic').click();
      });
      on($('#btnDashboard'), 'click', () => {
          renderDashboard();
          $('#modalDashboard').classList.add('show');
      });
      on($('#btnCloseDashboard'), 'click', () => {
          $('#modalDashboard').classList.remove('show');
      });
      on($('#btnCloseSettings'), 'click', closeSettings);
      on($('#btnSaveSettings'), 'click', saveSettings);
      on($('#btnDefaults'), 'click', setDefaults);
      on($('#btnTestSound'), 'click', ()=>{ ensureAudio(); playSound('work_end'); });
      on($('#btnToggleCustomSounds'), 'click', (e) => {
          e.preventDefault();
          const container = $('#customSoundsContainer');
          if (container) container.classList.toggle('hidden');
      });
      on($('#btnSaveNote'), 'click', async ()=>{ const s=getCurrentSubtopic(); if(!s) return; const id=pendingNoteSessionId; const sess=s.sessions.find(x=>x.id===id); if(sess){ sess.note=$('#noteText').value.trim(); await saveData(); renderStatsHistory(); toast('ƒê√£ l∆∞u ghi ch√∫'); } closeNoteModal(); });
      on($('#btnSkipNote'), 'click', ()=> closeNoteModal());
      on($('#btnAddGeneralNote'), 'click', addGeneralNote);
      on($('#btnSummarizeNote'), 'click', handleSummarizeNote);
      on($('#btnSendMessage'), 'click', handleSendMessage);
      on($('#chatInput'), 'keydown', (e) => { if (e.key === 'Enter') handleSendMessage(); });
      $$('#aiPromptSuggestions button').forEach(btn => {
        on(btn, 'click', () => {
          const promptTemplate = btn.dataset.prompt;
          $('#chatInput').value = promptTemplate;
          $('#chatInput').focus();
        });
      });
      on($('#btnClearChat'), 'click', clearChat);
      on($('#btnNewChat'), 'click', clearChat);
      on($('#btnAddSubtopicTask'), 'click', addSubtopicTask);
      on($('#newSubtopicTaskInput'), 'keydown', (e) => { if (e.key === 'Enter') addSubtopicTask(); });
      on($('#btnToggleYtSound'), 'click', toggleYtSound);
      on($('#ytSoundVolume'), 'input', (e) => {
          const vol = parseInt(e.target.value, 10);
          if (ytPlayer && ytPlayer.setVolume) {
              ytPlayer.setVolume(vol);
          }
      });
      on($('#set_youtubeUrl'), 'input', handleYoutubeUrlInput);
      $$('.nav-btn[data-view]').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
      $$('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                const parent = btn.closest('.aux-panel, .modal-card');
                if (!parent) return;
                parent.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                parent.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                    c.style.display = 'none';
                });
                const activeContent = parent.querySelector(`#${tabId}`);
                if(activeContent) {
                    activeContent.classList.add('active');
                    activeContent.style.display = 'block';
                    if(parent.closest('#modalSettings')) {
                        activeContent.style.display = 'flex';
                    }
                }
            });
        });
        $$('#timerPresetSelector button').forEach(btn => {
          btn.addEventListener('click', () => {
            editingPreset = btn.dataset.presetTarget;
            highlightPresetSelector();
            loadEditingPresetFields();
          });
        });
        $$('.presets button').forEach(button => {
          button.addEventListener('click', (e) => {
            const newPreset = e.target.dataset.preset;
            const currentPreset = data.settings.preset;
            if (newPreset === currentPreset) {
              return;
            }
            if (timer.state !== 'idle') {
              showConfirmModal(
                'X√°c nh·∫≠n chuy·ªÉn ƒë·ªïi',
                `B·∫°n c√≥ ch·∫Øc mu·ªën chuy·ªÉn sang Ki·ªÉu ${newPreset}? Thao t√°c n√†y s·∫Ω d·ª´ng v√† ƒë·∫∑t l·∫°i phi√™n l√†m vi·ªác hi·ªán t·∫°i.`,
                (confirmed) => {
                  if (confirmed) {
                    timer.reset();
                    timer.setPreset(newPreset);
                    renderAll();
                    toast(`ƒê√£ chuy·ªÉn sang Ki·ªÉu ${newPreset}.`);
                  }
                }
              );
            } 
            else {
              timer.setPreset(newPreset);
              renderAll();
              toast(`ƒê√£ chuy·ªÉn sang Ki·ªÉu ${newPreset}.`);
            }
          });
        });
      on($('#btnStart'), 'click', ()=> timer.start());
      on($('#btnPause'), 'click', ()=> timer.pause());
      on($('#btnResume'), 'click', ()=> timer.resume());
      on($('#btnSkip'), 'click', ()=> timer.skip());
      on($('#btnReset'), 'click', ()=> timer.reset());
      on($('#uploadBg'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customBg = id; await saveData(); applyCustomBg(); toast("ƒê√£ c·∫≠p nh·∫≠t h√¨nh n·ªÅn."); }); e.target.value = null; });
      on($('#btnClearBg'), 'click', async () => {
          data.settings.customBg = '';
          data.settings.useYtThumbnailAsBg = false;
          await saveData();
          applyCustomBg();
          toast("ƒê√£ x√≥a h√¨nh n·ªÅn t√πy ch·ªânh.");
          if ($('#modalSettings').classList.contains('show')) {
              openSettings();
          }
      });
      
      on($('#uploadSoundWork'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customSounds.work_end = id; await saveData(); toast("ƒê√£ l∆∞u √¢m b√°o h·∫øt L√ÄM VI·ªÜC."); }); e.target.value = null; });
      on($('#uploadSoundBreak'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customSounds.break_end = id; await saveData(); toast("ƒê√£ l∆∞u √¢m b√°o h·∫øt NGH·ªà NG·∫ÆN."); }); e.target.value = null; });
      on($('#uploadSoundLong'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customSounds.long_end = id; await saveData(); toast("ƒê√£ l∆∞u √¢m b√°o h·∫øt NGH·ªà D√ÄI."); }); e.target.value = null; });
      on($('#btnFullscreen'), 'click', toggleFullScreen);
      document.addEventListener('fullscreenchange', updateFullscreenButton);
      window.addEventListener('keydown', (e)=>{ const tag=(e.target.tagName||'').toLowerCase(); const isTyping=['input','textarea','select'].includes(tag); if(e.code==='Space' && !isTyping){ e.preventDefault(); if(timer.state==='idle'||timer.state==='paused') timer.start(); else timer.pause(); } if(e.key==='n'||e.key==='N'){ if(!isTyping){ e.preventDefault(); timer.skip(); } } if(e.key==='Escape'){ $$('.modal').forEach(m => m.classList.remove('show')); } });
      $$('.modal').forEach(m=> m.addEventListener('click', (ev)=>{ if(ev.target===m) m.classList.remove('show'); }));
      window.addEventListener('click', (e) => {
        if (!e.target.closest('.actions-menu-btn')) {
            closeAllMenus();
        }
      });
      window.addEventListener('beforeunload', () => timer.persistTimerState(true));
      const draggableElement = $('#draggableTimer');
      let isDragging = false;
      let offsetX, offsetY;
      if (draggableElement) {
        draggableElement.addEventListener('mousedown', (e) => {
          isDragging = true;
          const rect = draggableElement.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;
          draggableElement.style.transition = 'none';
        });
        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          let newX = e.clientX - offsetX;
          let newY = e.clientY - offsetY;
          const boundaryX = window.innerWidth - draggableElement.offsetWidth;
          const boundaryY = window.innerHeight - draggableElement.offsetHeight;
          newX = Math.max(0, Math.min(newX, boundaryX));
          newY = Math.max(0, Math.min(newY, boundaryY));
          draggableElement.style.left = newX + 'px';
          draggableElement.style.top = newY + 'px';
          draggableElement.style.bottom = 'auto';
          draggableElement.style.right = 'auto';
        });
        document.addEventListener('mouseup', () => {
          if (!isDragging) return;
          isDragging = false;
          draggableElement.style.transition = '';
        });
      }
    }
    function toggleBackgroundView(){
        const body = document.body;
        body.classList.toggle('bg-view-mode');
        const isActive = body.classList.contains('bg-view-mode');
        const btn = $('#btnToggleBg');
        if (!btn) return;
        if (isActive) {
            btn.title = 'Hi·ªán giao di·ªán';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></svg>`;
        } else {
            btn.title = '·∫®n giao di·ªán';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
        }
    }
    function updateMainViewVisibility() {
        const hasSubtopic = !!getCurrentSubtopic();
        const timerView = $('#view-timer');
        const welcomePanel = $('#welcomePanel');
        if (welcomePanel) {
            welcomePanel.classList.toggle('hidden', hasSubtopic);
        }
        if (timerView) {
            if (hasSubtopic) {
                timerView.classList.remove('no-subtopic-selected');
            } else {
                timerView.classList.add('no-subtopic-selected');
            }
        }
    }
    function updatePresetButtonsText() {
        const settings = data.settings;
        const cyclesA = settings.cyclesA;
        const cyclesB = settings.cyclesB;
        const workA = settings.durations.A_work;
        const workB = settings.durations.B_work;
        const btnA = $('#btnPresetA');
        const btnB = $('#btnPresetB');
        if (btnA) {
            btnA.textContent = `${cyclesA}√ó${workA} (A)`;
        }
        if (btnB) {
            btnB.textContent = `${cyclesB}√ó${workB} (B)`;
        }
    }
    function renderAll(){
        updatePresetButtonsText();
        const currentPreset = data.settings.preset;
        $$('.presets button').forEach(button => {
          const isSelected = button.dataset.preset === currentPreset;
          button.classList.toggle('acc', isSelected);
          button.classList.toggle('ghost', !isSelected);
          button.setAttribute('aria-pressed', isSelected);
        });
        updateMainViewVisibility();
        timer.setPreset(data.settings.preset, {silent:true});
        renderTopics();
        renderContextBadge();
        renderStatsHistory();
        renderGeneralNotes();
        renderChat();
        applyCustomBg();
        applyPanelOpacity();
        renderSubtopicTasks();
        updateFullscreenButton();
        switchView(data.settings.currentView);
        // fixVietnameseUI ƒë√£ b·ªã lo·∫°i b·ªè; n·ªôi dung hi·ªÉn th·ªã tr·ª±c ti·∫øp b·∫±ng UTF-8
    }
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                toast(`L·ªói: Kh√¥ng th·ªÉ b·∫≠t ch·∫ø ƒë·ªô to√†n m√†n h√¨nh: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }
    function updateFullscreenButton() {
        const btn = $('#btnFullscreen');
        if (document.fullscreenElement) {
            btn.innerHTML = '‚ÜôÔ∏è';
            btn.title = 'Tho√°t to√†n m√†n h√¨nh';
        } else {
            btn.innerHTML = '‚ÜóÔ∏è';
            btn.title = 'To√†n m√†n h√¨nh';
        }
    }
    async function initializeApp() {
      try {
        await storageManager.initDB();
        const [settings, topics, subtopics] = await Promise.all([
          storageManager.getSettings(),
          storageManager.getAll('topics'),
          storageManager.getAll('subtopics')
        ]);
        let merged;
        if (!settings || topics.length === 0 || subtopics.length === 0) {
          const defaultData = JSON.parse(JSON.stringify(defaults));
          await storageManager.updateSettings(defaultData.settings);
          for (const t of defaultData.topics) {
            const { subtopics: subs, ...topicData } = t;
            await storageManager.add('topics', topicData);
            for (const sub of subs) {
              await storageManager.add('subtopics', { ...sub, topicId: t.id });
            }
          }
          merged = defaultData;
        } else {
          const map = {};
          for (const t of topics) map[t.id] = { ...t, subtopics: [] };
          for (const s of subtopics) map[s.topicId]?.subtopics.push(s);
          merged = { version: defaults.version, settings, topics: Object.values(map) };
        }
        data = window.data = merged;
        normalizeDataStructure(data);
        await ensureValidSelection();
        await seedAchievedMilestones();
        renderAll();
        try { storageManager.autoBackup(data); } catch (e) { console.warn('AutoBackup error:', e); }
        bindEvents();
        applyTheme();
      } catch (err) {
        console.error('Initialization error:', err);
        toast(`L·ªói kh·ªüi t·∫°o: ${err.message}`);
      }
    }
    callGeminiAPI = async function(prompt, retries = 3, delay = 1000) {
        const apiKey = data?.settings?.apiKey || "";
        if (!apiKey) {
            toast("Vui l√≤ng nh·∫≠p Gemini API Key trong ph·∫ßn C√†i ƒë·∫∑t.");
            return null;
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                if (response.status === 429 && retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                }
                let errorData = null;
                try { errorData = await response.json(); } catch (e) {}
                let errorMessage = `L·ªói HTTP: ${response.status}`;
                if (response.status === 400) {
                    errorMessage = "L·ªói: Gemini API Key kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ b·ªã thay ƒë·ªïi. Vui l√≤ng ki·ªÉm tra l·∫°i trong C√†i ƒë·∫∑t.";
                } else if (response.status === 429) {
                    errorMessage = "L·ªói: ƒê√£ v∆∞·ª£t qu√° h·∫°n m·ª©c y√™u c·∫ßu t·ªõi Gemini. Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.";
                } else if (errorData?.error?.message) {
                    errorMessage = `L·ªói t·ª´ Gemini: ${errorData.error.message}`;
                }
                toast(errorMessage, 4000);
                console.error("Gemini API Error:", errorData || response.statusText);
                return null;
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                return formatGeminiResponse(result.candidates[0].content.parts[0].text);
            } else {
                console.error("API response structure is unexpected:", result);
                if (result.promptFeedback?.blockReason) { return `N·ªôi dung b·ªã ch·∫∑n v√¨: ${result.promptFeedback.blockReason}. Vui l√≤ng th·ª≠ l·∫°i v·ªõi n·ªôi dung kh√°c.`; }
                return "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung h·ª£p l·ªá t·ª´ AI.";
            }
        } catch (error) {
            console.error("L·ªói khi g·ªçi Gemini API:", error);
            toast("L·ªói m·∫°ng khi k·∫øt n·ªëi ƒë·∫øn Gemini. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.", 4000);
            return null;
        }
    }
    loadLanguage(localStorage.getItem('lang') || 'vi').then(initializeApp);
    </script>
</body>
</html>
