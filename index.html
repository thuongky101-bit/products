<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="·ª®ng d·ª•ng Pomodoro h·ªó tr·ª£ h·ªçc t·∫≠p v·ªõi t√≠ch h·ª£p Gemini AI v√† giao di·ªán hi·ªán ƒë·∫°i." />
    <title>Pomodoro Study App ‚Äî T√≠ch h·ª£p Gemini AI (Giao di·ªán m·ªõi)</title>
    <style>
    /*
    =============================================
    POMODORO STUDY APP ‚Äî PHI√äN B·∫¢N GIAO DI·ªÜN T·∫¨P TRUNG (v1.0)
    =============================================
    */

    :root {
      /* Theme Dark (M·∫∑c ƒë·ªãnh) - C·∫≠p nh·∫≠t t·ª´ file 2 */
      --bg: #0f1222;
      --panel: #171a2e;
      --panel-rgb: 23, 26, 46; /* Th√™m bi·∫øn RGB cho panel */
      --muted: #212646;
      --text: #f4f6ff;
      --sub: #b7c1ff;
      --acc: #6c8cff;
      --acc-rgb: 108, 140, 255;
      --acc-2: #27d3a2;
      --purple: #a78bfa;
      --warn: #ffb020;
      --danger: #ff5c7a;
      --shadow: 0px 1.8px 2.2px rgba(0, 0, 0, 0.054), 0px 4.3px 5.3px rgba(0, 0, 0, 0.077), 0px 8.1px 10px rgba(0, 0, 0, 0.095), 0px 14.5px 17.9px rgba(0, 0, 0, 0.113), 0px 27.2px 33.4px rgba(0, 0, 0, 0.136), 0px 65px 80px rgba(0, 0, 0, 0.19);
      --radius: 16px;
      --panel-opacity: 0.85;
      --gradient-border: linear-gradient(135deg, var(--acc), var(--acc-2));
    }
    
    /* === START: TH√äM C√ÅC THEME M·ªöI === */
    [data-theme='light'] {
      --bg: #f5f0e8; --panel: #ffffff; --panel-rgb: 255, 255, 255; --muted: #eaddcf; --text: #4a4a4a; --sub: #8a817c; --acc: #d4a373; --acc-rgb: 212, 163, 115; --acc-2: #a3b18a; --warn: #e76f51; --danger: #d00000;
      --shadow: 0px 1.8px 2.2px rgba(0, 0, 0, 0.024), 0px 4.3px 5.3px rgba(0, 0, 0, 0.037), 0px 8.1px 10px rgba(0, 0, 0, 0.045), 0px 14.5px 17.9px rgba(0, 0, 0, 0.053), 0px 27.2px 33.4px rgba(0, 0, 0, 0.066), 0px 65px 80px rgba(0, 0, 0, 0.09);
      --panel-opacity: 0.9;
      /* NgƒÉn n·ªÅn t·ªëi m·∫∑c ƒë·ªãnh khi kh√¥ng c√≥ ·∫£nh */
      --bg-image: none;
    }

    [data-theme='pastel'] {
      --bg: #fde2e4; --panel: #fff1f2; --panel-rgb: 255, 241, 242; --muted: #fad2e1; --text: #595260; --sub: #8c7a8a; --acc: #c78283; --acc-rgb: 199, 130, 131; --acc-2: #7ec4cf; --warn: #f9bf45; --danger: #d7263d;
      --shadow: 0 5px 20px rgba(200,150,150,0.2);
      --panel-opacity: 0.9;
      /* NgƒÉn n·ªÅn t·ªëi m·∫∑c ƒë·ªãnh khi kh√¥ng c√≥ ·∫£nh */
      --bg-image: none;
    }
    
    [data-theme='lofi'] {
      --bg: #2a2a3e; --panel: #3c3c52; --panel-rgb: 60, 60, 82; --muted: #4d4d66; --text: #e0e0ff; --sub: #a0a0c0; --acc: #ff8c69; --acc-rgb: 255, 140, 105; --acc-2: #69c6ff; --warn: #ffd700; --danger: #ff6961;
      /* === Replaced external GIF with inline data URI (offline-safe) === */
      --bg-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc4MDAnIGhlaWdodD0nNjAwJz48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9J2cnIHgxPScwJyB5MT0nMCcgeDI9JzEnIHkyPScxJz48c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjMmEyYTNlJy8+PHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjM2MzYzUyJy8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9JzEwMCUnIGhlaWdodD0nMTAwJScgZmlsbD0ndXJsKCNnKScvPjwvc3ZnPg==');
      --panel-opacity: 0.8;
    }
    
    [data-theme='space'] {
        --bg: #000000; --panel: #1a1a2e; --panel-rgb: 26, 26, 46; --muted: #2a2a4e; --text: #e0e0ff; --sub: #b0b0e0; --acc: #00aaff; --acc-rgb: 0, 170, 255; --acc-2: #aaff00; --warn: #ffaa00; --danger: #ff0055;
        /* === Replaced external GIF with inline data URI (offline-safe) === */
        --bg-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc4MDAnIGhlaWdodD0nNjAwJz48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9J2cnIGN4PSc1MCUnIGN5PSc0MCUnIHI9JzcwJSc+PHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzBiMGIxYScvPjxzdG9wIG9mZnNldD0nMTAwJScgc3RvcC1jb2xvcj0nIzAwMDAwMCcvPjwvcmFkaWFsR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPScxMDAlJyBoZWlnaHQ9JzEwMCUnIGZpbGw9J3VybCgjZyknLz48L3N2Zz4=');
        --panel-opacity: 0.75;
    }
    /* === END: TH√äM C√ÅC THEME M·ªöI === */

    *:focus-visible {
      outline: 2px solid var(--acc); outline-offset: 2px; border-radius: 4px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      margin:0; 
      font-family: system-ui, -apple-system, 'Segoe UI Variable', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Inter', sans-serif; 
      
      background-color: var(--bg);
      background-image: var(--bg-image, radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%));
      
      background-size: cover; 
      background-position: center; 
      color:var(--text); 
      transition: background 0.5s ease, color 0.5s ease, filter 0.5s ease;
      text-shadow: 0px 0px 5px rgba(0, 0, 0, 0.5);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    a{color:var(--acc)}

    .app{display:flex; min-height:100vh}
    
    .app-nav {
        width: 60px;
        padding: 16px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        z-index: 100;
    }
    .nav-btn {
        background: transparent;
        border: none;
        color: var(--sub);
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all .2s ease;
        position: relative;
    }
    .nav-btn:hover { background: var(--muted); color: var(--text); }
    .nav-btn.active { background: var(--acc); color: white; }
    .nav-btn svg { width: 24px; height: 24px; }
    .nav-btn .tooltip {
        position: absolute;
        left: 110%;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        box-shadow: var(--shadow);
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity .2s ease, visibility .2s ease;
        pointer-events: none;
        z-index: 200;
    }
    .nav-btn:hover .tooltip { opacity: 1; visibility: visible; }

    .app-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        max-height: 100vh;
    }

    .view { display: none; }
    .view.active { display: grid; gap: 24px; animation: fadeIn .3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .main.reloading { opacity: 0; transition: opacity 0.2s ease-out; }

    .panel-bg{
        background: rgba(23, 26, 46, var(--panel-opacity));
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border:1px solid rgba(255,255,255,.08);
    }
    /* Th√™m c√°c quy t·∫Øc border cho theme light/pastel */
    [data-theme='light'] .panel-bg, [data-theme='pastel'] .panel-bg { border:1px solid rgba(0,0,0,0.05); }
    [data-theme='lofi'] .panel-bg { border:1px solid rgba(255,255,255,0.1); }
    [data-theme='space'] .panel-bg { border:1px solid rgba(255,255,255,0.12); }


header.app-header{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom: 24px; position: relative; z-index: 2000;}
    header .actions{display:flex; gap:8px; align-items:center}
    
    .btn {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border: none; /* S·ª≠a ƒë·ªïi: b·ªè border m·∫∑c ƒë·ªãnh */
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.08);
      font-weight: 600;
      transition: all .15s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        border: 2px solid transparent; border-radius: 12px; background: var(--gradient-border) border-box;
        -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: destination-out; mask-composite: exclude; opacity: 0; transition: opacity 0.3s ease;
    }
    .btn:hover::before { opacity: 1; }
    .btn:hover { background: rgba(255, 255, 255, 0.12); }
    .btn:active { transform: translateY(1px) scale(0.98); filter: brightness(1); }
    .btn:disabled { cursor: not-allowed; filter: brightness(0.8) saturate(0.5); }
    .btn.ghost { background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); }
    .btn.ghost:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.3); }
    .btn.acc { background: var(--acc); color: white; }
    .btn.warn { background: var(--warn); color: white; }
    .btn.danger { background: var(--danger); color: white; }
    .btn.small { padding: 6px 10px; font-size: 14px; border-radius: 9px; }
    .btn.small::before { border-radius: 9px; }
    .btn > svg { width: 16px; height: 16px; stroke-width: 2.5px; }

    /* === START: C·∫¨P NH·∫¨T GIAO DI·ªÜN QU·∫¢N L√ù CH·ª¶ ƒê·ªÄ === */
    #view-topics { grid-template-columns: 1fr; }
    .topic-item { background:rgba(255,255,255,.04); border:1px solid var(--muted); border-radius:12px; padding:8px; margin-bottom:8px; } /* S·ª≠a ƒë·ªïi */
    .topic-header, .sub-row { display:flex; align-items:center; gap:8px; position: relative; }
    .topic-header { cursor: pointer; }
    .topic-header .topic-actions { cursor: default; }
    .topic-header .topic-actions * { cursor: pointer; }
    .topic-item { cursor: pointer; }
    .topic-item .topic-actions { cursor: default; }
    .topic-item .topic-actions * { cursor: pointer; }
    .topic-title { flex:1; font-weight:600; cursor: pointer; }
    .chev { width:28px; height:28px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; flex-shrink: 0; cursor: pointer; }
    .chev .ico { display:inline-block; transition: transform .18s ease; }
    .chev[aria-expanded="false"] .ico { transform: rotate(-90deg); }
    .subtopics { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .subtopics.hidden { display:none; }
    
    .topic-actions, .sub-row .actions {
        opacity: 0;
        visibility: hidden;
        transition: opacity .2s ease, visibility .2s ease;
        display: flex;
        gap: 6px;
        align-items: center;
    }
    .topic-item:hover .topic-actions, .topic-item:focus-within .topic-actions,
    .sub-row:hover .actions, .sub-row:focus-within .actions {
      opacity: 1;
      visibility: visible;
    }
    .actions-menu-btn {
        padding: 0;
        width: 28px;
        height: 28px;
        font-size: 1.2em;
        line-height: 1;
    }
    .actions-menu {
        position: absolute;
        top: 100%;
        right: 0;
        border-radius: 8px;
        padding: 6px;
        box-shadow: var(--shadow);
        z-index: 10;
        min-width: 150px;
        display: none;
        flex-direction: column;
        gap: 4px;
    }
    /* N√¢ng kh·ªëi ƒëang m·ªü menu l√™n tr√™n c√°c kh·ªëi kh√°c */
    .topic-item.menu-active { position: relative; z-index: 20; }
    
    .actions-menu.show { display: flex; }
    .menu-item {
        background: transparent; border: none; color: var(--text);
        padding: 8px 10px; border-radius: 6px; text-align: left;
        width: 100%; cursor: pointer; transition: background .2s ease;
        display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;
    }
    .menu-item:hover { background: var(--acc); color: white; }
    .menu-item.danger:hover { background: var(--danger); }
    /* === END: C·∫¨P NH·∫¨T GIAO DI·ªÜN QU·∫¢N L√ù CH·ª¶ ƒê·ªÄ === */

    .subtopic-btn{
        flex:1; 
        text-align:left;
        background-color: rgba(0,0,0,0.02); /* S·ª≠a ƒë·ªïi */
    }
    .subtopic-btn:hover {
        background-color: transparent; /* Hover transparent to avoid blue background */
    }
    .subtopic-btn.active{
        outline:2px solid var(--acc); 
    }
    .subtopic-btn.active:hover {
        background: transparent; /* Gi·ªØ n·ªÅn trong su·ªët khi di chu·ªôt qua */
    }
    
    .panel{border-radius:var(--radius); padding:24px; box-shadow:var(--shadow)}

    .timer-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .timer{display:grid; gap:16px; grid-template-columns: 1fr; align-items:center; text-align:center}
    .big-time{font-size: clamp(60px, 12vw, 96px); letter-spacing:1px; font-weight:700; color: var(--text)}
    .state{font-weight:700; letter-spacing:.6px}
    .state.work{color:var(--acc-2)} /* S·ª≠a ƒë·ªïi m√†u */
    .state.break{color:var(--warn)}
    .state.long{color:var(--danger)} /* S·ª≠a ƒë·ªïi m√†u */
    .controls{display:flex; flex-wrap:wrap; gap:12px; justify-content:center}    
    #btnStart { padding: 14px 28px; font-size: 1.2em; }
    #btnPause, #btnResume { padding: 12px 24px; font-size: 1.1em; }

    /* === START: T√ôY CH·ªàNH D·∫¢I PH√ÇN C√ÅCH M·ªÄM M·∫†I H∆†N === */
    #view-timer .panel-bg hr {
        border: none; /* B·ªè ƒë∆∞·ªùng vi·ªÅn m·∫∑c ƒë·ªãnh */
        height: 1px;  /* ƒê·∫∑t chi·ªÅu cao cho ƒë∆∞·ªùng k·∫ª */
        background-color: var(--muted); /* S·ª≠ d·ª•ng m√†u ph·ª• c·ªßa theme */
        opacity: 0.3; /* L√†m cho n√≥ m·ªù ƒëi, h√≤a v√†o n·ªÅn */
        margin-top: 0; /* ƒêi·ªÅu ch·ªânh l·∫°i kho·∫£ng c√°ch */
    }
    /* === END: T√ôY CH·ªàNH D·∫¢I PH√ÇN C√ÅCH M·ªÄM M·∫†I H∆†N === */

    .stats-grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:12px}
    .stat-card{background:rgba(255,255,255,0.04); border:1px solid var(--muted); border-radius:14px; padding:12px; text-align:center} /* S·ª≠a ƒë·ªïi */
    .stat-card h4{margin:4px 0 8px; color:var(--sub); font-weight:600; font-size: 14px;}
    .stat-value{font-size: 20px; font-weight: 600;}
    .tiny{font-size:12px; color:var(--sub)}
    .history{display:grid; gap:8px; max-height:300px; overflow:auto; padding-right:6px}
    .hist-item{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:start; background:rgba(255,255,255,0.04); border:1px solid var(--muted); border-radius:10px; padding:10px} /* S·ª≠a ƒë·ªïi */

    .row{display:flex; gap:8px; align-items:center}
    .row > * {flex:1}
    input[type="text"], input[type="password"], input[type="number"], select, textarea{width:100%; background:rgba(255,255,255,0.04); color:var(--text); border:1px solid var(--muted); border-radius:10px; padding:10px; outline:none}
    textarea{min-height:80px; resize: vertical;}

    .toasts{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999}
    .toast{
        background: var(--panel); /* S·ª≠a ƒë·ªïi */
        border:1px solid var(--muted);
        color:var(--text);
        padding:10px 12px; border-radius:12px; box-shadow:var(--shadow);
        animation: toast-in .3s ease; transform-origin: bottom right;
    }
    @keyframes toast-in { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,var(--panel-opacity)); z-index:10000; backdrop-filter: blur(5px);} /* N√¢ng z-index ƒë·ªÉ n·∫±m tr√™n header */
    .modal.show{display:flex}
    .modal-card{
        position: relative;
        z-index: 10001;
        width:min(720px, 94vw);
        border-radius:16px;
        padding:16px;
        box-shadow:var(--shadow);
        animation: modal-in .25s ease-out;
        max-height: 90vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    body.modal-open { overflow: hidden; }
    @keyframes modal-in { from { opacity: 0; transform: scale(0.92) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal-card h3{margin-top:0}
    .dashboard-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .dashboard-table th, .dashboard-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--muted); }
    .dashboard-table th { color: var(--sub); }

    .footer-note{font-size:12px; color:var(--sub)}
    .hidden{display:none !important}

    .notes-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; padding-right: 6px; }
    .note-item { background: rgba(255,255,255,0.04); border-radius: 10px; padding: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; cursor: pointer; } /* S·ª≠a ƒë·ªïi */
    .note-content-wrapper { flex: 1; min-width: 0; }
    .note-content { white-space: pre-wrap; word-break: break-word; max-height: 60px; overflow: hidden; position: relative; transition: max-height 0.35s ease-in-out; }
    .note-content:not(.expanded)::after {
        content: ''; position: absolute; bottom: 0; right: 0; width: 100%; height: 20px; background: linear-gradient(to top, var(--panel) 20%, transparent);
    }
    .note-content.expanded { max-height: 500px; }
    .note-meta { font-size: 11px; color: var(--sub); margin-top: 4px; }
    
    .spinner { border: 2px solid var(--muted); border-top-color: var(--text); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; } /* S·ª≠a ƒë·ªïi */
    @keyframes spin { to { transform: rotate(360deg); } }

    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .panel-header h3 { margin: 0; }
    .panel-header .actions { display: flex; gap: 8px; }
    
    .aux-panel { margin-top: 24px; }
    .tab-nav { display: flex; gap: 4px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 16px; }
    .tab-btn { background: transparent; border: none; color: var(--sub); padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all .2s ease; font-weight: 600; }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--acc); border-bottom-color: var(--acc); }
    .tab-content {
      display: none;
      padding-top: 8px;
    }
    .tab-content.active {
      animation: fadeIn 0.25s ease-out;
    }
    #tasks.tab-content.active,
    #notes.tab-content.active,
    #ai.tab-content.active {
        display: block;
    }

    #settings-timer.tab-content.active,
    #settings-ui.tab-content.active,
    #settings-integrations.tab-content.active {
        display: flex;
    }

    .settings-row-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }
    .settings-row-toggle span {
      flex: 1;
      cursor: pointer;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-switch .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--muted);
      transition: .3s;
      border-radius: 24px;
    }
    .toggle-switch .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .slider {
      background-color: var(--acc-2);
    }
    .toggle-switch input:checked + .slider:before {
      transform: translateX(20px);
    }
    
    .chat-messages { max-height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; padding: 4px; }
    .chat-msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; word-break: break-word; }
    .chat-msg.user { background: var(--acc); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-msg.model { background: var(--muted); align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-input-area { display: flex; gap: 8px; }

    .methods-list { list-style: none; padding: 0; }
    .method-item { align-items: flex-start; padding: 12px; display: flex; flex-direction: column; gap: 10px; border-radius: 8px; }
    .method-item:hover { background: rgba(0,0,0,0.03); } /* S·ª≠a ƒë·ªïi */
    .method-item input[type="checkbox"] { width: 18px; height: 18px; margin-top: 2px; flex-shrink: 0;}
    .method-item label { flex: 1; }
    .method-item label.completed { text-decoration: line-through; color: var(--sub); }
    .method-item .content-wrapper { flex: 1; cursor: pointer; }
    .method-item .concept { font-size: 14px; color: var(--sub); margin-top: 8px; border-left: 2px solid var(--muted); padding-left: 12px; white-space: pre-wrap; word-break: break-word; }
    /* Highlight section titles and bold text inside method content */
    .method-content h4 {
        color: var(--acc-2);
        font-size: 1.1em;
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        /* Gi·ªõi h·∫°n chi·ªÅu r·ªông ƒë·ªÉ ti√™u ƒë·ªÅ g·ªçn h∆°n */
        max-width: 50%;
    }
    .method-content strong {
        color: var(--acc);
        font-weight: 600;
    }
    /* Apply the same highlight to the Guide view */
    #view-guide h4 { color: var(--acc-2); }
    #view-guide strong { color: var(--acc-2); }
    /* Show hand cursor to indicate clickability */
    .method-item, .method-item summary { cursor: pointer; }
    .subtopic-todo-list { list-style: none; padding: 0; margin: 0; max-height: 100px; overflow-y: auto; text-align: left; }
    .subtopic-todo-list li { display: flex; align-items: center; gap: 8px; padding: 4px; transition: all 0.2s ease-out; }
    .subtopic-todo-list li.removing { transform: translateX(100%); opacity: 0; }
    .subtopic-todo-list label { flex: 1; }

    #youtube-player-container { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; overflow: hidden; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 10px; } /* S·ª≠a ƒë·ªïi */
    ::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background: var(--sub); background-clip: content-box; }
    
    .timer-circle-container {
        position: relative; width: clamp(250px, 40vw, 320px); height: clamp(250px, 40vw, 320px); margin: 24px auto; display: flex; align-items: center; justify-content: center;
    }
    .timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
    .timer-circle-bg, .timer-circle-progress { fill: none; stroke-width: 8; }
    .timer-circle-bg { stroke: var(--muted); } /* S·ª≠a ƒë·ªïi */
    .timer-circle-progress { stroke: var(--acc); stroke-linecap: round; transition: stroke-dashoffset 0.3s linear, stroke 0.5s ease; }
    @keyframes flash { 0%, 100% { box-shadow: 0 0 10px 2px transparent; } 50% { box-shadow: 0 0 20px 8px currentColor; } }
    .timer-circle-container.finished { color: var(--acc-2); animation: flash 1s ease-out; }
    @keyframes breathing-effect { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    .timer-circle-container.breathing { animation: breathing-effect 3s ease-in-out infinite; }
    
    
    
    @media (max-width: 1024px) {
      .app-content { padding: 20px; }
      .panel { padding: 20px; }
      .timer-circle-container { width: clamp(220px, 50vw, 300px); height: clamp(220px, 50vw, 300px); }
    }

    @media (max-width: 768px) {
      .app { flex-direction: column; }
      .app-nav { width: 100%; height: 60px; flex-direction: row; justify-content: center; border-right: none; border-top: 1px solid rgba(255,255,255,.08); order: 2; padding: 0 16px; }
      .app-content { padding: 16px; order: 1; }
      .panel { padding: 16px; }
      .modal-card .tab-nav { overflow-x: auto; }
    }

    @media (max-width: 480px) {
      .app-nav { height: 50px; }
      .nav-btn { flex: 1; }
      header.app-header { flex-direction: column; align-items: stretch; gap: 8px; }
      .btn { padding: 8px 12px; }
      .timer-circle-container { width: clamp(180px, 80vw, 220px); height: clamp(180px, 80vw, 220px); margin: 16px auto; }
      .panel { padding: 12px; }
      .app-content { padding: 12px; }
    }

    #view-timer.no-subtopic-selected > .panel-bg:not(:first-child) { display: none; }
    #view-timer.no-subtopic-selected .timer-header > .presets { display: none; }
    #view-timer.no-subtopic-selected .timer { display: none; }

    header.app-header .actions #btnFullscreen { background: transparent; border: none; box-shadow: none; }
    header.app-header .actions #btnFullscreen:hover { background: var(--muted); filter: none; }
    header.app-header .actions #btnFullscreen:hover::before { opacity: 0; }

    input[type="text"], input[type="password"], input[type="number"], select, textarea {
        background: rgba(255,255,255,0.04) !important; /* S·ª≠a ƒë·ªïi: chuy·ªÉn sang n·ªÅn tr·∫Øng trong su·ªët */
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.1); /* Vi·ªÅn tr·∫Øng m·ªù */
        transition: background .2s ease, border-color .2s ease;
    }
    input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
        background: rgba(255,255,255,0.06) !important; /* Tinh ch·ªânh: s√°t m·∫´u h∆°n */
        border-color: var(--acc);
    }
    /* === START: S·ª¨A L·ªñI N·ªÄN INPUT/SELECT TR√äN THEME S√ÅNG === */
    [data-theme='light'] input, [data-theme='light'] select, [data-theme='light'] textarea,
    [data-theme='pastel'] input, [data-theme='pastel'] select, [data-theme='pastel'] textarea {
        background: rgba(0, 0, 0, 0.05) !important; /* D√πng n·ªÅn ƒëen m·ªù thay v√¨ tr·∫Øng m·ªù */
        border-color: rgba(0, 0, 0, 0.1); /* Vi·ªÅn ƒëen m·ªù tr√™n theme s√°ng */
    }

    [data-theme='light'] input:focus, [data-theme='light'] select:focus, [data-theme='light'] textarea:focus,
    [data-theme='pastel'] input:focus, [data-theme='pastel'] select:focus, [data-theme='pastel'] textarea:focus {
        background: rgba(0, 0, 0, 0.07) !important; /* TƒÉng ƒë·ªô ƒë·∫≠m khi focus */
    }
    /* === END: S·ª¨A L·ªñI N·ªÄN INPUT/SELECT TR√äN THEME S√ÅNG === */

    /* C·∫£i thi·ªán n·ªÅn v√† m√†u ch·ªØ cho option trong select theo theme hi·ªán t·∫°i */
    select option {
        background: var(--panel);
        color: var(--text);
    }
    
    ::placeholder { color: var(--sub); opacity: 0.7; } /* S·ª≠a ƒë·ªïi */
    ::-ms-input-placeholder { color: var(--sub); }
    :-ms-input-placeholder { color: var(--sub); }

    
    
    .draggable-timer {
        position: fixed;
        bottom: 20px;
        right: 20px;
        color: var(--text);
        padding: 8px 16px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        font-size: 2em;
        font-weight: 600;
        cursor: move;
        user-select: none;
        z-index: 9998;
        opacity: 0;
        transform: scale(0.9);
        pointer-events: none;
        transition: opacity 0.35s ease, transform 0.35s ease;
    }
    body.bg-view-mode .draggable-timer {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto;
    }
    .app-nav, .panel-bg, .app-header .actions > *, .app-header > .row {
        transition: opacity 0.35s ease, transform 0.35s ease, background 0.35s ease, border-color 0.35s ease, box-shadow 0.35s ease;
    }
    body.bg-view-mode .app-nav,
    body.bg-view-mode .view.active > .panel-bg {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.98);
    }
    body.bg-view-mode .app-header {
        background: transparent !important;
        border-color: transparent !important;
        box-shadow: none !important;
    }
    body.bg-view-mode .app-header .actions > *:not(#btnToggleBg),
    body.bg-view-mode .app-header > .row {
        opacity: 0;
        pointer-events: none;
    }
    body.bg-view-mode #btnToggleBg {
        opacity: 1;
        pointer-events: auto;
    }
    .sound-permission-bar {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 48px; z-index: 9999;
      border-radius: 12px; padding: 10px 14px;
      display: none; align-items: center; gap: 10px;
      box-shadow: var(--shadow);
    }
    .sound-permission-bar.show { display: flex; }

    /* ========================================================= */
    /* START: C·∫¢I THI·ªÜN GIAO DI·ªÜN √ÇM THANH (HTML Refactor)     */
    /* ========================================================= */

    #customSoundsContainer {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
      padding: 14px;
      border-radius: 12px;
      background: rgba(var(--panel-rgb), var(--panel-opacity));
      border: 1px solid rgba(255, 255, 255, 0.08);
      width: 100%;
    }

    .custom-sound-row {
      align-items: center;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(var(--panel-rgb), calc(var(--panel-opacity) * 0.85));
      width: 100%;
      gap: 12px;
    }

    .custom-sound-row .custom-sound-label {
      flex: 1;
      margin: 0;
      font-size: 14px;
      color: var(--sub);
      font-weight: 500;
      cursor: default;
    }

    .custom-sound-row .btn[for] {
      flex-shrink: 0;
      margin-left: 12px;
      content: 'T·∫£i l√™n';
    }

    [data-theme='light'] #customSoundsContainer,
    [data-theme='pastel'] #customSoundsContainer {
      border-color: rgba(0, 0, 0, 0.08);
    }
    [data-theme='light'] .custom-sound-row,
    [data-theme='pastel'] .custom-sound-row {
      border-color: rgba(0, 0, 0, 0.08);
      background: rgba(var(--panel-rgb), 0.85);
    }

    .custom-sound-row .custom-sound-label {
      flex: 1;
      margin: 0;
      font-size: 14px;
      color: var(--sub);
      font-weight: 500;
      cursor: default;
    }

    .custom-sound-row .btn[for] {
      flex-shrink: 0;
      margin-left: 12px;
      /* VƒÉn b·∫£n hi·ªÉn th·ªã ƒë√£ ƒë·∫∑t trong HTML; khai b√°o content nh·∫±m nh·∫•n m·∫°nh m·ª•c ƒë√≠ch n√∫t */
      content: 'T·∫£i l√™n';
    }
    /* ========================================================= */
    /* END: C·∫¢I THI·ªÜN GIAO DI·ªÜN √ÇM THANH (HTML Refactor)         */
    /* ========================================================= */
    .sound-permission-bar .msg { font-size: 14px; color: var(--text); }
    .draggable-timer { text-shadow: 0px 0px 8px rgba(0, 0, 0, 0.9); }

    /* Gi·∫£m/lo·∫°i b·ªè b√≥ng ch·ªØ cho theme s√°ng ƒë·ªÉ tr√°nh nh√≤e/l√≥a */
    body[data-theme='light'],
    body[data-theme='pastel'] { text-shadow: none; }
    body[data-theme='light'] .draggable-timer,
    body[data-theme='pastel'] .draggable-timer { text-shadow: none; }

    /* ============================================= */
/* ========================================================= */
/* START: THI?T L?P PANEL KI?U M?  ?C (FROSTED GLASS)        */
/* ========================================================= */

/* --- 1.  p d?ng hi?u ?ng n?n m? chung cho t?t c? c c panel --- */
.app-nav,
.panel-bg,
.modal-card,
.actions-menu,
.nav-btn .tooltip,
.draggable-timer, 
.sound-permission-bar,
.toast,
.topic-item,
.stat-card,
.hist-item,
.method-item {
    background: rgba(var(--panel-rgb), var(--panel-opacity));
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
}

/* --- 2.  ?nh nghia vi?n cho t?ng lo?i panel --- */
.app-nav {
    border-right: 1px solid rgba(255, 255, 255, 0.1);
}
.panel-bg,
.modal-card,
.actions-menu,
.nav-btn .tooltip,
.draggable-timer, 
.sound-permission-bar,
.toast,
.topic-item,
.stat-card,
.hist-item,
.method-item {
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* --- 3. Tinh ch?nh vi?n cho c c theme S NG (Light/Pastel) --- */
[data-theme='light'] .app-nav,
[data-theme='light'] .panel-bg,
[data-theme='light'] .modal-card,
[data-theme='light'] .actions-menu,
[data-theme='light'] .nav-btn .tooltip,
[data-theme='light'] .draggable-timer,
[data-theme='light'] .sound-permission-bar,
[data-theme='light'] .toast,
[data-theme='light'] .topic-item,
[data-theme='light'] .stat-card,
[data-theme='light'] .hist-item,
[data-theme='light'] .method-item,
[data-theme='pastel'] .app-nav,
[data-theme='pastel'] .panel-bg,
[data-theme='pastel'] .modal-card,
[data-theme='pastel'] .actions-menu,
[data-theme='pastel'] .nav-btn .tooltip,
[data-theme='pastel'] .draggable-timer,
[data-theme='pastel'] .sound-permission-bar,
[data-theme='pastel'] .toast,
[data-theme='pastel'] .topic-item,
[data-theme='pastel'] .stat-card,
[data-theme='pastel'] .hist-item,
[data-theme='pastel'] .method-item {
    border-color: rgba(0, 0, 0, 0.1);
}

/* --- 4. S?a l?i hi?u ?ng fade-out c?a ghi ch  cho ph  h?p --- */
.note-content:not(.expanded)::after {
    background: linear-gradient(to top, rgba(var(--panel-rgb), 1) 20%, transparent);
}

/* --- C c quy t?c c n l?i gi? nguy n t? file g?c --- */
[data-theme='light'] .tab-nav,
[data-theme='pastel'] .tab-nav {
    border-bottom-color: rgba(0, 0, 0, 0.1);
}
.subtopic-btn {
    background-color: transparent;
}
.subtopic-btn:hover {
    background-color: transparent; /* Hover transparent to avoid blue background */
}
/* Khi n·ªôi dung m·ªü, th√™m ƒë∆∞·ªùng ph√¢n c√°ch ·ªü tr√™n n·ªôi dung */
.method-item > .method-content:not([hidden]) {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    /* margin-top: 8px;  <-- ƒê√£ x√≥a */
    padding-top: 8px; /* <-- Gi·ªØ l·∫°i m·ªôt ch√∫t padding ƒë·ªÉ n·ªôi dung kh√¥ng d√≠nh v√†o ƒë∆∞·ªùng k·∫ª */
}
    [data-theme='light'] .method-item > .method-content:not([hidden]),
    [data-theme='pastel'] .method-item > .method-content:not([hidden]) {
        border-top-color: rgba(0, 0, 0, 0.1);
    }

    /* Editor container (single pane, Rich Text) */
    .editor-container { height: 350px; }
    .editable-content { height: 100%; border: 1px solid var(--muted); border-radius: 10px; padding: 10px; overflow-y: auto; background: var(--bg); }
    .editable-content:focus-within { border-color: var(--acc); outline: none; }
    .editable-content h4 { color: var(--acc-2); font-size: 1.1em; margin-top: 1.5em; margin-bottom: 0.5em; }
    .editable-content strong, .editable-content b { color: var(--acc); font-weight: 600; }
    .editable-content ol, .editable-content ul { padding-left: 20px; }

    /* Editor toolbar for Methods modal */
    .editor-toolbar { display: flex; gap: 6px; margin-bottom: 6px; padding: 4px; background: var(--muted); border-radius: 8px; }
    .editor-toolbar button { font-weight: bold; width: 32px; height: 32px; padding: 0; }
    .editor-toolbar .btn.ghost:hover { background-color: rgba(var(--acc-rgb, 108, 140, 255), 0.15); }
    .editor-toolbar .btn.ghost.active { background-color: rgba(var(--acc-rgb, 108, 140, 255), 0.25); }
    .color-picker-wrapper { position: relative; }
    .color-palette { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; padding: 6px; border-radius: 8px; border: 1px solid var(--muted); background: var(--panel); box-shadow: var(--shadow); z-index: 10; }
    .color-swatch { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.5); cursor: pointer; transition: transform 0.15s ease; }
    .color-swatch:hover { transform: scale(1.15); }

    /* ========================================================= */
    /* START: C·∫¨P NH·∫¨T GIAO DI·ªÜN TI√äU ƒê·ªÄ KHO TRI TH·ª®C            */
    /* ========================================================= */

    /* S·ª≠ d·ª•ng Flexbox ƒë·ªÉ cƒÉn ch·ªânh ti√™u ƒë·ªÅ v√† c√°c n√∫t tr√™n c√πng m·ªôt h√†ng */
    .method-item > div:first-child {
        display: flex;
        align-items: center;
        justify-content: space-between; /* ƒê·∫©y ti√™u ƒë·ªÅ v√† c√°c n√∫t v·ªÅ hai ph√≠a */
        gap: 8px;
        width: 100%; /* ƒê·∫£m b·∫£o h√†ng ti√™u ƒë·ªÅ chi·∫øm ƒë·ªß chi·ªÅu r·ªông */
    }

    /* Cho ph√©p ti√™u ƒë·ªÅ co gi√£n ƒë·ªÉ chi·∫øm kh√¥ng gian v√† x·ª≠ l√Ω text d√†i */
    .method-item .method-title {
        flex: 1; /* Quan tr·ªçng: Cho ph√©p ti√™u ƒë·ªÅ chi·∫øm h·∫øt kh√¥ng gian tr·ªëng */
        min-width: 0;
        word-break: break-word;
        overflow-wrap: break-word;
        cursor: pointer;
    }

    /* Gi·ªØ l·∫°i quy t·∫Øc ·∫©n/hi·ªán c√°c n√∫t h√†nh ƒë·ªông khi di chu·ªôt */
    .method-item .topic-actions {
        margin-left: 8px; /* Th√™m m·ªôt ch√∫t kho·∫£ng ƒë·ªám b√™n tr√°i */
    }

    .method-item:hover .topic-actions,
    .method-item:focus-within .topic-actions {
        opacity: 1;
        visibility: visible;
    }
    /* ========================================================= */
    /* END: C·∫¨P NH·∫¨T GIAO DI·ªÜN                                  */
    /* ========================================================= */

    /* ========================================================= */
    /* START: S·ª¨A L·ªñI TR√ÄN GIAO DI·ªÜN V·ªöI VƒÇN B·∫¢N D√ÄI (FLEXBOX FIX) */
    /* ========================================================= */
    .topic-title,
    .subtopic-btn,
    .note-content-wrapper,
    .subtopic-todo-list label,
    .method-title,
    .method-item > div:first-child { /* <--- Cho ph√©p header Kho Tri Th·ª©c co l·∫°i */
        min-width: 0; /* Cho ph√©p ph·∫ßn t·ª≠ co l·∫°i nh·ªè h∆°n n·ªôi dung c·ªßa n√≥ */
    }

    .topic-title,
    .subtopic-btn,
    .note-content,
    .subtopic-todo-list label,
    .hist-item > div,
    .method-title { /* <--- B·ªï sung cho Kho Tri Th·ª©c */
        word-break: break-word;      /* T·ª± ƒë·ªông ng·∫Øt c√°c t·ª´ qu√° d√†i */
        overflow-wrap: break-word; /* ƒê·∫£m b·∫£o ng·∫Øt d√≤ng cho chu·ªói d√†i */
    }
    /* ========================================================= */
    /* END: S·ª¨A L·ªñI TR√ÄN GIAO DI·ªÜN V·ªöI VƒÇN B·∫¢N D√ÄI (FLEXBOX FIX) */

    </style>
</head>
<body data-theme="default"> <div class="app" id="app">
    <nav class="app-nav">
        <button class="nav-btn active" id="navBtnTimer" data-view="timer" aria-label="ƒê·ªìng h·ªì">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            <span class="tooltip">ƒê·ªìng h·ªì</span>
        </button>
        <button class="nav-btn" id="navBtnTopics" data-view="topics" aria-label="Ch·ªß ƒë·ªÅ">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
            <span class="tooltip">Ch·ªß ƒë·ªÅ</span>
        </button>
        <button class="nav-btn" id="navBtnStats" data-view="stats" aria-label="Th·ªëng k√™">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
            <span class="tooltip">Th·ªëng k√™</span>
        </button>
        <button class="nav-btn" id="navBtnMethods" data-view="methods" aria-label="Kho Tri Th·ª©c">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.042 21.672L13.684 16.6s.408-1.947 1.25-3.25c.842-1.303 2.002-2.5 3.5-3.5s3.25-1.25 3.25-1.25l5.072 1.358c.27.072.358.42.128.628l-3.35 3.35a.499.499 0 0 1-.594.052l-2.07-1.486c-.44-.314-.82-.53-1.11-.665-.29-.135-.55-.22-.78-.245s-.45.045-.63.155c-.18.11-.3.29-.36.5-.06.21.02.48.18.78.16.3.385.68.665 1.11l1.486 2.07a.499.499 0 0 1-.052.594l-3.35 3.35c-.208.23-.556.142-.628-.128z"/><path d="M12 15l-3-3 3-3 3 3-3 3z"/><path d="M9.01 11.99l-3.005 3.004a.997.997 0 0 1-1.41-1.41l3.004-3.005-3.004-3.005a.997.997 0 0 1 1.41-1.41l3.005 3.004z"/><path d="M5.01 11.99l-3.005 3.004a.997.997 0 0 1-1.41-1.41l3.004-3.005-3.004-3.005a.997.997 0 0 1 1.41-1.41l3.005 3.004z"/></svg>
            <span class="tooltip">Kho Tri Th·ª©c</span>
        </button>
        <button class="nav-btn" id="btnSettings" style="margin-top: auto;" aria-label="C√†i ƒë·∫∑t">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            <span class="tooltip">C√†i ƒë·∫∑t</span>
        </button>
        <button class="nav-btn" id="navBtnGuide" data-view="guide" aria-label="H∆∞·ªõng d·∫´n">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 1 1 5.82 1c0 2-3 2-3 4"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            <span class="tooltip">H∆∞·ªõng d·∫´n</span>
        </button>
    </nav>

    <main class="app-content">
      <header class="app-header panel-bg">
        <div class="row" style="gap:12px; align-items:center; flex:0 1 auto">
          <strong>üìö Pomodoro Study App</strong>
          <span class="badge" id="selectedContext">Ch∆∞a ch·ªçn Ch·ªß ƒë·ªÅ con</span>
        </div>
        <div class="actions">
          <button class="btn ghost small" id="btnDashboard" title="Dashboard T·ªïng quan">üìä T·ªïng Quan </button>
          <a href="https://forms.gle/EfFqBJFTbFtDo5H4A" target="_blank" rel="noopener noreferrer" class="btn ghost small" title="G·ª≠i ph·∫£n h·ªìi c·ªßa b·∫°n">üí¨ Ph·∫£n H·ªìi</a>
          <button class="btn ghost small" id="btnExport" title="Xu·∫•t JSON">‚¨áÔ∏è Xu·∫•t File</button>
          <label class="btn ghost small" for="importFile" title="Nh·∫≠p JSON">‚¨ÜÔ∏è Nh·∫≠p File</label>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
          <button class="btn small" id="btnToggleBg" title="·∫®n/Hi·ªán giao di·ªán">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
          <button class="btn small" id="btnFullscreen" title="To√†n m√†n h√¨nh">‚ÜóÔ∏è</button>
        </div>
      </header>
      

      <div id="view-timer" class="view active">
        <section class="panel panel-bg">
          <div class="timer-header">
            <div id="welcomePanel" class="hidden panel-bg" style="text-align:center; padding: 20px; border-radius: var(--radius); width: 100%;">
                <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi Pomodoro Study App!</h3>
                <p>H√£y b·∫Øt ƒë·∫ßu b·∫±ng c√°ch ch·ªçn m·ªôt <strong>Ch·ªß ƒë·ªÅ con</strong> ho·∫∑c t·∫°o Ch·ªß ƒë·ªÅ/Ch·ªß ƒë·ªÅ con m·ªõi.</p>
                <button class="btn acc" id="btnHelpCreateTopic">Ôºã T·∫°o Ch·ªß ƒë·ªÅ M·ªõi</button>
            </div>
            <div class="presets" role="group" aria-label="Ch·ªçn ch·∫ø ƒë·ªô preset">
                <button id="btnPresetA" class="btn small ghost" data-preset="A"></button>
                <button id="btnPresetB" class="btn small ghost" data-preset="B"></button>
                <button id="btnPresetC" class="btn small ghost" data-preset="C">üåä Flow</button>
            </div>
          </div>
          <hr />
          <div class="timer" aria-live="polite">
            <div class="badge" id="stateBadge">TR·∫†NG TH√ÅI</div>
            
            <div class="timer-circle-container">
              <svg class="timer-svg" viewBox="0 0 100 100">
                  <circle class="timer-circle-bg" cx="50" cy="50" r="45"></circle>
                  <circle class="timer-circle-progress" cx="50" cy="50" r="45"></circle>
              </svg>
              <div id="timeDisplay" class="big-time">00:00</div>
            </div>

            <div class="tiny" id="cycleInfo"></div>

            <div class="tiny" id="breakSuggestionDisplay" style="min-height: 1.5em; font-style: italic; opacity: 0.8; transition: opacity 0.3s ease;"></div>

            <div id="windDownChecklist" class="hidden" style="text-align: left; max-width: 300px; margin: 0 auto; padding: 0 10px;">
              <h4 style="margin: 8px 0 4px; color: var(--acc); text-align: center;">Checklist H·∫° nhi·ªát</h4>
              <ul style="list-style: '‚úì '; margin: 0; padding-left: 20px; color: var(--sub);">
                <li>L∆∞u c√¥ng vi·ªác ƒëang l√†m (Save/Commit).</li>
                <li>Ghi ch√∫ nhanh "Next step".</li>
                <li>D·ªçn d·∫πp kh√¥ng gian l√†m vi·ªác.</li>
              </ul>
            </div>
            
            <div class="controls">
              <button class="btn acc" id="btnStart" aria-label="B·∫Øt ƒë·∫ßu (Space)">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu</button>
              <button class="btn warn hidden" id="btnFinishFlow" aria-label="K·∫øt th√∫c phi√™n l√†m vi·ªác">üßò B·∫Øt ƒë·∫ßu ngh·ªâ</button>
              <button class="btn" id="btnPause" aria-label="T·∫°m d·ª´ng (Space)">‚è∏Ô∏è T·∫°m d·ª´ng</button>
              <button class="btn" id="btnResume" aria-label="Ti·∫øp t·ª•c (Space)">‚èµ Ti·∫øp t·ª•c</button>
              <button class="btn warn" id="btnSkip" aria-label="B·ªè qua (N)">‚è≠Ô∏è B·ªè qua</button>
              <button class="btn danger" id="btnReset">‚Ü∫ ƒê·∫∑t l·∫°i</button>
              <button class="btn acc small hidden" id="btnBreakEarly">üßò Ngh·ªâ s·ªõm</button>
            </div>
            <div class="tiny">Ph√≠m t·∫Øt: <strong>Space</strong> = B·∫Øt ƒë·∫ßu/T·∫°m d·ª´ng/Ti·∫øp t·ª•c, <strong>N</strong> = Ti·∫øp theo/B·ªè qua</div>
          </div>
        </section>

        <section class="panel panel-bg aux-panel">
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="tasks">Nhi·ªám v·ª•</button>
                <button class="tab-btn" data-tab="notes">Ghi ch√∫</button>
                <button class="tab-btn" data-tab="ai">Gemini AI</button>
            </nav>
            <div id="tasks" class="tab-content active">
                <h4 style="margin: 0 0 8px; color: var(--sub);">To-do cho ch·ªß ƒë·ªÅ con n√†y:</h4>
                <ul id="subtopicTasksList" class="subtopic-todo-list"></ul>
                <div class="row" style="gap:8px; margin-top: 8px;">
                    <input type="text" id="newSubtopicTaskInput" placeholder="Th√™m m·ªôt task m·ªõi..." />
                    <button id="btnAddSubtopicTask" class="btn small" style="flex: 0 1 auto;">Th√™m</button>
                </div>
            </div>
            <div id="notes" class="tab-content">
                <div id="generalNotesList" class="notes-list"></div>
                <div class="add-note-area" style="margin-top: 12px;">
                    <textarea id="newGeneralNoteText" placeholder="Th√™m ghi ch√∫ m·ªõi..."></textarea>
                    <div style="text-align: right; margin-top: 8px;">
                        <button class="btn acc small" id="btnAddGeneralNote">Ôºã Th√™m ghi ch√∫</button>
                    </div>
                </div>
            </div>
            <div id="ai" class="tab-content">
                <div class="panel-header" style="margin-bottom: 8px; padding: 0;">
                    <h4 style="margin:0;">Gemini cho: <span id="currentSubtopicNameChat">(ch∆∞a ch·ªçn)</span></h4>
                    <div class="actions">
                        <button id="btnClearChat" class="btn small danger" title="X√≥a l·ªãch s·ª≠">üóëÔ∏è</button>
                    </div>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div id="aiPromptSuggestions" style="display: flex; gap: 6px; margin: 8px 0; flex-wrap: wrap;">
                  <button class="btn small ghost" data-prompt="Gi·∫£i th√≠ch kh√°i ni·ªám ch√≠nh c·ªßa ch·ªß ƒë·ªÅ n√†y">Gi·∫£i th√≠ch kh√°i ni·ªám</button>
                  <button class="btn small ghost" data-prompt="T·∫°o m·ªôt d√†n √Ω chi ti·∫øt cho ch·ªß ƒë·ªÅ n√†y">T·∫°o d√†n √Ω</button>
                  <button class="btn small ghost" data-prompt="Li·ªát k√™ 5 c√¢u h·ªèi √¥n t·∫≠p quan tr·ªçng v·ªÅ ch·ªß ƒë·ªÅ n√†y">T·∫°o c√¢u h·ªèi √¥n t·∫≠p</button>
                </div>
                <div class="chat-input-area">
                  <input type="text" id="chatInput" placeholder="H·ªèi Gemini ƒëi·ªÅu g√¨ ƒë√≥..." />
                  <button id="btnSendMessage" class="btn acc">G·ª≠i</button>
                </div>
            </div>
        </section>
      </div>

      <div id="view-topics" class="view">
        <div class="panel panel-bg">
            <div class="row" style="gap:8px; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0;">Qu·∫£n l√Ω Ch·ªß ƒë·ªÅ</h3>
                <button class="btn small acc" id="btnAddTopic" style="margin-left: auto;">Ôºã Th√™m Ch·ªß ƒë·ªÅ</button>
            </div>
            <div id="topicsList"></div>
            <div class="footer-note">Nh·∫•p m≈©i t√™n ƒë·ªÉ m·ªü/ƒë√≥ng danh s√°ch ch·ªß ƒë·ªÅ con.</div>
        </div>
      </div>
      
      <div id="view-stats" class="view">
      <script>
        window.addEventListener('DOMContentLoaded', () => {
          try {
            const topicsView = document.querySelector('#view-topics');
            if (!topicsView) return;
            const header = topicsView.querySelector('.row h3');
            if (header) header.textContent = 'Qu·∫£n l√Ω Ch·ªß ƒë·ªÅ';
            const addBtn = topicsView.querySelector('#btnAddTopic');
            if (addBtn) addBtn.textContent = '+ Th√™m Ch·ªß ƒë·ªÅ';
            const note = topicsView.querySelector('.footer-note');
            if (note) note.textContent = 'Nh·∫•p m≈©i t√™n ƒë·ªÉ m·ªü/ƒë√≥ng danh s√°ch ch·ªß ƒë·ªÅ con.';
          } catch (e) {}
        });
      </script>
        <section class="panel panel-bg">
            <h3 style="margin:0 0 12px 0;">Th·ªëng k√™ & L·ªãch s·ª≠ ‚Äî <span id="currentSubtopicName">(ch∆∞a ch·ªçn)</span></h3>
            <div class="stats-grid">
              <div class="stat-card"><h4>T·ªïng th·ªùi gian</h4><div class="stat-value" id="statTotal">0 ph√∫t</div></div>
              <div class="stat-card"><h4>Phi√™n</h4><div class="stat-value" id="statSessions">0</div></div>
              <div class="stat-card"><h4>Nhi·ªám v·ª• Ho√†n th√†nh</h4><div class="stat-value" id="statTasks">0</div></div>
            </div>
            <div style="margin-top:12px">
              <h4 style="margin:4px 0 8px; color:var(--sub)">L·ªãch s·ª≠ (L√ÄM VI·ªÜC)</h4>
              <div class="history" id="historyList"></div>
            </div>
        </section>
      </div>
      
      <div id="view-methods" class="view">
        <div class="panel panel-bg">
            <div class="row" style="gap:8px; align-items: center; margin-bottom: 12px;">
                <h3 style="margin:0;">üí° Kho Tri Th·ª©c C√° Nh√¢n H√≥a</h3>
                <button class="btn small acc" id="btnAddMethod" style="margin-left: auto;">Ôºã Th√™m tri th·ª©c</button>
            </div>
            <p class="tiny" style="margin-top: -8px; margin-bottom: 20px;">Nh·∫•p v√†o t·ª´ng m·ª•c ƒë·ªÉ xem chi ti·∫øt.</p>
            <div class="methods-container"></div>
        </div>
      </div>

      <div id="view-guide" class="view">
          <div class="panel panel-bg">
              <h3 style="margin-top: 0;">üìñ Kh√°m Ph√° Pomodoro Study App</h3>
              <p>
                  Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi kh√¥ng gian h·ªçc t·∫≠p ƒë∆∞·ª£c thi·∫øt k·∫ø d√†nh ri√™ng cho s·ª± t·∫≠p trung v√† hi·ªáu qu·∫£. H√£y c√πng kh√°m ph√° nh·ªØng t√≠nh nƒÉng s·∫Ω ƒë·ªìng h√†nh c√πng b·∫°n tr√™n h√†nh tr√¨nh chinh ph·ª•c tri th·ª©c.
              </p>

              <h4>üöÄ Kh·ªüi ƒê·∫ßu Nhanh Ch·ªâ Trong 4 B∆∞·ªõc</h4>
              <p>ƒê·ªÉ h√†nh tr√¨nh c·ªßa b·∫°n lu√¥n m·∫°ch l·∫°c, m·ªçi th·ª© trong ·ª©ng d·ª•ng ƒë∆∞·ª£c s·∫Øp x·∫øp theo c·∫•u tr√∫c <strong>Ch·ªß ƒë·ªÅ L·ªõn ‚Üí Ch·ªß ƒë·ªÅ con</strong>.</p>
              <ol>
                  <li>M·ªü m·ª•c <strong>üìö Ch·ªß ƒë·ªÅ</strong> t·ª´ thanh ƒëi·ªÅu h∆∞·ªõng b√™n c·∫°nh.</li>
                  <li>Nh·∫•n <strong>Ôºã Th√™m Ch·ªß ƒë·ªÅ</strong> ƒë·ªÉ t·∫°o m·ªôt lƒ©nh v·ª±c l·ªõn (v√≠ d·ª•: "Ti·∫øng Anh Giao Ti·∫øp").</li>
                  <li>B√™n c·∫°nh ch·ªß ƒë·ªÅ v·ª´a t·∫°o, nh·∫•n <strong>Ôºã Th√™m</strong> ƒë·ªÉ t·∫°o m·ªôt ch·ªß ƒë·ªÅ con, chi ti·∫øt h∆°n (v√≠ d·ª•: "B√†i 1: Luy·ªán ph√°t √¢m IPA").</li>
                  <li>Ch·ªçn ch·ªß ƒë·ªÅ con ƒë√≥. Gi·ªù ƒë√¢y, b·∫°n ƒë√£ s·∫µn s√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu phi√™n h·ªçc ƒë·∫ßu ti√™n c·ªßa m√¨nh!</li>
              </ol>

              <hr />
              <h4>‚ú® Nh·ªØng T√≠nh NƒÉng ƒê√°ng Ch√∫ √ù</h4>

              <h4>C√°c Ch·∫ø ƒê·ªô ƒê·ªìng H·ªì Linh Ho·∫°t ‚è±Ô∏è</h4>
              <p>·ª®ng d·ª•ng kh√¥ng ch·ªâ c√≥ Pomodoro. H√£y ch·ªçn ph∆∞∆°ng ph√°p ph√π h·ª£p v·ªõi c√¥ng vi·ªác c·ªßa b·∫°n:</p>
              <ul>
                  <li><strong>Pomodoro C·ªï ƒêi·ªÉn (Ki·ªÉu A/B):</strong> L√†m vi·ªác t·∫≠p trung trong c√°c phi√™n ƒë·ªãnh s·∫µn (v√≠ d·ª•: 25 ph√∫t l√†m, 5 ph√∫t ngh·ªâ) ƒë·ªÉ x√¢y d·ª±ng k·ª∑ lu·∫≠t v√† nh·ªãp ƒë·ªô.</li>
                  <li><strong>Ch·∫ø ƒë·ªô Flowtime (Ki·ªÉu üåä Flow):</strong> D√†nh cho c√¥ng vi·ªác c·∫ßn d√≤ng ch·∫£y s√¢u. ƒê·ªìng h·ªì s·∫Ω ƒë·∫øm l√™n, cho ph√©p b·∫°n l√†m vi·ªác ƒë·∫øn khi t·ª± c·∫£m th·∫•y c·∫ßn ngh·ªâ. Th·ªùi gian ngh·ªâ s·∫Ω ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t d·ª±a tr√™n th·ªùi gian b·∫°n ƒë√£ l√†m vi·ªác.</li>
                  <li><strong>ƒê·ªám "H·∫° nhi·ªát" (Wind-down):</strong> M·ªôt kho·∫£ng ƒë·ªám t√πy ch·ªânh gi·ªØa l√∫c l√†m v√† l√∫c ngh·ªâ, gi√∫p b·∫°n k·∫øt th√∫c c√¥ng vi·ªác ƒëang d·ªü, ghi ch√∫ l·∫°i "b∆∞·ªõc ti·∫øp theo" v√† chuy·ªÉn tr·∫°ng th√°i m·ªôt c√°ch m∆∞·ª£t m√†, kh√¥ng b·ªã c·∫Øt ngang ƒë·ªôt ng·ªôt.</li>
              </ul> 
              <h4>Kho Tri Th·ª©c Theo T·ª´ng Ch·ªß ƒê·ªÅ Con üí°</h4>
<p>
    M·ªói m·ªôt <strong>Ch·ªß ƒë·ªÅ con</strong> gi·ªù ƒë√¢y s·∫Ω c√≥ m·ªôt "Kho Tri Th·ª©c" ho√†n to√†n ri√™ng bi·ªát. T√≠nh nƒÉng n√†y cho ph√©p b·∫°n x√¢y d·ª±ng m·ªôt th∆∞ vi·ªán ki·∫øn th·ª©c chuy√™n s√¢u, ch·ªâ li√™n quan ƒë·∫øn lƒ©nh v·ª±c b·∫°n ƒëang h·ªçc.
</p>
<p>
    V√≠ d·ª•, c√°c ghi ch√∫ v√† ph∆∞∆°ng ph√°p h·ªçc "Ti·∫øng Anh Giao Ti·∫øp" s·∫Ω ch·ªâ xu·∫•t hi·ªán khi b·∫°n ch·ªçn ch·ªß ƒë·ªÅ con ƒë√≥, v√† s·∫Ω kh√¥ng b·ªã l·∫´n v·ªõi c√°c c√¥ng th·ª©c trong ch·ªß ƒë·ªÅ con "Gi·∫£i t√≠ch To√°n h·ªçc".
</p>
<p>
    V·ªõi tr√¨nh so·∫°n th·∫£o m·∫°nh m·∫Ω, b·∫°n v·∫´n c√≥ th·ªÉ d·ªÖ d√†ng ƒë·ªãnh d·∫°ng ti√™u ƒë·ªÅ, in ƒë·∫≠m, t·∫°o danh s√°ch v√† l√†m n·ªïi b·∫≠t nh·ªØng th√¥ng tin quan tr·ªçng nh·∫•t cho t·ª´ng m√¥n h·ªçc c·ªßa m√¨nh.
</p>

              <h4>Qu·∫£n L√Ω Ch·ªß ƒê·ªÅ Tr·ª±c Quan</h4>
              <p>D·ªÖ d√†ng s·∫Øp x·∫øp c√°c m·ª•c ti√™u h·ªçc t·∫≠p c·ªßa b·∫°n. S·ª≠ d·ª•ng thao t√°c <strong>k√©o v√† th·∫£</strong> ƒë·ªÉ s·∫Øp x·∫øp l·∫°i th·ª© t·ª± c√°c Ch·ªß ƒë·ªÅ ho·∫∑c di chuy·ªÉn m·ªôt Ch·ªß ƒë·ªÅ con sang m·ªôt lƒ©nh v·ª±c kh√°c m·ªôt c√°ch tr·ª±c quan.</p>

              <h4>Nhi·ªám V·ª• & Ghi Ch√∫ T√≠ch H·ª£p üìù</h4>
              <p>Ngay trong m√†n h√¨nh ƒë·ªìng h·ªì, b·∫°n c√≥ th·ªÉ t·∫°o danh s√°ch vi·ªác c·∫ßn l√†m (to-do) cho t·ª´ng ch·ªß ƒë·ªÅ con ho·∫∑c ghi l·∫°i nh·ªØng √Ω t∆∞·ªüng ch·ª£t n·∫£y ra m√† kh√¥ng l√†m gi√°n ƒëo·∫°n d√≤ng ch·∫£y c√¥ng vi·ªác.</p>

              <h4>Ch·∫ø ƒê·ªô Zen üßò</h4>
              <p>Khi c·∫ßn t·∫≠p trung tuy·ªát ƒë·ªëi, h√£y nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng con m·∫Øt (üëÅÔ∏è). Giao di·ªán s·∫Ω ·∫©n ƒëi, ch·ªâ ƒë·ªÉ l·∫°i h√¨nh n·ªÅn v√† chi·∫øc ƒë·ªìng h·ªì. Trong ch·∫ø ƒë·ªô n√†y, b·∫°n c√≥ th·ªÉ <strong>k√©o th·∫£ ƒë·ªìng h·ªì</strong> ƒë·∫øn b·∫•t k·ª≥ v·ªã tr√≠ n√†o tr√™n m√†n h√¨nh ƒë·ªÉ c√≥ m·ªôt kh√¥ng gian l√†m vi·ªác g·ªçn g√†ng nh·∫•t.</p>

              <h4>Th·ªëng K√™ & C·ªôt M·ªëc üèÜ</h4>
              <p>Theo d√µi h√†nh tr√¨nh c·ªßa b·∫°n qua nh·ªØng con s·ªë bi·∫øt n√≥i. ·ª®ng d·ª•ng s·∫Ω t·ª± ƒë·ªông ghi nh·∫≠n v√† ch√∫c m·ª´ng khi b·∫°n ƒë·∫°t ƒë∆∞·ª£c nh·ªØng c·ªôt m·ªëc quan tr·ªçng v·ªÅ th·ªùi gian t·∫≠p trung, bi·∫øn m·ªói n·ªó l·ª±c th√†nh m·ªôt th√†nh t·ª±u ƒë√°ng t·ª± h√†o.</p>

              <hr />
              <h4>‚å®Ô∏è Ph√≠m T·∫Øt Th√¥ng Minh</h4>
              <ul>
                  <li><kbd>Space</kbd>: B·∫Øt ƒë·∫ßu / T·∫°m d·ª´ng / Ti·∫øp t·ª•c phi√™n h·ªçc.</li>
                  <li><kbd>N</kbd>: B·ªè qua phi√™n l√†m vi·ªác ho·∫∑c ngh·ªâ hi·ªán t·∫°i.</li>
                  <li><kbd>Esc</kbd>: ƒê√≥ng c√°c c·ª≠a s·ªï ƒëang m·ªü (nh∆∞ C√†i ƒë·∫∑t).</li>
              </ul>

              <hr />
              <h4>üõ†Ô∏è C√†i ƒê·∫∑t N√¢ng Cao & T√≠ch H·ª£p</h4>

              <h4>Tr·ª£ L√Ω Gemini AI üß†</h4>
              <p>Bi·∫øn ·ª©ng d·ª•ng th√†nh m·ªôt ng∆∞·ªùi b·∫°n ƒë·ªìng h√†nh th√¥ng minh. Ngo√†i vi·ªác h·ªèi ƒë√°p, b·∫°n c√≤n c√≥ th·ªÉ:</p>
              <ul>
                  <li><strong>T·ª± ƒë·ªông ƒê·ªãnh d·∫°ng Th√¥ng minh:</strong> Khi so·∫°n th·∫£o trong m·ª•c "Ph∆∞∆°ng ph√°p", h√£y ƒë·ªÉ AI t·ª± ƒë·ªông ph√¢n t√≠ch v√† ƒë·ªãnh d·∫°ng vƒÉn b·∫£n th√¥ c·ªßa b·∫°n‚Äît·ª± nh·∫≠n di·ªán ti√™u ƒë·ªÅ, c√°c √Ω ch√≠nh c·∫ßn in ƒë·∫≠m v√† danh s√°ch.</li>
                  <li><strong>Thi·∫øt l·∫≠p:</strong> Truy c·∫≠p Google AI Studio ƒë·ªÉ t·∫°o API Key mi·ªÖn ph√≠ v√† d√°n v√†o √¥ "Gemini API Key" trong C√†i ƒë·∫∑t c·ªßa ·ª©ng d·ª•ng.</li>
              </ul>

              <h4>T√πy Bi·∫øn Giao Di·ªán & √Çm Thanh üé®</h4>
              <p>Bi·∫øn kh√¥ng gian h·ªçc t·∫≠p th√†nh c·ªßa ri√™ng b·∫°n:</p>
              <ul>
                  <li><strong>Nhi·ªÅu Theme & H√¨nh n·ªÅn:</strong> L·ª±a ch·ªçn gi·ªØa c√°c theme c√≥ s·∫µn (S√°ng, T·ªëi, Pastel...) ho·∫∑c <strong>t·∫£i l√™n h√¨nh n·ªÅn c·ªßa ri√™ng b·∫°n</strong> ƒë·ªÉ t·∫°o c·∫£m h·ª©ng.</li>
                  <li><strong>√Çm b√°o T√πy ch·ªânh:</strong> B·∫°n c√≥ th·ªÉ <strong>t·∫£i l√™n c√°c file √¢m thanh (.mp3, .wav...) c·ªßa ri√™ng m√¨nh</strong> ƒë·ªÉ s·ª≠ d·ª•ng l√†m chu√¥ng b√°o cho c√°c phi√™n l√†m vi·ªác v√† ngh·ªâ ng∆°i.</li>
              </ul>

              <h4>Nh·∫°c N·ªÅn YouTube üé∂</h4>
              <p>T·∫°o kh√¥ng gian h·ªçc t·∫≠p ho√†n h·∫£o b·∫±ng c√°ch ph√°t m·ªôt video ho·∫∑c danh s√°ch ph√°t YouTube l√†m nh·∫°c n·ªÅn. D√°n ƒë∆∞·ªùng d·∫´n (URL) v√†o √¥ "Nh·∫°c n·ªÅn YouTube" trong C√†i ƒë·∫∑t.</p>

              <h4>An To√†n D·ªØ Li·ªáu: Sao L∆∞u & Ph·ª•c H·ªìi üõ°Ô∏è</h4>
              <p>·ª®ng d·ª•ng t·ª± ƒë·ªông sao l∆∞u ti·∫øn tr√¨nh c·ªßa b·∫°n m·ªói ng√†y. B·∫°n c√≥ th·ªÉ t√πy ch·ªânh s·ªë ng√†y l∆∞u gi·ªØ b·∫£n sao l∆∞u v√† ph·ª•c h·ªìi d·ªØ li·ªáu t·ª´ m·ªôt ng√†y trong qu√° kh·ª© n·∫øu c·∫ßn. ‚ö†Ô∏è <strong>C·∫£nh b√°o:</strong> Ph·ª•c h·ªìi s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i.</p>
          </div>
      </div>
    </main>
  </div>

  <div class="modal" id="modalMilestone" role="dialog" aria-modal="true" aria-labelledby="milestoneTitle">
    <div class="modal-card" style="width: min(600px, 94vw);">
        <h3 id="milestoneTitle">üéâ Ch√∫c m·ª´ng B·∫°n!</h3>
        <p id="milestoneMessage" style="white-space: pre-wrap; line-height: 1.6;"></p>
        <div class="row" style="justify-content:flex-end; margin-top:12px">
            <button class="btn acc" id="btnMilestoneClose">Ti·∫øp t·ª•c h√†nh tr√¨nh!</button>
        </div>
    </div>
  </div>
  <div class="modal" id="modalSettings" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-card">
          <h3 id="settingsTitle">‚öôÔ∏è C√†i ƒë·∫∑t</h3>
          <nav class="tab-nav">
              <button class="tab-btn active" data-tab="settings-timer">ƒê·ªìng h·ªì</button>
              <button class="tab-btn" data-tab="settings-ui">Giao di·ªán & √Çm thanh</button>
              <button class="tab-btn" data-tab="settings-integrations">T√≠ch h·ª£p</button>
          </nav>
          <div class="settings-content">
              <div id="settings-timer" class="tab-content active" style="flex-direction:column; gap:20px;">
                  <div class="row" id="timerPresetSelector" style="margin-bottom:16px;">
                      <button class="btn acc" data-preset-target="A"> Ki·ªÉu A </button>
                      <button class="btn ghost" data-preset-target="B"> Ki·ªÉu B </button>
                      <button class="btn ghost" data-preset-target="C"> Ki·ªÉu C (Flow) </button>
                  </div>
                  <div id="settings-pomodoro">
                      <h4>Th·ªùi l∆∞·ª£ng Pomodoro</h4>
                      <div class="row">
                          <label>L√ÄM VI·ªÜC (ph√∫t)<input type="number" id="set_work" min="1" /></label>
                          <label>H·∫† NHI·ªÜT (ph√∫t)<input type="number" id="set_winddown" min="0" /></label>
                          <label>NGH·ªà NG·∫ÆN (ph√∫t)<input type="number" id="set_short" min="1" /></label>
                          <label>NGH·ªà D√ÄI (ph√∫t)<input type="number" id="set_long" min="1" /></label>
                      </div>
                      <div class="row">
                          <label>Chu k·ª≥ Pomodoro<input type="number" id="set_cycles" min="1" /></label>
                          <label>Chu k·ª≥ ngh·ªâ d√†i<input type="number" id="set_interval" min="2" /></label>
                      </div>
                  </div>
                  <div id="settings-flowtime" class="hidden">
                      <h4>Flowtime</h4>
                      <div class="row">
                          <label>T·ª∑ l·ªá ngh·ªâ (L√†m vi·ªác / X)
                              <input type="number" id="set_flowRatio" min="1" max="20" />
                          </label>
                      </div>
                      <p class="tiny" style="margin-top: 4px;">G·ª£i √Ω: Th·ªùi gian ngh·ªâ = t·ªïng th·ªùi gian l√†m vi·ªác / X. M·∫∑c ƒë·ªãnh l√† 5.</p>
                  </div>
                  <div class="settings-row-toggle">
                          <label for="set_autoStartNext">T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu phi√™n ti·∫øp theo</label>
                          <label class="toggle-switch">
                              <input type="checkbox" id="set_autoStartNext">
                              <span class="slider"></span>
                          </label>
                      </div>
                  <div class="settings-row-toggle">
                          <label for="set_enableWinddown">B·∫≠t H·∫° nhi·ªát sau phi√™n l√†m</label>
                          <label class="toggle-switch">
                              <input type="checkbox" id="set_enableWinddown">
                              <span class="slider"></span>
                          </label>
                      </div>
                  <div class="settings-row-toggle">
                          <label for="set_enableSessionNotes">Nh·∫Øc ghi ch√∫ sau m·ªói phi√™n</label>
                          <label class="toggle-switch">
                              <input type="checkbox" id="set_enableSessionNotes">
                              <span class="slider"></span>
                          </label>
                      </div>
              </div>
              <div id="settings-ui" class="tab-content" style="flex-direction: column; gap: 20px;">
                  <div class="row" style="margin-top: 12px; align-items: center; gap: 12px;">
                      <label data-i18n-key="settingsLanguage">Ng√¥n ng·ªØ</label>
                      <select id="set_language" style="min-width: 180px;">
                          <option value="vi" data-i18n-key="languageVi">Ti·∫øng Vi·ªát</option>
                          <option value="en" data-i18n-key="languageEn">English</option>
                      </select>
                  </div>
                  <div>
                      <h4>Giao di·ªán</h4>
                      <div class="row">
                          <label>Theme Giao Di·ªán
                                <select id="set_theme_color">
                                    <option value="default">M·∫∑c ƒë·ªãnh (Dark Blue)</option>
                                    <option value="light">Light - Tr√† S·ªØa</option>
                                    <option value="pastel">Pastel - D·ªÖ th∆∞∆°ng</option>
                                    <option value="lofi">Lofi Study Room</option>
                                    <option value="space">Space Station</option>
                                </select>
                          </label>
                      </div>
                      <div class="row" style="margin-top: 12px;">
                          <label>Ch·∫ø ƒë·ªô hi·ªÉn th·ªã n·ªÅn
                              <select id="set_backgroundMode">
                                  <option value="cover">L·∫•p ƒë·∫ßy (M·∫∑c ƒë·ªãnh)</option>
                                  <option value="contain">V·ª´a v·∫∑n (S·∫Øc n√©t)</option>
                                  <option value="auto">K√≠ch th∆∞·ªõc g·ªëc (L·∫∑p l·∫°i)</option>
                              </select>
                          </label>
                      </div>
                      <div class="row" style="margin-top: 12px;">
                          <label style="flex: 1;">H√¨nh n·ªÅn</label>
                          <div style="flex: 2; display: flex; gap: 8px;">
                              <label class="btn small ghost" for="uploadBg" style="flex: 1;">T·∫£i ·∫£nh m·ªõi</label>
                              <input type="file" id="uploadBg" accept="image/*" class="hidden" />
                              <button class="btn small danger" id="btnClearBg" style="flex: 1;">X√≥a n·ªÅn</button>
                          </div>
                      </div>
                      <div class="row">
                          <label style="flex: 1;">ƒê·ªô trong su·ªët c·ªßa n·ªÅn</label>
                          <input type="range" id="set_panelOpacity" min="0.1" max="1" step="0.05" style="flex: 2;">
                      </div>
                      
                      
                   </div>
                  
                   <div>
                      <h4>√Çm thanh</h4>
                      
                      <div class="row">
                          <label style="flex: 1;">√Çm l∆∞·ª£ng (0‚Äì1)
                              <input type="number" id="set_volume" step="0.05" min="0" max="1"/>
                          </label>
                          <button class="btn" id="btnTestSound" style="flex-grow: 0; align-self: flex-end;">Test</button>
                      </div>

                      <div class="row" style="margin-top: 12px;">
                          <label style="flex: 1;">Ki·ªÉu √¢m b√°o (M·∫∑c ƒë·ªãnh)
                              <select id="set_theme">
                                  <option value="beep">Beep</option>
                                  <option value="chime">Chime</option>
                              </select>
                          </label>
                      </div>

                      <div class="settings-row-toggle" style="margin-top: 16px;">
                          <label for="set_useCustomSounds">S·ª≠ d·ª•ng √¢m b√°o t√πy ch·ªânh</label>
                          <label class="toggle-switch">
                              <input type="checkbox" id="set_useCustomSounds">
                              <span class="slider"></span>
                          </label>
                      </div>

                      <div id="customSoundsContainer" class="hidden">
                          
                          <div class="row custom-sound-row">
                              <label for="uploadSoundWork" class="custom-sound-label">√Çm b√°o h·∫øt L√ÄM VI·ªÜC</label>
                              <label class="btn small ghost" for="uploadSoundWork" title="T·∫£i l√™n t·ªáp √¢m b√°o L√ÄM VI·ªÜC">T·∫£i l√™n</label>
                              <input type="file" id="uploadSoundWork" accept="audio/*" class="hidden" />
                          </div>
                          
                          <div class="row custom-sound-row">
                              <label for="uploadSoundBreak" class="custom-sound-label">√Çm b√°o h·∫øt NGH·ªà NG·∫ÆN</label>
                              <label class="btn small ghost" for="uploadSoundBreak" title="T·∫£i l√™n t·ªáp √¢m b√°o NGH·ªà NG·∫ÆN">T·∫£i l√™n</label>
                              <input type="file" id="uploadSoundBreak" accept="audio/*" class="hidden" />
                          </div>
                          
                          <div class="row custom-sound-row">
                              <label for="uploadSoundLong" class="custom-sound-label">√Çm b√°o h·∫øt NGH·ªà D√ÄI</label>
                              <label class="btn small ghost" for="uploadSoundLong" title="T·∫£i l√™n t·ªáp √¢m b√°o NGH·ªà D√ÄI">T·∫£i l√™n</label>
                              <input type="file" id="uploadSoundLong" accept="audio/*" class="hidden" />
                          </div>

                      </div>
                  </div>
              </div>
              <div id="settings-integrations" class="tab-content" style="flex-direction: column; gap: 20px;">
                  <div>
                      <h4>T√≠ch h·ª£p AI</h4>
                      <label>Gemini API Key
                          <input type="password" id="set_apiKey" placeholder="D√°n API Key c·ªßa b·∫°n v√†o ƒë√¢y..." />
                      </label>
                      <div class="tiny">C·∫ßn c√≥ ƒë·ªÉ s·ª≠ d·ª•ng c√°c t√≠nh nƒÉng AI. L·∫•y key mi·ªÖn ph√≠ t·∫°i <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.</div>
                  </div>
                  <div>
                      <h4>üéµ Nh·∫°c n·ªÅn YouTube</h4>
                      <div class="row" style="gap:8px; align-items:center;">
                          <input type="text" id="set_youtubeUrl" placeholder="D√°n link YouTube v√†o ƒë√¢y..." style="flex:1;">
                          </div>
                      <div id="ytUrlFeedback" class="tiny" style="min-height: 1.2em; padding: 4px 0;"></div>
                      <div class="row" style="margin-top: 4px;">
                          <label style="flex: 0 1 auto; display: flex; align-items: center; gap: 8px; font-size: 14px;">
                              <input type="checkbox" id="set_ytThumbAsBg">
                              <span>D√πng ·∫£nh b√¨a video l√†m n·ªÅn</span>
                          </label>
                      </div>
                      <div class="row" style="margin-top: 8px;">
                          <button id="btnToggleYtSound" class="btn small" style="flex:0 1 auto;" title="D·ª´ng s·∫Ω kh√¥ng t·ª± ph√°t l·∫°i cho ƒë·∫øn khi b·∫°n b·∫•m ‚ñ∂Ô∏è">‚ñ∂Ô∏è</button>
                          <input type="range" id="ytSoundVolume" min="0" max="100" step="1" value="80" style="flex:1;">
                      </div>
                      <div class="tiny" style="text-align:center; margin-top:4px;">√Çm l∆∞·ª£ng</div>
                  </div>
                  <div>
                      <h4>üõ°Ô∏è C√†i ƒë·∫∑t sao l∆∞u</h4>
                      <div class="row">
                          <label>S·ªë ng√†y sao l∆∞u c·∫ßn gi·ªØ l·∫°i
                               <input type="number" id="set_backupDays" min="1" max="30" />
                          </label>
                      </div>
                  </div>
                  <div>
                      <h4>üõ°Ô∏è Ph·ª•c h·ªìi d·ªØ li·ªáu</h4>
                      <p class="tiny">Ph·ª•c h·ªìi d·ªØ li·ªáu t·ª´ m·ªôt b·∫£n sao l∆∞u t·ª± ƒë·ªông h√†ng ng√†y. H√†nh ƒë·ªông n√†y s·∫Ω ghi ƒë√® l√™n d·ªØ li·ªáu hi·ªán t·∫°i c·ªßa b·∫°n.</p>
                      <div class="row">
                          <select id="backupList" style="flex: 3;"></select>
                          <button id="btnRestoreBackup" class="btn warn small" style="flex: 1;">Ph·ª•c h·ªìi</button>
                      </div>
                  </div>
              </div>
          </div>
          <div class="row" style="margin-top:16px; justify-content:flex-end">
              <button class="btn ghost" id="btnDefaults">M·∫∑c ƒë·ªãnh</button>
              <button class="btn acc" id="btnSaveSettings">L∆∞u</button>
              <button class="btn" id="btnCloseSettings">ƒê√≥ng</button>
          </div>
      </div>
  </div>

  <div class="modal" id="modalNote" role="dialog" aria-modal="true" aria-labelledby="noteTitle">
    <div class="modal-card">
      <h3 id="noteTitle">üìù Ghi ch√∫ cho phi√™n v·ª´a ho√†n th√†nh</h3>
      <div class="row"><textarea id="noteText" placeholder="B·∫°n h·ªçc ƒë∆∞·ª£c g√¨? Kh√≥ khƒÉn? Next steps?"></textarea></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px; gap: 12px;">
        <button class="btn" id="btnSummarizeNote">‚ú® T√≥m t·∫Øt & G·ª£i √Ω</button>
        <button class="btn" id="btnSkipNote">B·ªè qua</button>
        <button class="btn acc" id="btnSaveNote">L∆∞u ghi ch√∫</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalGeneric" role="dialog" aria-modal="true" aria-labelledby="genericTitle">
      <div class="modal-card" style="width: min(450px, 94vw);">
          <h3 id="genericTitle">Ti√™u ƒë·ªÅ</h3>
          <p id="genericMessage" class="hidden"></p>
          <input type="text" id="genericInput" class="hidden" />
          <div class="row" style="justify-content:flex-end; margin-top:12px">
              <button class="btn" id="btnGenericCancel">H·ªßy</button>
              <button class="btn acc" id="btnGenericOk">OK</button>
          </div>
      </div>
  </div>
  
  <div class="modal" id="modalDashboard" role="dialog" aria-modal="true" aria-labelledby="dashboardTitle">
    <div class="modal-card" style="width: min(800px, 95vw);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 id="dashboardTitle">üìä T·ªïng quan</h3>
            <button class="btn ghost small" id="btnCloseDashboard">ƒê√≥ng</button>
        </div>
        <p class="tiny">T·ªïng h·ª£p th·ªùi gian v√† s·ªë phi√™n ƒë√£ ho√†n th√†nh tr√™n t·∫•t c·∫£ c√°c ch·ªß ƒë·ªÅ.</p>
        <div id="dashboardContent" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <div class="modal" id="modalMethodEditor" role="dialog" aria-modal="true">
    <div class="modal-card" style="width: min(800px, 95vw);">
      <h3 id="methodEditorTitle">Ch·ªânh-s·ª≠a Ph∆∞∆°ng-ph√°p</h3>
      
      <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 12px;">
        <input type="hidden" id="methodEditorId">
        <label>Ti√™u-ƒë·ªÅ<input type="text" id="methodEditorTitleInput"></label>
        
        <label>N·ªôi-dung</label>
        <div class="editor-toolbar">
          <button id="toolH4" class="btn small ghost" title="Ti√™u-ƒë·ªÅ nh·ªè">H</button>
          <button id="toolBold" class="btn small ghost" title="In ƒë·∫≠m">B</button>
          <button id="toolItalic" class="btn small ghost" title="In nghi√™ng">I</button>
          <button id="toolList" class="btn small ghost" title="Danh-s√°ch">1.</button>
          <button id="toolBullet" class="btn small ghost" title="Danh s√°ch ch·∫•m tr√≤n">‚Ä¢</button>

          <div class="color-picker-wrapper">
            <button id="toolColor" class="btn small ghost" title="M√†u ch·ªØ">A</button>
            <div class="color-palette hidden">
              <button class="color-swatch" style="background-color: var(--text);" data-color="var(--text)" title="M√†u ch·ªØ m·∫∑c ƒë·ªãnh"></button>
              <button class="color-swatch" style="background-color: var(--acc);" data-color="var(--acc)" title="M√†u nh·∫•n m·∫°nh"></button>
              <button class="color-swatch" style="background-color: var(--acc-2);" data-color="var(--acc-2)" title="M√†u t√≠ch c·ª±c"></button>
              <button class="color-swatch" style="background-color: var(--warn);" data-color="var(--warn)" title="M√†u c·∫£nh b√°o"></button>
              <button class="color-swatch" style="background-color: var(--danger);" data-color="var(--danger)" title="M√†u nguy hi·ªÉm"></button>
              <button class="color-swatch" style="background-color: var(--purple);" data-color="var(--purple)" title="M√†u t√≠m"></button>
            </div>
          </div>
        </div>

        <div class="editor-container">
            <div id="methodEditorContentInput" class="editable-content" contenteditable="true"></div>
        </div>

      </div>

      <div class="row" style="justify-content:space-between; margin-top:16px">
        <button id="btnAutoFormat" class="btn small" disabled title="T√≠nh nƒÉng n√†y y√™u c·∫ßu Gemini API Key">‚ú® T·ª± ƒë·ªông ƒë·ªãnh d·∫°ng</button>
        <div>
          <button class="btn" id="btnCancelMethodEditor">H·ªßy</button>
          <button class="btn acc" id="btnSaveMethod">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>
  <audio id="audioWorkEnd"></audio>
  <audio id="audioBreakEnd"></audio>
  <audio id="audioLongEnd"></audio>
  <div id="youtube-player-container"></div>

  <div id="draggableTimer" class="draggable-timer">00:00</div>

  <div id="soundPermissionBar" class="sound-permission-bar" role="alert" aria-live="polite">
    <span class="msg">Nh·∫•n "B·∫≠t √¢m thanh" ƒë·ªÉ cho ph√©p ph√°t nh·∫°c n·ªÅn.</span>
    <button id="btnEnableSound" class="btn small acc">B·∫≠t √¢m thanh</button>
  </div>
<!-- YouTube Iframe API is loaded dynamically when needed -->
<!-- === START: Inline Minimal Sortable (Offline-Safe) === -->
<script>
// Minimal Sortable shim for offline single-file usage.
// Supports: draggable selector, cross-list via same group, onEnd callback.
(function(){
  if (window.Sortable) return; // Respect existing if loaded
  const DND = { src: null, from: null, selector: null, group: null };
  function makeDraggable(container, selector){
    Array.from(container.querySelectorAll(selector)).forEach(el => {
      try { el.setAttribute('draggable','true'); } catch(_) {}
    });
  }
  function closestItem(e, selector){
    const t = e.target && e.target.closest ? e.target.closest(selector) : null;
    return t || null;
  }
  function Sortable(container, opts){
    this.el = container;
    this.options = opts || {};
    const selector = this.options.draggable || '*';
    const group = this.options.group || null;
    makeDraggable(container, selector);
    const handleDragStart = (e) => {
      const item = closestItem(e, selector);
      if (!item) return;
      DND.src = item; DND.from = container; DND.selector = selector; DND.group = group;
      e.dataTransfer.effectAllowed = 'move';
      try { e.dataTransfer.setData('text/plain', ''); } catch(_) {}
    };
    const handleDragOver = (e) => {
      if (!DND.src) return;
      // Only allow drop if same selector and group matches (or no group)
      const sameGroup = (!group && !DND.group) || (group && DND.group && group === DND.group);
      if (!sameGroup) return;
      const target = closestItem(e, selector);
      if (!target) return;
      e.preventDefault();
    };
    const handleDrop = (e) => {
      if (!DND.src) return;
      const sameGroup = (!group && !DND.group) || (group && DND.group && group === DND.group);
      if (!sameGroup) return;
      const target = closestItem(e, selector);
      if (!target) return;
      e.preventDefault();
      const from = DND.from;
      const to = container;
      const children = Array.from(from.querySelectorAll(DND.selector));
      const oldIndex = children.indexOf(DND.src);
      if (target && DND.src && target !== DND.src) {
        to.insertBefore(DND.src, target);
      }
      const newChildren = Array.from(to.querySelectorAll(DND.selector));
      const newIndex = newChildren.indexOf(DND.src);
      if (typeof this.options.onEnd === 'function') {
        try { this.options.onEnd({ oldIndex, newIndex, from, to, item: DND.src }); } catch(_) {}
      }
      DND.src = null; DND.from = null; DND.selector = null; DND.group = null;
    };
    this._listeners = { handleDragStart, handleDragOver, handleDrop };
    container.addEventListener('dragstart', handleDragStart);
    container.addEventListener('dragover', handleDragOver);
    container.addEventListener('drop', handleDrop);
    this.destroy = () => {
      container.removeEventListener('dragstart', handleDragStart);
      container.removeEventListener('dragover', handleDragOver);
      container.removeEventListener('drop', handleDrop);
    };
  }
  window.Sortable = Sortable;
})();
</script>
<!-- === END: Inline Minimal Sortable === -->
  <script>
    // ƒê√£ b·ªè fixVietnameseUI: d√πng tr·ª±c ti·∫øp ti·∫øng Vi·ªát (UTF-8) trong HTML/JS
    // N√∫t to√†n m√†n h√¨nh: d√πng bi·ªÉu t∆∞·ª£ng ‚ÜóÔ∏è/‚ÜôÔ∏è thay v√¨ ch·ªØ
    window.addEventListener('load', ()=>{ try { updateFullscreenButton(); } catch(_) {} });
    const IS_FILE_PROTOCOL = (window.location.protocol === 'file:');
    // Watchdog: th√¥ng b√°o n·∫øu API YouTube t·∫£i ch·∫≠m ho·∫∑c th·∫•t b·∫°i
    function startYtApiWatchdog(){
      const fb = document.getElementById('ytUrlFeedback');
      if (!fb) return;
      const t1 = setTimeout(()=>{
        try{ if (!window.YT || !window.YT.Player){ fb.textContent='ƒêang t·∫£i API YouTube...'; fb.style.color='var(--sub)'; } }catch(_){ }
      }, 1500);
      const t2 = setTimeout(()=>{
        try{ if (!window.YT || !window.YT.Player){ fb.textContent='Kh√¥ng t·∫£i ƒë∆∞·ª£c API YouTube. Ki·ªÉm tra m·∫°ng ho·∫∑c t·∫£i l·∫°i trang.'; fb.style.color='var(--danger)'; } }catch(_){ }
      }, 7000);
      window.__ytApiWatchdog = { cancel(){ clearTimeout(t1); clearTimeout(t2);} };
    }
    // Watchdog is triggered when API loading is requested
    // Inline i18n fallback so app works over file:// without CORS
    (function(){
      const DICT = {
        'timer.cycleInfo': ({ current = 0, target = 0 } = {}) => `Chu k·ª≥ ${current}/${target}`,
        'timer.selectSubtopicPrompt': 'Vui l√≤ng ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con tr∆∞·ªõc khi th·ª±c hi·ªán thao t√°c.'
      };
      window.t = function t(key, vars){
        try {
          const v = DICT[key];
          if (typeof v === 'function') return v(vars || {});
          if (typeof v === 'string') return v;
        } catch(_) {}
        return key;
      };
      window.loadLanguage = function loadLanguage(lang){
        try { localStorage.setItem('lang', lang || 'vi'); } catch(_) {}
        return Promise.resolve();
      };
    })();
    // === i18n core: translations + applyLanguage + t() + loadLanguage ===
    let currentLang = 'vi';
    const translations = {
      vi: {
        navTooltipTimer: "ƒê·ªìng h·ªì",
        navTooltipTopics: "Ch·ªß ƒë·ªÅ",
        navTooltipStats: "Th·ªëng k√™",
        navTooltipKnowledge: "Kho Tri Th·ª©c",
        navTooltipSettings: "C√†i ƒë·∫∑t",
        navTooltipGuide: "H∆∞·ªõng d·∫´n",
        headerDashboard: "üìä T·ªïng Quan",
        headerFeedback: "üí¨ Ph·∫£n H·ªìi",
        selectedContextNone: "Ch∆∞a ch·ªçn Ch·ªß ƒë·ªÅ con",
        welcomeHeading: "Ch√†o m·ª´ng ƒë·∫øn v·ªõi Pomodoro Study App!",
        welcomeText: "H√£y b·∫Øt ƒë·∫ßu b·∫±ng c√°ch ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con ho·∫∑c t·∫°o Ch·ªß ƒë·ªÅ/Ch·ªß ƒë·ªÅ con m·ªõi.",
        btnHelpCreateTopic: "+ T·∫°o Ch·ªß ƒë·ªÅ M·ªõi",
        presetsAria: "Ch·ªçn ch·∫ø ƒë·ªô preset",
        btnPresetCText: "üßò Flow",
        settingsTitle: "‚öôÔ∏è C√†i ƒë·∫∑t",
        settingsTabTimer: "ƒê·ªìng h·ªì",
        settingsTabUI: "Giao di·ªán & √Çm thanh",
        settingsTabIntegrations: "T√≠ch h·ª£p",
        settingsLanguage: "Ng√¥n ng·ªØ",
        languageVi: "Ti·∫øng Vi·ªát",
        languageEn: "English",
        btnSaveSettings: "L∆∞u",
        btnClose: "ƒê√≥ng",
        btnExport: "üì§ Xu·∫•t File",
        btnImport: "üì• Nh·∫≠p File",
        titleToggleUI: "·∫®n/Hi·ªán giao di·ªán",
        titleFullscreen: "To√†n m√†n h√¨nh",
        tasksTab: "Nhi·ªám v·ª•",
        notesTab: "Ghi ch√∫",
        aiTab: "Gemini AI",
        todoHeading: "To-do cho ch·ªß ƒë·ªÅ con n√†y:",
        newTaskPlaceholder: "Th√™m m·ªôt task m·ªõi...",
        btnAddTask: "Th√™m",
        stateBadgeReady: "S·∫¥N S√ÄNG",
        stateBadgeFocus: "L√ÄM VI·ªÜC",
        stateBadgeFocusFlow: "L√ÄM VI·ªÜC (FLOW)",
        stateBadgeShortBreak: "NGH·ªà NG·∫ÆN",
        stateBadgeLongBreak: "NGH·ªà D√ÄI",
        stateBadgeWindDown: "H·∫† NHI·ªÜT",
        stateBadgePaused: "T·∫†M D·ª™NG",
        btnStart: "‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu",
        btnFinishFlow: "üßò B·∫Øt ƒë·∫ßu ngh·ªâ",
        btnPause: "‚è∏Ô∏è T·∫°m d·ª´ng",
        btnResume: "‚ñ∂Ô∏è Ti·∫øp t·ª•c",
        btnSkip: "‚è≠Ô∏è B·ªè qua",
        btnReset: "‚Ü∫ ƒê·∫∑t l·∫°i",
        btnBreakEarly: "‚è±Ô∏è Ngh·ªâ s·ªõm",
        shortcutsLabel: "Ph√≠m t·∫Øt: Space = B·∫Øt ƒë·∫ßu/T·∫°m d·ª´ng/Ti·∫øp t·ª•c, N = Ti·∫øp theo/B·ªè qua",
        windDownTitle: "Checklist H·∫° nhi·ªát",
        windDownSave: "L∆∞u c√¥ng vi·ªác ƒëang l√†m (Save/Commit).",
        windDownNext: "Ghi ch√∫ nhanh \"Next step\".",
        windDownClean: "D·ªçn d·∫πp kh√¥ng gian l√†m vi·ªác.",
        'error.saveData': ({message='' }={})=>`L·ªói l∆∞u d·ªØ li·ªáu: ${message}`,
        'session.completed': 'Phi√™n ƒë√£ ho√†n th√†nh! Nh·∫•n B·∫Øt ƒë·∫ßu ƒë·ªÉ b·∫Øt ƒë·∫ßu phi√™n ti·∫øp theo.',
        'session.windDownStart': 'ƒê·∫øn gi·ªù h·∫° nhi·ªát. H√£y k·∫øt th√∫c c√¥ng vi·ªác v√† chu·∫©n b·ªã ngh·ªâ ng∆°i.',
        'flowtime.rest': ({minutes=0, ratio=5}={})=>`Ngh·ªâ ${minutes} ph√∫t theo Flowtime (${ratio}).`,
        'session.longBreakStart': 'Tuy·ªát v·ªùi! ƒê√£ ƒë·∫øn l√∫c ngh·ªâ d√†i.',
        'notes.summaryCleared': 'ƒê√£ x√≥a t√≥m t·∫Øt.',
        'error.cannotSaveChanges': 'Kh√¥ng th·ªÉ l∆∞u thay ƒë·ªïi.',
        'notes.noNotesToSummarize': 'Ch∆∞a c√≥ ghi ch√∫ ƒë·ªÉ t√≥m t·∫Øt.',
        'notes.summarizeFailed': 'T√≥m t·∫Øt th·∫•t b·∫°i.',
        'settings.restoredDefaults': 'ƒê√£ kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh',
        'settings.saved': 'ƒê√£ l∆∞u c√†i ƒë·∫∑t',
        'error.fileSave': 'L·ªói l∆∞u file.',
        'notes.enterBeforeSummarize': 'Vui l√≤ng nh·∫≠p ghi ch√∫ tr∆∞·ªõc khi t√≥m t·∫Øt.',
        'chat.cleared': 'ƒê√£ x√≥a l·ªãch s·ª≠ chat.',
        'audio.enabled': '√Çm thanh ƒë√£ ƒë∆∞·ª£c b·∫≠t!',
        'yt.invalidLink': 'Ch∆∞a c√≥ link h·ª£p l·ªá. D√°n link r·ªìi b·∫•m ‚ñ∂Ô∏è.',
        'yt.playing': 'ƒêang ph√°t nh·∫°c n·ªÅn...',
        'yt.stopped': 'ƒê√£ d·ª´ng nh·∫°c n·ªÅn.',
        'import.success': 'ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!',
        'import.failed': ({message='' }={})=>`Nh·∫≠p th·∫•t b·∫°i: ${message}`,
        'backup.selectOne': 'Vui l√≤ng ch·ªçn m·ªôt b·∫£n sao l∆∞u.',
        'backup.restoreSuccess': 'Ph·ª•c h·ªìi d·ªØ li·ªáu th√†nh c√¥ng! T·∫£i l·∫°i trang...',
        'backup.error': ({message='' }={})=>`L·ªói: ${message}`,
        'yt.thumbDisabledLightTheme': 'ƒê√£ t·∫Øt n·ªÅn YouTube ƒë·ªÉ h·ª£p v·ªõi theme s√°ng.',
        'notes.saved': 'ƒê√£ l∆∞u ghi ch√∫',
        'ai.formatNeedContent': 'C·∫ßn c√≥ n·ªôi dung ƒë·ªÉ AI ƒë·ªãnh d·∫°ng.',
        'ai.formatted': 'AI ƒë√£ ƒë·ªãnh d·∫°ng xong!',
        'ai.formatFailed': 'AI kh√¥ng th·ªÉ ƒë·ªãnh d·∫°ng l√∫c n√†y.',
        'preset.switched': ({newPreset='' }={})=>`ƒê√£ chuy·ªÉn sang Ki·ªÉu ${newPreset}.`,
        'bg.updated': 'ƒê√£ c·∫≠p nh·∫≠t h√¨nh n·ªÅn.',
        'bg.cleared': 'ƒê√£ x√≥a h√¨nh n·ªÅn t√πy ch·ªânh.',
        'sound.savedWorkEnd': 'ƒê√£ l∆∞u √¢m b√°o h·∫øt L√ÄM VI·ªÜC.',
        'sound.savedShortEnd': 'ƒê√£ l∆∞u √¢m b√°o h·∫øt NGH·ªà NG·∫ÆN.',
        'sound.savedLongEnd': 'ƒê√£ l∆∞u √¢m b√°o h·∫øt NGH·ªà D√ÄI.',
        'error.fullscreen': ({message='' }={})=>`L·ªói: Kh√¥ng th·ªÉ b·∫≠t ch·∫ø ƒë·ªô to√†n m√†n h√¨nh: ${message}`,
        'error.init': ({message='' }={})=>`L·ªói kh·ªüi t·∫°o: ${message}`,
        'ai.needApiKey': 'Vui l√≤ng nh·∫≠p Gemini API Key trong ph·∫ßn C√†i ƒë·∫∑t.',
        'error.networkGemini': 'L·ªói m·∫°ng khi k·∫øt n·ªëi ƒë·∫øn Gemini. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.',
        'timer.cycleInfo': ({ current = 0, target = 0 } = {}) => `Chu k·ª≥ ${current}/${target}`,
        'timer.selectSubtopicPrompt': 'Vui l√≤ng ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con tr∆∞·ªõc khi th·ª±c hi·ªán thao t√°c.',
      },
      en: {
        navTooltipTimer: "Timer",
        navTooltipTopics: "Topics",
        navTooltipStats: "Stats",
        navTooltipKnowledge: "Knowledge Base",
        navTooltipSettings: "Settings",
        navTooltipGuide: "Guide",
        headerDashboard: "üìä Dashboard",
        headerFeedback: "üí¨ Feedback",
        selectedContextNone: "No Subtopic Selected",
        welcomeHeading: "Welcome to the Pomodoro Study App!",
        welcomeText: "Start by selecting a Subtopic or create a new Topic/Subtopic.",
        btnHelpCreateTopic: "+ Create New Topic",
        presetsAria: "Select preset mode",
        btnPresetCText: "üßò Flow",
        settingsTitle: "‚öôÔ∏è Settings",
        settingsTabTimer: "Timer",
        settingsTabUI: "Interface & Sound",
        settingsTabIntegrations: "Integrations",
        settingsLanguage: "Language",
        languageVi: "Vietnamese",
        languageEn: "English",
        btnSaveSettings: "Save",
        btnClose: "Close",
        btnExport: "üì§ Export File",
        btnImport: "üì• Import File",
        titleToggleUI: "Toggle UI",
        titleFullscreen: "Fullscreen",
        tasksTab: "Tasks",
        notesTab: "Notes",
        aiTab: "Gemini AI",
        todoHeading: "To-do for this subtopic:",
        newTaskPlaceholder: "Add a new task...",
        btnAddTask: "Add",
        stateBadgeReady: "READY",
        stateBadgeFocus: "FOCUS",
        stateBadgeFocusFlow: "FOCUS (FLOW)",
        stateBadgeShortBreak: "SHORT BREAK",
        stateBadgeLongBreak: "LONG BREAK",
        stateBadgeWindDown: "WIND DOWN",
        stateBadgePaused: "PAUSED",
        btnStart: "‚ñ∂Ô∏è Start",
        btnFinishFlow: "üßò Start Break",
        btnPause: "‚è∏Ô∏è Pause",
        btnResume: "‚ñ∂Ô∏è Resume",
        btnSkip: "‚è≠Ô∏è Skip",
        btnReset: "‚Ü∫ Reset",
        btnBreakEarly: "‚è±Ô∏è Break Early",
        shortcutsLabel: "Shortcuts: Space = Start/Pause/Resume, N = Next/Skip",
        windDownTitle: "Wind Down Checklist",
        windDownSave: "Save your work (Save/Commit).",
        windDownNext: "Jot a quick \"Next step\".",
        windDownClean: "Clear your workspace.",
        'error.saveData': ({message='' }={})=>`Error saving data: ${message}`,
        'session.completed': 'Session complete! Press Start to begin the next one.',
        'session.windDownStart': 'Time to wind down. Wrap up and get ready to rest.',
        'flowtime.rest': ({minutes=0, ratio=5}={})=>`Rest ${minutes} minutes via Flowtime (${ratio}).`,
        'session.longBreakStart': "Great! It's time for a long break.",
        'notes.summaryCleared': 'Summary cleared.',
        'error.cannotSaveChanges': 'Unable to save changes.',
        'notes.noNotesToSummarize': 'No notes to summarize yet.',
        'notes.summarizeFailed': 'Summarization failed.',
        'settings.restoredDefaults': 'Defaults restored',
        'settings.saved': 'Settings saved',
        'error.fileSave': 'File save error.',
        'notes.enterBeforeSummarize': 'Please enter a note before summarizing.',
        'chat.cleared': 'Chat history cleared.',
        'audio.enabled': 'Audio is now enabled!',
        'yt.invalidLink': 'No valid link yet. Paste the link and press ‚ñ∂Ô∏è.',
        'yt.playing': 'Playing background music...',
        'yt.stopped': 'Background music stopped.',
        'import.success': 'Data imported successfully!',
        'import.failed': ({message='' }={})=>`Import failed: ${message}`,
        'backup.selectOne': 'Please select a backup.',
        'backup.restoreSuccess': 'Data restored! Reloading page...',
        'backup.error': ({message='' }={})=>`Error: ${message}`,
        'yt.thumbDisabledLightTheme': 'Disabled YouTube thumbnail background for light theme.',
        'notes.saved': 'Note saved',
        'ai.formatNeedContent': 'Content is required for AI formatting.',
        'ai.formatted': 'AI finished formatting!',
        'ai.formatFailed': 'AI cannot format right now.',
        'preset.switched': ({newPreset='' }={})=>`Switched to Preset ${newPreset}.`,
        'bg.updated': 'Background updated.',
        'bg.cleared': 'Custom background cleared.',
        'sound.savedWorkEnd': 'Saved alert for FOCUS end.',
        'sound.savedShortEnd': 'Saved alert for SHORT BREAK end.',
        'sound.savedLongEnd': 'Saved alert for LONG BREAK end.',
        'error.fullscreen': ({message='' }={})=>`Error: Unable to enter fullscreen: ${message}`,
        'error.init': ({message='' }={})=>`Initialization error: ${message}`,
        'ai.needApiKey': 'Please enter a Gemini API Key in Settings.',
        'error.networkGemini': 'Network error connecting to Gemini. Please check your internet.',
        'timer.cycleInfo': ({ current = 0, target = 0 } = {}) => `Cycle ${current}/${target}`,
        'timer.selectSubtopicPrompt': 'Please select a Subtopic first.',
      }
    };
    function setElTextPreserveIcon(el, text) {
      const icon = el.querySelector('svg, strong, span.badge');
      if (icon && (el.tagName === 'BUTTON' || el.tagName === 'A' || el.classList.contains('tooltip'))) {
        el.innerHTML = icon.outerHTML + ' ' + text;
      } else {
        el.textContent = text;
      }
    }
    function applyLanguage(lang) {
      currentLang = (lang === 'en' ? 'en' : 'vi');
      const dict = translations[currentLang];
      try { document.documentElement.setAttribute('lang', currentLang); } catch(_) {}
      document.querySelectorAll('[data-i18n-key]').forEach(el => {
        const key = el.getAttribute('data-i18n-key');
        const value = dict[key];
        if (value == null) return;
        const attrsRaw = el.getAttribute('data-i18n-attr') || '';
        const attrs = attrsRaw.split('|').map(s => s.trim()).filter(Boolean);
        const attrOnly = attrs.includes('only');
        attrs
          .filter(attr => attr && attr !== 'only')
          .forEach(attr => {
            el.setAttribute(attr, typeof value === 'function' ? value() : value);
          });
        if (!attrOnly) {
          const text = typeof value === 'function' ? value() : value;
          setElTextPreserveIcon(el, text);
        }
      });
    }
    window.t = function t(key, vars) {
      try {
        const v = translations[currentLang]?.[key];
        if (typeof v === 'function') return v(vars || {});
        if (typeof v === 'string') return v;
      } catch(_) {}
      return key;
    };
    window.loadLanguage = function loadLanguage(lang) {
      const next = (lang === 'en' ? 'en' : 'vi');
      try { localStorage.setItem('lang', next); } catch(_) {}
      applyLanguage(next);
      return Promise.resolve();
    };
    // Tag key elements with data-i18n-key at runtime (non-intrusive to HTML structure)
    function tagI18nElements(){
      const setKey = (sel, key) => { const el = document.querySelector(sel); if (el) el.setAttribute('data-i18n-key', key); };
      const setKeyAttr = (sel, key, attr) => { const el = document.querySelector(sel); if (el) { el.setAttribute('data-i18n-key', key); el.setAttribute('data-i18n-attr', attr); } };
      // Nav tooltips
      setKey('#navBtnTimer .tooltip', 'navTooltipTimer');
      setKey('#navBtnTopics .tooltip', 'navTooltipTopics');
      setKey('#navBtnStats .tooltip', 'navTooltipStats');
      setKey('#navBtnMethods .tooltip', 'navTooltipKnowledge');
      setKey('#btnSettings .tooltip', 'navTooltipSettings');
      setKey('#navBtnGuide .tooltip', 'navTooltipGuide');
      // Header
      setKey('#selectedContext', 'selectedContextNone');
      setKeyAttr('#btnDashboard', 'headerDashboard', 'title');
      setKeyAttr('a.btn.ghost.small[rel~="noopener"]', 'headerFeedback', 'title');
      setKey('#btnExport', 'btnExport');
      const importLbl = document.querySelector('label.btn.ghost.small[for="importFile"]'); if (importLbl) importLbl.setAttribute('data-i18n-key','btnImport');
      setKeyAttr('#btnToggleBg', 'titleToggleUI', 'title');
      setKeyAttr('#btnFullscreen', 'titleFullscreen', 'title');
      // Welcome & presets
      setKey('#welcomePanel h3', 'welcomeHeading');
      setKey('#welcomePanel p', 'welcomeText');
      setKey('#btnHelpCreateTopic', 'btnHelpCreateTopic');
      const presets = document.querySelector('.presets[role="group"]'); if (presets){ presets.setAttribute('data-i18n-key','presetsAria'); presets.setAttribute('data-i18n-attr','aria-label|only'); }
      setKey('#btnPresetC', 'btnPresetCText');
      // Timer badge + controls
      setKey('#stateBadge', 'stateBadgeReady');
      setKey('#btnStart', 'btnStart');
      setKey('#btnFinishFlow', 'btnFinishFlow');
      setKey('#btnPause', 'btnPause');
      setKey('#btnResume', 'btnResume');
      setKey('#btnSkip', 'btnSkip');
      setKey('#btnReset', 'btnReset');
      setKey('#btnBreakEarly', 'btnBreakEarly');
      // Wind down checklist
      setKey('#windDownChecklist h4', 'windDownTitle');
      const wd1 = document.querySelector('#windDownChecklist li:nth-child(1)'); if (wd1) wd1.setAttribute('data-i18n-key','windDownSave');
      const wd2 = document.querySelector('#windDownChecklist li:nth-child(2)'); if (wd2) wd2.setAttribute('data-i18n-key','windDownNext');
      const wd3 = document.querySelector('#windDownChecklist li:nth-child(3)'); if (wd3) wd3.setAttribute('data-i18n-key','windDownClean');
      // Tabs & tasks
      setKey('.tab-nav .tab-btn[data-tab="tasks"]', 'tasksTab');
      setKey('.tab-nav .tab-btn[data-tab="notes"]', 'notesTab');
      setKey('.tab-nav .tab-btn[data-tab="ai"]', 'aiTab');
      setKey('#tasks h4', 'todoHeading');
      const newTask = document.querySelector('#newSubtopicTaskInput'); if (newTask){ newTask.setAttribute('data-i18n-key','newTaskPlaceholder'); newTask.setAttribute('data-i18n-attr','placeholder'); }
      setKey('#btnAddSubtopicTask', 'btnAddTask');
      // Settings modal
      setKey('#settingsTitle', 'settingsTitle');
      setKey('.tab-btn[data-tab="settings-timer"]', 'settingsTabTimer');
      setKey('.tab-btn[data-tab="settings-ui"]', 'settingsTabUI');
      setKey('.tab-btn[data-tab="settings-integrations"]', 'settingsTabIntegrations');
      setKey('#btnSaveSettings', 'btnSaveSettings');
      setKey('#btnCloseSettings', 'btnClose');
    }
    function ensureYouTubeAPI(){
      if (IS_FILE_PROTOCOL) return Promise.resolve(false);
      try { if (window.YT && window.YT.Player) return Promise.resolve(true); } catch(_) {}
      if (window.__ytApiPromise) return window.__ytApiPromise;
      startYtApiWatchdog();
      window.__ytApiPromise = new Promise((resolve, reject) => {
        try {
          const s = document.createElement('script');
          s.src = 'https://www.youtube.com/iframe_api';
          s.async = true; s.defer = true;
          s.onload = () => resolve(true);
          s.onerror = () => reject(new Error('Failed to load YouTube API'));
          document.head.appendChild(s);
        } catch(err) { reject(err); }
      });
      return window.__ytApiPromise;
    }

    // storageManager will manage persistence
    // =============================
    // STORAGE MANAGER - Qu·∫£n l√Ω D·ªØ li·ªáu v√† Sao l∆∞u
    // =============================
    const storageManager = {
        DB_NAME: 'PomodoroAppDB',
        DB_VERSION: 1,
        db: null,
        async initDB() {
            return new Promise((resolve, reject) => {
                if (this.db) return resolve(this.db);
                const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings');
                    }
                    if (!db.objectStoreNames.contains('topics')) {
                        db.createObjectStore('topics', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('subtopics')) {
                        const subtopicsStore = db.createObjectStore('subtopics', { keyPath: 'id' });
                        subtopicsStore.createIndex('by_topic', 'topicId');
                    }
                    if (!db.objectStoreNames.contains('backups')) {
                        db.createObjectStore('backups', { keyPath: 'date' });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    console.log('IndexedDB initialized successfully.');
                    resolve(this.db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    reject(event.target.error);
                };
            });
        },
        async _getStore(storeName, mode = 'readonly') {
            await this.initDB();
            const tx = this.db.transaction([storeName], mode);
            return tx.objectStore(storeName);
        },
        async getSettings() {
            const store = await this._getStore('settings');
            return new Promise((resolve, reject) => {
                const request = store.get('main_settings');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async updateSettings(settingsObject) {
            const store = await this._getStore('settings', 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.put(settingsObject, 'main_settings');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async getAll(storeName) {
            const store = await this._getStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async update(storeName, object) {
            const store = await this._getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.put(object);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async add(storeName, object) {
            const store = await this._getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.add(object);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async delete(storeName, key) {
            const store = await this._getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.delete(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async save(data) {
            await this.initDB();
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(['settings', 'topics', 'subtopics'], 'readwrite');
                const settingsStore = tx.objectStore('settings');
                const topicsStore = tx.objectStore('topics');
                const subtopicsStore = tx.objectStore('subtopics');

                settingsStore.put(data.settings, 'main_settings');
                topicsStore.clear();
                subtopicsStore.clear();

                data.topics.forEach(topic => {
                    const { subtopics, ...topicData } = topic;
                    topicsStore.put(topicData);
                    (subtopics || []).forEach(sub => subtopicsStore.put(sub));
                });

                tx.oncomplete = () => resolve();
                tx.onerror = e => reject(e.target.error);
            });
        },
        async autoBackup(data) {
            await this.initDB();
            const today = new Date().toISOString().slice(0, 10);
            const lastBackupDate = localStorage.getItem('lastBackupDate');
            if (today !== lastBackupDate) {
                console.log(`Creating backup for ${today}...`);
                const backupData = { date: today, data: JSON.parse(JSON.stringify(data)) };
                const transaction = this.db.transaction(['backups'], 'readwrite');
                const store = transaction.objectStore('backups');
                const request = store.put(backupData);
                request.onsuccess = () => {
                    localStorage.setItem('lastBackupDate', today);
                    console.log('Daily backup successful.');
                    this.cleanupOldBackups((data?.settings?.backupDaysToKeep) || 7);
                };
                request.onerror = (event) => {
                    console.error('Backup failed:', event.target.error);
                };
            }
        },
        async cleanupOldBackups(daysToKeep) {
            await this.initDB();
            const transaction = this.db.transaction(['backups'], 'readwrite');
            const store = transaction.objectStore('backups');
            const request = store.getAllKeys();
            request.onsuccess = () => {
                const allKeys = request.result.sort().reverse();
                if (allKeys.length > daysToKeep) {
                    const keysToDelete = allKeys.slice(daysToKeep);
                    keysToDelete.forEach(key => {
                        store.delete(key);
                        console.log(`Deleted old backup: ${key}`);
                    });
                }
            };
        },
        async getBackupList() {
            await this.initDB();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result.sort((a, b) => b.date.localeCompare(a.date)));
                request.onerror = (event) => reject(event.target.error);
            });
        },
        async restoreBackup(date) {
            await this.initDB();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                const request = store.get(date);
                request.onsuccess = () => {
                    if (request.result && request.result.data) {
                        localStorage.setItem('pomodoroData_v11', JSON.stringify(request.result.data));
                        resolve(request.result.data);
                    } else {
                        reject(new Error('Kh√¥ng t√¨m th·∫•y b·∫£n sao l∆∞u.'));
                    }
                };
                request.onerror = (event) => reject(event.target.error);
            });
        },
        exportData(data) {
            // Sanitize sensitive fields before export (do not leak API keys)
            let safe = {};
            try { safe = JSON.parse(JSON.stringify(data || {})); } catch(_) { safe = data; }
            try { if (safe && safe.settings) safe.settings.apiKey = ''; } catch(_) {}
            const blob = new Blob([JSON.stringify(safe, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            const ts = new Date();
            const pad = n => `${n}`.padStart(2, '0');
            a.href = URL.createObjectURL(blob);
            a.download = `pomodoro_backup_${ts.getFullYear()}${pad(ts.getMonth() + 1)}${pad(ts.getDate())}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        },
        async importData(file) {
            const text = await file.text();
            const obj = JSON.parse(text);
            if (!obj.version || !obj.settings || !Array.isArray(obj.topics)) {
                throw new Error('T·ªáp kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
            }
            // Preserve existing apiKey if absent or empty in import
            try {
                const currentKey = (window.data && window.data.settings && window.data.settings.apiKey) || '';
                if (!('apiKey' in obj.settings) || obj.settings.apiKey === '') {
                    obj.settings.apiKey = currentKey;
                }
            } catch(_) {}
            localStorage.setItem('pomodoroData_v11', JSON.stringify(obj));
            return obj;
        }
    };

    // =============================
    // Helpers
    // =============================
    const $ = (sel, root=document) => root.querySelector(sel);
    
    // Danh s√°ch g·ª£i √Ω cho gi·ªù ngh·ªâ (break)
    const breakSuggestions = [
      "H√£y ƒë·ª©ng d·∫≠y v∆∞∆°n vai v√† du·ªói ng∆∞·ªùi.",
      "U·ªëng m·ªôt ly n∆∞·ªõc ƒë·ªÉ gi·ªØ ƒë·ªß n∆∞·ªõc.",
      "Nh√¨n ra xa qua c·ª≠a s·ªï trong 20 gi√¢y.",
      "ƒêi d·∫°o m·ªôt v√≤ng ng·∫Øn quanh ph√≤ng.",
      "Th·ª±c hi·ªán v√†i ƒë·ªông t√°c h√≠t th·ªü s√¢u.",
      "S·∫Øp x·∫øp l·∫°i kh√¥ng gian l√†m vi·ªác c·ªßa b·∫°n.",
      "Nghe m·ªôt b·∫£n nh·∫°c y√™u th√≠ch.",
      "Nh·∫Øm m·∫Øt v√† th∆∞ gi√£n trong m·ªôt ph√∫t.",
      "L·∫Øc nh·∫π c·ªï tay v√† vai trong 30 gi√¢y.",
      "Th·∫£ l·ªèng to√†n th√¢n, c·∫£m nh·∫≠n h∆°i th·ªü.",
      "ƒê·∫∑t tay l√™n ng·ª±c, c·∫£m nh·∫≠n nh·ªãp tim c·ªßa m√¨nh.",
      "M·ªü c·ª≠a s·ªï cho kh√¥ng kh√≠ m·ªõi v√†o ph√≤ng.",
      "Massage nh·∫π hai b√™n th√°i d∆∞∆°ng.",
      "Xem m·ªôt t·∫•m ·∫£nh d·ªÖ th∆∞∆°ng ho·∫∑c l√†m b·∫°n vui.",
      "ƒê·∫øm ng∆∞·ª£c t·ª´ 20 ƒë·∫øn 0 th·∫≠t ch·∫≠m r√£i.",
      "T·ª± h·ªèi b·∫£n th√¢n: ‚ÄúM√¨nh c·∫£m th·∫•y th·∫ø n√†o l√∫c n√†y?‚Äù",
      "Ki·ªÉm tra v√† ch·ªânh l·∫°i t∆∞ th·∫ø ng·ªìi cho ƒë√∫ng.",
      "Nh·∫π nh√†ng nh·∫Øm m·∫Øt v√† m·ªâm c∆∞·ªùi v·ªõi ch√≠nh m√¨nh.",
      "Th·∫£ l·ªèng hai ch√¢n, l·∫Øc nh·∫π c·ªï ch√¢n d∆∞·ªõi b√†n.",
      "Ch√∫ √Ω ƒë·∫øn c·∫£m gi√°c nhi·ªát ƒë·ªô, √°nh s√°ng trong ph√≤ng.",
      "ƒê·∫øm ch·∫≠m t·ª´ng nh·ªãp th·ªü ƒë·∫øn s·ªë 10.",
      "L√†m ƒë·ªông t√°c ‚Äúth·ªü d√†i‚Äù s√¢u m·ªôt l·∫ßn, th·∫£ l·ªèng vai.",
      "L·∫Øng nghe h∆°i th·ªü ra v√†o qua m≈©i.",
      "Nh·ªõ u·ªëng m·ªôt ng·ª•m n∆∞·ªõc nh√©!",
      "ƒê·ª©ng l√™n v√† ƒëi l·∫°i v√†i b∆∞·ªõc ƒë·ªÉ m√°u l∆∞u th√¥ng.",
      "Ch·ªõp m·∫Øt li√™n t·ª•c 10 l·∫ßn ƒë·ªÉ tr√°nh kh√¥ m·∫Øt.",
      "R·ª≠a m·∫∑t ho·∫∑c v·ªó nh·∫π l√™n m·∫∑t ƒë·ªÉ t·ªânh t√°o h∆°n.",
      "N·∫Øn nh·∫π c√°c kh·ªõp ng√≥n tay sau khi g√µ ph√≠m.",
      "N·∫°p nƒÉng l∆∞·ª£ng b·∫±ng m·ªôt m√≥n ƒÉn nh·∫π l√†nh m·∫°nh.",
      "B∆∞·ªõc ra ban c√¥ng, t·∫≠n h∆∞·ªüng √°nh s√°ng t·ª± nhi√™n.",
      "Ki·ªÉm tra nh·ªãp th·ªü ‚Äì n·∫øu g·∫•p g√°p, h√£y l√†m ch·∫≠m l·∫°i.",
      "T·ª± nh·∫Øc: Ngh·ªâ ng∆°i ƒë√∫ng c√°ch l√† ƒë·ªÉ l√†m vi·ªác t·ªët h∆°n!"
    ];
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    function on(el, evt, handler){ if(!el){ console.warn('Missing element', evt); return; } el.addEventListener(evt, handler); }
    const formatMMSS = (s) => { const m = Math.floor(s/60).toString().padStart(2,'0'); const ss = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; };
    const uid = (p='id') => `${p}_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;

    // === START: A11y Focus Trap (non-invasive) ===
    let __releaseFocusTrap = null;
    function trapFocus(modalEl){
      try {
        const focusable = modalEl.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (!focusable.length) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        const handler = (e) => {
          if (e.key === 'Tab') {
            if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
            else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
          }
        };
        modalEl.addEventListener('keydown', handler);
        first.focus();
        __releaseFocusTrap = () => { try { modalEl.removeEventListener('keydown', handler); } catch(_){} };
      } catch(_) {}
    }
    function releaseFocus(){ if (__releaseFocusTrap) { try { __releaseFocusTrap(); } catch(_){} __releaseFocusTrap = null; } }
    // === END: A11y Focus Trap ===

    

    
    const todayISO = () => new Date().toISOString();
    function toast(msg, ms=2600){ const box=$('#toasts'); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; box.appendChild(t); setTimeout(()=>{t.style.opacity='0';}, ms-300); setTimeout(()=> box.removeChild(t), ms); }
    function escapeHTML(str){ return str.replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    function formatDaysHoursMinutes(totalMinutes) {
        if (!totalMinutes || totalMinutes < 1) return "0 ph√∫t";
        const totalHours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        const mm = minutes.toString().padStart(2, '0');
        return `${totalHours} ti·∫øng ${mm} ph√∫t`;
    }
    function formatGeminiResponse(text) {
        return text.replace(/(\*\*|__|\*|_|#+\s*)/g, '');
    }
    // Parse a minimal Markdown-like syntax to safe HTML for Methods
    function parseSimpleMarkdown(text) {
        const lines = (text || '').split('\n');
        let html = '';
        let listType = null; // 'ol' | 'ul'
        const closeList = () => { if (listType) { html += (listType === 'ol' ? '</ol>' : '</ul>'); listType = null; } };
        for (let raw of lines) {
            let line = (raw || '').trim();
            if (!line) { closeList(); continue; }
            if (line.startsWith('#### ')) {
                closeList();
                html += `<h4>${escapeHTML(line.substring(5))}</h4>`;
            } else if (/^\d+\.\s/.test(line)) {
                if (listType !== 'ol') { closeList(); html += '<ol>'; listType = 'ol'; }
                const itemText = line.substring(line.indexOf(' ') + 1);
                html += `<li>${escapeHTML(itemText)}</li>`;
            } else if (line.startsWith('- ')) {
                if (listType !== 'ul') { closeList(); html += '<ul>'; listType = 'ul'; }
                html += `<li>${escapeHTML(line.substring(2))}</li>`;
            } else {
                closeList();
                line = escapeHTML(line)
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/_(.*?)_/g, '<i>$1</i>');
                html += `<p>${line}</p>`;
            }
        }
        closeList();
        return html;
    }
    function wrapTextInMarkdown(textarea, prefix, suffix = '') {
        if (!textarea) return;
        const start = textarea.selectionStart || 0;
        const end = textarea.selectionEnd || 0;
        const selectedText = textarea.value.substring(start, end);
        const newText = prefix + selectedText + (suffix || prefix);
        textarea.setRangeText(newText, start, end, 'end');
        textarea.focus();
    }
    function updateEditorPreview() {
        const contentInput = $('#methodEditorContentInput');
        const preview = $('#editorPreview');
        if (!contentInput || !preview) return;
        const markdownText = contentInput.value || '';
        preview.innerHTML = parseSimpleMarkdown(markdownText);
    }
    function normalizeDataStructure(obj){
        if (!obj || typeof obj !== 'object') return;
        const s = obj.settings || {};
        const mergedSettings = {
            ...defaults.settings,
            ...s,
            durations: { ...defaults.settings.durations, ...(s.durations || {}) }
        };
        if (!Array.isArray(mergedSettings.achievedMilestones)) mergedSettings.achievedMilestones = [];
        if (typeof mergedSettings.useCustomSounds !== 'boolean') mergedSettings.useCustomSounds = false;
        obj.settings = mergedSettings;
        obj.topics = Array.isArray(obj.topics) ? obj.topics : [];
        obj.topics.forEach(t => {
            t.subtopics = Array.isArray(t.subtopics) ? t.subtopics : [];
            t.subtopics.forEach(st => {
                st.tasks = st.tasks || [];
                st.generalNotes = st.generalNotes || [];
                st.summaries = st.summaries || [];
                st.chatHistory = st.chatHistory || [];
                // Ensure each subtopic has its own knowledge base
                st.methods = Array.isArray(st.methods) ? st.methods : [];
                st.stats = st.stats || { totalMinutes: 0, sessionsCompleted: 0, tasksCompleted: 0 };
                st.sessions = st.sessions || [];
                st.timerState = st.timerState || { state: 'idle', prevState: null, remaining: 0, segmentTotal: 0, cycleIndex: 0 };
            });
        });
    }
    function extractYouTubeID(url) {
        if (!url) return null;
        const regExp = /^.*(?:youtu.be\/|shorts\/|live\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([A-Za-z0-9_-]{11}).*/;
        const match = url.match(regExp);
        return match ? match[1] : null;
    }
    let sessionYoutubeUrl = '';
    function getActiveYoutubeUrl(){
        try {
            if (sessionYoutubeUrl) return sessionYoutubeUrl;
            const el = document.getElementById('set_youtubeUrl');
            const v = (el && el.value ? el.value : '').trim();
            return v;
        } catch(_) { return ''; }
    }
    function getActiveVideoId(){ return extractYouTubeID(getActiveYoutubeUrl()); }
    function handleYoutubeUrlInput() {
        const input = $("#set_youtubeUrl");
        const feedbackEl = $("#ytUrlFeedback");
        const toggleBtn = $("#btnToggleYtSound");
        const url = input.value.trim();
        const videoId = extractYouTubeID(url);

        if (videoId) {
            feedbackEl.textContent = "OK. Link h·ª£p l·ªá. ƒêang chu·∫©n b·ªã ph√°t...";
            feedbackEl.style.color = 'var(--acc-2)';
            toggleBtn.disabled = false;
            sessionYoutubeUrl = url;
            // Khi d√°n link m·ªõi, coi nh∆∞ √Ω ƒë·ªãnh ph√°t nh·∫°c ‚Üí b·ªè tr·∫°ng th√°i t·∫°m d·ª´ng th·ªß c√¥ng
            try { ytUserPaused = false; } catch(_) {}
            try {
                const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                const img = new Image();
                img.onload = async () => { data.settings.customBg = thumbUrl; try { await saveData(); } catch(_) {} applyCustomBg(); };
                img.onerror = async () => { const fb = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`; data.settings.customBg = fb; try { await saveData(); } catch(_) {} applyCustomBg(); };
                img.src = thumbUrl;
            } catch(_) {}
            try {
                if (IS_FILE_PROTOCOL) {
                    const isMuted = _ytUnlocked ? 0 : 1;
                    fallbackLoadVideo(videoId, { autoplay: 1, mute: isMuted });
                    try { setTimeout(() => { try { fallbackPostMessage('playVideo'); } catch(_) {} }, 250); } catch(_) {}
                    if (!_ytUnlocked) { showSoundPermission(); }
                try { setTimeout(() => { const fb = document.getElementById('ytUrlFeedback'); if (fb) fb.textContent = 'ƒêang ph√°t'; }, 500); } catch(_) {}
                } else {
                    ensureYouTubeAPI().then(() => {
                        updateYouTubePlayer();
                        try {
                            if (_ytUnlocked) {
                                ytFadeInPlay();
                            } else if (ytPlayer && ytPlayer.mute && ytPlayer.playVideo) {
                                // Prime muted playback like 4.html and show permission bar
                                ytPlayer.mute();
                                ytPlayer.playVideo();
                                _ytPrimed = true;
                                showSoundPermission();
                            }
                        } catch(_) {}
                    }).catch(()=>{});
                }
            } catch(_) {}
        } else if (url === '') {
            feedbackEl.textContent = "";
            toggleBtn.disabled = true;
            if (IS_FILE_PROTOCOL) { try { fallbackStop(); } catch(_) {} }
            else if (ytPlayer && ytPlayer.stopVideo) { ytPlayer.stopVideo(); }
        } else {
            feedbackEl.textContent = "‚ùå Link kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£.";
            feedbackEl.style.color = 'var(--danger)';
            toggleBtn.disabled = true;
        }
    }
    
    // THAY ƒê·ªîI: H√†m applyTheme ƒë∆∞·ª£c c·∫≠p nh·∫≠t ho√†n to√†n
    function applyTheme(previewTheme) {
        const theme = previewTheme || data.settings.theme || 'default';
        document.body.dataset.theme = theme;
        
        const themeHasBg = ['lofi', 'space'].includes(theme);
        const isLightTheme = (theme === 'light' || theme === 'pastel');
        const customBg = data.settings.customBg;

        // helper: always clear any previously forced inline fallback
        const clearInlineBgFallback = () => { try { document.body.style.backgroundImage = ''; } catch(_) {} };

        if (customBg && !data.settings.useYtThumbnailAsBg) {
            document.body.style.setProperty('--bg-image', `url(${customBg})`);
            clearInlineBgFallback();
        } else if (customBg && data.settings.useYtThumbnailAsBg) {
            document.body.style.setProperty('--bg-image', `url(${customBg})`);
            clearInlineBgFallback();
        } else if (themeHasBg) {
            // Use theme-provided background (e.g., lofi/space)
            document.body.style.removeProperty('--bg-image');
            clearInlineBgFallback();
        } else if (isLightTheme) {
            // For light/pastel, avoid dark radial fallback
            document.body.style.setProperty('--bg-image', 'none');
            clearInlineBgFallback();
        } else {
            // Dark/default fallback
            document.body.style.setProperty('--bg-image', '');
            document.body.style.backgroundImage = 'radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%)';
        }
    }


    const defaults = {
        version: 1,
        settings: {
            apiKey: "",
            currentView: 'timer',
            preset: 'A',
            autoStartNext: true,
            soundOn: true,
            volume: 0.8,
            soundTheme: 'beep',
            theme: 'default',
            cyclesA: 4,
            longBreakIntervalA: 4,
            cyclesB: 4,
            longBreakIntervalB: 4,
            // Flowtime preset (Preset C)
            flowtimeBreakRatio: 5,
            // B·∫≠t/t·∫Øt H·∫° nhi·ªát sau phi√™n l√†m
            enableWinddown: true,
            // B·∫≠t/t·∫Øt nh·∫Øc ghi ch√∫ sau m·ªói phi√™n
            enableSessionNotes: true,
            durations: { A_work: 25, A_short: 5, A_long: 15, A_winddown: 2, B_work: 50, B_short: 10, B_long: 30, B_winddown: 5 },
            selectedTopicId: '',
            selectedSubtopicId: '',
            collapsedTopics: {},
            customBg: '',
            useCustomSounds: false,
            customSounds: { work_end: '', break_end: '', long_end: '' },
            youtubeUrl: '',
            youtubeVolume: 80,
            useYtThumbnailAsBg: true,
            panelOpacity: 0.85,
            panelBlur: 10,
            backgroundMode: 'cover',
            backupDaysToKeep: 7,
            achievedMilestones: [],
            // Seeded learning methods as HTML content (Rich Text)
            methods: [
                {
                    id: uid('m'),
                    title: 'K·ªπ Thu·∫≠t Feynman: Hi·ªÉu S√¢u B·∫±ng C√°ch Gi·∫£i Th√≠ch ƒê∆°n Gi·∫£n',
                    content: `<p>Nguy√™n t·∫Øc c·ªët l√µi c·ªßa k·ªπ thu·∫≠t n√†y d·ª±a tr√™n m·ªôt √Ω t∆∞·ªüng duy nh·∫•t: "N·∫øu b·∫°n kh√¥ng th·ªÉ gi·∫£i th√≠ch m·ªôt ch·ªß ƒë·ªÅ m·ªôt c√°ch ƒë∆°n gi·∫£n, b·∫°n ch∆∞a th·ª±c s·ª± hi·ªÉu n√≥." M·ª•c ti√™u l√† bi·∫øn ki·∫øn th·ª©c ph·ª©c t·∫°p th√†nh l·ªùi gi·∫£i th√≠ch ƒë∆°n gi·∫£n ƒë·∫øn m·ª©c m·ªôt ƒë·ª©a tr·∫ª c≈©ng c√≥ th·ªÉ hi·ªÉu.</p><h4>Quy Tr√¨nh 4 B∆∞·ªõc Tinh G·ªçn</h4><ol><li><strong>H·ªçc:</strong> Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ v√† vi·∫øt ra t·∫•t c·∫£ nh·ªØng g√¨ b·∫°n bi·∫øt v·ªÅ n√≥.</li><li><strong>D·∫°y:</strong> Gi·∫£ v·ªù d·∫°y l·∫°i ch·ªß ƒë·ªÅ n√†y b·∫±ng ng√¥n ng·ªØ ƒë∆°n gi·∫£n nh·∫•t c√≥ th·ªÉ. Vi·∫øt ho·∫∑c n√≥i to ra.</li><li><strong>T√¨m & S·ª≠a L·ªói:</strong> B·∫•t c·ª© khi n√†o b·∫°n b·ªã "k·∫πt", ph·∫£i d√πng thu·∫≠t ng·ªØ ph·ª©c t·∫°p, ho·∫∑c kh√¥ng th·ªÉ gi·∫£i th√≠ch tr√¥i ch·∫£y, b·∫°n ƒë√£ t√¨m th·∫•y l·ªó h·ªïng ki·∫øn th·ª©c c·ªßa m√¨nh. H√£y quay l·∫°i t√†i li·ªáu g·ªëc ƒë·ªÉ h·ªçc l·∫°i cho ƒë·∫øn khi l·∫•p ƒë∆∞·ª£c l·ªó h·ªïng ƒë√≥.</li><li><strong>ƒê∆°n Gi·∫£n H√≥a:</strong> S·∫Øp x·∫øp l·∫°i l·ªùi gi·∫£i th√≠ch cu·ªëi c√πng, s·ª≠ d·ª•ng c√°c v√≠ d·ª• ho·∫∑c ph√©p v√≠ von ƒë∆°n gi·∫£n ƒë·ªÉ n√≥ tr·ªü n√™n m·∫°ch l·∫°c v√† d·ªÖ hi·ªÉu nh·∫•t.</li></ol><h4>C·ªët L√µi</h4><p>K·ªπ thu·∫≠t Feynman bu·ªôc b·∫°n ph·∫£i chuy·ªÉn t·ª´ vi·ªác ti·∫øp thu th·ª• ƒë·ªông (ƒë·ªçc, nghe) sang ch·ªß ƒë·ªông x·ª≠ l√Ω th√¥ng tin. Qu√° tr√¨nh "b·ªã k·∫πt" khi gi·∫£i th√≠ch ch√≠nh l√† c√¥ng c·ª• ch·∫©n ƒëo√°n m·∫°nh m·∫Ω nh·∫•t, n√≥ ch·ªâ ra ch√≠nh x√°c ƒëi·ªÉm b·∫°n c√≤n y·∫øu.</p><p><i>C√°ch nhanh nh·∫•t ƒë·ªÉ ki·ªÉm tra v√† c·ªßng c·ªë s·ª± hi·ªÉu bi·∫øt c·ªßa b·∫°n l√† th·ª≠ d·∫°y l·∫°i n√≥ cho ng∆∞·ªùi kh√°c m·ªôt c√°ch ƒë∆°n gi·∫£n.</i></p>`
                },
                {
                    id: uid('m'),
                    title: 'Ph∆∞∆°ng Ph√°p Vi·∫øt c·ªßa Benjamin Franklin: H·ªçc Vi·∫øt B·∫±ng C√°ch T√°i T·∫°o',
                    content: `<p>Benjamin Franklin ƒë√£ t·ª± r√®n luy·ªán k·ªπ nƒÉng vi·∫øt t·ª´ k√©m c·ªèi tr·ªü n√™n b·∫≠c th·∫ßy b·∫±ng m·ªôt ph∆∞∆°ng ph√°p ch·ªß ƒë·ªông, thay v√¨ ch·ªâ ƒë·ªçc m·ªôt c√°ch th·ª• ƒë·ªông. C·ªët l√µi c·ªßa ph∆∞∆°ng ph√°p n√†y l√† ph√¢n t√≠ch, t√°i t·∫°o, v√† so s√°nh v·ªõi m·ªôt b√†i vi·∫øt ch·∫•t l∆∞·ª£ng cao.</p><p>ƒê√¢y l√† m·ªôt v√≠ d·ª• kinh ƒëi·ªÉn c·ªßa "Luy·ªán t·∫≠p c√≥ Ch·ªß ƒë√≠ch": t·∫≠p trung v√†o ƒëi·ªÉm y·∫øu, c√≥ m·ª•c ti√™u r√µ r√†ng v√† nh·∫≠n ph·∫£n h·ªìi ngay l·∫≠p t·ª©c.</p><h4>Quy Tr√¨nh 3 B∆∞·ªõc C·ªët L√µi</h4><ol><li><strong>Ph√¢n T√≠ch (Deconstruct):</strong> ƒê·ªçc m·ªôt b√†i vi·∫øt m·∫´u xu·∫•t s·∫Øc. Sau ƒë√≥, ch·ªâ ghi l·∫°i nh·ªØng √Ω ch√≠nh c·ªßa t·ª´ng ƒëo·∫°n ho·∫∑c t·ª´ng c√¢u ra m·ªôt t·ªù gi·∫•y ri√™ng.</li><li><strong>T√°i T·∫°o (Reconstruct):</strong> V√†i ng√†y sau, khi ƒë√£ qu√™n ƒëi vƒÉn phong c·ªßa b·∫£n g·ªëc, h√£y d√πng nh·ªØng ghi ch√∫ √Ω ch√≠nh ƒë√≥ ƒë·ªÉ vi·∫øt l·∫°i to√†n b·ªô b√†i vi·∫øt b·∫±ng ng√¥n ng·ªØ v√† c√°ch di·ªÖn ƒë·∫°t c·ªßa ch√≠nh b·∫°n.</li><li><strong>So S√°nh & S·ª≠a L·ªói (Compare & Correct):</strong> ƒê·ªëi chi·∫øu tr·ª±c ti·∫øp b√†i vi·∫øt c·ªßa b·∫°n v·ªõi b·∫£n g·ªëc. ƒê√¢y l√† b∆∞·ªõc quan tr·ªçng nh·∫•t. N√≥ gi√∫p b·∫°n ph√°t hi·ªán ngay l·∫≠p t·ª©c nh·ªØng l·ªói sai v·ªÅ t·ª´ v·ª±ng, c·∫•u tr√∫c c√¢u, v√† c√°ch s·∫Øp x·∫øp √Ω t∆∞·ªüng ƒë·ªÉ s·ª≠a ch·ªØa.</li></ol><p>Franklin c√≤n th·ª±c h√†nh c√°c bi·∫øn th·ªÉ n√¢ng cao nh∆∞ x√°o tr·ªôn th·ª© t·ª± c√°c √Ω ch√≠nh ƒë·ªÉ r√®n luy·ªán t∆∞ duy logic, ho·∫∑c chuy·ªÉn vƒÉn xu√¥i th√†nh th∆° ƒë·ªÉ l√†m gi√†u v·ªën t·ª´.</p><h4>Nguy√™n T·∫Øc V√†ng</h4><p>Th√†nh c√¥ng c·ªßa ph∆∞∆°ng ph√°p n√†y kh√¥ng ƒë·∫øn t·ª´ vi·ªác l·∫∑p l·∫°i v√¥ th·ª©c, m√† ƒë·∫øn t·ª´ v√≤ng l·∫∑p ph·∫£n h·ªìi tr·ª±c ti·∫øp. Vi·ªác so s√°nh v·ªõi b·∫£n g·ªëc bu·ªôc b·∫°n ph·∫£i ƒë·ªëi m·∫∑t v√† s·ª≠a ch·ªØa nh·ªØng ƒëi·ªÉm y·∫øu c·ª• th·ªÉ c·ªßa m√¨nh, bi·∫øn vi·ªác h·ªçc t·ª´ m·ªôt qu√° tr√¨nh m∆° h·ªì th√†nh m·ªôt b√†i t·∫≠p c√≥ th·ªÉ ƒëo l∆∞·ªùng ƒë∆∞·ª£c.</p><p><i>ƒê·ªÉ vi·∫øt gi·ªèi h∆°n, ƒë·ª´ng ch·ªâ ƒë·ªçc. H√£y ch·ªçn m·ªôt b√†i vi·∫øt hay, ph√¢n t√≠ch n√≥, c·ªë g·∫Øng vi·∫øt l·∫°i, v√† so s√°nh ƒë·ªÉ t√¨m ra l·ªói sai.</i></p>`
                },
                {
                    id: uid('m'),
                    title: 'Nguy√™n T·∫Øc 80/20 ƒê·ªÉ Chinh Ph·ª•c Lƒ©nh V·ª±c M·ªõi',
                    content: `<p>ƒê·ªÉ kh√¥ng b·ªã cho√°ng ng·ª£p khi h·ªçc m·ªôt lƒ©nh v·ª±c m·ªõi, h√£y t·∫≠p trung v√†o 20% ki·∫øn th·ª©c c·ªët l√µi mang l·∫°i 80% k·∫øt qu·∫£ (Li·ªÅu l∆∞·ª£ng Hi·ªáu qu·∫£ T·ªëi thi·ªÉu).</p><h4>20% c·ªët l√µi: √Åp d·ª•ng Khung Ph√¢n t√≠ch 5 B∆∞·ªõc ƒë·ªÉ x√°c ƒë·ªãnh 20% quan tr·ªçng nh·∫•t:</h4><ol><li><strong>X√°c ƒë·ªãnh K·∫øt qu·∫£:</strong> M·ª•c ti√™u cu·ªëi c√πng c·ªßa b·∫°n l√† g√¨? (v√≠ d·ª•: x√¢y d·ª±ng ƒë∆∞·ª£c m·ªôt trang web).</li><li><strong>Ph√¢n t√≠ch N·ªÅn t·∫£ng:</strong> T√¨m 3-5 nguy√™n l√Ω b·∫•t bi·∫øn c·ªßa ng√†nh.</li><li><strong>Nh·∫≠n di·ªán L·ªói sai Ph·ªï bi·∫øn:</strong> H·ªçc c√°ch tr√°nh nh·ªØng l·ªói m√† ng∆∞·ªùi m·ªõi hay m·∫Øc ph·∫£i.</li><li><strong>T√¨m "Y·∫øu t·ªë Nh√¢n":</strong> K·ªπ nƒÉng n√†o s·∫Ω gi√∫p h·ªçc m·ªçi th·ª© kh√°c d·ªÖ d√†ng h∆°n? (v√≠ d·ª•: nh·∫°c l√Ω trong √¢m nh·∫°c).</li><li><strong>L·∫≠p b·∫£n ƒë·ªì ·ª®ng d·ª•ng Th·ª±c ti·ªÖn:</strong> T·∫≠p trung v√†o 20% c√¥ng vi·ªác chi·∫øm 80% th·ªùi gian th·ª±c t·∫ø c·ªßa ng√†nh.</li></ol>`
                },
                {
                    id: uid('m'),
                    title: 'G·ª£i Nh·ªõ Ch·ªß ƒê·ªông (Active Recall): Nguy√™n T·∫Øc C·ªët L√µi ƒê·ªÉ H·ªçc S√¢u',
                    content: `<p>G·ª£i nh·ªõ ch·ªß ƒë·ªông l√† h√†nh ƒë·ªông n·ªó l·ª±c truy xu·∫•t th√¥ng tin t·ª´ n√£o b·ªô m√† kh√¥ng nh√¨n v√†o t√†i li·ªáu. ƒê√¢y l√† ph∆∞∆°ng ph√°p h·ªçc hi·ªáu qu·∫£ v∆∞·ª£t tr·ªôi so v·ªõi vi·ªác ƒë·ªçc l·∫°i, highlight hay t√≥m t·∫Øt m·ªôt c√°ch th·ª• ƒë·ªông.</p><h4>Nguy√™n T·∫Øc 20/80</h4><p><strong>20% C·ªët l√µi:</strong> H√†nh ƒë·ªông "v·∫Øt √≥c" ƒë·ªÉ nh·ªõ l·∫°i th√¥ng tin s·∫Ω c·ªßng c·ªë c√°c li√™n k·∫øt th·∫ßn kinh, gi√∫p chuy·ªÉn ki·∫øn th·ª©c v√†o b·ªô nh·ªõ d√†i h·∫°n. C·∫£m gi√°c kh√≥ khƒÉn khi c·ªë g·∫Øng nh·ªõ ch√≠nh l√† d·∫•u hi·ªáu c·ªßa vi·ªác h·ªçc t·∫≠p hi·ªáu qu·∫£ ƒëang di·ªÖn ra.</p><p><strong>80% K·∫øt qu·∫£:</strong> B·∫°n s·∫Ω ghi nh·ªõ ki·∫øn th·ª©c s√¢u v√† l√¢u h∆°n, ƒë·ªìng th·ªùi bi·∫øt ch√≠nh x√°c m√¨nh ƒëang y·∫øu ·ªü ƒë√¢u.</p><h4>C√°c Ph∆∞∆°ng Ph√°p Quan Tr·ªçng Nh·∫•t</h4><ul><li><strong>T·ª± Ki·ªÉm Tra (Self-testing):</strong> Thay v√¨ ƒë·ªçc l·∫°i ghi ch√∫, h√£y che ch√∫ng ƒëi v√† t·ª± ƒë·∫∑t c√¢u h·ªèi cho m√¨nh. V√≠ d·ª•: D√πng flashcards (th·∫ª ghi nh·ªõ) v√† lu√¥n tr·∫£ l·ªùi tr∆∞·ªõc khi l·∫≠t xem ƒë√°p √°n.</li><li><strong>K·ªπ thu·∫≠t "Blurting":</strong> Sau khi h·ªçc m·ªôt ch·ªß ƒë·ªÅ, h√£y ƒë√≥ng s√°ch l·∫°i v√† vi·∫øt ra gi·∫•y m·ªçi th·ª© b·∫°n c√≥ th·ªÉ nh·ªõ. Sau ƒë√≥, so s√°nh v·ªõi t√†i li·ªáu g·ªëc ƒë·ªÉ l·∫•p ƒë·∫ßy nh·ªØng l·ªó h·ªïng ki·∫øn th·ª©c.</li><li><strong>D·∫°y l·∫°i cho ng∆∞·ªùi kh√°c:</strong> Gi·∫£i th√≠ch m·ªôt kh√°i ni·ªám cho ng∆∞·ªùi kh√°c bu·ªôc b·∫°n ph·∫£i truy xu·∫•t, ƒë∆°n gi·∫£n h√≥a v√† s·∫Øp x·∫øp l·∫°i th√¥ng tin m·ªôt c√°ch m·∫°ch l·∫°c.</li></ul><p><i>T√≥m l·∫°i: ƒê·ª´ng ch·ªâ ƒë·ªçc l·∫°i. H√£y d·ª´ng l·∫°i, che t√†i li·ªáu ƒëi, v√† t·ª± h·ªèi: "M√¨nh th·ª±c s·ª± nh·ªõ ƒë∆∞·ª£c g√¨?"</i></p>`
                },
                {
                    id: uid('m'),
                    title: 'L·∫∑p L·∫°i Ng·∫Øt Qu√£ng (Spaced Repetition): H·ªçc ƒê√∫ng Th·ªùi ƒêi·ªÉm',
                    content: `<p>N·∫øu G·ª£i nh·ªõ ch·ªß ƒë·ªông l√† v·ªÅ c√°ch h·ªçc, th√¨ L·∫∑p l·∫°i ng·∫Øt qu√£ng l√† v·ªÅ th·ªùi ƒëi·ªÉm h·ªçc. ƒê√¢y l√† m·ªôt h·ªá th·ªëng l√™n l·ªãch √¥n t·∫≠p ƒë·ªÉ ƒë∆∞a th√¥ng tin v√†o tr√≠ nh·ªõ d√†i h·∫°n m·ªôt c√°ch hi·ªáu qu·∫£ nh·∫•t.</p><h4>Nguy√™n T·∫Øc C·ªët L√µi: Ch·ªëng L·∫°i S·ª± L√£ng Qu√™n üß†</h4><p>Ph∆∞∆°ng ph√°p n√†y d·ª±a tr√™n "ƒê∆∞·ªùng cong L√£ng qu√™n", cho th·∫•y ch√∫ng ta qu√™n th√¥ng tin nhanh nh·∫•t ngay sau khi h·ªçc. L·∫∑p l·∫°i ng·∫Øt qu√£ng ho·∫°t ƒë·ªông b·∫±ng c√°ch y√™u c·∫ßu b·∫°n √¥n t·∫≠p l·∫°i m·ªôt th√¥ng tin ngay tr∆∞·ªõc khi b·∫°n s·∫Øp qu√™n n√≥.</p><p>M·ªói l·∫ßn √¥n t·∫≠p th√†nh c√¥ng s·∫Ω l√†m cho kho·∫£ng th·ªùi gian b·∫°n nh·ªõ th√¥ng tin ƒë√≥ d√†i ra. L·∫ßn ƒë·∫ßu b·∫°n c√≥ th·ªÉ qu√™n sau 1 ng√†y, nh∆∞ng sau khi √¥n t·∫≠p, b·∫°n s·∫Ω nh·ªõ ƒë∆∞·ª£c trong 3 ng√†y, r·ªìi 1 tu·∫ßn, 1 th√°ng, v√† c·ª© th·∫ø xa d·∫ßn.</p><h4>C√¥ng C·ª• Hi·ªáu Qu·∫£ Nh·∫•t: Ph·∫ßn M·ªÅm SRS üì±</h4><p>Thay v√¨ t·ª± l√™n l·ªãch th·ªß c√¥ng, c√°ch hi·ªáu qu·∫£ nh·∫•t l√† s·ª≠ d·ª•ng c√°c ph·∫ßn m·ªÅm L·∫∑p l·∫°i ng·∫Øt qu√£ng (Spaced Repetition Software - SRS). Anki ƒë∆∞·ª£c xem l√† ti√™u chu·∫©n v√†ng. N√≥ t·ª± ƒë·ªông h√≥a ho√†n to√†n vi·ªác l√™n l·ªãch √¥n t·∫≠p cho h√†ng ng√†n th·∫ª ghi nh·ªõ d·ª±a tr√™n ƒë·ªô kh√≥ m√† b·∫°n t·ª± ƒë√°nh gi√°, ƒë·∫£m b·∫£o b·∫°n lu√¥n √¥n t·∫≠p v√†o th·ªùi ƒëi·ªÉm t·ªëi ∆∞u nh·∫•t.</p><h4>Sai L·∫ßm L·ªõn Nh·∫•t C·∫ßn Tr√°nh ‚ùå</h4><p>L√Ω do s·ªë m·ªôt khi·∫øn m·ªçi ng∆∞·ªùi th·∫•t b·∫°i v·ªõi ph∆∞∆°ng ph√°p n√†y l√† "Qu√° t·∫£i L·ªãch √¥n t·∫≠p" (Review Overload). ƒêi·ªÅu n√†y x·∫£y ra khi b·∫°n t·∫°o qu√° nhi·ªÅu th·∫ª m·ªõi m·ªói ng√†y ho·∫∑c b·ªè l·ª° v√†i ng√†y √¥n t·∫≠p, d·∫´n ƒë·∫øn m·ªôt l∆∞·ª£ng th·∫ª t·ªìn ƒë·ªçng kh·ªïng l·ªì g√¢y n·∫£n ch√≠.</p><p><strong>Gi·∫£i ph√°p (20% h√†nh ƒë·ªông, 80% k·∫øt qu·∫£):</strong> H√£y nh·∫•t qu√°n. ƒê·∫∑t ra gi·ªõi h·∫°n th·ª±c t·∫ø v·ªÅ s·ªë l∆∞·ª£ng th·∫ª m·ªõi m·ªói ng√†y (v√≠ d·ª•: 10-20 th·∫ª) v√† duy tr√¨ vi·ªác √¥n t·∫≠p h√†ng ng√†y. Th√† h·ªçc √≠t m√† ƒë·ªÅu c√≤n h∆°n h·ªçc d·ªìn.</p><h4>S·ª± K·∫øt H·ª£p S·ªëng C√≤n: AR + SR</h4><p>L·∫∑p l·∫°i ng·∫Øt qu√£ng (SR) v√† G·ª£i nh·ªõ ch·ªß ƒë·ªông (AR) l√† hai m·∫∑t c·ªßa c√πng m·ªôt ƒë·ªìng xu v√† kh√¥ng th·ªÉ t√°ch r·ªùi. SR cung c·∫•p l·ªãch tr√¨nh KHI N√ÄO n√™n √¥n t·∫≠p. AR l√† h√†nh ƒë·ªông b·∫°n th·ª±c hi·ªán KHI √¥n t·∫≠p. S·ª± k·∫øt h·ª£p n√†y ƒë·∫£m b·∫£o n·ªó l·ª±c g·ª£i nh·ªõ c·ªßa b·∫°n x·∫£y ra v√†o "ƒëi·ªÉm ng·ªçt" c·ªßa tr√≠ nh·ªõ. S·ª≠ d·ª•ng Anki ch√≠nh l√† c√°ch tri·ªÉn khai k·ªπ thu·∫≠t k·∫øt h·ª£p n√†y m·ªôt c√°ch hi·ªáu qu·∫£ nh·∫•t.</p>`
                }
            ]
        },
        topics: []
    };
    // ƒê·ªìng nh·∫•t logic: lo·∫°i b·ªè kho tri th·ª©c to√†n c·ª•c trong defaults (ch·ªâ d√πng per-subtopic)
    try { delete defaults.settings.methods; } catch(_) {}
    let data;
    let editingPreset = 'A';

    // (C√°c h√†m c√≤n l·∫°i gi·ªØ nguy√™n)
    // ...
    // ...
    // callGeminiAPI unified at the end of file (single source of truth)
    let AUDIO_CTX = null;
    function ensureAudio(){ if(!AUDIO_CTX) AUDIO_CTX = new (window.AudioContext||window.webkitAudioContext)(); }
    function tone(freq=880, durMs=200, vol=0.2, type='sine', when=0){ ensureAudio(); const ctx=AUDIO_CTX; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); const t = ctx.currentTime + when; g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(vol, t+0.01); g.gain.exponentialRampToValueAtTime(0.0001, t + durMs/1000); o.start(t); o.stop(t + durMs/1000 + 0.05); }
    function playSound(kind){
      if(!data.settings.soundOn) return;
      const vol = Math.max(0, Math.min(1, data.settings.volume ?? 0.8));
      const useCustom = !!data.settings.useCustomSounds;
      const ref = useCustom ? data.settings.customSounds?.[kind] : '';
      let audioEl;
      if (kind === 'work_end') audioEl = $('#audioWorkEnd'); else if (kind === 'break_end') audioEl = $('#audioBreakEnd'); else if (kind === 'long_end') audioEl = $('#audioLongEnd');
      if (ref && audioEl) {
        if (ref.startsWith('data:') || ref.startsWith('http') || ref.startsWith('blob:')) {
            audioEl.src = ref;
            audioEl.volume = vol;
            audioEl.play().catch(e => console.error("L·ªói ph√°t √¢m thanh:", e));
        } else {
            getStoredFileUrl(ref).then(url => {
                if (url) {
                    audioEl.src = url;
                    audioEl.volume = vol;
                    audioEl.play().catch(e => console.error("L·ªói ph√°t √¢m thanh:", e));
                }
            });
        }
        return;
      }
      const theme = data.settings.soundTheme || 'beep';
      if(theme==='beep'){
        if(kind==='work_end') { tone(880,250,vol); tone(660,180,vol*0.8, 'sine', 0.22); } else if(kind==='break_end') { tone(660,220,vol*0.9); } else if(kind==='long_end') { tone(520,200,vol); tone(780,200,vol, 'sine', 0.22); tone(1040,220,vol, 'sine', 0.44); }
      } else {
        if(kind==='work_end') { tone(1200,160,vol*0.9,'triangle'); tone(900,220,vol*0.8,'triangle',0.18); } else if(kind==='break_end') { tone(880,240,vol*0.8,'triangle'); } else if(kind==='long_end') { tone(600,220,vol*0.9,'triangle'); tone(950,240,vol*0.9,'triangle',0.22); tone(1200,240,vol,'triangle',0.44); }
      }
    }
      async function saveData() {
        try {
          await storageManager.save(data);
        } catch (err) {
          console.error('Failed to save data:', err);
          toast(`L·ªói l∆∞u d·ªØ li·ªáu: ${err.message}`);
        }
      }
        async function ensureValidSelection(){
          const set = data.settings;
          if (!data.topics || data.topics.length === 0) { set.selectedTopicId = ''; set.selectedSubtopicId = ''; await saveData(); return; }
          const t = data.topics.find(x=>x.id===set.selectedTopicId);
          const s = t?.subtopics.find(x=>x.id===set.selectedSubtopicId);
          if(!t || !s){
            const t0 = data.topics[0];
            const s0 = t0?.subtopics?.[0];
            set.selectedTopicId = t0?.id || '';
            set.selectedSubtopicId = s0?.id || '';
            await saveData();
          }
        }
    function showInputModal(title, okCallback, defaultValue = '') {
        $('#genericTitle').textContent = title;
        $('#genericMessage').classList.add('hidden');
        const input = $('#genericInput'); input.value = defaultValue; input.classList.remove('hidden');
        $('#modalGeneric').classList.add('show');
        try { trapFocus($('#modalGeneric')); } catch(_) {}
        input.focus(); input.select();
        const okHandler = () => { okCallback(input.value); cleanup(); };
        const cancelHandler = () => cleanup();
        const keyHandler = (e) => { if (e.key === 'Enter') okHandler(); if (e.key === 'Escape') cancelHandler(); };
        $('#btnGenericOk').onclick = okHandler; $('#btnGenericCancel').onclick = cancelHandler; input.onkeydown = keyHandler;
        function cleanup() { $('#modalGeneric').classList.remove('show'); $('#btnGenericOk').onclick = null; $('#btnGenericCancel').onclick = null; input.onkeydown = null; try { releaseFocus(); } catch(_) {} }
    }
    function showConfirmModal(title, message, okCallback) {
        $('#genericTitle').textContent = title;
        const msgEl = $('#genericMessage'); msgEl.textContent = message; msgEl.classList.remove('hidden');
        $('#genericInput').classList.add('hidden'); $('#modalGeneric').classList.add('show');
        try { trapFocus($('#modalGeneric')); } catch(_) {}
        const okHandler = () => { okCallback(true); cleanup(); };
        const cancelHandler = () => { okCallback(false); cleanup(); };
        $('#btnGenericOk').onclick = okHandler; $('#btnGenericCancel').onclick = cancelHandler;
        function cleanup() { $('#modalGeneric').classList.remove('show'); $('#btnGenericOk').onclick = null; $('#btnGenericCancel').onclick = null; try { releaseFocus(); } catch(_) {} }
    }
    // Modal ghi ch√∫ cho phi√™n v·ª´a ho√†n th√†nh
    let pendingNoteSessionId = null;
    function openNoteModal(sessionId) {
        pendingNoteSessionId = sessionId || null;
        const modal = $('#modalNote');
        if (!modal) return;
        const text = $('#noteText');
        if (text) { try { text.value = ''; } catch(_) {} }
        modal.classList.add('show');
        try { trapFocus(modal); } catch(_) {}
    }
    function closeNoteModal() {
        const modal = $('#modalNote');
        if (!modal) return;
        modal.classList.remove('show');
        pendingNoteSessionId = null;
        try { releaseFocus(); } catch(_) {}
    }
    async function switchView(viewId) {
        $$('.view').forEach(v => v.classList.remove('active'));
        $(`#view-${viewId}`).classList.add('active');
        $$('.nav-btn').forEach(b => b.classList.remove('active'));
        const navBtn = $(`.nav-btn[data-view="${viewId}"]`);
        if (navBtn) navBtn.classList.add('active');
        data.settings.currentView = viewId;
        await saveData();
        if (viewId === 'stats') {
            renderDashboard();
        }
    }
    function closeAllMenus() {
        $$('.actions-menu.show').forEach(menu => menu.classList.remove('show'));
        $$('.topic-item.menu-active').forEach(item => item.classList.remove('menu-active'));
    }
    function renderTopics(){
      const wrap = $('#topicsList');
      if (!wrap) return;
      wrap.innerHTML='';
      const collapsedMap = data.settings.collapsedTopics || {};
      data.topics.forEach(topic => {
        const box = document.createElement('div');
        box.className='topic-item';
        box.dataset.tid = topic.id;
        const header = document.createElement('div');
        header.className='topic-header';
        const isCollapsed = !!collapsedMap[topic.id];
        const chev = document.createElement('button');
        chev.className = 'chev btn small ghost';
        chev.setAttribute('aria-expanded', String(!isCollapsed));
        chev.innerHTML = '<span class="ico">‚ñæ</span>';
        const title = document.createElement('div');
        title.className='topic-title';
        title.textContent = topic.name;
        const act = document.createElement('div');
        act.className='topic-actions';
        const bAdd = document.createElement('button');
        bAdd.className='btn small';
        bAdd.innerHTML = 'Ôºã Th√™m';
        bAdd.title = 'Th√™m Ch·ªß ƒë·ªÅ con';
        const menuContainer = document.createElement('div');
        menuContainer.style.position = 'relative';
        const bMore = document.createElement('button');
        bMore.className = 'btn small ghost actions-menu-btn';
        bMore.innerHTML = '...';
        bMore.title = 'Th√™m t√πy ch·ªçn';
        const menu = document.createElement('div');
        menu.className = 'actions-menu';
        const bEdit = document.createElement('button');
        bEdit.className = 'menu-item';
        bEdit.innerHTML = 'S·ª≠a t√™n Ch·ªß ƒë·ªÅ';
        const bDel = document.createElement('button');
        bDel.className = 'menu-item danger';
        bDel.innerHTML = 'X√≥a Ch·ªß ƒë·ªÅ';
        menu.append(bEdit, bDel);
        menuContainer.append(bMore, menu);
        act.append(bAdd, menuContainer);
        header.append(chev, title, act);
        // Chevron toggles collapse/expand of subtopics
        chev.addEventListener('click', async (e) => {
          e.stopPropagation();
          const currentlyCollapsed = !!collapsedMap[topic.id];
          if (currentlyCollapsed) { delete collapsedMap[topic.id]; } else { collapsedMap[topic.id] = true; }
          data.settings.collapsedTopics = collapsedMap;
          await storageManager.updateSettings(data.settings);
          renderTopics();
        });
        const toggleTopic = async () => {
          const currentlyCollapsed = !!collapsedMap[topic.id];
          if (currentlyCollapsed) { delete collapsedMap[topic.id]; } else { collapsedMap[topic.id] = true; }
          data.settings.collapsedTopics = collapsedMap;
          await storageManager.updateSettings(data.settings);
          renderTopics();
        };
        // Allow clicking the topic header to toggle subtopics
        // (ignore clicks on actual interactive controls only)
        header.addEventListener('click', async (e) => {
          const t = e.target;
          if (t && t.closest) {
            if (t.closest('.actions-menu') || t.closest('.actions-menu-btn') || t.closest('button') || t.closest('input,select,textarea')) {
              return; // user interacted with a control, don't toggle
            }
          }
          e.stopPropagation();
          await toggleTopic();
        });
        // Make the title area itself a large click target to toggle
        title.addEventListener('click', async (e) => { e.stopPropagation(); await toggleTopic(); });
        // Also allow clicking anywhere on the topic card (outside subtopics and controls) to toggle
        box.addEventListener('click', async (e) => {
          const t = e.target;
          if (t && t.closest) {
            if (t.closest('.subtopics')) return;
            if (t.closest('.actions-menu') || t.closest('.actions-menu-btn') || t.closest('button') || t.closest('input,select,textarea')) return;
          }
          await toggleTopic();
        });
        const subs = document.createElement('div');
        subs.className='subtopics' + (isCollapsed? ' hidden':'');
        subs.dataset.tid = topic.id;
        topic.subtopics.forEach(st => {
          const row = document.createElement('div');
          row.className='sub-row';
          row.dataset.sid = st.id;
          const btn = document.createElement('button');
          btn.className='btn subtopic-btn';
          // B·ªçc vƒÉn b·∫£n trong span ƒë·ªÉ x·ª≠ l√Ω tr√†n t·ªët h∆°n v√† escape HTML
          btn.innerHTML = `<span>‚Ä¢ ${escapeHTML(st.name)}</span>`;
          btn.dataset.sid = st.id;
          btn.dataset.tid = topic.id;
          if(data.settings.selectedSubtopicId===st.id) btn.classList.add('active');
          const subActions = document.createElement('div');
          subActions.className = 'actions';
          const subMenuContainer = document.createElement('div');
          subMenuContainer.style.position = 'relative';
          const subBMore = document.createElement('button');
          subBMore.className = 'btn small ghost actions-menu-btn';
          subBMore.innerHTML = '...';
          subBMore.title = 'Th√™m t√πy ch·ªçn';
          const subMenu = document.createElement('div');
          subMenu.className = 'actions-menu';
          const subBEdit = document.createElement('button');
          subBEdit.className = 'menu-item';
          subBEdit.innerHTML = 'S·ª≠a t√™n Ch·ªß ƒë·ªÅ con';
          const subBDel = document.createElement('button');
          subBDel.className = 'menu-item danger';
          subBDel.innerHTML = 'X√≥a Ch·ªß ƒë·ªÅ con';
          subMenu.append(subBEdit, subBDel);
          subMenuContainer.append(subBMore, subMenu);
          subActions.append(subMenuContainer);
          row.append(btn, subActions);
          subs.appendChild(row);
          btn.addEventListener('click', ()=> selectSubtopic(topic.id, st.id));
          subBMore.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = subMenu.classList.contains('show');
            closeAllMenus();
            if (isOpen) {
              // ƒêang m·ªü => ƒë√≥ng v√† KH√îNG m·ªü l·∫°i
              box.classList.remove('menu-active');
            } else {
              // ƒêang ƒë√≥ng => m·ªü menu n√†y v√† n√¢ng z-index
              subMenu.classList.add('show');
              box.classList.add('menu-active');
            }
          });
          subBEdit.addEventListener('click', ()=> showInputModal('ƒê·ªïi t√™n Ch·ªß ƒë·ªÅ con', async (newName) => { if(!newName) return; st.name=newName; await storageManager.update('subtopics', st); renderAll(); }, st.name));
          subBDel.addEventListener('click', ()=> showConfirmModal('X√°c nh·∫≠n x√≥a', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Ch·ªß ƒë·ªÅ con "${st.name}"? M·ªçi d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã m·∫•t.`, async (ok) => { if(!ok) return; topic.subtopics = topic.subtopics.filter(x=>x.id!==st.id); const set=data.settings; if(set.selectedSubtopicId===st.id){ set.selectedSubtopicId=''; set.selectedTopicId=''; ensureValidSelection(); } await storageManager.delete('subtopics', st.id); renderAll(); }));
        });
        
        bMore.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = menu.classList.contains('show');
          closeAllMenus();
          if (isOpen) {
            // ƒêang m·ªü => ƒë√≥ng v√† KH√îNG m·ªü l·∫°i
            box.classList.remove('menu-active');
          } else {
            // ƒêang ƒë√≥ng => m·ªü menu n√†y v√† n√¢ng z-index
            menu.classList.add('show');
            box.classList.add('menu-active');
          }
        });
        bAdd.addEventListener('click', ()=> showInputModal('T√™n Ch·ªß ƒë·ªÅ con m·ªõi?', async (name) => { if(!name) return; const newSub = { id: uid('s'), topicId: topic.id, name, tasks: [], generalNotes: [], summaries: [], chatHistory: [], methods: [], stats:{ totalMinutes:0, sessionsCompleted:0, tasksCompleted: 0 }, sessions: [], timerState: { state: 'idle', prevState: null, remaining: 0, segmentTotal: 0, cycleIndex: 0 } }; topic.subtopics.push(newSub); await storageManager.add('subtopics', newSub); renderTopics(); }));
        bEdit.addEventListener('click', ()=> showInputModal('ƒê·ªïi t√™n Ch·ªß ƒë·ªÅ', async (newName) => { if(!newName) return; topic.name=newName; await storageManager.update('topics', topic); renderTopics(); }, topic.name));
        bDel.addEventListener('click', ()=> showConfirmModal('X√°c nh·∫≠n x√≥a', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Ch·ªß ƒë·ªÅ "${topic.name}"? M·ªçi ch·ªß ƒë·ªÅ con v√† d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã m·∫•t.`, async (ok) => { if(!ok) return; data.topics = data.topics.filter(t=>t.id!==topic.id); delete collapsedMap[topic.id]; if(data.settings.selectedTopicId===topic.id){ data.settings.selectedTopicId=''; data.settings.selectedSubtopicId=''; ensureValidSelection(); } await storageManager.delete('topics', topic.id); for(const sub of topic.subtopics){ await storageManager.delete('subtopics', sub.id); } renderAll(); }));
        // Prevent header toggle when clicking action buttons
        bAdd.addEventListener('click', (e)=> e.stopPropagation());
        bEdit.addEventListener('click', (e)=> e.stopPropagation());
        bDel.addEventListener('click', (e)=> e.stopPropagation());
        box.append(header, subs);
        wrap.appendChild(box);
      });
      if (window.Sortable) {
        const topicsListEl = document.getElementById('topicsList');
        if (topicsListEl) {
          if (topicsListEl._sortable) { try { topicsListEl._sortable.destroy(); } catch (e) {} }
          topicsListEl._sortable = new Sortable(topicsListEl, {
            animation: 150,
            draggable: '.topic-item',
            onEnd: async function (evt) {
              if (evt.oldIndex === evt.newIndex) return;
              const moved = data.topics.splice(evt.oldIndex, 1)[0];
              data.topics.splice(evt.newIndex, 0, moved);
              await saveData();
              renderTopics();
            }
          });
          topicsListEl.querySelectorAll('.subtopics').forEach(subsEl => {
            new Sortable(subsEl, {
              group: 'subtopics-group',
              animation: 150,
              draggable: '.sub-row',
              onEnd: async function (evt) {
                const fromTopicId = evt.from?.dataset?.tid || evt.from?.closest('.topic-item')?.dataset?.tid;
                const toTopicId = evt.to?.dataset?.tid || evt.to?.closest('.topic-item')?.dataset?.tid;
                const fromTopic = data.topics.find(t => t.id === fromTopicId);
                const toTopic = data.topics.find(t => t.id === toTopicId);
                if (!fromTopic || !toTopic) return;
                let movedSubtopic = null;
                const movedSid = evt.item?.dataset?.sid || evt.item?.querySelector('.subtopic-btn')?.dataset?.sid;
                if (movedSid) {
                  const idx = fromTopic.subtopics.findIndex(s => s.id === movedSid);
                  if (idx >= 0) movedSubtopic = fromTopic.subtopics.splice(idx, 1)[0];
                }
                if (!movedSubtopic) {
                  movedSubtopic = fromTopic.subtopics.splice(evt.oldIndex, 1)[0];
                }
                if (!movedSubtopic) return;
                movedSubtopic.topicId = toTopic.id;
                toTopic.subtopics.splice(evt.newIndex, 0, movedSubtopic);
                if (data.settings.selectedSubtopicId === movedSubtopic.id) {
                  data.settings.selectedTopicId = toTopic.id;
                }
                await saveData();
                renderTopics();
              }
            });
          });
        }
      }
    }
    function selectSubtopic(topicId, subId) {
        const mainEl = $('.app-content');
        const oldSubtopic = getCurrentSubtopic();
        if (oldSubtopic && timer.state !== 'idle') {
            oldSubtopic.timerState = {
                state: timer.state,
                prevState: timer.prevState,
                remaining: timer.remaining,
                segmentTotal: timer.segmentTotal,
                cycleIndex: timer.cycleIndex
            };
        }
        mainEl.classList.add('reloading');
        setTimeout(async () => {
            data.settings.selectedTopicId = topicId;
            data.settings.selectedSubtopicId = subId;
            const newSubtopic = getCurrentSubtopic();
            if (newSubtopic.timerState) {
                timer.state = newSubtopic.timerState.state;
                timer.prevState = newSubtopic.timerState.prevState || null;
                timer.remaining = newSubtopic.timerState.remaining;
                timer.segmentTotal = newSubtopic.timerState.segmentTotal;
                timer.cycleIndex = newSubtopic.timerState.cycleIndex;
            } else {
                timer.reset();
            }
            await saveData();
            timer.updateUI();
            renderAll();
            switchView('timer');
            mainEl.classList.remove('reloading');
        }, 200);
    }
    function getCurrentSubtopic(){ const tid=data.settings.selectedTopicId, sid=data.settings.selectedSubtopicId; if(!tid||!sid) return null; const t=data.topics.find(x=>x.id===tid); if(!t) return null; return t.subtopics.find(x=>x.id===sid) || null; }
    function renderContextBadge(){
      const s=getCurrentSubtopic();
      const name = s ? s.name : '(ch∆∞a ch·ªçn)';
      const selectedContext = $('#selectedContext');
      const currentName = $('#currentSubtopicName');
      const currentChatName = $('#currentSubtopicNameChat');
      if (selectedContext) selectedContext.textContent = s? `Ch·ªß ƒë·ªÅ con: ${s.name}`:'Ch∆∞a ch·ªçn Ch·ªß ƒë·ªÅ con';
      if (currentName) currentName.textContent = name;
      if (currentChatName) currentChatName.textContent = name;
    }
    function renderSubtopicTasks() {
        const s = getCurrentSubtopic();
        const listEl = $('#subtopicTasksList');
        const inputEl = $('#newSubtopicTaskInput');
        if (!listEl || !inputEl) return;
        const addArea = inputEl.parentElement;
        if (!s) {
            listEl.innerHTML = '<li class="tiny" style="opacity: 0.7;">Ch·ªçn ch·ªß ƒë·ªÅ con ƒë·ªÉ xem to-do list.</li>';
            addArea.classList.add('hidden'); return;
        }
        addArea.classList.remove('hidden');
        listEl.innerHTML = '';
        const uncompletedTasks = s.tasks ? s.tasks.filter(t => !t.isCompleted) : [];

        if (uncompletedTasks.length === 0) {
            listEl.innerHTML = '<li class="tiny" style="opacity: 0.7;">Tuy·ªát v·ªùi! Kh√¥ng c√≤n task n√†o.</li>';
        }
        uncompletedTasks.forEach(task => {
            const item = document.createElement('li');
            item.innerHTML = `<input type="checkbox" id="${task.id}" title="Ho√†n th√†nh task"> <label for="${task.id}">${escapeHTML(task.text)}</label>`;
            item.querySelector('input').addEventListener('change', (e) => toggleSubtopicTask(e.target.id, item));
            listEl.appendChild(item);
        });
    }
    async function addSubtopicTask() {
        const s = getCurrentSubtopic();
        if (!s) { toast(t('timer.selectSubtopicPrompt')); return; }
        const input = $('#newSubtopicTaskInput');
        const text = input.value.trim();
        if (text) {
            if (!s.tasks) s.tasks = [];
            s.tasks.push({ id: uid('task'), text, isCompleted: false, createdAt: todayISO() });
            await saveData();
            renderSubtopicTasks();
            input.value = '';
        }
        input.focus();
    }
    async function toggleSubtopicTask(taskId, listItemElement) {
        const s = getCurrentSubtopic();
        if (!s || !s.tasks) return;
        const task = s.tasks.find(t => t.id === taskId);
        if (task) {
            task.isCompleted = true;
            s.stats.tasksCompleted = (s.stats.tasksCompleted || 0) + 1;
            await saveData();
            listItemElement.classList.add('removing');
            setTimeout(() => {
                renderSubtopicTasks();
                renderStatsHistory();
            }, 200);
        }
    }
    const timer = {
      state:'idle', prevState:null, tickHandle:null, endAt:null,
      remaining:0, segmentTotal:0, cyclesTarget:4, cycleIndex:0, mode:'A',
      persistInterval: 60*1000,
      lastPersist: 0,
      async setPreset(p, {silent=false}={}){
        const st = data.settings;
        this.mode = p;
        this.cyclesTarget = (p==='A' ? st.cyclesA : (p==='B' ? st.cyclesB : 0));
        st.preset = p;
        await saveData();
        if (this.state === 'idle') {
          this.reset();
        }
      },
      currentDurations(){
        const d=data.settings.durations;
        if(this.mode==='A') return {work:d.A_work, short:d.A_short, long:d.A_long, winddown: d.A_winddown ?? 0};
        if(this.mode==='B') return {work:d.B_work, short:d.B_short, long:d.B_long, winddown: d.B_winddown ?? 0};
        return {work:0, short:0, long:0, winddown:0};
      },
      currentConfig(){ const s=data.settings; if(this.mode==='A') return {cycles:s.cyclesA, interval:s.longBreakIntervalA}; if(this.mode==='B') return {cycles:s.cyclesB, interval:s.longBreakIntervalB}; return {cycles:0, interval:0}; },
      updateUI() {
        const badge = $('#stateBadge');
        const progressCircle = $('.timer-circle-progress');
        const container = $('.timer-circle-container');
        if (!badge || !progressCircle || !container) return;
        const isFlowMode = (this.mode === 'C');
        $('#btnStart').classList.toggle('hidden', this.state !== 'idle' || (isFlowMode && this.state === 'work'));
        $('#btnFinishFlow').classList.toggle('hidden', !(isFlowMode && this.state === 'work'));
        $('#btnPause').classList.toggle('hidden', !['work', 'break', 'long_break'].includes(this.state));
        $('#btnResume').classList.toggle('hidden', this.state !== 'paused');
        let currentColor = 'var(--muted)';
        if (this.state === 'work') { badge.textContent = isFlowMode ? 'L√ÄM VI·ªÜC (FLOW)' : 'L√ÄM VI·ªÜC'; badge.className = 'badge state work'; currentColor = 'var(--acc)'; }
        else if (this.state === 'break') { badge.textContent = 'NGH·ªà NG·∫ÆN'; badge.className = 'badge state break'; currentColor = 'var(--warn)'; }
        else if (this.state === 'long_break') { badge.textContent = 'NGH·ªà D√ÄI'; badge.className = 'badge state long'; currentColor = 'var(--danger)'; }
        else if (this.state === 'wind_down') { badge.textContent = 'H·∫† NHI·ªÜT'; badge.className = 'badge state work'; currentColor = 'var(--acc-2)'; try { $('#windDownChecklist').classList.remove('hidden'); $('#btnBreakEarly').classList.remove('hidden'); } catch(_){} }
        else if (this.state === 'paused') { badge.textContent = 'T·∫†M D·ª™NG'; badge.className = 'badge'; }
        else { badge.textContent = 'S·∫¥N S√ÄNG'; badge.className = 'badge'; }
        try {
          if (this.state === 'work') badge.textContent = isFlowMode ? t('stateBadgeFocusFlow') : t('stateBadgeFocus');
          else if (this.state === 'break') badge.textContent = t('stateBadgeShortBreak');
          else if (this.state === 'long_break') badge.textContent = t('stateBadgeLongBreak');
          else if (this.state === 'wind_down') badge.textContent = t('stateBadgeWindDown');
          else if (this.state === 'paused') badge.textContent = t('stateBadgePaused');
          else badge.textContent = t('stateBadgeReady');
        } catch(_) {}
        if (['work','break','long_break','wind_down'].includes(this.state)) { container.classList.add('breathing'); } else { container.classList.remove('breathing'); }
        progressCircle.style.stroke = currentColor; container.classList.remove('finished');
        const timeEl = $('#timeDisplay'); if (timeEl) timeEl.textContent = formatMMSS(this.remaining);
        const radius = progressCircle.r.baseVal.value; const circumference = 2 * Math.PI * radius;
        const offset = (this.segmentTotal>0) ? (circumference - (this.remaining / this.segmentTotal) * circumference) : circumference;
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = isNaN(offset) ? circumference : offset;
        const cyc = $('#cycleInfo'); if (cyc) { const cfg=this.currentConfig(); cyc.textContent = t('timer.cycleInfo', { current: this.cycleIndex, target: cfg.cycles }); cyc.classList.toggle('hidden', isFlowMode); }
        const bs = $('#breakSuggestionDisplay'); if (bs) { bs.classList.toggle('hidden', isFlowMode && this.state === 'work'); }
        const draggableTimer = $('#draggableTimer'); if (draggableTimer) draggableTimer.textContent = formatMMSS(this.remaining);
        if (this.state !== 'wind_down') {
          try { $('#windDownChecklist').classList.add('hidden'); $('#btnBreakEarly').classList.add('hidden'); } catch(_){}
        }
      },
      persistTimerState(force=false){
        try{
          const s = getCurrentSubtopic(); if(!s) return;
          const state = { state:this.state, prevState:this.prevState, remaining:this.remaining, segmentTotal:this.segmentTotal, cycleIndex:this.cycleIndex };
          s.timerState = state; try{ localStorage.setItem('timerState_'+s.id, JSON.stringify(state)); }catch(_){ }
          this.lastPersist = Date.now();
        }catch(_){ }
      },
      _startTick(){
        if(this.tickHandle) clearInterval(this.tickHandle);
        if (this.mode === 'C' && this.state === 'work') {
          this.tickHandle = setInterval(()=>{ this.remaining += 1; this.updateUI(); this.persistTimerState(); }, 1000);
          return;
        }
        this.tickHandle = setInterval(()=>{ if(this.remaining>0){ this.remaining -= 1; this.updateUI(); this.persistTimerState(); } if(this.remaining<=0){ clearInterval(this.tickHandle); this.tickHandle=null; this._onFinishSegment(); } }, 1000);
      },
      _onFinishSegment(){
        if (this.state === 'work') {
            const s = getCurrentSubtopic();
            if (s) {
                const duration = this.currentDurations().work;
                s.stats.totalMinutes = (s.stats.totalMinutes || 0) + duration;
                s.stats.sessionsCompleted = (s.stats.sessionsCompleted || 0) + 1;
                const newSession = {
                    id: uid('sess'),
                    dateISO: todayISO(),
                    durationMinutes: duration,
                    mode: this.mode,
                    note: ''
                };
                if (!s.sessions) s.sessions = [];
                s.sessions.unshift(newSession);
                if (data?.settings?.enableSessionNotes !== false) {
                    try { openNoteModal(newSession.id); } catch(_) {}
                }
                saveData();
                renderStatsHistory();
                checkAndShowMilestones();
            }
            this.cycleIndex++;
        }
        if ((typeof data !== 'undefined') && data && data.settings && data.settings.enableWinddown === false && this.state === 'work') {
          playSound('work_end');
        } else if (this.state === 'wind_down' || this.state === 'break' || this.state === 'long_break') {
          playSound('break_end');
        }
        const container = $('.timer-circle-container');
        if(container) container.classList.add('finished');
        if (data.settings.autoStartNext) {
          if(this.state==='work'){
            if (data.settings.enableWinddown === false) { this.beginBreak(); }
            else { this.beginWindDown(); }
          } else if (this.state === 'wind_down') {
            this.beginBreak();
          } else {
            this.beginWork();
          }
        } else {
          if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; }
          this.state = 'idle';
          this.prevState = null;
          this.updateUI();
          toast("Phi√™n ƒë√£ ho√†n th√†nh! Nh·∫•n B·∫Øt ƒë·∫ßu ƒë·ªÉ b·∫Øt ƒë·∫ßu phi√™n ti·∫øp theo.");
        }
      },
      beginWindDown(){
        if (data?.settings?.enableWinddown === false) { this.beginBreak(); return; }
        this.prevState = this.state;
        this.state = 'wind_down';
        const d = (this.currentDurations().winddown || 0) * 60;
        if (d <= 0) { this.beginBreak(); return; }
        this.segmentTotal = d;
        this.remaining = d;
        try { playSound('break_end'); } catch(_){}
        try { toast('ƒê·∫øn gi·ªù h·∫° nhi·ªát. H√£y k·∫øt th√∫c c√¥ng vi·ªác v√† chu·∫©n b·ªã ngh·ªâ ng∆°i.'); } catch(_){}
        this._startTick();
        this.updateUI();
      },
      beginWork(){
        this.prevState = this.state;
        this.state = 'work';
        if (this.mode === 'C') {
          this.segmentTotal = 0;
          if (this.prevState !== 'paused') this.remaining = 0; // ƒë·∫øm l√™n t·ª´ 0
        } else {
          const d = this.currentDurations().work * 60;
          this.segmentTotal = d;
          if (this.prevState !== 'paused') this.remaining = d;
        }
        const suggestionEl = $('#breakSuggestionDisplay');
        if (suggestionEl) { suggestionEl.textContent = ''; }
        this._startTick();
        this.updateUI();
      },
      finishFlowSession(){
        if (this.mode !== 'C' || this.state !== 'work') return;
        if (this.tickHandle) { clearInterval(this.tickHandle); this.tickHandle = null; }
        const ratio = Math.max(1, parseInt((data.settings.flowtimeBreakRatio ?? 5), 10));
        const workSec = Math.max(0, this.remaining|0);
        const restSec = Math.max(60, Math.floor(workSec / ratio));
        // Ghi l·∫°i m·ªôt session cho Flow v√† m·ªü modal ghi ch√∫
        try {
          const s = getCurrentSubtopic();
          if (s) {
            const minutes = Math.max(1, Math.round(workSec / 60));
            s.stats.totalMinutes = (s.stats.totalMinutes || 0) + minutes;
            s.stats.sessionsCompleted = (s.stats.sessionsCompleted || 0) + 1;
            const newSession = { id: uid('sess'), dateISO: todayISO(), durationMinutes: minutes, mode: this.mode, note: '' };
            if (!s.sessions) s.sessions = [];
            s.sessions.unshift(newSession);
            saveData();
            renderStatsHistory();
            if (data?.settings?.enableSessionNotes !== false) {
              openNoteModal(newSession.id);
            }
          }
        } catch(_) {}
        this.state = 'break';
        this.segmentTotal = restSec;
        this.remaining = restSec;
        this._startTick();
        this.updateUI();
        this.persistTimerState(true);
        try { toast(`Ngh·ªâ ${Math.round(restSec/60)} ph√∫t theo Flowtime (${ratio}).`); } catch(_) {}
      },
      beginBreak() {
        this.prevState = this.state;
        const config = this.currentConfig();
        const durations = this.currentDurations();
        if (this.cycleIndex > 0 && this.cycleIndex % config.interval === 0) {
          this.state = 'long_break';
          const d = durations.long * 60;
          this.segmentTotal = d;
          if (this.prevState !== 'paused') this.remaining = d;
          toast(`Tuy·ªát v·ªùi! ƒê√£ ƒë·∫øn l√∫c ngh·ªâ d√†i.`);
        } else {
          this.state = 'break';
          const d = durations.short * 60;
          this.segmentTotal = d;
          if (this.prevState !== 'paused') this.remaining = d;
        }
        // Hi·ªÉn th·ªã g·ª£i √Ω khi b·∫Øt ƒë·∫ßu ngh·ªâ
        const suggestionEl = $('#breakSuggestionDisplay');
        if (suggestionEl) {
          const randomIndex = Math.floor(Math.random() * breakSuggestions.length);
          suggestionEl.textContent = `üí° G·ª£i √Ω: ${breakSuggestions[randomIndex]}`;
        }
        this._startTick();
        this.updateUI();
      },
      async start(){ if(!getCurrentSubtopic()){ toast('H√£y ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu'); return; } ensureAudio(); if(this.mode==='C' && this.state==='idle'){ this.state='work'; this.remaining=0; this.segmentTotal=0; this.cycleIndex=0; this._startTick(); this.updateUI(); } else if(this.state==='idle'){ this.cycleIndex = this.cycleIndex || 0; this.beginWork(); } else if(this.state==='paused'){ this.resume(); } await this.persistTimerState(true); },
      async pause(){ if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; } this.prevState=this.state; this.state='paused'; this.updateUI(); await this.persistTimerState(true); },
      async resume(){ if(this.state!=='paused'){ return; } this.state=this.prevState||'work'; this._startTick(); this.updateUI(); await this.persistTimerState(true); },
      async skip(){
        if(this.mode==='C' && this.state==='work'){ this.finishFlowSession(); await this.persistTimerState(true); return; }
        if(this.state==='work'){
          if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; }
          this.remaining = 0;
          this._onFinishSegment();
        } else {
          this.remaining=0; if(this.tickHandle){ clearInterval(this.tickHandle); this.tickHandle=null; } this._onFinishSegment();
        }
        await this.persistTimerState(true);
      },
      async reset(){
        if (this.tickHandle) { clearInterval(this.tickHandle); this.tickHandle = null; }
        this.state = 'idle';
        this.prevState = null;
        this.remaining = 0;
        this.segmentTotal = 0;
        this.cycleIndex = 0;
        // X√≥a g·ª£i √Ω khi ƒë·∫∑t l·∫°i
        const suggestionEl = $('#breakSuggestionDisplay');
        if (suggestionEl) { suggestionEl.textContent = ''; }
        this.updateUI();
        await this.persistTimerState(true);
      }
    };
    async function deleteSummary(id) {
        showConfirmModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√≥m t·∫Øt n√†y?', async (ok) => {
            if (!ok) return;
            const s = getCurrentSubtopic();
            if (!s || !s.summaries) return;
            const original = [...s.summaries];
            s.summaries = s.summaries.filter(x => x.id !== id);
            try {
                await storageManager.update('subtopics', s);
                renderSummaries();
                toast('ƒê√£ x√≥a t√≥m t·∫Øt.');
            } catch (err) {
                console.error('Failed to delete summary:', err);
                s.summaries = original;
                toast('Kh√¥ng th·ªÉ l∆∞u thay ƒë·ªïi.');
            }
        });
    }
function exportSummary(sum) {
        const blob = new Blob([sum.content], { type: 'text/plain' });
        const a = document.createElement('a');
        const ts = new Date(sum.createdAt);
        const pad = n => `${n}`.padStart(2, '0');
        a.href = URL.createObjectURL(blob);
        a.download = `summary_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}.txt`;
        a.click();
        URL.revokeObjectURL(a.href);
}
    function renderStatsHistory(){
        const s = getCurrentSubtopic();
        const statTotal = $('#statTotal');
        const statSessions = $('#statSessions');
        const statTasks = $('#statTasks');
        const list = $('#historyList');
        if (!statTotal || !statSessions || !statTasks || !list) return;

        if (!s) {
            statTotal.textContent = '0 ph√∫t';
            statSessions.textContent = '0';
            statTasks.textContent = '0';
            list.innerHTML = '<div class="tiny">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
            return;
        }

        const total = (s.stats && s.stats.totalMinutes) ? s.stats.totalMinutes : 0;
        const count = (s.stats && s.stats.sessionsCompleted) ? s.stats.sessionsCompleted : 0;
        const tasksDone = s.tasks ? s.tasks.filter(t => t.isCompleted).length : 0;

        statTotal.textContent = formatDaysHoursMinutes(total);
        statSessions.textContent = String(count);
        statTasks.textContent = String(tasksDone);

        list.innerHTML = '';
        const sessions = Array.isArray(s.sessions) ? s.sessions : [];
        if (sessions.length === 0) {
            list.innerHTML = '<div class="tiny">Ch∆∞a c√≥ phi√™n n√†o</div>';
            return;
        }
        sessions.forEach(sess => {
            const row = document.createElement('div');
            row.className = 'hist-item';
            const content = document.createElement('div');
            const date = sess.dateISO ? new Date(sess.dateISO) : new Date();
            const dur = (sess.durationMinutes != null) ? sess.durationMinutes : (sess.workMinutes || 0);
            const metaHTML = `<div class="hist-meta">${date.toLocaleString()} ¬∑ ${dur}' ¬∑ Mode ${sess.mode || ''}</div>`;
            let noteHTML = '';
            if (sess.note) {
                noteHTML = `<div>${escapeHTML(sess.note)}</div>`;
            } else if (data?.settings?.enableSessionNotes !== false) {
                noteHTML = `<div><span class="tiny">(ch∆∞a c√≥ ghi ch√∫)</span></div>`;
            }
            content.innerHTML = metaHTML + noteHTML;
            row.appendChild(content);
            list.appendChild(row);
        });
    }
    function renderGeneralNotes(){
        const listEl = $('#generalNotesList');
        if (!listEl) return;
        const s = getCurrentSubtopic();
        if (!s) { listEl.innerHTML = '<div class="tiny">Vui l√≤ng ch·ªçn m·ªôt ch·ªß ƒë·ªÅ con.</div>'; return; }
        s.generalNotes = s.generalNotes || [];
        if (s.generalNotes.length === 0) { listEl.innerHTML = '<div class="tiny">Ch∆∞a c√≥ ghi ch√∫.</div>'; return; }
        listEl.innerHTML = '';
        s.generalNotes.forEach(note => {
            const item = document.createElement('div'); item.className = 'note-item';
            const content = document.createElement('div'); content.className = 'note-content'; content.textContent = typeof note === 'string' ? note : (note.text || '');
            const meta = document.createElement('div'); meta.className = 'note-meta'; meta.textContent = note.createdAt ? new Date(note.createdAt).toLocaleString() : '';
            const actions = document.createElement('div');
            const delBtn = document.createElement('button'); delBtn.className = 'btn small danger'; delBtn.textContent = 'X√≥a';
            delBtn.onclick = async (e)=>{
                e.stopPropagation();
                const s2 = getCurrentSubtopic(); if (!s2) return;
                s2.generalNotes = (s2.generalNotes || []).filter(x => (x.id || x) !== (note.id || note));
                await saveData();
                renderGeneralNotes();
            };
            actions.appendChild(delBtn);
            const wrap = document.createElement('div'); wrap.className = 'note-content-wrapper'; wrap.append(content, meta);
            item.append(wrap, actions);
            listEl.appendChild(item);
        });
    }
    function renderMethods() {
        const container = document.querySelector('#view-methods .methods-container');
        if (!container) return;
        container.innerHTML = '';

        const s = getCurrentSubtopic();
        if (!s) {
            container.innerHTML = '<p class="tiny" style="opacity:0.7;">Vui l√≤ng ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con ƒë·ªÉ xem Kho Tri Th·ª©c.</p>';
            return;
        }

        const methods = Array.isArray(s.methods) ? s.methods : [];

        if (methods.length === 0) {
            container.innerHTML = '<p class="tiny" style="opacity:0.7;">Ch∆∞a c√≥ tri th·ª©c n√†o trong Ch·ªß ƒë·ªÅ con n√†y.</p>';
            return;
        }

        methods.forEach(method => {
            const details = document.createElement('div');
            details.className = 'method-item';
            details.dataset.methodId = method.id;

            const summary = document.createElement('div');

            // M·ªü r·ªông v√πng nh·∫•n b·∫±ng c√°ch ƒë·∫∑t ti√™u ƒë·ªÅ trong span ri√™ng
            const titleSpan = document.createElement('span');
            titleSpan.className = 'method-title';
            titleSpan.textContent = method.title || 'Ch∆∞a c√≥ ti√™u ƒë·ªÅ';
            // Nh·∫•p v√†o ti√™u ƒë·ªÅ ƒë·ªÉ m·ªü th·∫ª (kh√¥ng toggle)
            titleSpan.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const contentDiv = details.querySelector('.method-content');
                if (!contentDiv) return;
                const isOpening = contentDiv.hidden;
                container.querySelectorAll('.method-item .method-content').forEach(el => { el.hidden = true; });
                contentDiv.hidden = !isOpening;
            });

            // Actions hi·ªÉn th·ªã ·ªü cu·ªëi thanh ti√™u ƒë·ªÅ (summary)
            const actions = document.createElement('div');
            actions.className = 'topic-actions';
            const btnEdit = document.createElement('button');
            btnEdit.className = 'btn small ghost method-edit';
            btnEdit.textContent = 'S·ª≠a';
            btnEdit.dataset.id = method.id;
            const btnDel = document.createElement('button');
            btnDel.className = 'btn small danger method-delete';
            btnDel.textContent = 'X√≥a';
            btnDel.dataset.id = method.id;
            actions.append(btnEdit, btnDel);
            summary.append(titleSpan, actions);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'method-content';
            contentDiv.innerHTML = method.content || '';
            contentDiv.hidden = true;


            details.append(summary, contentDiv);
            container.appendChild(details);

            // Click anywhere on the card to open (except controls)
            details.addEventListener('click', (e) => {
                const t = e.target;
                if (!t) return;
                if (t.closest('button') || t.closest('a') || t.closest('.color-picker-wrapper') || t.closest('.color-palette')) return;
                const isOpening = contentDiv.hidden;
                container.querySelectorAll('.method-item .method-content').forEach(el => { el.hidden = true; });
                contentDiv.hidden = !isOpening;
            });
        });

        // T·ª± ƒë·ªông ƒë√≥ng c√°c th·∫ª kh√°c (accordion)
        const allMethodItems = container.querySelectorAll('.method-item');
        allMethodItems.forEach(item => {
            item.addEventListener('toggle', () => {
                if (item.open) {
                    allMethodItems.forEach(other => { if (other !== item) other.open = false; });
                }
            });
        });

        // === START: K√çCH HO·∫†T K√âO-TH·∫¢ CHO KHO TRI TH·ª®C ===
        if (window.Sortable) {
            new Sortable(container, {
                animation: 150,
                draggable: '.method-item', // X√°c ƒë·ªãnh ph·∫ßn t·ª≠ c√≥ th·ªÉ k√©o
                onEnd: async function (evt) {
                    if (evt.oldIndex === evt.newIndex) return; // Kh√¥ng thay ƒë·ªïi n·∫øu v·ªã tr√≠ c≈© v√† m·ªõi nh∆∞ nhau

                    const subtopic = getCurrentSubtopic();
                    if (!subtopic || !Array.isArray(subtopic.methods)) return;

                    // C·∫≠p nh·∫≠t l·∫°i th·ª© t·ª± trong m·∫£ng d·ªØ li·ªáu
                    const movedItem = subtopic.methods.splice(evt.oldIndex, 1)[0];
                    subtopic.methods.splice(evt.newIndex, 0, movedItem);

                    // L∆∞u l·∫°i thay ƒë·ªïi
                    await saveData();
                    // Kh√¥ng c·∫ßn render l·∫°i v√¨ th∆∞ vi·ªán ƒë√£ t·ª± c·∫≠p nh·∫≠t giao di·ªán
                }
            });
        }
        // === END: K√çCH HO·∫†T K√âO-TH·∫¢ CHO KHO TRI TH·ª®C ===
    }
    function addGeneralNote(){
        showInputModal('Th√™m ghi ch√∫', async (text) => {
            if (!text) return;
            const s = getCurrentSubtopic();
        if (!s) { toast('Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ con tr∆∞·ªõc.'); return; }
            s.generalNotes = s.generalNotes || [];
            s.generalNotes.unshift({ id: uid('gn'), text, createdAt: todayISO() });
            await saveData();
            renderGeneralNotes();
        }, '');
    }
    async function summarizeNotes(){
        const s = getCurrentSubtopic();
        if (!s) { toast('Ch·ªçn ch·ªß ƒë·ªÅ con tr∆∞·ªõc.'); return; }
        const notes = (s.generalNotes || []).map(n => (typeof n === 'string' ? n : (n.text||''))).filter(Boolean);
        if (notes.length === 0) { toast('Ch∆∞a c√≥ ghi ch√∫ ƒë·ªÉ t√≥m t·∫Øt.'); return; }
        const btn = $('#btnSummarize');
        if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div>'; }
        try {
            const prompt = `T√≥m t·∫Øt c√°c ghi ch√∫ sau theo g·∫°ch ƒë·∫ßu d√≤ng, ng·∫Øn g·ªçn, r√µ r√†ng:\n\n${notes.join('\n- ')}`;
            const result = await callGeminiAPI(prompt);
            if (!s.summaries) s.summaries = [];
            s.summaries.unshift({ id: uid('sum'), content: result || '(Kh√¥ng t·∫°o ƒë∆∞·ª£c t√≥m t·∫Øt)', createdAt: todayISO() });
            await saveData();
            renderSummaries();
        } catch (e) {
            console.error(e);
            toast('T√≥m t·∫Øt th·∫•t b·∫°i.');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'T√≥m t·∫Øt'; }
        }
    }
    function renderSummaries() {
        const listEl = $('#summariesList');
        if (!listEl) return;
        const s = getCurrentSubtopic();
        if (!s) { listEl.innerHTML = '<div class="tiny">Vui l√≤ng ch·ªçn m·ªôt ch·ªß ƒë·ªÅ con ƒë·ªÉ xem t√≥m t·∫Øt.</div>'; return; }
        listEl.innerHTML = '';
        if (!s.summaries || s.summaries.length === 0) { listEl.innerHTML = '<div class="tiny">Ch∆∞a c√≥ t√≥m t·∫Øt n√†o.</div>'; return; }
        s.summaries.forEach(sum => {
            const item = document.createElement('div'); item.className = 'note-item';
            const contentWrapper = document.createElement('div'); contentWrapper.className = 'note-content-wrapper';
            const sumContent = document.createElement('div'); sumContent.className = 'note-content'; sumContent.textContent = sum.content;
            const sumMeta = document.createElement('div'); sumMeta.className = 'note-meta'; sumMeta.textContent = new Date(sum.createdAt).toLocaleString();
            contentWrapper.append(sumContent, sumMeta);
            const actions = document.createElement('div');
            const expBtn = document.createElement('button'); expBtn.className = 'btn small'; expBtn.textContent = 'Xu·∫•t'; expBtn.onclick = (e)=>{ e.stopPropagation(); exportSummary(sum); };
            const delBtn = document.createElement('button'); delBtn.className = 'btn small danger'; delBtn.textContent = 'X√≥a'; delBtn.onclick = (e)=>{ e.stopPropagation(); deleteSummary(sum.id); };
            actions.append(expBtn, delBtn);
            item.append(contentWrapper, actions);
            item.addEventListener('click', ()=> sumContent.classList.toggle('expanded'));
            listEl.appendChild(item);
        });
    }
      function loadEditingPresetFields(){
          const s = data.settings;
          const d = s.durations;
          const pomodoroWrap = $('#settings-pomodoro');
          const flowWrap = $('#settings-flowtime');
          if (pomodoroWrap && flowWrap) {
            const isFlow = (editingPreset === 'C');
            pomodoroWrap.classList.toggle('hidden', isFlow);
            flowWrap.classList.toggle('hidden', !isFlow);
          }
          if(editingPreset === 'A'){
              $('#set_work').value = d.A_work;
              if ($('#set_winddown')) $('#set_winddown').value = d.A_winddown ?? 0;
              $('#set_short').value = d.A_short;
              $('#set_long').value = d.A_long;
              $('#set_cycles').value = s.cyclesA;
              $('#set_interval').value = s.longBreakIntervalA;
          } else if (editingPreset === 'B') {
              $('#set_work').value = d.B_work;
              if ($('#set_winddown')) $('#set_winddown').value = d.B_winddown ?? 0;
              $('#set_short').value = d.B_short;
              $('#set_long').value = d.B_long;
              $('#set_cycles').value = s.cyclesB;
              $('#set_interval').value = s.longBreakIntervalB;
          } else if (editingPreset === 'C') {
              const ratioInput = $('#set_flowRatio');
              if (ratioInput) ratioInput.value = s.flowtimeBreakRatio ?? 5;
          }
      }
      function highlightPresetSelector(){
          $$('#timerPresetSelector button').forEach(btn=>{
              const isActive = btn.dataset.presetTarget === editingPreset;
              btn.classList.toggle('acc', isActive);
              btn.classList.toggle('ghost', !isActive);
          });
      }
      function openSettings(){
          const s = data.settings;
          editingPreset = s.preset;
          $('#set_apiKey').value = s.apiKey || '';
          loadEditingPresetFields();
          highlightPresetSelector();
          $('#set_volume').value=s.volume ?? 0.8;
          $('#set_theme').value=s.soundTheme || 'beep';
          const customToggle = $('#set_useCustomSounds');
          const customContainer = $('#customSoundsContainer');
          if (customToggle) {
              customToggle.checked = !!s.useCustomSounds;
              if (customContainer) customContainer.classList.toggle('hidden', !customToggle.checked);
          }
          // THAY ƒê·ªîI: C·∫≠p nh·∫≠t gi√° tr·ªã dropdown
          $('#set_theme_color').value = s.theme || 'default';
          const activeUrl = getActiveYoutubeUrl();
          $('#set_youtubeUrl').value = activeUrl || '';
          const initialVideoId = extractYouTubeID(activeUrl);
          $('#btnToggleYtSound').disabled = !initialVideoId;
          if ($('#ytUrlFeedback')) {
              $('#ytUrlFeedback').textContent = '';
          }
          $('#ytSoundVolume').value = s.youtubeVolume || 80;
          $('#set_ytThumbAsBg').checked = !!s.useYtThumbnailAsBg;
          $('#set_panelOpacity').value = s.panelOpacity || 0.85;
          if ($('#set_language')) { $('#set_language').value = s.language || (localStorage.getItem('lang') || 'vi'); }
          if ($('#set_backgroundMode')) { $('#set_backgroundMode').value = s.backgroundMode || 'cover'; }
          
          if ($('#set_autoStartNext')) { $('#set_autoStartNext').checked = !!s.autoStartNext; }
          if ($('#set_enableWinddown')) { $('#set_enableWinddown').checked = (s.enableWinddown !== false); }
          if ($('#set_enableSessionNotes')) { $('#set_enableSessionNotes').checked = (s.enableSessionNotes !== false); }
          if ($('#set_backupDays')) { $('#set_backupDays').value = s.backupDaysToKeep || 7; }
        const backupListEl = $('#backupList');
        if (backupListEl) {
            storageManager.getBackupList().then(backups => {
                backupListEl.innerHTML = '<option value="">-- Ch·ªçn ng√†y ƒë·ªÉ ph·ª•c h·ªìi --</option>';
                if (backups && backups.length > 0) {
                    backups.forEach(backup => {
                        const option = document.createElement('option');
                        option.value = backup.date;
                        option.textContent = `B·∫£n sao l∆∞u ng√†y: ${new Date(backup.date).toLocaleDateString('vi-VN')}`;
                        backupListEl.appendChild(option);
                    });
                } else {
                    backupListEl.innerHTML = '<option value="">Kh√¥ng c√≥ b·∫£n sao l∆∞u n√†o</option>';
                }
            });
        }
        $('#modalSettings').classList.add('show');
        try { trapFocus($('#modalSettings')); } catch(_) {}
    }
    function closeSettings(){ $('#modalSettings').classList.remove('show'); try { releaseFocus(); } catch(_) {} }
    async function setDefaults(){
        data.settings.durations={A_work:25,A_short:5,A_long:15,A_winddown:2,B_work:50,B_short:10,B_long:30,B_winddown:5};
        data.settings.cyclesA=4;
        data.settings.longBreakIntervalA=4;
        data.settings.cyclesB=4;
        data.settings.longBreakIntervalB=4;
        data.settings.flowtimeBreakRatio=5;
          data.settings.preset='A';
          data.settings.volume=0.8;
          data.settings.soundTheme='beep';
          data.settings.useCustomSounds = false;
          await saveData(); openSettings(); toast('ƒê√£ kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh'); }
      async function saveSettings(){
          const s = data.settings;
          s.apiKey = $('#set_apiKey').value.trim();
          const d = s.durations;
          if(editingPreset === 'A'){
              d.A_work = clampInt($('#set_work').value,1,999);
              d.A_winddown = clampInt($('#set_winddown').value,0,999);
              d.A_short = clampInt($('#set_short').value,1,999);
              d.A_long = clampInt($('#set_long').value,1,999);
              s.cyclesA = clampInt($('#set_cycles').value,1,12);
              s.longBreakIntervalA = clampInt($('#set_interval').value,2,12);
          } else if (editingPreset === 'B') {
              d.B_work = clampInt($('#set_work').value,1,999);
              d.B_winddown = clampInt($('#set_winddown').value,0,999);
              d.B_short = clampInt($('#set_short').value,1,999);
              d.B_long = clampInt($('#set_long').value,1,999);
              s.cyclesB = clampInt($('#set_cycles').value,1,12);
              s.longBreakIntervalB = clampInt($('#set_interval').value,2,12);
          } else if (editingPreset === 'C') {
              const ratioInput = $('#set_flowRatio');
              if (ratioInput) s.flowtimeBreakRatio = clampInt(ratioInput.value, 1, 20);
          }
          s.volume = clampFloat($('#set_volume').value,0,1,0.8);
          s.soundTheme = $('#set_theme').value==='chime' ? 'chime':'beep';
          // THAY ƒê·ªîI: L∆∞u gi√° tr·ªã theme
          s.theme = $('#set_theme_color').value;
          s.language = ($('#set_language') && $('#set_language').value) || s.language;
          s.panelOpacity = parseFloat($('#set_panelOpacity').value) || 0.85;
          if ($('#set_backgroundMode')) { s.backgroundMode = $('#set_backgroundMode').value; }
          s.autoStartNext = !!($('#set_autoStartNext') && $('#set_autoStartNext').checked);
          s.enableWinddown = !!($('#set_enableWinddown') && $('#set_enableWinddown').checked);
          s.enableSessionNotes = !!($('#set_enableSessionNotes') && $('#set_enableSessionNotes').checked);
          if ($('#set_useCustomSounds')) { s.useCustomSounds = !!$('#set_useCustomSounds').checked; }
          if ($('#set_backupDays')) { s.backupDaysToKeep = clampInt($('#set_backupDays').value, 1, 30); }

          // B·ªï sung: N·∫øu ch·ªçn theme s√°ng, lu√¥n t·∫Øt thumbnail YouTube l√†m n·ªÅn
          if (s.theme === 'light' || s.theme === 'pastel') {
              s.useYtThumbnailAsBg = false;
              // N·∫øu n·ªÅn hi·ªán t·∫°i l√† thumbnail YouTube, b·ªè n·ªÅn ƒë·ªÉ gi·ªØ n·ªÅn g·ªëc c·ªßa theme s√°ng
              if (typeof s.customBg === 'string' && s.customBg.includes('img.youtube.com/vi/')) {
                  s.customBg = '';
              }
          } else {
              // Ng∆∞·ª£c l·∫°i, v·ªõi theme t·ªëi th√¨ b·∫≠t d√πng thumbnail YouTube (n·∫øu c√≥ link)
              s.useYtThumbnailAsBg = true;
          }

          const newYtUrl = $('#set_youtubeUrl').value.trim();
          s.useYtThumbnailAsBg = $('#set_ytThumbAsBg').checked;
          s.youtubeVolume = parseInt($('#ytSoundVolume').value, 10);
          // Ghi nh·∫≠n URL m·ªõi cho phi√™n nh∆∞ng KH√îNG ƒë·ª•ng ƒë·∫øn player ·ªü ƒë√¢y ƒë·ªÉ tr√°nh d·ª´ng nh·∫°c
          sessionYoutubeUrl = newYtUrl;
          // C·∫≠p nh·∫≠t √¢m l∆∞·ª£ng tr·ª±c ti·∫øp, kh√¥ng cue l·∫°i video
          try {
              if (!IS_FILE_PROTOCOL) {
                  if (ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(s.youtubeVolume);
              } else {
                  // Fallback: g·ª≠i l·ªánh setVolume qua postMessage n·∫øu ƒëang d√πng iframe nh√∫ng
                  try { fallbackPostMessage('setVolume', [s.youtubeVolume]); } catch(_) {}
              }
          } catch(_) {}

          await saveData();
          applyTheme();
          applyCustomBg();
          applyPanelOpacity();
          updatePresetButtonsText();
          timer.setPreset(s.preset, {silent:true});

          // Kh√¥ng can thi·ªáp tr·∫°ng th√°i ƒëang ph√°t: tr√°nh cue/pause l·∫°i khi nh·∫•n L∆∞u

          closeSettings();
          toast('ƒê√£ l∆∞u c√†i ƒë·∫∑t');
      }
    function clampInt(v,min,max){ v=parseInt(v||0,10); if(isNaN(v)) v=min; return Math.max(min, Math.min(max, v)); }
    function clampFloat(v,min,max,def){ v=parseFloat(v); if(Number.isNaN(v)) v=def; return Math.max(min, Math.min(max, v)); }
    const dbPromise = new Promise((resolve, reject) => {
        const req = indexedDB.open('pomodoro_files', 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore('files');
        req.onsuccess = (e) => resolve(e.target.result);
        req.onerror = (e) => reject(e);
    });
    const fileCache = {};
    function handleFileUpload(file, callback) {
        if (!file) return;
        dbPromise.then(db => {
            const id = uid('file');
            const tx = db.transaction('files', 'readwrite');
            tx.objectStore('files').put(file, id);
            tx.oncomplete = () => callback(id);
            tx.onerror = () => toast("L·ªói l∆∞u file.");
        });
    }
    function getStoredFileUrl(id){
        if (!id) return Promise.resolve('');
        if (fileCache[id]) return Promise.resolve(fileCache[id]);
        return dbPromise.then(db => new Promise((resolve) => {
            const tx = db.transaction('files', 'readonly');
            const req = tx.objectStore('files').get(id);
            req.onsuccess = (e) => {
                const file = e.target.result;
                if (file) {
                    const url = URL.createObjectURL(file);
                    fileCache[id] = url;
                    resolve(url);
                } else resolve('');
            };
            req.onerror = () => resolve('');
        }));
    }
    function applyCustomBg() {
        const s = data.settings;
        const ref = s.customBg;
        const theme = s.theme;
        const themeHasBg = ['lofi', 'space'].includes(theme);
        const isLightTheme = (theme === 'light' || theme === 'pastel');

        // √Åp d·ª•ng ch·∫ø ƒë·ªô hi·ªÉn th·ªã n·ªÅn
        const bgMode = s.backgroundMode || 'cover';
        document.body.style.backgroundSize = bgMode;
        document.body.style.backgroundRepeat = (bgMode === 'auto') ? 'repeat' : 'no-repeat';

        const clearInlineBgFallback = () => { try { document.body.style.backgroundImage = ''; } catch(_) {} };

        if (ref) {
            const urlPromise = (ref.startsWith('data:') || ref.startsWith('http') || ref.startsWith('blob:'))
                ? Promise.resolve(ref)
                : getStoredFileUrl(ref);
            
            urlPromise.then(url => {
                if (url) {
                    document.body.style.setProperty('--bg-image', `url(${url})`);
                } else {
                    document.body.style.setProperty('--bg-image', isLightTheme ? 'none' : '');
                }
                clearInlineBgFallback();
            });
        } else if (!themeHasBg) {
            if (isLightTheme) {
                // Light/pastel: kh√¥ng d√πng n·ªÅn t·ªëi
                document.body.style.setProperty('--bg-image', 'none');
                clearInlineBgFallback();
            } else {
                // Dark/default fallback
                document.body.style.setProperty('--bg-image', 'radial-gradient(1200px 800px at 10% -10%, #20285b 0%, #0f1222 50%, #0b0e1a 100%)');
            }
        } else {
            // Let the CSS for the theme handle the background
            document.body.style.removeProperty('--bg-image');
            clearInlineBgFallback();
        }
    }
    function applyPanelOpacity() { document.documentElement.style.setProperty('--panel-opacity', data.settings.panelOpacity); }
      function renderDashboard(){
          const stats = data.topics.flatMap(t => t.subtopics.map(s => ({ topic: t.name, subtopic: s.name, m: s.stats.totalMinutes || 0, c: s.stats.sessionsCompleted || 0, t: s.stats.tasksCompleted || 0 })));
          const totalM = stats.reduce((a, b) => a + b.m, 0);
          const totalC = stats.reduce((a, b) => a + b.c, 0);
          const totalT = stats.reduce((a, b) => a + b.t, 0);

        let tableHTML = `<p class="tiny"><strong>T·ªïng th·ªùi gian:</strong> ${formatDaysHoursMinutes(totalM)} | <strong>T·ªïng phi√™n:</strong> ${totalC} | <strong>T·ªïng nhi·ªám v·ª•:</strong> ${totalT}</p>
        <table class="dashboard-table">
            <thead><tr><th>Ch·ªß ƒë·ªÅ</th><th>Ch·ªß ƒë·ªÅ con</th><th>Th·ªùi gian</th><th>Phi√™n</th><th>Nhi·ªám v·ª•</th></tr></thead>
            <tbody>`;

          stats.forEach(item => {
            tableHTML += `<tr><td>${escapeHTML(item.topic)}</td><td>${escapeHTML(item.subtopic)}</td><td>${formatDaysHoursMinutes(item.m)}</td><td>${item.c}</td><td>${item.t}</td></tr>`;
        });

        tableHTML += '</tbody></table>';
        const contentEl = $('#dashboardContent');
        if (contentEl) contentEl.innerHTML = tableHTML;
    }
    function getMilestones() {
        return [
            // === GIAI ƒêO·∫†N ƒê·∫¶U: X√ÇY D·ª∞NG TH√ìI QUEN ===
            {
                hours: 5,
                title: "G·ª≠i b·∫°n, 5 gi·ªù ƒë·∫ßu ti√™n (Kh·ªüi ƒë·ªông)",
                message: "NƒÉm gi·ªù t·∫≠p trung! B·∫°n ƒë√£ v∆∞·ª£t qua r√†o c·∫£n l·ªõn nh·∫•t: s·ª± tr√¨ ho√£n. M·ªói ph√∫t b·∫°n d√†nh ra ƒë·ªÅu l√† m·ªôt l·ªùi kh·∫≥ng ƒë·ªãnh cho m·ª•c ti√™u c·ªßa m√¨nh. H√£y gi·ªØ v·ªØng ng·ªçn l·ª≠a n√†y!"
            },
            {
                hours: 20,
                title: "G·ª≠i b·∫°n, 20 gi·ªù (N·ªÅn t·∫£ng)",
                message: "Ch√∫c m·ª´ng b·∫°n ƒë√£ l√†m ƒë∆∞·ª£c ƒëi·ªÅu kh√≥ nh·∫•t: B·∫Øt ƒë·∫ßu v√† duy tr√¨.\n\n20 gi·ªù kh√¥ng ch·ªâ l√† th·ªùi gian, ƒë√≥ l√† 20 gi·ªù b·∫°n ƒë√£ chi·∫øn th·∫Øng s·ª± xao nh√£ng. B·∫°n ƒëang x√¢y d·ª±ng m·ªôt n·ªÅn t·∫£ng v·ªØng ch·∫Øc cho s·ª± k·ª∑ lu·∫≠t. H√£y t·ª± h√†o v·ªÅ kh·ªüi ƒë·∫ßu n√†y."
            },
            {
                hours: 50,
                title: "G·ª≠i b·∫°n, 50 gi·ªù (ƒê·ªông l·ª±c)",
                message: "50 gi·ªù t·∫≠p trung! Th√≥i quen c·ªßa b·∫°n ƒëang t·∫°o ra ƒë·ªông l·ª±c. S·ª± nh·∫•t qu√°n nh·ªè b√© m·ªói ng√†y ƒëang c·ªông h∆∞·ªüng th√†nh nh·ªØng b∆∞·ªõc ti·∫øn l·ªõn. B·∫°n ƒëang ƒëi ƒë√∫ng h∆∞·ªõng, h√£y ti·∫øp t·ª•c ph√°t huy."
            },

            // === GIAI ƒêO·∫†N GI·ªÆA: CAM K·∫æT V√Ä B·ªÄN B·ªà ===
            {
                hours: 100,
                title: "G·ª≠i b·∫°n, 100 gi·ªù c·ªëng hi·∫øn (Cam k·∫øt)",
                message: "100 gi·ªù! ƒê√¢y kh√¥ng c√≤n l√† m·ªôt th·ª≠ nghi·ªám n·ªØa, m√† l√† m·ªôt s·ª± ƒë·∫ßu t∆∞ nghi√™m t√∫c cho m·ª•c ti√™u c·ªßa b·∫°n.\n\nH√£y d√†nh m·ªôt ch√∫t th·ªùi gian ƒë·ªÉ nh√¨n l·∫°i: 100 gi·ªù t·∫≠p trung n√†y ƒë√£ gi√∫p b·∫°n ti·∫øn xa ƒë·∫øn ƒë√¢u? NƒÉng l∆∞·ª£ng b·∫°n b·ªè ra ƒëang ƒë·ªãnh h√¨nh n√™n k·∫øt qu·∫£."
            },
            {
                hours: 250,
                title: "G·ª≠i b·∫°n, 250 gi·ªù (B·ªÅn b·ªâ)",
                message: "250 gi·ªù l√† minh ch·ª©ng cho s·ª± b·ªÅn b·ªâ ƒë√°ng kinh ng·∫°c. B·∫°n ƒë√£ ƒë·ªëi m·∫∑t v·ªõi nh·ªØng ng√†y kh√≥ khƒÉn, nh·ªØng l√∫c m·∫•t t·∫≠p trung, nh∆∞ng b·∫°n v·∫´n quay tr·ªü l·∫°i. S·ª©c m·∫°nh th·ª±c s·ª± n·∫±m ·ªü ch√≠nh s·ª± ki√™n tr√¨ n√†y."
            },
            {
                hours: 500,
                title: "G·ª≠i b·∫°n, 500 gi·ªù (Chuy√™n t√¢m)",
                message: "N·ª≠a ngh√¨n gi·ªù t·∫≠p trung. B·∫°n ƒë√£ d√†nh m·ªôt kho·∫£ng th·ªùi gian ƒë√°ng k·ªÉ ƒë·ªÉ theo ƒëu·ªïi ƒëi·ªÅu quan tr·ªçng v·ªõi m√¨nh. M·ª©c ƒë·ªô chuy√™n t√¢m n√†y ch·∫Øc ch·∫Øn ƒëang t·∫°o ra nh·ªØng k·∫øt qu·∫£ s√¢u s·∫Øc v√† kh√°c bi·ªát. Th·∫≠t ƒë√°ng ng∆∞·ª°ng m·ªô."
            },

            // === GIAI ƒêO·∫†N N√ÇNG CAO: CHUY·ªÇN H√ìA V√Ä DI S·∫¢N ===
            {
                hours: 1000,
                title: "G·ª≠i b·∫°n, 1.000 gi·ªù (Chuy·ªÉn h√≥a)",
                message: "Ch√†o m·ª´ng ƒë·∫øn C√¢u l·∫°c b·ªô 1000 gi·ªù.\n\nCon s·ªë n√†y kh√¥ng ch·ªâ ƒëo l∆∞·ªùng th·ªùi gian, n√≥ ƒë·∫°i di·ªán cho s·ª± chuy·ªÉn h√≥a. S·ª± t·∫≠p trung ƒë√£ tr·ªü th√†nh m·ªôt ph·∫ßn con ng∆∞·ªùi b·∫°n, m·ªôt 'si√™u nƒÉng l·ª±c' b·∫°n c√≥ th·ªÉ tri·ªáu h·ªìi. H√†nh tr√¨nh c·ªßa b·∫°n th·ª±c s·ª± truy·ªÅn c·∫£m h·ª©ng."
            },
            {
                hours: 5000,
                title: "G·ª≠i b·∫°n, 5.000+ gi·ªù (Di s·∫£n)",
                message: "5.000 gi·ªù t·∫≠p trung c√≥ ch·ªß ƒë√≠ch. ƒê√¢y l√† m·ªôt th√†nh t·ª±u m√† r·∫•t √≠t ng∆∞·ªùi ƒë·∫°t ƒë∆∞·ª£c.\n\nT·∫°i c·ªôt m·ªëc n√†y, c√¢u h·ªèi kh√¥ng c√≤n l√† 'L√†m th·∫ø n√†o ƒë·ªÉ t·∫≠p trung?', m√† l√† 'S·ª± t·∫≠p trung n√†y s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ t·∫°o ra gi√° tr·ªã g√¨?'. B·∫°n kh√¥ng ch·ªâ l√†m vi·ªác, b·∫°n ƒëang t·∫°o ra di s·∫£n."
            }
        ].sort((a, b) => b.hours - a.hours); // S·∫Øp x·∫øp gi·∫£m d·∫ßn ƒë·ªÉ d·ªÖ x·ª≠ l√Ω
    }
    async function checkAndShowMilestones() {
        if (!data || !data.settings) return;
        if (!Array.isArray(data.settings.achievedMilestones)) data.settings.achievedMilestones = [];
        const totalMinutes = data.topics.reduce((total, topic) => {
            return total + topic.subtopics.reduce((subTotal, subtopic) => {
                return subTotal + (subtopic.stats.totalMinutes || 0);
            }, 0);
        }, 0);
        const totalHours = totalMinutes / 60;
        const milestones = getMilestones();
        const achieved = Array.isArray(data.settings.achievedMilestones) ? data.settings.achievedMilestones : [];
        const eligible = milestones.filter(m => totalHours >= m.hours && !achieved.includes(m.hours));
        if (eligible.length === 0) return false;
        const target = eligible.reduce((best, m) => (best && best.hours > m.hours ? best : m), null);
        if (!target) return false;
        $('#milestoneTitle').textContent = target.title;
        $('#milestoneMessage').textContent = target.message;
        $('#modalMilestone').classList.add('show');
        try { trapFocus($('#modalMilestone')); } catch(_) {}
        data.settings.achievedMilestones.push(target.hours);
        await saveData();
        return true;
    }
    async function seedAchievedMilestones() {
        if (!data || !data.settings) return;
        if (!Array.isArray(data.settings.achievedMilestones)) {
            data.settings.achievedMilestones = [];
            await saveData();
        }
    }
    async function handleSendMessage() {
        const btn = $('#btnSendMessage');
        const input = $('#chatInput');
        const query = input.value.trim();
        const subtopic = getCurrentSubtopic();
        if (!query) return;
        if (!subtopic) { toast(t('timer.selectSubtopicPrompt')); return; }
        input.value = '';
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div>';
        subtopic.chatHistory.push({ role: 'user', text: query });
        renderChat();
        const response = await callGeminiAPI(query);
        if (response) {
            subtopic.chatHistory.push({ role: 'model', text: response });
            await saveData();
            renderChat();
        }
        btn.disabled = false;
        btn.innerHTML = 'G·ª≠i';
    }
    function renderChat() {
        const s = getCurrentSubtopic();
        const messagesEl = $('#chatMessages');
        const chatInput = $('#chatInput');
        const sendBtn = $('#btnSendMessage');
        if (!messagesEl || !chatInput || !sendBtn) return;
        if (!s) {
            messagesEl.innerHTML = '<div class="tiny">Ch·ªçn ch·ªß ƒë·ªÅ con ƒë·ªÉ b·∫Øt ƒë·∫ßu chat.</div>';
            chatInput.disabled = true; sendBtn.disabled = true;
            return;
        }
        chatInput.disabled = false; sendBtn.disabled = false;
        messagesEl.innerHTML = '';
        if (!s.chatHistory || s.chatHistory.length === 0) {
            messagesEl.innerHTML = '<div class="tiny">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</div>';
            return;
        }
        s.chatHistory.forEach(msg => {
            const msgEl = document.createElement('div');
            msgEl.className = `chat-msg ${msg.role}`;
            msgEl.textContent = msg.text;
            messagesEl.appendChild(msgEl);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    async function handleSummarizeNote() {
        const btn = $('#btnSummarizeNote');
        const noteTextEl = $('#noteText');
        const noteText = noteTextEl.value.trim();
        const subtopic = getCurrentSubtopic();
        if (!noteText) { toast("Vui l√≤ng nh·∫≠p ghi ch√∫ tr∆∞·ªõc khi t√≥m t·∫Øt."); return; }
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<div class="spinner"></div>'; btn.disabled = true;
        const prompt = `D·ª±a v√†o th√¥ng tin sau:\n- Ch·ªß ƒë·ªÅ: "${subtopic?.name || 'kh√¥ng r√µ'}"\n- Ghi ch√∫ c·ªßa ng∆∞·ªùi d√πng sau m·ªôt phi√™n l√†m vi·ªác: "${noteText}"\n\nH√£y t·∫°o m·ªôt b·∫£n t√≥m t·∫Øt ng·∫Øn g·ªçn v·ªÅ nh·ªØng g√¨ ƒë√£ l√†m v√† ƒë·ªÅ xu·∫•t m·ªôt b∆∞·ªõc h·ª£p l√Ω ti·∫øp theo. ƒê·ªãnh d·∫°ng c√¢u tr·∫£ l·ªùi nh∆∞ sau:\n\n---\n**‚ú® T√≥m t·∫Øt AI:**\n[T√≥m t·∫Øt ·ªü ƒë√¢y]\n\n**üöÄ G·ª£i √Ω ti·∫øp theo:**\n[G·ª£i √Ω ·ªü ƒë√¢y]`;
        const result = await callGeminiAPI(prompt);
        if (result) {
            noteTextEl.value += `\n\n${result}`;
        }
        btn.innerHTML = originalContent; btn.disabled = false;
    }
    function clearChat() {
        const s = getCurrentSubtopic();
        if (!s) { toast(t('timer.selectSubtopicPrompt')); return; }
        showConfirmModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ chat c·ªßa ch·ªß ƒë·ªÅ con n√†y?', async (ok) => {
            if (ok) {
                s.chatHistory = [];
                await saveData();
                renderChat();
                toast("ƒê√£ x√≥a l·ªãch s·ª≠ chat.");
            }
        });
    }
    let ytPlayer;
    let ytUserPaused = false;
    let ytFallbackFrame = null;
    let ytFallbackIsPlaying = false;
    function buildFallbackSrc(videoId, { autoplay=1, mute=1 }={}){
        const params = new URLSearchParams({
            autoplay: String(autoplay),
            mute: String(mute),
            controls: '0',
            playsinline: '1',
            loop: '1',
            playlist: videoId,
            enablejsapi: '1',
            origin: 'https://www.youtube.com'
        }).toString();
        return `https://www.youtube.com/embed/${videoId}?${params}`;
    }
    function ensureFallbackFrame(){
        const cont = document.getElementById('youtube-player-container');
        if (!cont) return null;
        if (ytFallbackFrame && ytFallbackFrame.isConnected) return ytFallbackFrame;
        const ifr = document.createElement('iframe');
        ifr.id = 'yt-fallback';
        ifr.width = '1'; ifr.height = '1';
        ifr.style.position = 'absolute'; ifr.style.top='-9999px'; ifr.style.left='-9999px';
        ifr.allow = 'autoplay; encrypted-media; picture-in-picture';
        cont.innerHTML = '';
        cont.appendChild(ifr);
        ytFallbackFrame = ifr;
        return ifr;
    }
    function fallbackLoadVideo(videoId, {autoplay=1, mute=1}={}){
        const cont = document.getElementById('youtube-player-container');
        if (!cont) return;
        cont.innerHTML = '';
        const ifr = document.createElement('iframe');
        ifr.id = 'yt-fallback';
        ifr.width = '1';
        ifr.height = '1';
        ifr.style.position = 'absolute';
        ifr.style.top='-9999px';
        ifr.style.left='-9999px';
        ifr.allow = 'autoplay; encrypted-media; picture-in-picture';
        ifr.src = buildFallbackSrc(videoId, {autoplay, mute});
        cont.appendChild(ifr);
        ytFallbackFrame = ifr;
        ytFallbackIsPlaying = !!autoplay;
        try { 
            const btn = document.getElementById('btnToggleYtSound'); 
            if (btn) btn.textContent = ytFallbackIsPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'; 
        } catch(_) {}
    }
    function fallbackPostMessage(func, args=[]) {
        try {
            if (!ytFallbackFrame || !ytFallbackFrame.contentWindow) return;
            ytFallbackFrame.contentWindow.postMessage(JSON.stringify({ event:'command', func, args }), 'https://www.youtube.com');
        } catch(_) {}
    }
    function fallbackPlay(){ fallbackPostMessage('playVideo'); }
    function fallbackStop(){
        try {
            if (ytFallbackFrame) {
                ytFallbackFrame.src = 'about:blank';
                ytFallbackIsPlaying = false;
            }
        } catch(_) {}
    }
    function fallbackPause(){ fallbackStop(); }
    function fallbackUnMute(){ fallbackPostMessage('unMute'); }
    function fallbackMute(){ fallbackPostMessage('mute'); }
    window.onYouTubeIframeAPIReady = function() {
        if (IS_FILE_PROTOCOL) {
            try { window.__ytApiWatchdog && window.__ytApiWatchdog.cancel(); } catch(_) {}
            return;
        }
        const opts = {
            height: '1',
            width: '1',
            playerVars: { autoplay: 0, controls: 0, playsinline: 1 },
            events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange },
            host: 'https://www.youtube.com'
        };
        if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
            opts.origin = window.location.origin;
        }
        ytPlayer = new YT.Player('youtube-player-container', opts);
        try { window.__ytApiWatchdog && window.__ytApiWatchdog.cancel(); const fb = document.getElementById('ytUrlFeedback'); if (fb) { fb.textContent=''; } } catch(_) {}
    };

    let _ytPrimed = false;
    let _ytUnlocked = false;
    try { _ytUnlocked = localStorage.getItem('sound_unlocked') === '1'; } catch(_) {}
    function showSoundPermission() {
        const bar = document.getElementById('soundPermissionBar');
        if (!bar) return;
        if (_ytUnlocked) { bar.classList.remove('show'); return; }
        bar.classList.add('show');
    }
    function hideSoundPermission() {
        const bar = document.getElementById('soundPermissionBar');
        if (!bar) return;
        bar.classList.remove('show');
    }
    function unlockAudioChain() {
        try { if (AUDIO_CTX && typeof AUDIO_CTX.resume === 'function') AUDIO_CTX.resume(); } catch(_) {}
        try {
            if (IS_FILE_PROTOCOL) {
                fallbackUnMute();
                fallbackPlay();
            } else if (ytPlayer && ytPlayer.unMute) {
                ytPlayer.unMute();
                ytPlayer.playVideo();
            }
        } catch(_) {}
        _ytUnlocked = true;
        try { localStorage.setItem('sound_unlocked','1'); } catch(_) {}
        hideSoundPermission();
        toast('√Çm thanh ƒë√£ ƒë∆∞·ª£c b·∫≠t!');
    }
    function onPlayerReady(event) {
        try {
            const iframe = ytPlayer && ytPlayer.getIframe ? ytPlayer.getIframe() : null;
            if (iframe) {
                iframe.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture');
            }
        } catch (_) {}
        try { if (ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume((data && data.settings && data.settings.youtubeVolume) || 80); } catch(_) {}
        // Prime muted autoplay like 4.html so music starts silently and waits for user to enable sound
        try {
            const hasVid = getActiveVideoId && getActiveVideoId();
            if (hasVid && ytPlayer && ytPlayer.mute && ytPlayer.playVideo) {
                ytPlayer.mute();
                ytPlayer.playVideo();
                _ytPrimed = true;
                const unlock = () => {
                    if (_ytUnlocked) return;
                    try { unlockAudioChain(); } catch(_) {}
                    window.removeEventListener('pointerdown', unlock, true);
                    window.removeEventListener('keydown', unlock, true);
                };
                window.addEventListener('pointerdown', unlock, true);
                window.addEventListener('keydown', unlock, true);
                showSoundPermission();
            }
        } catch(_) {}
        updateYouTubePlayer();
    }
    function onPlayerStateChange(event) {
        const btn = $('#btnToggleYtSound');
        if (event.data == YT.PlayerState.PLAYING) {
            btn.textContent = '‚è∏Ô∏è';
            hideSoundPermission();
        } else {
            btn.textContent = '‚ñ∂Ô∏è';
        }
        if (event.data === YT.PlayerState.ENDED) {
            if (!ytUserPaused) ytPlayer.playVideo();
        }
    }
    async function ytFadeTo(target, ms=250) {
        try {
            if (!ytPlayer || !ytPlayer.getVolume || !ytPlayer.setVolume) return;
            ytPlayer.unMute();
            const start = ytPlayer.getVolume();
            const diff = target - start;
            if (Math.abs(diff) < 1 || ms <= 0) { ytPlayer.setVolume(target); return; }
            const t0 = performance.now();
            await new Promise(res => {
                const step = (t) => {
                    const p = Math.min(1, (t - t0) / ms);
                    const v = Math.round(start + diff * p);
                    ytPlayer.setVolume(v);
                    if (p < 1) requestAnimationFrame(step); else res();
                };
                requestAnimationFrame(step);
            });
        } catch(_) {}
    }
    async function ytFadeInPlay(ms=220) {
        try {
            const tgt = Math.max(0, Math.min(100, (data && data.settings && data.settings.youtubeVolume) || 80));
            if (!IS_FILE_PROTOCOL) {
                if (!ytPlayer) return;
                ytPlayer.unMute();
                ytPlayer.playVideo();
                try { ytPlayer.setVolume(0); } catch(_) {}
                await ytFadeTo(tgt, ms);
            } else {
                const vid = getActiveVideoId();
                if (vid) { fallbackLoadVideo(vid, {autoplay:1, mute:0}); }
            }
        } catch(_) {}
    }
    async function ytFadeOutPause(ms=180) {
        try {
            const tgt = Math.max(0, Math.min(100, (data && data.settings && data.settings.youtubeVolume) || 80));
            if (!IS_FILE_PROTOCOL) {
                if (!ytPlayer) return;
                await ytFadeTo(0, ms);
                try { ytPlayer.pauseVideo(); ytPlayer.setVolume(tgt); } catch(_) {}
            } else {
                try { fallbackPause(); } catch(_) {}
            }
        } catch(_) {}
    }
    async function updateYouTubePlayer() {
        const videoId = getActiveVideoId();
        if (data.settings.useYtThumbnailAsBg && videoId) {
            const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
            const img = new Image();
            img.onload = async () => { data.settings.customBg = thumbUrl; await saveData(); applyCustomBg(); };
            img.onerror = async () => { const fb = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`; data.settings.customBg = fb; await saveData(); applyCustomBg(); };
            img.src = thumbUrl;
        } else if (!videoId) {
            data.settings.customBg = '';
            await saveData();
            applyCustomBg();
        }
        if (IS_FILE_PROTOCOL) {
            if (!videoId) { 
                fallbackStop();
                hideSoundPermission();
                return;
            }
            const isMuted = _ytUnlocked ? 0 : 1;
            fallbackLoadVideo(videoId, { autoplay: 1, mute: isMuted });
            if (!_ytUnlocked) {
                showSoundPermission();
            }
            return;
        }
        if (!ytPlayer || !ytPlayer.cueVideoById) { try { ensureYouTubeAPI(); } catch(_) {} return; }
        if (!videoId) {
            if (ytPlayer.stopVideo) ytPlayer.stopVideo();
            hideSoundPermission();
            return;
        }
        ytPlayer.cueVideoById(videoId);
        ytPlayer.setVolume(data.settings.youtubeVolume);
    }
    function toggleYtSound() {
        if (!_ytUnlocked) {
            try { ensureAudio(); } catch(_) {}
            try { unlockAudioChain(); } catch(_) {}
            return;
        }
        if (IS_FILE_PROTOCOL) {
            const vid = getActiveVideoId();
            if (!ytFallbackFrame || !ytFallbackFrame.isConnected) {
                if (!vid) { toast('Ch∆∞a c√≥ link h·ª£p l·ªá. D√°n link r·ªìi b·∫•m ‚ñ∂Ô∏è.'); return; }
                fallbackLoadVideo(vid, { autoplay: 1, mute: 0 });
                ytFallbackIsPlaying = true;
                try { const btn = document.getElementById('btnToggleYtSound'); if (btn) btn.textContent = '‚è∏Ô∏è'; } catch(_) {}
                toast('ƒêang ph√°t nh·∫°c n·ªÅn...');
                return;
            }
            if (ytFallbackIsPlaying) {
                fallbackPostMessage('pauseVideo');
                ytFallbackIsPlaying = false;
                toast('ƒê√£ d·ª´ng nh·∫°c n·ªÅn.');
            } else {
                if (!vid) { toast('Ch∆∞a c√≥ link h·ª£p l·ªá. D√°n link r·ªìi b·∫•m ‚ñ∂Ô∏è.'); return; }
                fallbackPostMessage('playVideo');
                ytFallbackIsPlaying = true;
                toast('ƒêang ph√°t nh·∫°c n·ªÅn...');
            }
            try { 
                const btn = document.getElementById('btnToggleYtSound'); 
                if (btn) btn.textContent = ytFallbackIsPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'; 
            } catch(_) {}
            return;
        }
        if (!ytPlayer || typeof ytPlayer.getPlayerState !== 'function') { try { ensureYouTubeAPI(); } catch(_) {} return; }
        const playerState = ytPlayer.getPlayerState();
        if (playerState === YT.PlayerState.PLAYING || playerState === YT.PlayerState.BUFFERING) {
            ytFadeOutPause();
            ytUserPaused = true;
            toast('ƒê√£ d·ª´ng nh·∫°c n·ªÅn.');
        } else {
            ytFadeInPlay();
            ytUserPaused = false;
            toast('ƒêang ph√°t nh·∫°c n·ªÅn...');
        }
    }
    function bindEvents(){
      // Update welcome message copy
      try {
        const wp = document.querySelector('#welcomePanel p');
        if (wp) {
          wp.innerHTML = 'H√£y b·∫Øt ƒë·∫ßu b·∫±ng c√°ch ch·ªçn m·ªôt <strong>Ch·ªß ƒë·ªÅ con</strong> ho·∫∑c t·∫°o Ch·ªß ƒë·ªÅ.';
        }
      } catch(_) {}
      on($('#btnToggleBg'), 'click', toggleBackgroundView);
      on($('#btnMilestoneClose'), 'click', () => { $('#modalMilestone').classList.remove('show'); try { releaseFocus(); } catch(_) {} });
      on($('#btnAddTopic'), 'click', () => showInputModal('T√™n Ch·ªß ƒë·ªÅ m·ªõi?', async (name) => { if (!name) return; data.topics.push({ id: uid('t'), name, subtopics: [] }); await saveData(); renderTopics(); }));
      on($('#btnExport'), 'click', ()=> storageManager.exportData(data));
        on($("#importFile"), 'change', (e) => {
          const f = e.target.files[0];
          if (!f) return;
          storageManager.importData(f).then(async (d) => {
            data = d;
            normalizeDataStructure(data);
            await ensureValidSelection();
            await seedAchievedMilestones();
            toast('ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!');
            renderAll();
          }).catch(err => toast('Nh·∫≠p th·∫•t b·∫°i: ' + err.message));
          e.target.value = null;
        });
      on($('#btnRestoreBackup'), 'click', () => {
          const backupListEl = $('#backupList');
          const selectedDate = backupListEl ? backupListEl.value : '';
          if (!selectedDate) { toast('Vui l√≤ng ch·ªçn m·ªôt b·∫£n sao l∆∞u.'); return; }
          showConfirmModal('X√°c nh·∫≠n ph·ª•c h·ªìi', `B·∫°n c√≥ ch·∫Øc mu·ªën ph·ª•c h·ªìi d·ªØ li·ªáu t·ª´ ng√†y ${new Date(selectedDate).toLocaleDateString()}? D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®.`, (ok) => {
              if (ok) {
                  storageManager.restoreBackup(selectedDate).then((d) => {
                      data = d;
                      toast('Ph·ª•c h·ªìi d·ªØ li·ªáu th√†nh c√¥ng! T·∫£i l·∫°i trang...');
                      setTimeout(() => window.location.reload(), 1500);
                  }).catch(err => {
                      toast(`L·ªói: ${err.message}`);
                  });
              }
          });
      });
      on($('#set_theme_color'), 'input', (e) => {
          const selectedTheme = e.target.value;
          applyTheme(selectedTheme);
          if (selectedTheme === 'light' || selectedTheme === 'pastel') {
              const ytThumbCheckbox = $('#set_ytThumbAsBg');
              if (ytThumbCheckbox) {
                  ytThumbCheckbox.checked = false;
                  toast('ƒê√£ t·∫Øt n·ªÅn YouTube ƒë·ªÉ h·ª£p v·ªõi theme s√°ng.', 2000);
              }
              // ƒê·∫£m b·∫£o xem tr∆∞·ªõc n·ªÅn g·ªëc cho theme s√°ng
              try { document.body.style.setProperty('--bg-image', 'none'); } catch(_) {}
          } else {
              // Theme t·ªëi: t·ª± b·∫≠t d√πng thumbnail YouTube n·∫øu c√≥ link
              const ytThumbCheckbox = $('#set_ytThumbAsBg');
              if (ytThumbCheckbox) {
                  ytThumbCheckbox.checked = true;
              }
              try { updateYouTubePlayer(); } catch(_) {}
          }
      });
      on($('#btnSettings'), 'click', openSettings);
      on($('#btnHelpCreateTopic'), 'click', () => {
          switchView('topics');
          $('#btnAddTopic').click();
      });
      on($('#btnDashboard'), 'click', () => {
          renderDashboard();
          $('#modalDashboard').classList.add('show');
      });
      on($('#btnCloseDashboard'), 'click', () => {
          $('#modalDashboard').classList.remove('show');
      });
      on($('#btnCloseSettings'), 'click', closeSettings);
      on($('#btnSaveSettings'), 'click', saveSettings);
      on($('#set_language'), 'change', (e) => {
        const newLang = e.target.value;
        loadLanguage(newLang);
        if (window.data && data.settings) { data.settings.language = newLang; saveData(); }
      });
      on($('#btnDefaults'), 'click', setDefaults);
      on($('#btnTestSound'), 'click', ()=>{ ensureAudio(); playSound('work_end'); });
      const customSoundsToggle = $('#set_useCustomSounds');
      if (customSoundsToggle) {
          on(customSoundsToggle, 'change', (e) => {
              const enabled = !!e.target.checked;
              const container = $('#customSoundsContainer');
              if (container) container.classList.toggle('hidden', !enabled);
          });
      }
      on($('#btnSaveNote'), 'click', async ()=>{ const s=getCurrentSubtopic(); if(!s) return; const id=pendingNoteSessionId; const sess=s.sessions.find(x=>x.id===id); if(sess){ sess.note=$('#noteText').value.trim(); await saveData(); renderStatsHistory(); toast('ƒê√£ l∆∞u ghi ch√∫'); } closeNoteModal(); });
      on($('#btnSkipNote'), 'click', ()=> closeNoteModal());
      on($('#btnAddGeneralNote'), 'click', addGeneralNote);
      on($('#btnSummarizeNote'), 'click', handleSummarizeNote);
      on($('#btnSendMessage'), 'click', handleSendMessage);
      on($('#chatInput'), 'keydown', (e) => { if (e.key === 'Enter') handleSendMessage(); });
      $$('#aiPromptSuggestions button').forEach(btn => {
        on(btn, 'click', () => {
          const promptTemplate = btn.dataset.prompt;
          $('#chatInput').value = promptTemplate;
          $('#chatInput').focus();
        });
      });
      on($('#btnClearChat'), 'click', clearChat);
      on($('#btnAddSubtopicTask'), 'click', addSubtopicTask);
      on($('#newSubtopicTaskInput'), 'keydown', (e) => { if (e.key === 'Enter') addSubtopicTask(); });
      on($('#btnToggleYtSound'), 'click', toggleYtSound);
      on($('#btnEnableSound'), 'click', () => { ensureAudio(); unlockAudioChain(); });
      on($('#ytSoundVolume'), 'input', (e) => {
          const vol = parseInt(e.target.value, 10);
          if (ytPlayer && ytPlayer.setVolume) {
              ytPlayer.setVolume(vol);
          }
      });
      on($('#set_youtubeUrl'), 'input', handleYoutubeUrlInput);
      // Removed performance mode toggle from settings
      
      // Pin timer menu removed per request
      // Nav buttons: toggle back to Timer on second click (guide, methods, topics, stats)
      $$('.nav-btn[data-view]').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          const cur = data?.settings?.currentView || 'timer';
          if (cur === view && view !== 'timer') switchView('timer');
          else switchView(view);
        });
      });
      $$('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                const parent = btn.closest('.aux-panel, .modal-card');
                if (!parent) return;
                parent.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                parent.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                    c.style.display = 'none';
                });
                const activeContent = parent.querySelector(`#${tabId}`);
                if(activeContent) {
                    activeContent.classList.add('active');
                    activeContent.style.display = 'block';
                    if(parent.closest('#modalSettings')) {
                        activeContent.style.display = 'flex';
                    }
                }
            });
        });
      // === Methods toolbar & actions ===
      const editorContent = $('#methodEditorContentInput');
      function formatDoc(command, value = null) {
        try { document.execCommand('styleWithCSS', false, true); } catch(_) {}
        try { document.execCommand(command, false, value); } catch(_) {}
        if (editorContent) editorContent.focus();
      }
      on($('#toolBold'), 'click', () => formatDoc('bold'));
      on($('#toolItalic'), 'click', () => formatDoc('italic'));
      on($('#toolH4'), 'click', () => formatDoc('formatBlock', '<h4>'));
      on($('#toolList'), 'click', () => formatDoc('insertOrderedList'));
      on($('#toolBullet'), 'click', () => formatDoc('insertUnorderedList'));
      // === Color Picker events ===
      const colorPickerWrapper = $('.color-picker-wrapper');
      const colorPalette = $('.color-palette');
      on($('#toolColor'), 'click', (e) => {
        if (!colorPalette) return;
        e.stopPropagation();
        colorPalette.classList.toggle('hidden');
      });
      $$('.color-swatch').forEach(swatch => {
        on(swatch, 'click', (e) => {
          e.preventDefault();
          const colorVar = swatch.dataset.color || '';
          let computedColor = colorVar;
          try {
            const m = colorVar.match(/--[a-zA-Z0-9_-]+/);
            if (m) computedColor = getComputedStyle(document.body).getPropertyValue(m[0]).trim();
          } catch(_) {}
          formatDoc('foreColor', computedColor);
          if (colorPalette) colorPalette.classList.add('hidden');
        });
      });
      on(document, 'click', (e) => {
        if (!colorPickerWrapper || !colorPalette) return;
        if (!colorPickerWrapper.contains(e.target) && !colorPalette.classList.contains('hidden')) {
          colorPalette.classList.add('hidden');
        }
      });
      function openMethodEditor(id){
        const s = getCurrentSubtopic();
        if (!s) { toast('Vui l√≤ng ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con tr∆∞·ªõc.'); return; }
        s.methods = Array.isArray(s.methods) ? s.methods : [];
        const list = s.methods;
        const m = id ? list.find(x => x.id === id) : null;
        $('#methodEditorId').value = (m && m.id) || '';
        $('#methodEditorTitle').textContent = m ? 'Ch·ªânh-s·ª≠a Tri th·ª©c' : 'Th√™m Tri th·ª©c m·ªõi';
        $('#methodEditorTitleInput').value = (m && m.title) || '';
        const ed = $('#methodEditorContentInput');
        if (ed) ed.innerHTML = (m && m.content) || '';
        $('#modalMethodEditor').classList.add('show');
        try { trapFocus($('#modalMethodEditor')); } catch(_) {}
        // Enable/disable Auto Format depending on API key
        try {
          const autoBtn = $('#btnAutoFormat');
          if (autoBtn) {
            const hasApiKey = !!(data?.settings?.apiKey && data.settings.apiKey.trim());
            autoBtn.disabled = !hasApiKey;
            autoBtn.title = hasApiKey ? 'D√πng AI ƒë·ªÉ t·ª± ƒë·ªông ƒë·ªãnh d·∫°ng vƒÉn b·∫£n' : 'Vui l√≤ng th√™m Gemini API Key trong C√†i ƒë·∫∑t ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.';
          }
        } catch(_) {}
      }
      on($('#btnCancelMethodEditor'), 'click', () => { $('#modalMethodEditor').classList.remove('show'); try { releaseFocus(); } catch(_) {} });
      on($('#btnSaveMethod'), 'click', async () => {
        const s = getCurrentSubtopic();
        if (!s) { toast('Vui l√≤ng ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con tr∆∞·ªõc.'); return; }
        s.methods = Array.isArray(s.methods) ? s.methods : [];
        const id = $('#methodEditorId').value || uid('m');
        const title = ($('#methodEditorTitleInput').value || '').trim();
        const ed = $('#methodEditorContentInput');
        const content = ed ? (ed.innerHTML || '') : '';
        const idx = s.methods.findIndex(x => x.id === id);
        const item = { id, title, content };
        if (idx >= 0) s.methods[idx] = item; else s.methods.unshift(item);
        await storageManager.update('subtopics', s);
        renderMethods();
        $('#modalMethodEditor').classList.remove('show');
        try { releaseFocus(); } catch(_) {}
      });
      on($('#btnAutoFormat'), 'click', async () => {
        const ed = $('#methodEditorContentInput');
        if (!ed) return;
        const plainText = (ed.textContent || '').trim();
        if (!plainText || plainText.length < 20) { toast('C·∫ßn c√≥ n·ªôi dung ƒë·ªÉ AI ƒë·ªãnh d·∫°ng.'); return; }
        const btn = $('#btnAutoFormat');
        if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div>'; }
        const prompt = `Ph√¢n t√≠ch v√† ƒë·ªãnh d·∫°ng l·∫°i ƒëo·∫°n vƒÉn b·∫£n sau ƒë√¢y th√†nh m√£ HTML s·∫°ch. S·ª≠ d·ª•ng c√°c th·∫ª sau:\n- D√πng <h4> cho c√°c ti√™u ƒë·ªÅ ch√≠nh.\n- D√πng <strong> ƒë·ªÉ nh·∫•n m·∫°nh c√°c thu·∫≠t ng·ªØ ho·∫∑c √Ω t∆∞·ªüng quan tr·ªçng.\n- D√πng <i> cho c√°c c√¢u ghi ch√∫ ho·∫∑c tr√≠ch d·∫´n.\n- D√πng <ol> v√† <li> cho c√°c danh s√°ch c√≥ th·ª© t·ª±.\n- D√πng <ul> v√† <li> cho c√°c danh s√°ch kh√¥ng c√≥ th·ª© t·ª±.\n- B·ªçc c√°c ƒëo·∫°n vƒÉn th√¥ng th∆∞·ªùng trong th·∫ª <p>.\nVƒÉn b·∫£n c·∫ßn ƒë·ªãnh d·∫°ng:\n\n"${plainText}"`;
        const formattedHtml = await callGeminiAPI(prompt);
        if (formattedHtml) { ed.innerHTML = formattedHtml; toast('AI ƒë√£ ƒë·ªãnh d·∫°ng xong!'); }
        else { toast('AI kh√¥ng th·ªÉ ƒë·ªãnh d·∫°ng l√∫c n√†y.'); }
        if (btn) { btn.disabled = false; btn.innerHTML = '‚ú® T·ª± ƒë·ªông ƒë·ªãnh d·∫°ng'; }
      });
      on($('#btnAddMethod'), 'click', () => {
        if (!getCurrentSubtopic()) { toast('Vui l√≤ng ch·ªçn m·ªôt Ch·ªß ƒë·ªÅ con tr∆∞·ªõc.'); return; }
        openMethodEditor();
      });
      const methodsView = document.querySelector('#view-methods');
      if (methodsView) {
        methodsView.addEventListener('click', (e) => {
          const editBtn = e.target.closest && e.target.closest('.method-edit');
          const delBtn = !editBtn && e.target.closest && e.target.closest('.method-delete');
          if (editBtn) {
            e.preventDefault(); e.stopPropagation();
            const id = editBtn.dataset.id;
            if (id) openMethodEditor(id);
            return;
          }
          if (delBtn) {
            e.preventDefault(); e.stopPropagation();
            const id = delBtn.dataset.id;
            if (!id) return;
            const s = getCurrentSubtopic();
            if (!s) return;
            s.methods = Array.isArray(s.methods) ? s.methods : [];
            const item = s.methods.find(x => x.id === id);
            if (!item) return;
            showConfirmModal('X√°c nh·∫≠n x√≥a', `X√≥a tri th·ª©c "${item.title || ''}"?`, async (ok) => {
              if (!ok) return;
              s.methods = s.methods.filter(x => x.id !== id);
              await storageManager.update('subtopics', s);
              renderMethods();
            });
          }
        });
      }
        $$('#timerPresetSelector button').forEach(btn => {
          btn.addEventListener('click', () => {
            editingPreset = btn.dataset.presetTarget;
            highlightPresetSelector();
            loadEditingPresetFields();
          });
        });
      $$('.presets button').forEach(button => {
        button.addEventListener('click', (e) => {
          const newPreset = e.target.dataset.preset;
          const currentPreset = data.settings.preset;
          if (newPreset === currentPreset) {
            return;
          }
          if (timer.state !== 'idle') {
            showConfirmModal(
              'X√°c nh·∫≠n chuy·ªÉn ƒë·ªïi',
              `B·∫°n c√≥ ch·∫Øc mu·ªën chuy·ªÉn sang Ki·ªÉu ${newPreset}? Thao t√°c n√†y s·∫Ω d·ª´ng v√† ƒë·∫∑t l·∫°i phi√™n l√†m vi·ªác hi·ªán t·∫°i.`,
              (confirmed) => {
                if (confirmed) {
                  timer.reset();
                  timer.setPreset(newPreset);
                  renderAll();
                  toast(`ƒê√£ chuy·ªÉn sang Ki·ªÉu ${newPreset}.`);
                }
              }
            );
          } 
          else {
            timer.setPreset(newPreset);
            renderAll();
            toast(`ƒê√£ chuy·ªÉn sang Ki·ªÉu ${newPreset}.`);
          }
        });
      });
      on($('#btnStart'), 'click', ()=> timer.start());
      on($('#btnFinishFlow'), 'click', ()=> timer.finishFlowSession());
      on($('#btnPause'), 'click', ()=> timer.pause());
      on($('#btnResume'), 'click', ()=> timer.resume());
      on($('#btnSkip'), 'click', ()=> timer.skip());
      on($('#btnReset'), 'click', ()=> timer.reset());
      on($('#btnBreakEarly'), 'click', ()=> timer.beginBreak());
      on($('#uploadBg'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customBg = id; await saveData(); applyCustomBg(); toast("ƒê√£ c·∫≠p nh·∫≠t h√¨nh n·ªÅn."); }); e.target.value = null; });
      on($('#btnClearBg'), 'click', async () => {
          data.settings.customBg = '';
          data.settings.useYtThumbnailAsBg = false;
          await saveData();
          applyCustomBg();
          toast("ƒê√£ x√≥a h√¨nh n·ªÅn t√πy ch·ªânh.");
          if ($('#modalSettings').classList.contains('show')) {
              openSettings();
          }
      });
      
      on($('#uploadSoundWork'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customSounds.work_end = id; await saveData(); toast("ƒê√£ l∆∞u √¢m b√°o h·∫øt L√ÄM VI·ªÜC."); }); e.target.value = null; });
      on($('#uploadSoundBreak'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customSounds.break_end = id; await saveData(); toast("ƒê√£ l∆∞u √¢m b√°o h·∫øt NGH·ªà NG·∫ÆN."); }); e.target.value = null; });
      on($('#uploadSoundLong'), 'change', (e) => { handleFileUpload(e.target.files[0], async (id) => { data.settings.customSounds.long_end = id; await saveData(); toast("ƒê√£ l∆∞u √¢m b√°o h·∫øt NGH·ªà D√ÄI."); }); e.target.value = null; });
      on($('#btnFullscreen'), 'click', toggleFullScreen);
      document.addEventListener('fullscreenchange', updateFullscreenButton);
      window.addEventListener('keydown', (e)=>{
        const target = e.target;
        const tag = (target.tagName||'').toLowerCase();
        const isTyping = ['input','textarea','select'].includes(tag) || target.isContentEditable;
        if(e.code==='Space' && !isTyping){
          e.preventDefault();
          if(timer.state==='idle'||timer.state==='paused') timer.start(); else timer.pause();
        }
        if(e.key==='n'||e.key==='N'){
          if(!isTyping){ e.preventDefault(); timer.skip(); }
        }
        if(e.key==='Escape'){
          $$('.modal').forEach(m => m.classList.remove('show'));
          try { releaseFocus(); } catch(_) {}
        }
        if(e.altKey && !isTyping){
          if(e.key==='ArrowUp'){ e.preventDefault(); nudgeTimer(0,-10); }
          else if(e.key==='ArrowDown'){ e.preventDefault(); nudgeTimer(0,10); }
          else if(e.key==='ArrowLeft'){ e.preventDefault(); nudgeTimer(-10,0); }
          else if(e.key==='ArrowRight'){ e.preventDefault(); nudgeTimer(10,0); }
        }
      });
      $$('.modal').forEach(m=> m.addEventListener('click', (ev)=>{
        // ƒê·ª´ng ƒë√≥ng Modal Method Editor khi click n·ªÅn
        if (ev && ev.target && ev.target.id === 'modalMethodEditor') return;
        if(ev.target===m){ m.classList.remove('show'); try { releaseFocus(); } catch(_) {} }
      }));
      window.addEventListener('click', (e) => {
        if (!e.target.closest('.actions-menu-btn') && !e.target.closest('.actions-menu')) {
            closeAllMenus();
        }
      });
      // ƒê√≥ng menu khi cu·ªôn n·ªôi dung ƒë·ªÉ tr√°nh sai l·ªõp ch·ªìng
      try {
        const appContent = document.querySelector('.app-content');
        if (appContent) appContent.addEventListener('scroll', closeAllMenus);
      } catch(_) {}
      try { window.addEventListener('scroll', closeAllMenus, true); } catch(_) {}
      window.addEventListener('beforeunload', () => timer.persistTimerState(true));

      // Accordion behavior for Methods section (always single-open)
      try {
        const methodItems = Array.from(document.querySelectorAll('#view-methods .method-item'));
        if (methodItems.length) {
          methodItems.forEach(item => {
            item.addEventListener('toggle', () => {
              if (item.open) {
                methodItems.forEach(other => { if (other !== item) other.open = false; });
              }
            });
          });
        }
      } catch(_) {}
      const draggableElement = $('#draggableTimer');
      let isDragging = false;
      let offsetX, offsetY;
      if (draggableElement) {
        draggableElement.addEventListener('mousedown', (e) => {
          isDragging = true;
          const rect = draggableElement.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;
          draggableElement.style.transition = 'none';
        });
        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          let newX = e.clientX - offsetX;
          let newY = e.clientY - offsetY;
          const boundaryX = window.innerWidth - draggableElement.offsetWidth;
          const boundaryY = window.innerHeight - draggableElement.offsetHeight;
          newX = Math.max(0, Math.min(newX, boundaryX));
          newY = Math.max(0, Math.min(newY, boundaryY));
          draggableElement.style.left = newX + 'px';
          draggableElement.style.top = newY + 'px';
          draggableElement.style.bottom = 'auto';
          draggableElement.style.right = 'auto';
        });
        document.addEventListener('mouseup', () => {
          if (!isDragging) return;
          isDragging = false;
          draggableElement.style.transition = '';
        });
      }
      function pinTimerCorner(pos){
        const el = $('#draggableTimer'); if (!el) return;
        el.style.position = 'fixed';
        el.style.transition = '';
        el.style.left = 'auto'; el.style.top = 'auto'; el.style.right = 'auto'; el.style.bottom = 'auto';
        const m = 16; // margin
        if (pos === 'tl') { el.style.left = m+'px'; el.style.top = m+'px'; }
        if (pos === 'tr') { el.style.right = m+'px'; el.style.top = m+'px'; }
        if (pos === 'bl') { el.style.left = m+'px'; el.style.bottom = m+'px'; }
        if (pos === 'br') { el.style.right = m+'px'; el.style.bottom = m+'px'; }
      }
      function nudgeTimer(dx, dy){
        const el = $('#draggableTimer'); if (!el) return;
        const rect = el.getBoundingClientRect();
        const nx = Math.max(0, Math.min((rect.left + dx), window.innerWidth - el.offsetWidth));
        const ny = Math.max(0, Math.min((rect.top + dy), window.innerHeight - el.offsetHeight));
        el.style.left = nx + 'px'; el.style.top = ny + 'px';
        el.style.right = 'auto'; el.style.bottom = 'auto';
      }
    }
    function toggleBackgroundView(){
        const body = document.body;
        body.classList.toggle('bg-view-mode');
        const isActive = body.classList.contains('bg-view-mode');
        const btn = $('#btnToggleBg');
        if (!btn) return;
        if (isActive) {
            btn.title = 'Hi·ªán giao di·ªán';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></svg>`;
        } else {
            btn.title = '·∫®n giao di·ªán';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
        }
    }
    function updateMainViewVisibility() {
        const hasSubtopic = !!getCurrentSubtopic();
        const timerView = $('#view-timer');
        const welcomePanel = $('#welcomePanel');
        if (welcomePanel) {
            welcomePanel.classList.toggle('hidden', hasSubtopic);
        }
        if (timerView) {
            if (hasSubtopic) {
                timerView.classList.remove('no-subtopic-selected');
            } else {
                timerView.classList.add('no-subtopic-selected');
            }
        }
    }
    function updatePresetButtonsText() {
        const settings = data.settings;
        const cyclesA = settings.cyclesA;
        const cyclesB = settings.cyclesB;
        const workA = settings.durations.A_work;
        const workB = settings.durations.B_work;
        const btnA = $('#btnPresetA');
        const btnB = $('#btnPresetB');
        const btnC = $('#btnPresetC');
        if (btnA) {
            btnA.textContent = `${cyclesA}√ó${workA} (A)`;
        }
        if (btnB) {
            btnB.textContent = `${cyclesB}√ó${workB} (B)`;
        }
        if (btnC) {
            btnC.textContent = 'üåä Flow';
        }
    }
    function renderAll(){
        updatePresetButtonsText();
        const currentPreset = data.settings.preset;
        $$('.presets button').forEach(button => {
          const isSelected = button.dataset.preset === currentPreset;
          button.classList.toggle('acc', isSelected);
          button.classList.toggle('ghost', !isSelected);
          button.setAttribute('aria-pressed', isSelected);
        });
        updateMainViewVisibility();
        timer.setPreset(data.settings.preset, {silent:true});
        renderTopics();
        renderContextBadge();
        renderStatsHistory();
        renderGeneralNotes();
        renderMethods();
        renderChat();
        applyCustomBg();
        applyPanelOpacity();
        renderSubtopicTasks();
        updateFullscreenButton();
        switchView(data.settings.currentView);
        // fixVietnameseUI ƒë√£ b·ªã lo·∫°i b·ªè; n·ªôi dung hi·ªÉn th·ªã tr·ª±c ti·∫øp b·∫±ng UTF-8
    }
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                toast(`L·ªói: Kh√¥ng th·ªÉ b·∫≠t ch·∫ø ƒë·ªô to√†n m√†n h√¨nh: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }
    function updateFullscreenButton() {
        const btn = $('#btnFullscreen');
        if (document.fullscreenElement) {
            btn.innerHTML = '‚ÜôÔ∏è';
            btn.title = 'Tho√°t to√†n m√†n h√¨nh';
        } else {
            btn.innerHTML = '‚ÜóÔ∏è';
            btn.title = 'To√†n m√†n h√¨nh';
        }
    }
    async function initializeApp() {
      try {
        await storageManager.initDB();
        const [settings, topics, subtopics] = await Promise.all([
          storageManager.getSettings(),
          storageManager.getAll('topics'),
          storageManager.getAll('subtopics')
        ]);
        let merged;
        if (!settings) {
          const defaultData = JSON.parse(JSON.stringify(defaults));
          await storageManager.updateSettings(defaultData.settings);
          // Seed any default topics/subtopics if provided
          for (const t of defaultData.topics) {
            const { subtopics: subs, ...topicData } = t;
            await storageManager.add('topics', topicData);
            for (const sub of subs) {
              await storageManager.add('subtopics', { ...sub, topicId: t.id });
            }
          }
          merged = defaultData;
        } else {
          const map = {};
          for (const t of topics) map[t.id] = { ...t, subtopics: [] };
          for (const s of subtopics) map[s.topicId]?.subtopics.push(s);
          merged = { version: defaults.version, settings, topics: Object.values(map) };
        }
        data = window.data = merged;
        normalizeDataStructure(data);
        await ensureValidSelection();
        await seedAchievedMilestones();
        renderAll();
        try { tagI18nElements(); applyLanguage(data.settings?.language || localStorage.getItem('lang') || 'vi'); } catch(_) {}
        try { storageManager.autoBackup(data); } catch (e) { console.warn('AutoBackup error:', e); }
        bindEvents();
        applyTheme();
      } catch (err) {
        console.error('Initialization error:', err);
        toast(`L·ªói kh·ªüi t·∫°o: ${err.message}`);
      }
    }
    // =========================================================
    // START: SMART API KEY LOAD BALANCER (DEVELOPER KEYS)
    // =========================================================

    // !!! QUAN TR·ªåNG: D√°n 5 API key c·ªßa b·∫°n v√†o ƒë√¢y !!!
    const DEV_API_KEYS = [
        "AIzaSyD8E1bD0QNkUGlq7MKKkp9eNsaOcQyfhPc", // Thay th·∫ø b·∫±ng key 1
        "AIzaSyCt7WR2hjW2GPxMWDQio8oq6s_DWx_Xw3c", // Thay th·∫ø b·∫±ng key 2
        "AIzaSyAUHA8NhgR1HZJHdSY5PpDazk9TYtEzPK4", // Thay th·∫ø b·∫±ng key 3
        "AIzaSyDq7pp49556F9sNCoKI-yKasvwQITe88ZQ", // Thay th·∫ø b·∫±ng key 4
        "AIzaSyBPSxO2QIFhgc9vcytVVNO_CYPUShPTCRc" // Thay th·∫ø b·∫±ng key 5
    ].filter(Boolean); // L·ªçc ra c√°c key r·ªóng (n·∫øu b·∫°n d√°n thi·∫øu)

    const geminiKeyManager = {
        health: {}, // L∆∞u tr·∫°ng th√°i: { "key_string": { healthy: true } }

        /**
         * Kh·ªüi t·∫°o tr·∫°ng th√°i health cho c√°c key
         */
        initializeHealth: function() {
            this.health = {};
            for (const key of DEV_API_KEYS) {
                // ƒê·∫£m b·∫£o key l√† string v√† kh√¥ng r·ªóng
                if (typeof key === 'string' && key.trim()) {
                    this.health[key.trim()] = { healthy: true };
                }
            }
        },

        /**
         * Ch·ªçn key t·ªët nh·∫•t (∆∞u ti√™n key "healthy")
         */
        selectBestKey: function() {
            const validKeys = DEV_API_KEYS.filter(k => k && this.health[k]);
            if (validKeys.length === 0) return null;

            const healthyKeys = validKeys.filter(k => this.health[k]?.healthy);
            
            if (healthyKeys.length > 0) {
                // ƒê∆°n gi·∫£n l√† ch·ªçn key ƒë·∫ßu ti√™n trong danh s√°ch healthy
                return healthyKeys[0]; 
            }

            // N·∫øu t·∫•t c·∫£ ƒë·ªÅu unhealthy, th·ª≠ reset v√† ch·ªçn l·∫°i
            console.warn("T·∫•t c·∫£ Gemini keys ƒë·ªÅu b·ªã ƒë√°nh d·∫•u unhealthy. Reset v√† th·ª≠ l·∫°i...");
            this.resetHealth(); // Reset t·∫•t c·∫£ v·ªÅ 'healthy: true'
            
            // N·∫øu sau khi reset v·∫´n c√≥ key, tr·∫£ v·ªÅ key ƒë·∫ßu ti√™n
            const resetKeys = DEV_API_KEYS.filter(k => k && this.health[k]);
            if (resetKeys.length > 0) return resetKeys[0];

            return null; // Th·ª±c s·ª± kh√¥ng c√≥ key n√†o
        },

        /**
         * B√°o c√°o l·ªói cho m·ªôt key (v√≠ d·ª•: l·ªói 429 - h·∫øt quota)
         */
        reportFailure: function(key) {
            if (this.health[key]) {
                this.health[key].healthy = false;
                console.warn(`Gemini key ...${key.slice(-4)} b·ªã ƒë√°nh d·∫•u unhealthy.`);
            }
        },

        /**
         * B√°o c√°o key ho·∫°t ƒë·ªông th√†nh c√¥ng
         */
        reportSuccess: function(key) {
            if (this.health[key]) {
                this.health[key].healthy = true;
            }
        },

        /**
         * Reset health c·ªßa t·∫•t c·∫£ key (ƒë·ªÉ th·ª≠ l·∫°i sau m·ªôt th·ªùi gian)
         */
        resetHealth: function() {
            Object.keys(this.health).forEach(k => {
                if(this.health[k]) this.health[k].healthy = true;
            });
            if (Object.keys(this.health).length > 0) {
                console.log("Tr·∫°ng th√°i Gemini key health ƒë√£ ƒë∆∞·ª£c reset.");
            }
        }
    };

    // Kh·ªüi t·∫°o tr·∫°ng th√°i health ngay khi t·∫£i
    geminiKeyManager.initializeHealth();

    // T·ª± ƒë·ªông reset health c·ªßa c√°c key m·ªói 30 ph√∫t
    // (Gi·ªëng logic "Health monitoring" trong v√≠ d·ª• c·ªßa b·∫°n)
    setInterval(() => {
        geminiKeyManager.resetHealth();
    }, 1800000); // 30 ph√∫t

    /**
     * H√†m g·ªçi API M·ªöI v·ªõi logic Smart Load Balancing
     * @param {string} prompt - C√¢u l·ªánh prompt
     * @param {Set<string>} visitedKeys - (Ch·ªâ d√πng n·ªôi b·ªô) ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n
     */
    callGeminiAPI = async function(prompt, visitedKeys = new Set()) {
        
        // 1. Ch·ªçn key t·ªët nh·∫•t
        const apiKey = geminiKeyManager.selectBestKey();

        if (!apiKey) {
            // Tr∆∞·ªùng h·ª£p n√†y ch·ªâ x·∫£y ra n·∫øu m·∫£ng DEV_API_KEYS b·ªã r·ªóng
            toast("L·ªói: Ch∆∞a c·∫•u h√¨nh API key ph√≠a nh√† ph√°t tri·ªÉn.", 4000);
            return null;
        }

        // 2. Ki·ªÉm tra v√≤ng l·∫∑p (n·∫øu ƒë√£ th·ª≠ key n√†y trong 1 chu·ªói failover)
        if (visitedKeys.has(apiKey)) {
            // ƒê√£ th·ª≠ h·∫øt t·∫•t c·∫£ c√°c key v√† quay l·∫°i key ƒë·∫ßu ti√™n -> t·∫•t c·∫£ ƒë·ªÅu h·ªèng
            toast("T·∫•t c·∫£ API keys ƒë·ªÅu kh√¥ng kh·∫£ d·ª•ng. Vui l√≤ng th·ª≠ l·∫°i sau.", 4000);
            geminiKeyManager.resetHealth(); // Reset cho l·∫ßn g·ªçi ti·∫øp theo
            return null;
        }
        visitedKeys.add(apiKey); // ƒê√°nh d·∫•u ƒë√£ th·ª≠ key n√†y

        // 3. Th·ª±c hi·ªán cu·ªôc g·ªçi API
        // (S·ª≠ d·ª•ng model v√† URL gi·ªëng nh∆∞ trong file 02.html g·ªëc c·ªßa b·∫°n)
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

            if (!response.ok) {
                // 4. X·ª≠ l√Ω l·ªói & T·ª∞ ƒê·ªòNG FAILOVER
                let errorMsg = `L·ªói API Key ...${apiKey.slice(-4)}`;

                if (response.status === 429) { // Rate limit (H·∫øt Quota)
                    errorMsg = `Key ...${apiKey.slice(-4)} h·∫øt quota. T·ª± ƒë·ªông chuy·ªÉn key...`;
                    console.warn(errorMsg);
                    toast(errorMsg, 2500);
                } else if (response.status === 400) { // Bad key (Key sai)
                    errorMsg = `L·ªói: Key ...${apiKey.slice(-4)} kh√¥ng h·ª£p l·ªá. T·ª± ƒë·ªông chuy·ªÉn key...`;
                    toast(errorMsg, 3000);
                } else { // L·ªói kh√°c (Server 500,...)
                    errorMsg = `L·ªói m√°y ch·ªß (${response.status}) v·ªõi key ...${apiKey.slice(-4)}. T·ª± ƒë·ªông chuy·ªÉn key...`;
                    console.error("Gemini API Error:", await response.text());
                }
                
                geminiKeyManager.reportFailure(apiKey); // ƒê√°nh d·∫•u key n√†y l√† h·ªèng
                return callGeminiAPI(prompt, visitedKeys); // ƒê·ªá quy ƒë·ªÉ th·ª≠ key kh√°c
            }

            // 5. TH√ÄNH C√îNG
            const result = await response.json();
            geminiKeyManager.reportSuccess(apiKey); // B√°o c√°o key n√†y OK

            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                return formatGeminiResponse(result.candidates[0].content.parts[0].text);
            } else {
                console.error("API response structure is unexpected:", result);
                if (result.promptFeedback?.blockReason) { return `N·ªôi dung b·ªã ch·∫∑n v√¨: ${result.promptFeedback.blockReason}. Vui l√≤ng th·ª≠ l·∫°i v·ªõi n·ªôi dung kh√°c.`; }
                return "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung h·ª£p l·ªá t·ª´ AI.";
            }

        } catch (error) {
            // 6. L·ªñI M·∫†NG (Fetch failed) & T·ª∞ ƒê·ªòNG FAILOVER
            console.error("L·ªói m·∫°ng khi g·ªçi Gemini API:", error);
            toast("L·ªói m·∫°ng khi k·∫øt n·ªëi. T·ª± ƒë·ªông chuy·ªÉn key...", 3000);
            geminiKeyManager.reportFailure(apiKey); // ƒê√°nh d·∫•u key h·ªèng
            return callGeminiAPI(prompt, visitedKeys); // Th·ª≠ key kh√°c
        }
    }

    // =========================================================
    // END: SMART API KEY LOAD BALANCER
    // =========================================================

    loadLanguage(localStorage.getItem('lang') || 'vi').then(initializeApp);
    </script>
</body>
</html>

